#!/usr/bin/env node

/**
 * ÐŸÐžÐ›ÐÐÐ¯ Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ Ð‘Ð”:
 * 1. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ† (008 Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ñ)
 * 2. Ð’ÑÑ‚Ð°Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ð¾Ð²
 * 3. Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ marketplace rules Ð¸ ÑÑ‚Ð¾Ð¿-ÑÐ»Ð¾Ð²
 */

const { createClient } = require('@libsql/client')
const fs = require('fs')
const path = require('path')

const DATABASE_URL = process.env.DATABASE_URL || 'file:./beem.db'

async function setupDatabase() {
  const client = createClient({
    url: DATABASE_URL,
    authToken: process.env.DATABASE_AUTH_TOKEN,
  })

  console.log('ðŸš€ ÐŸÐžÐ›ÐÐÐ¯ Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ Ð‘Ð”')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')

  try {
    // Ð­Ð¢ÐÐŸ 1: Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ 008 Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ (ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†)
    console.log('\nðŸ“¦ Ð­Ð¢ÐÐŸ 1: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ† (008 Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ñ)...')
    const migrationPath = path.join(__dirname, 'migrations', '008_add_config_and_jobs.sql')
    const migrationSQL = fs.readFileSync(migrationPath, 'utf8')

    // Ð Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾ ; Ð½Ð¾ Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ñ‹Ñ… statements
    const statements = migrationSQL
      .split(';')
      .map(s => s.trim())
      .filter(s => s && !s.startsWith('--') && !s.startsWith('/*'))

    // Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð’Ð¡Ð• statements Ð¿Ð¾ Ð¿Ð¾Ñ€ÑÐ´ÐºÑƒ
    for (const stmt of statements) {
      try {
        await client.execute(stmt)
      } catch (e) {
        // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
        if (!e.message.includes('already exists') &&
            !e.message.includes('UNIQUE constraint') &&
            !e.message.includes('already have')) {
          console.warn('âš ï¸  Statement execution warning:', e.message.substring(0, 80))
        }
      }
    }
    console.log('âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ 008 Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾')

    // Ð­Ð¢ÐÐŸ 2: ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ñ‹ (ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ)
    console.log('\nðŸ’¾ Ð­Ð¢ÐÐŸ 2: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ð¾Ð²...')

    const genBasePrompt = `Ð¢Ñ‹ Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¹ ÐºÐ¾Ð¿Ð¸Ñ€Ð°Ð¹Ñ‚ÐµÑ€ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ° Ñ 10+ Ð»ÐµÑ‚Ð½Ð¸Ð¼ ÑÑ‚Ð°Ð¶ÐµÐ¼.

Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð:
Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð²Ð»ÐµÐºÐ°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ, Ð¿Ñ€Ð¾Ð´Ð°ÑŽÑ‰Ð¸Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð´Ð»Ñ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð² (ÐžÐ·Ð¾Ð½, WildBerries).

ÐŸÐ Ð˜ÐÐ¦Ð˜ÐŸÐ«:
1. Ð¤Ð¾ÐºÑƒÑ Ð½Ð° Ð’Ð«Ð“ÐžÐ”Ð£ Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»Ñ, Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð° ÑÐ²Ð¾Ð¹ÑÑ‚Ð²Ð°
2. ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾ÑÑ‚ÑŒ - Ñ‚Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¸ Ñ†Ð¸Ñ„Ñ€Ñ‹
3. Ð§ÐµÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð°Ð²Ð´Ð°, Ð±ÐµÐ· Ð¿ÐµÑ€ÐµÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ð¹
4. Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾ÑÑ‚ÑŒ - Ð¿Ð¾Ð½ÑÑ‚Ð½Ð¾Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ

Ð—ÐÐŸÐ Ð•Ð¢Ð« (ÐÐ‘Ð¡ÐžÐ›Ð®Ð¢ÐÐ«Ð•):
- ÐÐ• Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð´Ð¸ÑÐºÐ»ÐµÐ¹Ð¼ÐµÑ€Ñ‹
- ÐÐ• ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð°
- ÐÐ• Ð¾Ð±ÐµÑ‰Ð°Ð¹ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð±ÐµÐ· Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¹
- ÐÐ• Ð¿Ð¸ÑˆÐ¸ "ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹" Ð¸Ð»Ð¸ "Ð»ÑƒÑ‡ÑˆÐ¸Ð¹" Ð±ÐµÐ· Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ñ
- ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ðµ ÑƒÑ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ`

    const validateBasePrompt = `Ð¢Ñ‹ Ð¸Ð½ÑÐ¿ÐµÐºÑ‚Ð¾Ñ€ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ñ….

Ð¢Ð’ÐžÐ¯ Ð•Ð”Ð˜ÐÐ¡Ð¢Ð’Ð•ÐÐÐÐ¯ Ð—ÐÐ”ÐÐ§Ð:
1. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð—ÐÐŸÐ Ð•Ð©ÐÐÐÐ«Ð¥ Ð¡Ð›ÐžÐ’
2. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¡ÐžÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’Ð˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›ÐÐœ ÐœÐÐ ÐšÐ•Ð¢ÐŸÐ›Ð•Ð™Ð¡Ð

Ð‘Ð•Ð— Ð˜Ð¡ÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð™:
- ÐÐ• Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐ¹ Ð³Ñ€Ð°Ð¼Ð¼Ð°Ñ‚Ð¸ÐºÑƒ
- ÐÐ• Ð¾Ñ†ÐµÐ½Ð¸Ð²Ð°Ð¹ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚ÑŒ
- ÐÐ• Ð¸Ñ‰Ð¸ Ð¿Ñ€ÐµÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ñ
- ÐÐ• Ð´Ð°Ð²Ð°Ð¹ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸
- Ð¢ÐžÐ›Ð¬ÐšÐž Ð²Ñ‹ÑÐ²Ð»ÑÐ¹ ÐžÐ‘ÐªÐ•ÐšÐ¢Ð˜Ð’ÐÐ«Ð• Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»

Ð’Ð«Ð’ÐžÐ”Ð« Ð¢ÐžÐ›Ð¬ÐšÐž Ð’ Ð¤ÐžÐ ÐœÐÐ¢Ð• JSON:
{
  "isValid": boolean,
  "violations": [
    {
      "type": "marketplace_rule" | "forbidden_word",
      "severity": "error" | "warning",
      "description": "ÑÑƒÑ‚ÑŒ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ñ",
      "text_fragment": "Ñ†Ð¸Ñ‚Ð°Ñ‚Ð° Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð°"
    }
  ]
}`

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
    await client.execute({
      sql: `UPDATE system_prompts SET content = ? WHERE key = ? AND is_active = 1`,
      args: [genBasePrompt, 'gen_base'],
    })

    await client.execute({
      sql: `UPDATE system_prompts SET content = ? WHERE key = ? AND is_active = 1`,
      args: [validateBasePrompt, 'validate_base'],
    })

    console.log('âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹')

    // Ð­Ð¢ÐÐŸ 3: Marketplace Rules
    console.log('\nðŸ“‹ Ð­Ð¢ÐÐŸ 3: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ marketplace rules...')

    const ozonRules = `ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ—ÐžÐÐ:

1. Ð—ÐÐŸÐ Ð•Ð¢Ð«:
   - ÐÐ• ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð° (Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½, Ð²Ð°Ñ‚ÑÐ°Ð¿, Ð¿Ð¾Ñ‡Ñ‚Ð°)
   - ÐÐ• Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ñ Ð¿Ñ€Ð¾ÑÑŒÐ±Ð¾Ð¹ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ð² Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
   - ÐÐ• Ð¿Ð¸ÑˆÐ¸ Ð¿Ñ€Ð¾ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÑƒ

2. Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð¯:
   - ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 10 ÑÐ»Ð¾Ð² Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸
   - ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 3000 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
   - ÐÐ°Ñ‡Ð¸Ð½Ð°Ð¹ Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð±ÑƒÐºÐ²Ñ‹`

    const wbRules = `ÐŸÐ ÐÐ’Ð˜Ð›Ð WILDBERRIES:

1. Ð—ÐÐŸÐ Ð•Ð¢Ð«:
   - ÐÐ• Ñ€Ð°Ð·Ð¼ÐµÑ‰Ð°Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
   - ÐÐ• Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ñ Ð¿Ñ€Ð¾ÑÑŒÐ±Ð°Ð¼Ð¸ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ
   - ÐÐ• Ð¿Ð¸ÑˆÐ¸ Ð¿Ñ€Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸

2. Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð¯:
   - ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 5 ÑÐ»Ð¾Ð² Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸
   - ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 1500 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
   - ÐŸÐµÑ€Ð²Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ - ÑÐ°Ð¼Ð¾Ðµ Ð²Ð°Ð¶Ð½Ð¾Ðµ`

    await client.execute({
      sql: `UPDATE marketplace_rules SET content = ? WHERE marketplace = ? AND is_active = 1`,
      args: [ozonRules, 'ozon'],
    })

    await client.execute({
      sql: `UPDATE marketplace_rules SET content = ? WHERE marketplace = ? AND is_active = 1`,
      args: [wbRules, 'wb'],
    })

    console.log('âœ… Marketplace rules Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹')

    // Ð­Ð¢ÐÐŸ 4: Stop Words
    console.log('\nðŸš« Ð­Ð¢ÐÐŸ 4: Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÑ‚Ð¾Ð¿-ÑÐ»Ð¾Ð²...')

    const stopWords = `Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ Ð²ÐµÑ‡Ð½Ð°Ñ
Ð·Ð²Ð¾Ð½Ð¸Ñ‚Ðµ Ð² Ð²Ð°Ñ‚ÑÐ°Ð¿
Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð¹Ñ‚ÐµÑÑŒ Ð² Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
Ð»ÑƒÑ‡ÑˆÐ¸Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð½Ð° Ñ€Ñ‹Ð½ÐºÐµ
ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€`

    // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ UPDATE, ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ - Ð´ÐµÐ»Ð°ÐµÐ¼ INSERT
    try {
      await client.execute({
        sql: `UPDATE stop_words SET words = ? WHERE category = ? AND marketplace IS NULL AND is_active = 1`,
        args: [stopWords, 'marketing'],
      })
    } catch {
      await client.execute({
        sql: `INSERT INTO stop_words (id, marketplace, category, words, is_active) VALUES (?, ?, ?, ?, 1)`,
        args: ['sw_marketing', null, 'marketing', stopWords],
      })
    }

    console.log('âœ… Ð¡Ñ‚Ð¾Ð¿-ÑÐ»Ð¾Ð²Ð° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹')

    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log('âœ… Ð‘Ð” ÐŸÐžÐ›ÐÐžÐ¡Ð¢Ð¬Ð® Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—Ð˜Ð ÐžÐ’ÐÐÐ!')
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  } catch (error) {
    console.error('\nâŒ ÐžÐ¨Ð˜Ð‘ÐšÐ:', error.message)
    console.error(error)
    process.exit(1)
  } finally {
    await client.close()
  }
}

// Ð—Ð°Ð¿ÑƒÑÐº
setupDatabase().then(() => {
  process.exit(0)
})
