# üöÄ PRODUCTION-READY: CardMaker Queue System

**–î–∞—Ç–∞:** 02.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production-Ready  
**–í–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:** Phase 9

---

## üìã –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 1Ô∏è‚É£ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `userId` –≤ —Ç–∞–±–ª–∏—Ü—É `jobs`** ‚úÖ
- **–§–∞–π–ª:** `src/lib/db.ts`
- **–ß—Ç–æ:** –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `userId TEXT` –≤ —Ç–∞–±–ª–∏—Ü—É `jobs`
- **–ò–Ω–¥–µ–∫—Å:** `idx_jobs_userId_status` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ —Å—Ç–∞—Ç—É—Å—É
- **–ú–∏–≥—Ä–∞—Ü–∏—è:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —á–µ—Ä–µ–∑ `addColumnIfNotExists()` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**SQL:**
```sql
ALTER TABLE jobs ADD COLUMN userId TEXT;
CREATE INDEX idx_jobs_userId_status ON jobs(userId, status, created_at DESC);
```

---

### 2Ô∏è‚É£ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω PER-USER –ª–∏–º–∏—Ç –¥–ª—è batch** ‚úÖ
- **–§–∞–π–ª:** `src/app/api/batch/create/route.ts`
- **–ß—Ç–æ:** –ª–∏–º–∏—Ç —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ü–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ, –∞ –Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–æ
- **–†–∞–Ω—å—à–µ:** `WHERE status IN ('queued', 'processing')`
- **–¢–µ–ø–µ—Ä—å:** `WHERE status IN ('queued', 'processing') AND userId = ?`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏—Ö

**–ö–æ–¥:**
```typescript
const queuedResult = await db.execute(
  `SELECT COUNT(*) as count FROM jobs 
   WHERE status IN ('queued', 'processing') AND userId = ?`,
  [session.user.id]
)
```

---

### 3Ô∏è‚É£ **–ü–µ—Ä–µ–¥–∞—á–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ `userId` –≤ batch-worker** ‚úÖ
- **–§–∞–π–ª:** `scripts/batch-worker.ts`
- **–ß—Ç–æ:** batch-worker —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π userId –≤ `generateProductCard()`
- **–†–∞–Ω—å—à–µ:** `userId: 'batch-worker'` (—Å–∏—Å—Ç–µ–º–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Å–∫—Ä—ã–≤–∞–ª–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- **–¢–µ–ø–µ—Ä—å:** `userId: payload.userId` (—Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è batch

**–ö–æ–¥:**
```typescript
const realUserId = payload.userId
const result = await generateProductCard({
  // ...
  userId: realUserId, // —Ä–µ–∞–ª—å–Ω—ã–π userId –¥–ª—è –ª–∏–º–∏—Ç–æ–≤
})
```

---

### 4Ô∏è‚É£ **–ú–µ—Ö–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å—à–∏—Ö jobs (Recovery)** ‚úÖ
- **–§–∞–π–ª:** `scripts/batch-worker.ts`
- **–§—É–Ω–∫—Ü–∏—è:** `recoverStuckJobs()`
- **–ß—Ç–æ:** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç jobs —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `processing` –æ–±—Ä–∞—Ç–Ω–æ –≤ `queued` –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ > timeout

**–õ–æ–≥–∏–∫–∞:**
```sql
UPDATE jobs
SET status = 'queued', updated_at = ?
WHERE status = 'processing' AND (updated_at IS NULL OR updated_at < ?)
```

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
1. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ worker'–∞ (–æ–¥–∏–Ω —Ä–∞–∑)
2. –¢–∞–π–º–∞—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1800 —Å–µ–∫—É–Ω–¥ (30 –º–∏–Ω—É—Ç)
3. –¢–∞–π–º–∞—É—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `limits_config` —Ç–∞–±–ª–∏—Ü—É

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —Å–∏—Å—Ç–µ–º–∞ –í–°–ï–ì–î–ê –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è worker'–∞

---

### 5Ô∏è‚É£ **–¢–∞–±–ª–∏—Ü–∞ `limits_config` –∏ Admin API** ‚úÖ
- **–§–∞–π–ª:** `src/lib/db.ts` (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
- **API:** `src/app/api/admin/limits/route.ts`
- **–¢–∞–±–ª–∏—Ü–∞:** `limits_config`

**–õ–∏–º–∏—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å:**
```
batch_max_items_per_request: 200          (—Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ–¥–Ω–æ–º batch)
batch_max_queued_per_user: 300            (—Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
job_processing_timeout_seconds: 1800      (timeout –¥–ª—è –∑–∞–≤–∏—Å—à–µ–≥–æ job)
single_daily_limit_free: 5                (–¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç free)
single_daily_limit_basic: 20              (–¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç basic)
single_daily_limit_professional: 100      (–¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç pro)
single_daily_limit_enterprise: 1000       (–¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç enterprise)
```

**Admin API:**
```bash
# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ª–∏–º–∏—Ç—ã
GET /api/admin/limits
Headers: Authorization: NextAuth session

# –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç
POST /api/admin/limits
Body: {
  "key": "batch_max_items_per_request",
  "value": 50
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ª–∏–º–∏—Ç—ã –±–µ–∑ —Ä–µ–¥–µ–ø–ª–æ—è, –∑–∞ 30 —Å–µ–∫—É–Ω–¥

---

### 6Ô∏è‚É£ **–õ–∏–º–∏—Ç—ã –∏–∑ –ë–î –≤–º–µ—Å—Ç–æ hardcoded** ‚úÖ
- **–§–∞–π–ª:** `src/lib/ai-services/generation.ts`
- **–§—É–Ω–∫—Ü–∏—è:** `getLimitForPlan()` - –ø–æ–ª—É—á–∞–µ—Ç –ª–∏–º–∏—Ç –∏–∑ `limits_config`
- **Fallback:** –µ—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç hardcoded –∑–Ω–∞—á–µ–Ω–∏—è
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ –ª–∏–º–∏—Ç—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∏–∑ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞

---

### 7Ô∏è‚É£ **In-Memory –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ worker** ‚úÖ
- **–§–∞–π–ª:** `scripts/batch-worker.ts`
- **–§—É–Ω–∫—Ü–∏—è:** `getCachedConfig()`
- **TTL:** 5 –º–∏–Ω—É—Ç
- **–ß—Ç–æ:** worker –∫—ç—à–∏—Ä—É–µ—Ç –ª–∏–º–∏—Ç—ã –∏–∑ –ë–î, –Ω–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
  - –ú–µ–Ω—å—à–µ I/O –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
  - –ë—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞ jobs
  - –î–ª—è batch –∏–∑ 50 —Ç–æ–≤–∞—Ä–æ–≤: 1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 50

---

### 8Ô∏è‚É£ **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã** ‚úÖ
- **`idx_jobs_status_type`** ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ queued jobs
- **`idx_jobs_created_at`** ‚Äî –¥–ª—è FIFO –æ—á–µ—Ä–µ–¥–∏ (ORDER BY created_at)
- **`idx_jobs_userId_status`** ‚Äî –¥–ª—è per-user –ª–∏–º–∏—Ç–æ–≤
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** O(1) –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–æ 50k+ jobs

---

## üîÑ –ú–û–î–ï–õ–¨ –û–ß–ï–†–ï–î–ò

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GLOBAL QUEUE (FIFO)                            ‚îÇ
‚îÇ  –û–¥–Ω–∞ –æ—á–µ—Ä–µ–¥—å, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è N=3 ‚îÇ
‚îÇ  jobs                                           ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  SELECT * FROM jobs                            ‚îÇ
‚îÇ  WHERE status='queued'                          ‚îÇ
‚îÇ  ORDER BY created_at ASC                        ‚îÇ
‚îÇ  LIMIT 1                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ATOMICITY (no race conditions)                 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  UPDATE jobs                                    ‚îÇ
‚îÇ  SET status='processing'                        ‚îÇ
‚îÇ  WHERE id=? AND status='queued'                 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  –ï—Å–ª–∏ UPDATE –≤–µ—Ä–Ω—É–ª 0 rows ‚Üí –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å    ‚îÇ
‚îÇ  —É–∂–µ –≤–∑—è–ª —ç—Ç–æ—Ç job                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CONCURRENCY = 3                                ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  npm run worker:batch &                        ‚îÇ
‚îÇ  npm run worker:batch &                        ‚îÇ
‚îÇ  npm run worker:batch &                        ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞, –ë–î —Ä–µ—à–∞–µ—Ç –≥–æ–Ω–∫–∏        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ –°–¶–ï–ù–ê–†–ò–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–¥–∏–Ω–æ—á–Ω—ã–π batch (50 —Ç–æ–≤–∞—Ä–æ–≤)
```bash
POST /api/batch/create
{
  "marketplace": "ozon",
  "style": "selling",
  "items": [
    { "description": "...", "category": "..." },
    // x50
  ]
}

–û–∂–∏–¥–∞–µ–º–æ:
‚úì 50 jobs —Å–æ–∑–¥–∞–Ω—ã —Å userId = user123
‚úì –í—Å–µ jobs –≤ —Å—Ç–∞—Ç—É—Å–µ 'queued'
‚úì Worker –Ω–∞—á–Ω–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É
‚úì –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: ~1-2 –º–∏–Ω—É—Ç—ã (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç OpenAI)
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö batch'–∞ (3 √ó 50 = 150 —Ç–æ–≤–∞—Ä–æ–≤)
```bash
User1: POST /api/batch/create (50 —Ç–æ–≤–∞—Ä–æ–≤)
User2: POST /api/batch/create (50 —Ç–æ–≤–∞—Ä–æ–≤)
User3: POST /api/batch/create (50 —Ç–æ–≤–∞—Ä–æ–≤)

–û–∂–∏–¥–∞–µ–º–æ:
‚úì –í—Å–µ 150 jobs –≤ 'queued'
‚úì Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç FIFO: –ø–æ–∫–∞ –µ—Å—Ç—å jobs
‚úì User1, User2, User3 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏
‚úì –ù–∏–∫—Ç–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–∏–∫–æ–≥–æ
‚úì –õ–∏–º–∏—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 3: Worker crash –∏ recovery
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å 3 worker'–∞
npm run worker:batch &
npm run worker:batch &
npm run worker:batch &

# 2. –ó–∞–ª–∏—Ç—å 100 jobs
POST /api/batch/create (100 —Ç–æ–≤–∞—Ä–æ–≤)

# 3. –ü–æ—Å–ª–µ 30 —Å–µ–∫—É–Ω–¥ —É–±–∏—Ç—å –≤—Å–µ worker'—ã
kill %1 %2 %3

# 4. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ë–î
SELECT COUNT(*) FROM jobs WHERE status='processing'
‚Üí –í—Å–µ –µ—â–µ –µ—Å—Ç—å jobs –≤ processing

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å worker —Å–Ω–æ–≤–∞
npm run worker:batch &

–û–∂–∏–¥–∞–µ–º–æ:
‚úì –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ worker –≤—ã–∑—ã–≤–∞–µ—Ç recoverStuckJobs()
‚úì –í—Å–µ jobs —Å–æ —Å—Ç–∞—Ä—ã–º updated_at –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ 'queued'
‚úì Worker –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å
‚úì –ù–∏ –æ–¥–∏–Ω job –Ω–µ –ø–æ—Ç–µ—Ä—è–ª—Å—è
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 4: PER-USER –ª–∏–º–∏—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
```bash
# User1: –¥–æ–±–∞–≤–∏—Ç—å 300 jobs –≤ –æ—á–µ—Ä–µ–¥—å
POST /api/batch/create (300 —Ç–æ–≤–∞—Ä–æ–≤) ‚Üí success

# User1: –ø–æ–ø—ã—Ç—å—Å—è –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ 50
POST /api/batch/create (50 —Ç–æ–≤–∞—Ä–æ–≤) ‚Üí 429 Too Many Requests

# User2: –¥–æ–±–∞–≤–∏—Ç—å 50 (—ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É—Å—Ç–æ–π)
POST /api/batch/create (50 —Ç–æ–≤–∞—Ä–æ–≤) ‚Üí success

–û–∂–∏–¥–∞–µ–º–æ:
‚úì User1 —É–ø–∏—Ä–∞–µ—Ç—Å—è –≤ –ª–∏–º–∏—Ç 300
‚úì User2 –ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è
‚úì –õ–∏–º–∏—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è WHERE userId = ?
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 5: –õ–∏–º–∏—Ç—ã –º–µ–Ω—è—é—Ç—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ
```bash
# 1. –ò–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç batch —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω
POST /api/admin/limits
{
  "key": "batch_max_items_per_request",
  "value": 10
}

# 2. –°—Ä–∞–∑—É –∂–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å batch —Å 50 —Ç–æ–≤–∞—Ä–∞–º–∏
POST /api/batch/create (50 —Ç–æ–≤–∞—Ä–æ–≤) ‚Üí 400 Validation Error

# 3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å 5 —Ç–æ–≤–∞—Ä–∞–º–∏
POST /api/batch/create (5 —Ç–æ–≤–∞—Ä–æ–≤) ‚Üí success

–û–∂–∏–¥–∞–µ–º–æ:
‚úì –ù–æ–≤—ã–π –ª–∏–º–∏—Ç –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ë–î (–Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ API)
‚úì Worker –∫—ç—à–∏—Ä—É–µ—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç (ok, —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ)
‚úì –õ–∏–º–∏—Ç—ã –º–µ–Ω—è—é—Ç—Å—è –ë–ï–ó —Ä–µ–¥–µ–ø–ª–æ—è
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 6: –î–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è single –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```bash
# Free user: 5 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –¥–µ–Ω—å
# Basic user: 20 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –¥–µ–Ω—å

# Free user —Å–æ–∑–¥–∞–µ—Ç –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
POST /api/generate-card
‚Üí success, usage logged

# Free user —Å–æ–∑–¥–∞–µ—Ç 5-—é –∫–∞—Ä—Ç–æ—á–∫—É
‚Üí success, usage logged

# Free user —Å–æ–∑–¥–∞–µ—Ç 6-—é –∫–∞—Ä—Ç–æ—á–∫—É
‚Üí 400 Limit Exceeded

# –ù–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å - —Å—á–µ—Ç—á–∏–∫ —Å–±—Ä–æ—Å–∏–ª—Å—è
‚Üí success —Å–Ω–æ–≤–∞

–û–∂–∏–¥–∞–µ–º–æ:
‚úì –õ–∏–º–∏—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –¥–Ω—é (date, –Ω–µ datetime)
‚úì Batch –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π userId –¥–ª—è –ª–∏–º–∏—Ç–æ–≤
‚úì –û–¥–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = +1 –∫ —Å—á–µ—Ç—á–∏–∫—É
```

---

## üìä –ú–ï–¢–†–ò–ö–ò –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –°–∫–æ–ª—å–∫–æ jobs –≤ –æ—á–µ—Ä–µ–¥–∏ (–Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è)
SELECT COUNT(*) FROM jobs WHERE status='queued';

# –°–∫–æ–ª—å–∫–æ jobs –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â§3)
SELECT COUNT(*) FROM jobs WHERE status='processing';

# –°–∫–æ–ª—å–∫–æ jobs –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è
SELECT COUNT(*) FROM jobs 
WHERE status='done' AND created_at > unix_timestamp('today');

# –°–∫–æ–ª—å–∫–æ jobs –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT COUNT(*) FROM jobs 
WHERE userId='USER_ID' AND status IN ('queued', 'processing');

# –ù–∞–π—Ç–∏ –∑–∞–≤–∏—Å—à–∏–µ jobs
SELECT id, status, updated_at FROM jobs 
WHERE status='processing' AND updated_at < (strftime('%s','now') - 1800);

# –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã
SELECT key, value FROM limits_config ORDER BY key;
```

---

## üîß –û–ü–ï–†–ê–¶–ò–ò

### –ó–∞–ø—É—Å–∫ worker'–∞ (production)

```bash
# Single instance
npm run worker:batch

# Concurrency = 3 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
npm run worker:batch &
npm run worker:batch &
npm run worker:batch &

# –° supervisor/systemd (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ-–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
# –°–æ–∑–¥–∞—Ç—å service —Ñ–∞–π–ª –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Restart=always
```

### –ò–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –±–µ–∑ —Ä–µ–¥–µ–ø–ª–æ—è

```bash
# –ß–µ—Ä–µ–∑ admin API
curl -X POST https://yourapp.com/api/admin/limits \
  -H "Authorization: Bearer SESSION" \
  -H "Content-Type: application/json" \
  -d '{
    "key": "batch_max_queued_per_user",
    "value": 500
  }'

# –ò–ª–∏ –ø—Ä—è–º–æ –≤ –ë–î
UPDATE limits_config SET value=500 WHERE key='batch_max_queued_per_user';
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å—à–∏–µ jobs –≤—Ä—É—á–Ω—É—é

```bash
# –ù–∞–π—Ç–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ processing jobs –≤ queued
UPDATE jobs 
SET status='queued', updated_at=? 
WHERE status='processing';

# Worker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
```

---

## ‚úÖ PRODUCTION CHECKLIST

- [x] –ú–æ–¥–µ–ª—å –æ—á–µ—Ä–µ–¥–∏ FIFO, atomicity –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ UPDATE —Å WHERE
- [x] Concurrency = 3 –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è 3 worker –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏, –ë–î —Ä–µ—à–∞–µ—Ç –≥–æ–Ω–∫–∏
- [x] Per-user –ª–∏–º–∏—Ç—ã –¥–ª—è batch (WHERE userId = ?)
- [x] –†–µ–∞–ª—å–Ω—ã–π userId –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ batch-worker
- [x] Recovery –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –∑–∞–≤–∏—Å—à–∏—Ö jobs
- [x] –õ–∏–º–∏—Ç—ã –≤ –ë–î (limits_config), –±–µ–∑ hardcoded
- [x] Admin API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞–º–∏
- [x] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ worker (5 –º–∏–Ω—É—Ç TTL)
- [x] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- [x] Fallback –Ω–∞ hardcoded –∑–Ω–∞—á–µ–Ω–∏—è (–µ—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)

---

## üìù –ó–ê–ú–ï–¢–ö–ò

1. **–ò–Ω–¥–µ–∫—Å—ã**: –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `db.ts`. –ù–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤—Ä—É—á–Ω—É—é.
2. **–ú–∏–≥—Ä–∞—Ü–∏–∏**: –∫–æ–ª–æ–Ω–∫–∞ `userId` –≤ `jobs` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `addColumnIfNotExists()`.
3. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è backward-compatible, —Å—Ç–∞—Ä—ã–µ jobs –±—É–¥—É—Ç –∏–º–µ—Ç—å `userId=NULL`.
4. **–ö—ç—à**: 5 –º–∏–Ω—É—Ç TTL –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –≤ worker –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è production. –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
5. **Recovery**: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ worker'–∞, –Ω–æ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.

---

## üöÄ –ì–û–¢–û–í–û –ö PRODUCTION

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production —Å:**
- ‚úÖ –ù—É–ª–µ–≤—ã–º–∏ –ø–∞–¥–µ–Ω–∏—è–º–∏ (recovery –º–µ—Ö–∞–Ω–∏–∑–º)
- ‚úÖ –ù—É–ª–µ–≤—ã–º–∏ –≤–µ—á–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∞–Ω–∏—è–º–∏ (timeout + recovery)
- ‚úÖ –ó–∞—â–∏—Ç–æ–π –æ—Ç –æ–±—Ö–æ–¥–∞ –ª–∏–º–∏—Ç–æ–≤ (per-user + DB)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ —Ç–æ–∫–µ–Ω–æ–≤ (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é –¥–æ 50k+ jobs

**–î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –î–æ–±–∞–≤–∏—Ç—å Redis –¥–ª—è –∫—ç—à–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è)
- –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
