<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depeche - AI Article Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", sans-serif;
            background: #ffffff;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* === SIDEBAR === */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 0 20px 24px;
            border-bottom: 1px solid #e8e8e8;
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0 0 16px 0;
            letter-spacing: -0.5px;
        }

        .btn-new-article {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .btn-new-article:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .articles-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px;
        }

        .article-item {
            padding: 12px 40px 12px 16px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #1a1a1a;
            font-size: 14px;
            line-height: 1.4;
            display: block;
            text-align: left;
            text-decoration: none;
            position: relative;
        }

        .article-item:hover {
            background: #f5f5f5;
            border-color: #d0d0d0;
            transform: translateX(2px);
        }

        .article-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: #667eea;
            font-weight: 600;
            color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .article-delete-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 4px 6px;
            font-size: 18px;
            line-height: 1;
            transition: all 0.2s ease;
            opacity: 0;
            display: inline-block;
        }

        .article-item:hover .article-delete-btn {
            opacity: 1;
        }

        .article-delete-btn:hover {
            color: #e74c3c;
            transform: translateY(-50%) scale(1.2);
        }

        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: none;
            padding: 0;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 12px;
            color: #888;
            margin: 2px 0 0 0;
        }

        /* === MAIN CONTENT === */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .editor-header {
            padding: 20px 32px;
            border-bottom: 1px solid #e8e8e8;
            background: #fafafa;
        }

        .editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            border-bottom: 1px solid #e8e8e8;
            background: #fafafa;
        }

        .article-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            margin-left: auto;
        }

        /* === CHAR COUNT DISPLAY === */
        .char-count {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-right: 16px;
            letter-spacing: 1px;
            min-width: 40px;
            text-align: right;
            flex-shrink: 0;
        }

        .dirty-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: background-color 0.2s ease;
        }

        .dirty-indicator.clean {
            background-color: #22c55e;
        }

        .dirty-indicator.dirty {
            background-color: #3b82f6;
        }

        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 32px;
        }

        .editor-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-content {
            flex: 1;
            position: relative;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
            color: #2d2d2d;
            outline: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            resize: none;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .btn-save {
            width: 32px;
            height: 32px;
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #999;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-save:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.05);
            color: #667eea;
        }

        .btn-save:active:not(:disabled) {
            background: rgba(102, 126, 234, 0.1);
        }

        .btn-save:disabled {
            cursor: not-allowed;
            color: #ddd;
            opacity: 0.5;
        }

        .btn-copy {
            width: 32px;
            height: 32px;
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #999;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-copy:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #667eea;
        }

        .btn-copy:active {
            background: rgba(102, 126, 234, 0.1);
        }

        .editor-content:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .editor-content::-webkit-scrollbar {
            width: 8px;
        }

        .editor-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .editor-content::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 4px;
        }

        .editor-content::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* === CODE BLOCKS IN EDITOR === */
        .editor-content pre {
            white-space: pre-wrap;          /* –ü–µ—Ä–µ–Ω–æ—Å–∏ –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ */
            word-break: break-word;         /* –†–∞–∑–±–∏–≤–∞–π –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ */
            overflow-wrap: break-word;      /* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–ª–æ–≤ */
            background: #f5f5f5;            /* –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ */
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 12px 16px;
            font-size: 13px;
            line-height: 1.5;
            margin: 12px 0;
            overflow-x: hidden;             /* –ó–∞–ø—Ä–µ—Ç–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
            overflow-y: visible;            /* –†–∞–∑—Ä–µ—à–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ */
        }

        .editor-content code {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #2d2d2d;
            background: transparent;       /* –ù–µ –¥–æ–±–∞–≤–ª—è–π —Ñ–æ–Ω –¥–ª—è inline –∫–æ–¥–∞ */
        }

        /* === PROMPT BAR === */
        .prompt-bar-container {
            padding: 20px 32px;
            background: white;
            border-top: 1px solid #e8e8e8;
        }

        .prompt-bar {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .prompt-input-wrapper {
            flex: 1;
            display: flex;
            align-items: flex-start;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 12px;
            padding: 8px 16px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .prompt-input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .prompt-textarea {
            flex: 1;
            border: none;
            outline: none;
            padding: 8px 0;
            font-size: 14px;
            background: transparent;
            color: #1a1a1a;
            font-family: inherit;
            resize: none;
            overflow-y: auto;
            max-height: 120px;
            line-height: 1.5;
            width: 100%;
        }

        .prompt-textarea::placeholder {
            color: #999;
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –∫–∞–∫ –≤ Anthropic/ChatGPT */
        .prompt-textarea::-webkit-scrollbar {
            width: 4px;
        }

        .prompt-textarea::-webkit-scrollbar-track {
            background: transparent;
        }

        .prompt-textarea::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 2px;
        }

        .prompt-textarea::-webkit-scrollbar-thumb:hover {
            background: #b0b0b0;
        }

        .btn-apply {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            white-space: nowrap;
            height: fit-content;
            margin-top: 2px;
        }

        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-apply:active {
            transform: translateY(0);
        }

        .btn-apply:disabled,
        .btn-apply.generating {
            cursor: not-allowed;
            position: relative;
            pointer-events: none;
        }

        .btn-apply:disabled::after,
        .btn-apply.generating::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spinner-rotate 0.8s linear infinite;
        }

        .btn-apply:disabled:hover,
        .btn-apply.generating:hover {
            cursor: not-allowed;
            transform: none;
        }

        /* === ENHANCE BUTTON === */
        .btn-enhance {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.2);
            white-space: nowrap;
            height: fit-content;
            margin-top: 2px;
            margin-left: 8px;
        }

        .btn-enhance:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 87, 108, 0.3);
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-enhance:active {
            transform: translateY(0);
        }

        .btn-enhance:disabled,
        .btn-enhance.generating {
            cursor: not-allowed;
            position: relative;
            pointer-events: none;
            opacity: 0.6;
        }

        /* –°–ø–∏–Ω–Ω–µ—Ä –¢–û–õ–¨–ö–û –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∫–ª–∞—Å—Å generating) */
        .btn-enhance.generating::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spinner-rotate 0.8s linear infinite;
        }

        .btn-enhance:disabled:hover,
        .btn-enhance.generating:hover {
            cursor: not-allowed;
            transform: none;
        }

        /* === HUMANIZE BUTTON === */
        .btn-humanize {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: none;
            color: #1a1a1a;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(168, 237, 234, 0.2);
            white-space: nowrap;
            height: fit-content;
            margin-top: 2px;
            margin-left: 8px;
        }

        .btn-humanize:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(168, 237, 234, 0.3);
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #1a1a1a;
        }

        .btn-humanize:active {
            transform: translateY(0);
        }

        .btn-humanize:disabled,
        .btn-humanize.generating {
            cursor: not-allowed;
            position: relative;
            pointer-events: none;
            opacity: 0.6;
        }

        .btn-humanize.generating::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(26, 26, 26, 0.3);
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spinner-rotate 0.8s linear infinite;
        }

        .btn-humanize:disabled:hover,
        .btn-humanize.generating:hover {
            cursor: not-allowed;
            transform: none;
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        /* === DROPDOWN === */
        .dropdown-menu {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            padding: 8px 0;
            min-width: 180px;
            background: white;
            backdrop-filter: blur(10px);
        }

        .dropdown-item {
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            color: #667eea;
            padding-left: 22px;
        }

        .dropdown-divider {
            margin: 8px 0;
            border: none;
            border-top: 1px solid #f0f0f0;
        }

        /* === TOAST NOTIFICATION === */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            font-size: 13px;
            animation: slideIn 0.3s ease;
            z-index: 1050;
            max-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* === MODAL === */
        .modal-content {
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            border-bottom: 1px solid #e8e8e8;
            padding: 20px 24px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            border-top: 1px solid #e8e8e8;
            padding: 16px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .form-control {
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-secondary {
            background: #e8e8e8;
            border: none;
            color: #1a1a1a;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
        }

        /* === SCROLLBAR === */
        .articles-list::-webkit-scrollbar {
            width: 6px;
        }

        .articles-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .articles-list::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        .articles-list::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                padding: 16px 0;
                max-height: 120px;
            }

            .articles-list {
                max-height: 40px;
            }

            .sidebar-footer {
                display: none;
            }

            .editor-header,
            .editor-area,
            .prompt-bar-container {
                padding: 16px;
            }

            .article-title {
                font-size: 18px;
            }

            .editor-content {
                font-size: 14px;
            }

            .notification-toast {
                right: 10px;
                left: 10px;
                top: 10px;
                max-width: none;
            }
        }

        /* === SELECTION OVERLAY HIGHLIGHT === */
        .selection-overlay {
            position: absolute;
            background-color: rgba(100, 200, 255, 0.25);
            border-radius: 2px;
            pointer-events: none;
            z-index: 1;
        }

        /* === MARKDOWN PREVIEW === */
        .markdown-preview {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
            color: #2d2d2d;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            white-space: normal;
            word-wrap: break-word;
        }

        .markdown-preview h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 24px 0 16px 0;
            color: #1a1a1a;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 12px;
        }

        .markdown-preview h2 {
            font-size: 24px;
            font-weight: 700;
            margin: 20px 0 12px 0;
            color: #1a1a1a;
        }

        .markdown-preview h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 16px 0 10px 0;
            color: #2d2d2d;
        }

        .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
            font-size: 16px;
            font-weight: 600;
            margin: 12px 0 8px 0;
            color: #2d2d2d;
        }

        .markdown-preview p {
            margin: 12px 0;
        }

        .markdown-preview ul, .markdown-preview ol {
            margin: 12px 0;
            padding-left: 32px;
        }

        .markdown-preview li {
            margin: 6px 0;
        }

        .markdown-preview code {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #d63384;
        }

        .markdown-preview pre {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            overflow-x: hidden;             /* –ó–∞–ø—Ä–µ—Ç–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
            overflow-y: visible;            /* –†–∞–∑—Ä–µ—à–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ */
            margin: 12px 0;
            line-height: 1.5;
            white-space: pre-wrap;          /* –ü–µ—Ä–µ–Ω–æ—Å–∏ –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ */
            word-break: break-word;         /* –†–∞–∑–±–∏–≤–∞–π –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ */
            overflow-wrap: break-word;      /* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–ª–æ–≤ */
        }

        .markdown-preview pre code {
            background: transparent;
            border: none;
            padding: 0;
            color: #2d2d2d;
            font-size: 13px;
        }

        .markdown-preview blockquote {
            border-left: 4px solid #667eea;
            padding-left: 16px;
            margin-left: 0;
            margin-right: 0;
            color: #666;
            font-style: italic;
        }

        .markdown-preview strong {
            font-weight: 700;
            color: #1a1a1a;
        }

        .markdown-preview em {
            font-style: italic;
        }

        .markdown-preview a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid #667eea;
        }

        .markdown-preview a:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .markdown-preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .markdown-preview th, .markdown-preview td {
            border: 1px solid #e0e0e0;
            padding: 10px 12px;
            text-align: left;
        }

        .markdown-preview th {
            background: #f9f9f9;
            font-weight: 600;
            color: #1a1a1a;
        }

        .markdown-preview hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 20px 0;
        }

        .btn-preview-toggle {
            width: 32px;
            height: 32px;
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #999;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-preview-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #667eea;
        }

        .btn-preview-toggle:active {
            background: rgba(102, 126, 234, 0.1);
        }

        .btn-preview-toggle.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.15);
        }

        /* === UNSAVED CHANGES MODAL === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.2s ease;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0 0 12px 0;
        }

        .modal-text {
            font-size: 14px;
            color: #666;
            margin: 0 0 24px 0;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .modal-btn-cancel {
            background: #f3f4f6;
            color: #666;
        }

        .modal-btn-cancel:hover {
            background: #e5e7eb;
        }

        .modal-btn-discard {
            background: #f3f4f6;
            color: #666;
        }

        .modal-btn-discard:hover {
            background: #e5e7eb;
        }

        .modal-btn-save {
            background: #3b82f6;
            color: white;
        }

        .modal-btn-save:hover {
            background: #2563eb;
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- === SIDEBAR === -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">Depeche</h1>
                <button class="btn-new-article" onclick="openNewArticleModal()">+ New Article</button>
            </div>

            <div class="articles-list" id="articlesList">
            </div>

            <div class="sidebar-footer">
                <div class="dropdown">
                    <button class="user-avatar dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">A</button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#">Pricing</a></li>
                        <li><a class="dropdown-item" href="#">Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Logout</a></li>
                    </ul>
                </div>
                <div class="user-info">
                    <p class="user-name">Alex Chen</p>
                    <p class="user-status">Pro</p>
                </div>
            </div>
        </div>

        <!-- === MAIN AREA === -->
        <div class="main-content">
            <div class="editor-header">
                <h2 class="article-title" id="currentTitle">
                    <span id="titleText"></span>
                </h2>
                <div class="header-actions">
                    <div class="char-count" id="charCountDisplay">0</div>
                    <div class="dirty-indicator clean" id="dirtyIndicator" title="Changes saved"></div>
                    <button class="btn-preview-toggle" id="previewToggleButton" title="Toggle preview" type="button" aria-label="Toggle preview">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                    <button class="btn-save" id="saveButton" title="Save article" type="button" aria-label="Save" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                    </button>
                    <button class="btn-copy" id="copyButton" title="Copy to clipboard" type="button" aria-label="Copy">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="editor-area">
                <div class="editor-wrapper">
                    <div class="editor-content" id="editorContent" contenteditable="true"></div>
                    <div class="markdown-preview" id="markdownPreview" style="display:none;"></div>
                </div>
            </div>

            <div class="prompt-bar-container">
                <div class="prompt-bar">
                    <div class="prompt-input-wrapper">
                        <textarea
                            class="prompt-textarea"
                            id="promptInput"
                            placeholder="Describe what you would like to do... (e.g., &quot;Make it shorter&quot;, &quot;Add examples&quot;, &quot;Change tone&quot;)"
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="btn-apply" onclick="applyPrompt()">Apply</button>
                    <button class="btn-enhance" id="enhanceButton" onclick="enhanceText()" title="Enhance selected text or article" aria-label="Enhance">‚ú® Enhance</button>
                    <button class="btn-humanize" id="humanizeButton" onclick="handleHumanizeClick()" title="Make text more natural" aria-label="Humanize">üß† Humanize</button>
                </div>
            </div>
        </div>
    </div>

    <!-- === NEW ARTICLE MODAL === -->
    <div class="modal fade" id="newArticleModal" tabindex="-1" aria-labelledby="newArticleLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newArticleLabel">Create New Article</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="newArticleTitle" placeholder="Article title">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn-primary" onclick="createNewArticle()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // === API CONFIGURATION ===
        const API_BASE_URL = "http://localhost:8000/api";

        // === STATE ===
        let currentArticleId = null;
        let articles = {}; // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { id, title, content (–∏–∑ –ë–î), localContent (—Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç), isDirty }

        // === PERSISTENT SELECTION STATE ===
        let savedSelection = null; // { startOffset, endOffset, text }
        let highlightJustApplied = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞

        // === GENERATION STATE ===
        let isGenerating = false; // –§–ª–∞–≥ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ Apply

        // === PREVIEW STATE ===
        let isPreviewMode = false; // –§–ª–∞–≥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É edit –∏ preview —Ä–µ–∂–∏–º–æ–º

        // === SAVE STATE ===
        let isDirty = false; // –§–ª–∞–≥ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç—å–∏
        let isSaving = false; // –§–ª–∞–≥ –≤–æ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        let pendingArticleId = null; // ID —Å—Ç–∞—Ç—å–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞


        // === INITIALIZATION ===
        document.addEventListener("DOMContentLoaded", function() {
            loadArticlesList();
            setupSelectionHandlers();
            setupCopyButton();
            setupPreviewToggle();
            setupDirtyTracking();
            setupSaveButton();
            updateIndicator();
        });

        // === SELECTION MANAGEMENT ===

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø—Ä–∏ mouseup –≤ editor
         */
        function setupSelectionHandlers() {
            const editorContent = document.getElementById("editorContent");

            // –ü—Ä–∏ mouseup —Å –Ω–æ–≤—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º - –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            editorContent.addEventListener("mouseup", function() {
                const selection = window.getSelection();
                if (selection.toString().trim()) {
                    // –ï—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
                    const range = selection.getRangeAt(0);
                    const preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(editorContent);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);

                    const startOffset = preCaretRange.toString().length - range.toString().length;
                    const endOffset = preCaretRange.toString().length;

                    savedSelection = {
                        startOffset: startOffset,
                        endOffset: endOffset,
                        text: range.toString()
                    };

                    console.log(`[SELECTION_SAVE] –í—ã–¥–µ–ª–µ–Ω–æ: "${savedSelection.text.substring(0, 50)}..."`);
                    console.log(`[SELECTION_SAVE] startOffset=${startOffset}, endOffset=${endOffset}`);

                    applySelectionHighlight();
                }
                // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è!
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–Ω–∞ –¥–æ —è–≤–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –≤ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ
            });

            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ –≤ editor - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            editorContent.addEventListener("click", function(e) {
                if (e.target === editorContent) {
                    // –ö–ª–∏–∫ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ –≤ editor
                    setTimeout(() => {
                        // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ –ø–æ–¥—Å–≤–µ—Ç–∫—É
                        if (highlightJustApplied) {
                            console.log("[SELECTION_CLICK] –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º click —Ç.–∫. —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ –ø–æ–¥—Å–≤–µ—Ç–∫—É");
                            return;
                        }

                        const selection = window.getSelection();
                        if (!selection.toString().trim() && savedSelection) {
                            console.log("[SELECTION_CLEAR] –í—ã–¥–µ–ª–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ");
                            clearSelectionHighlight();
                            savedSelection = null;
                        }
                    }, 10);
                }
            });
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Copy-–∫–Ω–æ–ø–∫—É
         */
        function setupCopyButton() {
            const copyBtn = document.getElementById("copyButton");
            if (!copyBtn) {
                console.error("[COPY] Copy –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                return;
            }

            copyBtn.addEventListener("click", async function(e) {
                e.preventDefault();
                e.stopPropagation();

                const editorContent = document.getElementById("editorContent");
                const textToCopy = editorContent.textContent;

                if (!textToCopy.trim()) {
                    console.log("[COPY] –ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å - —Ç–µ–∫—Å—Ç –ø—É—Å—Ç");
                    return;
                }

                try {
                    await navigator.clipboard.writeText(textToCopy);
                    console.log("[COPY] –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
                    const originalColor = copyBtn.style.color;
                    copyBtn.style.color = "#52c41a"; // –ó–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç

                    setTimeout(() => {
                        copyBtn.style.color = originalColor;
                    }, 1500);

                    showNotification("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
                } catch (err) {
                    console.error("[COPY] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:", err);
                    showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞");
                }
            });

            console.log("[COPY] Copy –∫–Ω–æ–ø–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É toggle Preview
         */
        function setupPreviewToggle() {
            const previewToggleBtn = document.getElementById("previewToggleButton");
            if (!previewToggleBtn) {
                console.error("[PREVIEW] Preview toggle –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                return;
            }

            previewToggleBtn.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                togglePreview();
            });

            console.log("[PREVIEW] Preview toggle –∫–Ω–æ–ø–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –º–µ–∂–¥—É edit –∏ preview —Ä–µ–∂–∏–º–æ–º
         */
        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            console.log(`[PREVIEW] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ä–µ–∂–∏–º: ${isPreviewMode ? 'PREVIEW' : 'EDIT'}`);

            const editorContent = document.getElementById("editorContent");
            const markdownPreview = document.getElementById("markdownPreview");
            const previewToggleBtn = document.getElementById("previewToggleButton");

            if (isPreviewMode) {
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ Preview —Ä–µ–∂–∏–º
                console.log("[PREVIEW] –í–∫–ª—é—á–∞—é preview mode");

                // –°–∫—Ä—ã—Ç—å editorContent, –ø–æ–∫–∞–∑–∞—Ç—å preview
                editorContent.style.display = "none";
                editorContent.setAttribute("contenteditable", "false");
                markdownPreview.style.display = "block";
                previewToggleBtn.classList.add("active");

                // –û—Ç–∫–ª—é—á–∏—Ç—å selection handlers (–æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –≤ preview)
                clearSelectionHighlight();
                savedSelection = null;

                // –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å markdown
                renderPreview();
            } else {
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ Edit —Ä–µ–∂–∏–º
                console.log("[PREVIEW] –í–∫–ª—é—á–∞—é edit mode");

                // –ü–æ–∫–∞–∑–∞—Ç—å editorContent, —Å–∫—Ä—ã—Ç—å preview
                editorContent.style.display = "block";
                editorContent.setAttribute("contenteditable", "true");
                markdownPreview.style.display = "none";
                previewToggleBtn.classList.remove("active");

                // –í–µ—Ä–Ω—É—Ç—å —Ñ–æ–∫—É—Å –≤ editor
                editorContent.focus();
            }
        }

        /**
         * –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å markdown –≤ preview –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
         */
        function renderPreview() {
            const editorContent = document.getElementById("editorContent");
            const markdownPreview = document.getElementById("markdownPreview");
            const rawText = editorContent.textContent;

            if (!rawText.trim()) {
                markdownPreview.innerHTML = "<p style=\"color: #999;\">–¢–µ–∫—Å—Ç –ø—É—Å—Ç</p>";
                return;
            }

            try {
                // marked –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ CDN
                const htmlContent = marked.parse(rawText);
                markdownPreview.innerHTML = htmlContent;
                console.log("[PREVIEW] Markdown —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω");
            } catch (err) {
                console.error("[PREVIEW] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ markdown:", err);
                markdownPreview.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞: ${err.message}</p>`;
            }
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–µ–∫—Å—Ç–∞ (onInput)
         */
        function setupDirtyTracking() {
            const editorContent = document.getElementById("editorContent");
            if (!editorContent) {
                console.error("[DIRTY] Editor –Ω–µ –Ω–∞–π–¥–µ–Ω");
                return;
            }

            editorContent.addEventListener("input", function() {
                updateDirtyState();
            });

            console.log("[DIRTY] –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
        }

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ö–µ–¥–µ—Ä–µ
         */
        function updateCharCount() {
            const editorContent = document.getElementById("editorContent");
            const charCountDisplay = document.getElementById("charCountDisplay");
            if (!charCountDisplay) return;

            const charCount = editorContent.textContent.length;
            charCountDisplay.textContent = charCount.toLocaleString('ru-RU');
        }

        function updateDirtyState() {
            if (!currentArticleId) return;

            const editorContent = document.getElementById("editorContent");
            const article = articles[currentArticleId];

            if (!article) return;

            const currentText = editorContent.textContent;
            const wasClean = !isDirty;

            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
            isDirty = (currentText !== article.content);
            article.isDirty = isDirty;

            // –û–±–Ω–æ–≤–∏—Ç—å UI —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (wasClean !== !isDirty) {
                updateSaveButtonState();
                updateIndicator();
            }

            // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
            updateCharCount();

            console.log(`[DIRTY] isDirty=${isDirty} –¥–ª—è —Å—Ç–∞—Ç—å–∏ ${currentArticleId}`);
        }

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä isDirty
         */
        function updateIndicator() {
            const indicator = document.getElementById("dirtyIndicator");
            if (!indicator) return;

            if (isDirty) {
                indicator.classList.remove("clean");
                indicator.classList.add("dirty");
                indicator.title = "Unsaved changes";
            } else {
                indicator.classList.remove("dirty");
                indicator.classList.add("clean");
                indicator.title = "Changes saved";
            }

            console.log(`[INDICATOR] isDirty=${isDirty}`);
        }

        /**
         * –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Save
         */
        function updateSaveButtonState() {
            const saveBtn = document.getElementById("saveButton");
            if (!saveBtn) return;

            if (isDirty && !isSaving) {
                saveBtn.disabled = false;
                console.log("[SAVE] –ö–Ω–æ–ø–∫–∞ Save –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
            } else {
                saveBtn.disabled = true;
                console.log("[SAVE] –ö–Ω–æ–ø–∫–∞ Save –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
            }
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É Save
         */
        function setupSaveButton() {
            const saveBtn = document.getElementById("saveButton");
            if (!saveBtn) {
                console.error("[SAVE] Save –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                return;
            }

            saveBtn.addEventListener("click", async function(e) {
                e.preventDefault();
                e.stopPropagation();
                await saveArticle();
            });

            console.log("[SAVE] Save –∫–Ω–æ–ø–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç—å—é
         * @returns {Promise<boolean>} true –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, false –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
         */
        async function saveArticle() {
            if (!currentArticleId || isSaving) {
                console.log("[SAVE] –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞: –Ω–µ—Ç —Å—Ç–∞—Ç—å–∏ –∏–ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è");
                return false;
            }

            const article = articles[currentArticleId];
            if (!article || !isDirty) {
                console.log("[SAVE] –ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å - —Å—Ç–∞—Ç—å—è —á–∏—Å—Ç–∞—è –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                return false;
            }

            isSaving = true;
            const saveBtn = document.getElementById("saveButton");
            if (saveBtn) saveBtn.disabled = true;

            console.log(`[SAVE] –ù–∞—á–∏–Ω–∞—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ ${currentArticleId}`);

            try {
                const editorContent = document.getElementById("editorContent");
                const textToSave = editorContent.textContent;

                const response = await fetch(`${API_BASE_URL}/articles/${currentArticleId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content: textToSave })
                });

                console.log(`[SAVE] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
                }

                const savedArticle = await response.json();
                console.log("[SAVE] –°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
                article.content = textToSave;
                isDirty = false;
                article.isDirty = false;

                updateSaveButtonState();
                updateIndicator();
                showNotification("–°—Ç–∞—Ç—å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
                return true;
            } catch (err) {
                console.error("[SAVE] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:", err);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.message);
                return false;
            } finally {
                isSaving = false;
                updateSaveButtonState();
            }
        }

        /**
         * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ overlay–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
         * –¢–ï–ö–°–¢ –ù–ï –ú–ï–ù–Ø–ï–¢–°–Ø - —Ç–æ–ª—å–∫–æ —É–¥–∞–ª—è—é—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
         */
        function clearSelectionHighlight() {
            const editor = document.getElementById("editorContent");
            const overlays = editor.querySelectorAll(".selection-overlay");
            overlays.forEach(overlay => overlay.remove());
            console.log("[HIGHLIGHT] –í—Å–µ overlay–∏ —É–¥–∞–ª–µ–Ω—ã");
        }

        /**
         * –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É –≤—ã–¥–µ–ª–µ–Ω–∏—é
         * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: Range.getClientRects() ‚Üí overlay div—ã
         * –¢–ï–ö–°–¢ –í–û–û–ë–©–ï –ù–ï –ú–ï–ù–Ø–ï–¢–°–Ø
         */
        function applySelectionHighlight() {
            clearSelectionHighlight(); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ overlay–∏

            if (!savedSelection) return;

            const editor = document.getElementById("editorContent");
            const selection = window.getSelection();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ selection —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ editor–µ
            if (!selection || selection.rangeCount === 0) {
                console.log("[HIGHLIGHT] –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ selection");
                return;
            }

            const range = selection.getRangeAt(0);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Range –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ editor–∞
            if (!editor.contains(range.commonAncestorContainer)) {
                console.log("[HIGHLIGHT] Range –≤–Ω–µ editor");
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –≤—ã–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const rects = range.getClientRects();
            if (rects.length === 0) {
                console.log("[HIGHLIGHT] Range –Ω–µ –∏–º–µ–µ—Ç –≤–∏–¥–∏–º—ã—Ö rect–æ–≤");
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é editor–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ relative –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            const editorRect = editor.getBoundingClientRect();

            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ rect —Å–æ–∑–¥–∞–µ–º overlay div
            for (let rect of rects) {
                const overlay = document.createElement("div");
                overlay.className = "selection-overlay";

                // –ü–æ–∑–∏—Ü–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ editor–∞
                const top = rect.top - editorRect.top + editor.scrollTop;
                const left = rect.left - editorRect.left + editor.scrollLeft;
                const width = rect.width;
                const height = rect.height;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏
                overlay.style.top = top + "px";
                overlay.style.left = left + "px";
                overlay.style.width = width + "px";
                overlay.style.height = height + "px";

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ editor
                editor.appendChild(overlay);
            }

            console.log("[HIGHLIGHT] –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (" + rects.length + " rect–æ–≤)");

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
            highlightJustApplied = true;
            setTimeout(() => {
                highlightJustApplied = false;
            }, 100);
        }

        // === HELPER FUNCTIONS FOR MODE DETECTION ===

        /**
         * –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å YouTube URL –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–º–ø—Ç–∞
         *
         * –†–ï–ñ–ò–ú 4: –ï—Å–ª–∏ prompt = —Ç–æ–ª—å–∫–æ YouTube URL ‚Üí YouTube Import
         */
        function parseYoutubeUrl(text) {
            const trimmed = text.trim();

            // –ü–∞—Ç—Ç–µ—Ä–Ω—ã YouTube URL
            const youtubePatterns = [
                /^https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/,
                /^https?:\/\/(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]+)/,
                /^https?:\/\/youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/,
                /^https?:\/\/youtu\.be\/([a-zA-Z0-9_-]+)/
            ];

            for (const pattern of youtubePatterns) {
                const match = trimmed.match(pattern);
                if (match) {
                    return {
                        isYoutube: true,
                        url: trimmed,
                        videoId: match[1]
                    };
                }
            }

            return {
                isYoutube: false,
                url: null,
                videoId: null
            };
        }

        /**
         * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
         *
         * –†–ï–ñ–ò–ú 1: –¢–µ–∫—Å—Ç –ø—É—Å—Ç ‚Üí –ü–õ–ê–ù (–ª—é–±–æ–π –≤–≤–æ–¥ = —Ç–µ–º–∞)
         * –†–ï–ñ–ò–ú 2: –¢–µ–∫—Å—Ç –µ—Å—Ç—å + –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è ‚Üí –ü–†–ê–í–ö–ê –í–°–ï–ì–û
         * –†–ï–ñ–ò–ú 3: –¢–µ–∫—Å—Ç –µ—Å—Ç—å + –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ ‚Üí –ü–†–ê–í–ö–ê –§–†–ê–ì–ú–ï–ù–¢–ê
         */
        function detectMode() {
            const editorContent = document.getElementById("editorContent").textContent.trim();

            // –†–ï–ñ–ò–ú 1: —Ç–µ–∫—Å—Ç –ø—É—Å—Ç
            if (!editorContent) {
                return {
                    mode: 1,
                    description: "–ü–õ–ê–ù: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ —Å—Ç–∞—Ç—å–∏"
                };
            }

            // –†–ï–ñ–ò–ú 3: —Ç–µ–∫—Å—Ç –µ—Å—Ç—å –ò –µ—Å—Ç—å –°–û–•–†–ê–ù–ï–ù–ù–û–ï –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (savedSelection && savedSelection.text && savedSelection.text.length > 0) {
                console.log(`[DETECT] –†–µ–∂–∏–º 3: –Ω–∞–π–¥–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ`);
                return {
                    mode: 3,
                    description: "–§–†–ê–ì–ú–ï–ù–¢: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞",
                    selectedText: savedSelection.text
                };
            }

            // –†–ï–ñ–ò–ú 2: —Ç–µ–∫—Å—Ç –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è
            console.log(`[DETECT] –†–µ–∂–∏–º 2: –≤–µ—Å—å —Ç–µ–∫—Å—Ç`);
            return {
                mode: 2,
                description: "–í–ï–°–¨ –¢–ï–ö–°–¢: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å—Ç–∞—Ç—å–∏"
            };
        }

        /**
         * –ü–æ–ª—É—á–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤–º–µ—Å—Ç–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–∑ –°–û–•–†–ê–ù–ï–ù–ù–û–ì–û –≤—ã–¥–µ–ª–µ–Ω–∏—è
         */
        function getSelectionWithContext() {
            if (!savedSelection || !savedSelection.text) {
                console.log("[SELECTION] –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è");
                return null;
            }

            const fullText = document.getElementById("editorContent").textContent;
            const { startOffset, endOffset } = savedSelection;

            console.log(`[SELECTION] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ. startOffset=${startOffset}, endOffset=${endOffset}`);
            console.log(`[SELECTION] –†–∞–∑–º–µ—Ä —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞: ${endOffset - startOffset} —Å–∏–º–≤–æ–ª–æ–≤`);

            // –ë–µ—Ä—ë–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–±–∑–∞—Ü (–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–≤–æ–π–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –î–û –≤—ã–¥–µ–ª–µ–Ω–∏—è)
            let beforeStart = startOffset;
            let doubleNewlineCount = 0;
            for (let i = startOffset - 1; i >= 0; i--) {
                if (fullText[i] === "\n") {
                    doubleNewlineCount++;
                    if (doubleNewlineCount >= 2) {
                        beforeStart = i + 1;
                        break;
                    }
                } else if (fullText[i] !== " " && fullText[i] !== "\r") {
                    doubleNewlineCount = 0;
                }
            }
            if (beforeStart === startOffset) beforeStart = 0; // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞—á–∞–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

            const beforeContext = fullText.substring(beforeStart, startOffset).trim();
            console.log(`[SELECTION] –î–æ: ${beforeContext.substring(0, 50)}...`);

            // –ë–µ—Ä—ë–º —Å–ª–µ–¥—É—é—â–∏–π –∞–±–∑–∞—Ü (–æ—Ç –∫–æ–Ω—Ü–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –î–û —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–≤–æ–π–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞)
            let afterEnd = endOffset;
            doubleNewlineCount = 0;
            for (let i = endOffset; i < fullText.length; i++) {
                if (fullText[i] === "\n") {
                    doubleNewlineCount++;
                    if (doubleNewlineCount >= 2) {
                        afterEnd = i;
                        break;
                    }
                } else if (fullText[i] !== " " && fullText[i] !== "\r") {
                    doubleNewlineCount = 0;
                }
            }
            if (afterEnd === endOffset) afterEnd = fullText.length; // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞

            const afterContext = fullText.substring(endOffset, afterEnd).trim();
            console.log(`[SELECTION] –ü–æ—Å–ª–µ: ${afterContext.substring(0, 50)}...`);

            return {
                before: beforeContext,
                fragment: savedSelection.text,
                after: afterContext
            };
        }

        // === API FUNCTIONS ===

        async function loadArticlesList() { // —É–∂–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è, –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é
            try {
                console.log("[LOAD] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π");
                const response = await fetch(`${API_BASE_URL}/articles`);
                const articlesList = await response.json();
                console.log(`[LOAD] –ü–æ–ª—É—á–µ–Ω–æ ${articlesList.length} —Å—Ç–∞—Ç–µ–π –æ—Ç API`);

                // –û—á–∏—â–∞–µ–º sidebar –∏ DOM –∫—ç—à
                const articlesList_elem = document.getElementById("articlesList");
                articlesList_elem.innerHTML = "";
                articles = {};
                currentArticleId = null;
                console.log("[LOAD] –û—á–∏—â–µ–Ω –∫—ç—à –∏ sidebar");

                if (articlesList.length === 0) {
                    console.log("[LOAD] –°–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π –ø—É—Å—Ç");
                    const titleElem = document.getElementById("titleText");
                    if (titleElem) titleElem.textContent = "";
                    document.getElementById("editorContent").textContent = "";
                    return;
                }

                // –ó–∞–ø–æ–ª–Ω—è–µ–º sidebar
                articlesList.forEach((article, index) => {
                    console.log(`[LOAD] –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—å—é: ID=${article.id}, title="${article.title}"`);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—å—é —Å –ø–æ–ª–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    article.isDirty = false; // –ù–∞ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—å—è —á–∏—Å—Ç–∞—è
                    articles[article.id] = article;
                    // –ü–µ—Ä–≤—É—é —Å—Ç–∞—Ç—å—é –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
                    const isFirst = index === 0;
                    addArticleToSidebar(article.id, article.title, isFirst);
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç–∞—Ç—å—é
                if (articlesList.length > 0) {
                    const firstId = articlesList[0].id;
                    console.log(`[LOAD] –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç–∞—Ç—å—é. ID=${firstId}`);
                    currentArticleId = firstId;
                    const firstArticle = articles[firstId];
                    console.log(`[LOAD] currentArticleId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${currentArticleId}`);
                    const titleText = document.getElementById("titleText");
                    if (titleText) titleText.textContent = firstArticle.title;

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º content –∏–∑ –ë–î
                    const fullArticle = await loadArticleContent(firstId);
                    if (fullArticle) {
                        articles[firstId].content = fullArticle.content;
                        document.getElementById("editorContent").textContent = fullArticle.content || "";
                        updateCharCount();
                        console.log(`[LOAD] Content –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ë–î (${(fullArticle.content || "").length} —Å–∏–º–≤–æ–ª–æ–≤)`);
                    }

                    document.getElementById("promptInput").value = "";
                    checkEnhanceButtonState();
                    console.log("[LOAD] UI –æ–±–Ω–æ–≤–ª–µ–Ω");
                }
            } catch (error) {
                console.error("[LOAD] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç–µ–π");
            }
        }

        async function loadArticleContent(articleId) {
            try {
                const response = await fetch(`${API_BASE_URL}/articles/${articleId}`);
                if (!response.ok) throw new Error("–°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

                const article = await response.json();
                return article;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—å–∏:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—å–∏");
                return null;
            }
        }

        async function createEmptyArticleViaAPI(title) {
            // –°–æ–∑–¥–∞—ë—Ç –ø—É—Å—Ç—É—é —Å—Ç–∞—Ç—å—é –ë–ï–ó –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞
            try {
                console.log(`[CREATE_API] –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —Å—Ç–∞—Ç—å—é. title="${title}"`);

                const url = `${API_BASE_URL}/articles`;
                const body = { topic: title };
                console.log(`[CREATE_API] URL: ${url}`);
                console.log(`[CREATE_API] –¢–µ–ª–æ: ${JSON.stringify(body)}`);

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });

                console.log(`[CREATE_API] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const error = await response.json();
                    console.error(`[CREATE_API] –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${error.detail}`);
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏");
                }

                const article = await response.json();
                console.log(`[CREATE_API] –°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! ID=${article.id}, title="${article.title}"`);

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–ª–∞–≥ isDirty –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç–∞—Ç—å–∏
                article.isDirty = false;
                return article;
            } catch (error) {
                console.error("[CREATE_API] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞: " + error.message);
                return null;
            }
        }

        async function generatePlanForArticleViaAPI(articleId, topic, format = "plain") {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ—ë
            try {
                console.log(`[PLAN_GEN] –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞. articleId=${articleId}, topic="${topic}", format="${format}"`);
                showNotification("–ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏...");

                const url = `${API_BASE_URL}/articles/${articleId}/plan`;
                const requestBody = {
                    topic: topic,
                    format: format
                };

                console.log(`[PLAN_GEN] URL –∑–∞–ø—Ä–æ—Å–∞: ${url}`);
                console.log(`[PLAN_GEN] –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞: ${JSON.stringify(requestBody)}`);

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log(`[PLAN_GEN] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const error = await response.json();
                    console.error(`[PLAN_GEN] –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${error.detail}`);
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞");
                }

                const article = await response.json();
                console.log(`[PLAN_GEN] –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –ø–ª–∞–Ω: ${article.id} - ${article.title}`);
                const contentPreview = (article.content || "").substring(0, 100);
                console.log(`[PLAN_GEN] –ö–æ–Ω—Ç–µ–Ω—Ç: ${contentPreview}...`);
                return article;
            } catch (error) {
                console.error("[PLAN_GEN] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: " + error.message);
                return null;
            }
        }

        async function deleteArticleViaAPI(articleId) {
            try {
                const response = await fetch(`${API_BASE_URL}/articles/${articleId}`, {
                    method: "DELETE"
                });

                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");

                delete articles[articleId];
                return true;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏");
                return false;
            }
        }

        /**
         * –†–ï–ñ–ò–ú 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–°–ï–ì–û —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—å–∏
         */
        async function editFullTextViaAPI(articleId, currentText, instruction, format = "plain") {
            try {
                console.log(`[EDIT_FULL_API] –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞. articleId=${articleId}, format="${format}"`);
                console.log(`[EDIT_FULL_API] –¢–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è: ${currentText.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                console.log(`[EDIT_FULL_API] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: "${instruction}"`);

                const url = `${API_BASE_URL}/articles/${articleId}/edit-full`;
                const body = {
                    current_text: currentText,
                    instruction: instruction,
                    format: format
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                console.log(`[EDIT_FULL_API] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏");
                }

                const article = await response.json();
                console.log(`[EDIT_FULL_API] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω`);
                return article;
            } catch (error) {
                console.error("[EDIT_FULL_API] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: " + error.message);
                return null;
            }
        }

        /**
         * –†–ï–ñ–ò–ú 3: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–´–î–ï–õ–ï–ù–ù–û–ì–û –§–†–ê–ì–ú–ï–ù–¢–ê
         */
        async function editFragmentViaAPI(articleId, beforeContext, fragment, afterContext, instruction, format = "plain") {
            try {
                console.log(`[EDIT_FRAGMENT_API] –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞. articleId=${articleId}, format="${format}"`);
                console.log(`[EDIT_FRAGMENT_API] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: "${instruction}"`);
                console.log(`[EDIT_FRAGMENT_API] –†–∞–∑–º–µ—Ä —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞: ${fragment.length} —Å–∏–º–≤–æ–ª–æ–≤`);

                const url = `${API_BASE_URL}/articles/${articleId}/edit-fragment`;
                const body = {
                    before_context: beforeContext,
                    fragment: fragment,
                    after_context: afterContext,
                    instruction: instruction,
                    format: format
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                console.log(`[EDIT_FRAGMENT_API] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞");
                }

                const article = await response.json();
                console.log(`[EDIT_FRAGMENT_API] –§—Ä–∞–≥–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω`);
                return article;
            } catch (error) {
                console.error("[EDIT_FRAGMENT_API] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: " + error.message);
                return null;
            }
        }

        /**
         * –†–ï–ñ–ò–ú 4: –ò–º–ø–æ—Ä—Ç —Å—Ç–∞—Ç—å–∏ –∏–∑ YouTube –≤–∏–¥–µ–æ
         */
        async function handleYoutubeImport(youtubeUrl) {
            try {
                console.log(`[YOUTUBE_IMPORT] –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –∏–∑ YouTube: ${youtubeUrl}`);

                // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞—Ç—å–∏ - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
                if (!currentArticleId) {
                    console.log("[YOUTUBE_IMPORT] –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é –¥–ª—è YouTube –∏–º–ø–æ—Ä—Ç–∞");
                    const newArticle = await createEmptyArticleViaAPI(youtubeUrl);
                    if (!newArticle) return;
                    addArticleToSidebar(newArticle.id, newArticle.title, true);
                    currentArticleId = newArticle.id;
                }

                showNotification("–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —Å YouTube –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ç–µ–∫—Å—Ç...");
                console.log(`[YOUTUBE_IMPORT] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ backend. articleId=${currentArticleId}`);

                const url = `${API_BASE_URL}/articles/${currentArticleId}/import-youtube`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ youtube_url: youtubeUrl })
                });

                console.log(`[YOUTUBE_IMPORT] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏–∑ YouTube");
                }

                const article = await response.json();
                console.log(`[YOUTUBE_IMPORT] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (${article.content.length} —Å–∏–º–≤–æ–ª–æ–≤)`);

                // –ü—Ä–∏–º–µ–Ω—è–µ–º typewriter effect
                await typewriterEffect(document.getElementById("editorContent"), article.content, 15);
                updateDirtyState();

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ prompt
                document.getElementById("promptInput").value = "";
                checkEnhanceButtonState();

                showNotification("–°—Ç–∞—Ç—å—è –∏–∑ YouTube —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞! –ú–æ–∂–µ—Ç–µ –µ—ë —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.");
                return article;

            } catch (error) {
                console.error("[YOUTUBE_IMPORT] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: " + error.message);
                return null;
            } finally {
                unlockApplyButton();
            }
        }

        // === TYPEWRITER EFFECT ===
        /**
         * –†–ï–ñ–ò–ú 1: –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π typewriter effect (—Ç–µ–∫—Å—Ç –±—ã–ª –ø—É—Å—Ç)
         */
        async function typewriterEffect(element, text, speed = 20) {
            console.log("[TYPEWRITER] –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏");
            element.textContent = "";
            for (let i = 0; i < text.length; i++) {
                element.textContent += text[i];
                await new Promise(resolve => setTimeout(resolve, speed));
            }
            // –û–±–Ω–æ–≤–∏—Ç—å preview –µ—Å–ª–∏ –æ–Ω –≤–∫–ª—é—á–µ–Ω
            if (isPreviewMode) {
                renderPreview();
            }
        }

        /**
         * –†–ï–ñ–ò–ú 2: –ü–æ—Å–∏–º–≤–æ–ª—å–Ω–∞—è –∑–∞–º–µ–Ω–∞ –í–°–ï–ì–û —Ç–µ–∫—Å—Ç–∞
         */
        async function animateTextReplacement(element, oldText, newText, speed = 10) {
            console.log("[REPLACE_TEXT] –ê–Ω–∏–º–∏—Ä—É—é –∑–∞–º–µ–Ω—É –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞");
            console.log(`[REPLACE_TEXT] –°—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç: ${oldText.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            console.log(`[REPLACE_TEXT] –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç: ${newText.length} —Å–∏–º–≤–æ–ª–æ–≤`);

            // –§–ê–ó–ê 1: –ó–∞–º–µ–Ω—è–µ–º –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ –¥–æ –¥–ª–∏–Ω—ã –º–µ–Ω—å—à–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const minLen = Math.min(oldText.length, newText.length);

            for (let i = 0; i < minLen; i++) {
                if (oldText[i] !== newText[i]) {
                    let currentText = element.textContent;
                    currentText = currentText.substring(0, i) + newText[i] + currentText.substring(i + 1);
                    element.textContent = currentText;
                }
                await new Promise(resolve => setTimeout(resolve, speed));
            }

            // –§–ê–ó–ê 2: –ï—Å–ª–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ - –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã –≤ –∫–æ–Ω–µ—Ü
            if (newText.length > oldText.length) {
                for (let i = oldText.length; i < newText.length; i++) {
                    element.textContent += newText[i];
                    await new Promise(resolve => setTimeout(resolve, speed));
                }
            }
            // –§–ê–ó–ê 3: –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ - —É–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
            else if (oldText.length > newText.length) {
                element.textContent = newText;
            }

            console.log("[REPLACE_TEXT] –ó–∞–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");

            // –û–±–Ω–æ–≤–∏—Ç—å preview –µ—Å–ª–∏ –æ–Ω –≤–∫–ª—é—á–µ–Ω
            if (isPreviewMode) {
                renderPreview();
            }
        }

        /**
         * –†–ï–ñ–ò–ú 3: –ü–æ—Å–∏–º–≤–æ–ª—å–Ω–∞—è –∑–∞–º–µ–Ω–∞ –í–´–î–ï–õ–ï–ù–ù–û–ì–û –§–†–ê–ì–ú–ï–ù–¢–ê
         * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: [before][–ø–µ—á–∞—Ç—å –Ω–æ–≤–æ–≥–æ][–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ][after]
         * –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±–æ–π –¥–ª–∏–Ω—ã newFragment (–∫–æ—Ä–æ—á–µ, —Ä–∞–≤–Ω–∞, –¥–ª–∏–Ω–Ω–µ–µ oldFragment)
         *
         * –§–ê–ó–´ –ê–ù–ò–ú–ê–¶–ò–ò:
         * 1. –ï—Å–ª–∏ newLen < oldLen: –ø–µ—á–∞—Ç—å –Ω–æ–≤–æ–≥–æ + —É–¥–∞–ª–µ–Ω–∏–µ —Ö–≤–æ—Å—Ç–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ
         * 2. –ï—Å–ª–∏ newLen >= oldLen: –ø–µ—á–∞—Ç—å –Ω–æ–≤–æ–≥–æ (–∫–∞–∫ –æ–±—ã—á–Ω–æ)
         */
        async function animateFragmentReplacement(element, fullOldText, startOffset, endOffset, newFragment, speed = 10) {
            console.log(`[REPLACE_FRAGMENT] –ê–Ω–∏–º–∏—Ä—É—é –∑–∞–º–µ–Ω—É —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞. –ü–æ–∑–∏—Ü–∏—è: ${startOffset}-${endOffset}`);

            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ —á–∞—Å—Ç–∏ –î–û –Ω–∞—á–∞–ª–∞ —Ü–∏–∫–ª–∞
            const before = fullOldText.substring(0, startOffset);
            const after = fullOldText.substring(endOffset);
            const oldFragment = fullOldText.substring(startOffset, endOffset);

            const oldLen = oldFragment.length;
            const newLen = newFragment.length;

            console.log(`[REPLACE_FRAGMENT] –°—Ç–∞—Ä—ã–π: ${oldLen} —Å–∏–º–≤–æ–ª–æ–≤, –ù–æ–≤—ã–π: ${newLen} —Å–∏–º–≤–æ–ª–æ–≤`);

            // ========== –§–ê–ó–ê 1: –ü–µ—á–∞—Ç—å –Ω–æ–≤–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ ==========
            for (let i = 0; i < newLen; i++) {
                // –ü–µ—á–∞—Ç–∞–µ–º —á–∞—Å—Ç—å –Ω–æ–≤–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ (–æ—Ç 0 –¥–æ i+1)
                const printedPart = newFragment.substring(0, i + 1);

                // –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ (–ø–æ—Å–ª–µ i+1)
                const remainingOld = oldFragment.substring(i + 1);

                // –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
                element.textContent = before + printedPart + remainingOld + after;

                await new Promise(resolve => setTimeout(resolve, speed));
            }

            // ========== –§–ê–ó–ê 2: –£–¥–∞–ª–µ–Ω–∏–µ —Ö–≤–æ—Å—Ç–∞ (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ) ==========
            if (newLen < oldLen) {
                const tailLen = oldLen - newLen;
                console.log(`[REPLACE_FRAGMENT] –£–¥–∞–ª—è—é —Ö–≤–æ—Å—Ç: ${tailLen} —Å–∏–º–≤–æ–ª–æ–≤`);

                for (let j = 0; j < tailLen; j++) {
                    // –ù–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª—è–µ–º j-–π —Å–∏–º–≤–æ–ª —Ö–≤–æ—Å—Ç–∞
                    // –û—Å—Ç–∞—Ç–æ–∫ —Ö–≤–æ—Å—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–æ–∑–∏—Ü–∏–∏ (newLen + j + 1)
                    const remainingTail = oldFragment.substring(newLen + j + 1);
                    element.textContent = before + newFragment + remainingTail + after;

                    await new Promise(resolve => setTimeout(resolve, speed));
                }
            }

            console.log("[REPLACE_FRAGMENT] –ó–∞–º–µ–Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");

            // –û–±–Ω–æ–≤–∏—Ç—å preview –µ—Å–ª–∏ –æ–Ω –≤–∫–ª—é—á–µ–Ω
            if (isPreviewMode) {
                renderPreview();
            }
        }

        // === UI FUNCTIONS ===

        function addArticleToSidebar(articleId, title, select = true) {
            const list = document.getElementById("articlesList");
            const button = document.createElement("button");
            button.className = "article-item";
            if (select) button.classList.add("active");
            button.setAttribute("data-id", articleId);
            button.innerHTML = title + `<span class="article-delete-btn" onclick="deleteArticle(event, ${articleId})" title="Delete">√ó</span>`;
            button.onclick = function(e) {
                if (e.target.classList.contains("article-delete-btn")) return;
                selectArticle(this, articleId);
            };
            list.appendChild(button);
        }

        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å modal —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
         */
        function showUnsavedChangesModal(targetId) {
            pendingArticleId = targetId;
            const modal = document.getElementById("unsavedChangesModal");
            if (modal) {
                modal.classList.add("visible");
                console.log(`[MODAL] –ü–æ–∫–∞–∑—ã–≤–∞—é modal –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–∞—Ç—å—é ${targetId}`);
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ modal
                document.addEventListener("keydown", handleEscapeKey);
            }
        }

        /**
         * –°–∫—Ä—ã—Ç—å modal
         */
        function hideUnsavedChangesModal() {
            const modal = document.getElementById("unsavedChangesModal");
            if (modal) {
                modal.classList.remove("visible");
                console.log("[MODAL] Modal –∑–∞–∫—Ä—ã—Ç–∞");
            }
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ modal
            document.removeEventListener("keydown", handleEscapeKey);
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π modal
         */
        function handleEscapeKey(e) {
            if (e.key === "Escape") {
                e.preventDefault();
                onModalCancel();
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ backdrop (–≤–Ω–µ modal content)
         */
        function onModalBackdropClick(event) {
            // –ö–ª–∏–∫ —Ç–æ–ª—å–∫–æ –Ω–∞ overlay, –Ω–µ –Ω–∞ content
            if (event.target.id === "unsavedChangesModal") {
                console.log("[MODAL] –ö–ª–∏–∫ –Ω–∞ backdrop");
                onModalCancel();
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Save –≤ modal
         */
        async function onModalSave() {
            console.log("[MODAL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª Save");

            if (!currentArticleId) {
                hideUnsavedChangesModal();
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç—å—é
            const saveSuccess = await saveArticle();
            if (saveSuccess) {
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
                if (pendingArticleId && pendingArticleId !== currentArticleId) {
                    const targetElement = document.querySelector(`.article-item[data-id="${pendingArticleId}"]`);
                    if (targetElement) {
                        performArticleSwitch(targetElement, pendingArticleId);
                    }
                }
                pendingArticleId = null;
                hideUnsavedChangesModal();
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Discard –≤ modal
         */
        function onModalDiscard() {
            console.log("[MODAL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª Discard");

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
            if (currentArticleId && articles[currentArticleId]) {
                const article = articles[currentArticleId];
                const editorContent = document.getElementById("editorContent");
                editorContent.textContent = article.content || "";

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º isDirty
                isDirty = false;
                article.isDirty = false;
                updateSaveButtonState();
                updateIndicator();
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ü–µ–ª–µ–≤—É—é —Å—Ç–∞—Ç—å—é
            if (pendingArticleId && pendingArticleId !== currentArticleId) {
                const targetElement = document.querySelector(`.article-item[data-id="${pendingArticleId}"]`);
                if (targetElement) {
                    performArticleSwitch(targetElement, pendingArticleId);
                }
            }

            pendingArticleId = null;
            hideUnsavedChangesModal();
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Cancel –≤ modal
         */
        function onModalCancel() {
            console.log("[MODAL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª Cancel");
            pendingArticleId = null;
            hideUnsavedChangesModal();
        }

        function selectArticle(element, id) {
            console.log(`[SELECT] –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–∞—Ç—å—é ID=${id}`);

            // –ï—Å–ª–∏ —ç—Ç–æ —Ç–∞ –∂–µ —Å—Ç–∞—Ç—å—è - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (currentArticleId === id) {
                console.log("[SELECT] –≠—Ç–æ –∂–µ —Ç–µ–∫—É—â–∞—è —Å—Ç–∞—Ç—å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É—é");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç—å–µ
            if (currentArticleId && isDirty) {
                console.log(`[SELECT] –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ç–∞—Ç—å–µ ${currentArticleId}`);
                console.log(`[SELECT] –ü–æ–∫–∞–∑—ã–≤–∞—é modal –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–∞—Ç—å—é ${id}`);
                showUnsavedChangesModal(id);
                return;
            }

            // –ù–µ—Ç –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π - –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
            performArticleSwitch(element, id);
        }

        /**
         * –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç–∞—Ç—å—é (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ isDirty)
         */
        async function performArticleSwitch(element, id) {
            console.log(`[SELECT] –í—ã–ø–æ–ª–Ω—è—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç–∞—Ç—å—é ID=${id}`);

            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤ sidebar
            document.querySelectorAll(".article-item").forEach(item => {
                item.classList.remove("active");
            });
            element.classList.add("active");

            currentArticleId = id;
            console.log(`[SELECT] currentArticleId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${currentArticleId}`);

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å—é
            const article = articles[id];
            console.log(`[SELECT] –°—Ç–∞—Ç—å—è –∏–∑ –∫—ç—à–∞: ${article ? "–Ω–∞–π–¥–µ–Ω–∞" : "–ù–ï –Ω–∞–π–¥–µ–Ω–∞"}`);

            if (article) {
                console.log(`[SELECT] –û—Ç–æ–±—Ä–∞–∂–∞–µ–º: title="${article.title}"`);
                const titleText = document.getElementById("titleText");
                if (titleText) {
                    titleText.textContent = article.title;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º content –∏–∑ –ë–î –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                const fullArticle = await loadArticleContent(id);
                if (fullArticle) {
                    articles[id].content = fullArticle.content;
                    document.getElementById("editorContent").textContent = fullArticle.content || "";
                    console.log(`[SELECT] Content –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ë–î (${(fullArticle.content || "").length} —Å–∏–º–≤–æ–ª–æ–≤)`);
                } else {
                    document.getElementById("editorContent").textContent = article.content || "";
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
                updateCharCount();

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º isDirty –¥–ª—è —ç—Ç–æ–π —Å—Ç–∞—Ç—å–∏
                isDirty = false;
                article.isDirty = false;
                updateSaveButtonState();
                updateIndicator();

                // –û—á–∏—â–∞–µ–º promptInput
                document.getElementById("promptInput").value = "";
                document.getElementById("promptInput").style.height = "auto";
                checkEnhanceButtonState();

                // –ï—Å–ª–∏ –±—ã–ª preview - –≤—ã—Ö–æ–¥–∏–º –∏–∑ –Ω–µ–≥–æ
                if (isPreviewMode) {
                    togglePreview();
                }

                console.log("[SELECT] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
            } else {
                console.log(`[SELECT] –û–®–ò–ë–ö–ê: –°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫—ç—à–µ!`);
            }
        }

        // Delete article
        async function deleteArticle(event, id) {
            event.stopPropagation();
            const success = await deleteArticleViaAPI(id);

            if (success) {
                const articleButton = document.querySelector(`.article-item[data-id="${id}"]`);
                articleButton.remove();

                // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞—Ç—å—è - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥—É—é
                const activeItem = document.querySelector(".article-item.active");
                if (!activeItem) {
                    const firstArticle = document.querySelector(".article-item");
                    if (firstArticle) {
                        const firstId = parseInt(firstArticle.getAttribute("data-id"));
                        selectArticle(firstArticle, firstId);
                    } else {
                        const titleElem = document.getElementById("titleText");
                        if (titleElem) titleElem.textContent = "No articles";
                        document.getElementById("editorContent").textContent = "";
                        document.getElementById("promptInput").value = "";
                        checkEnhanceButtonState();
                    }
                }

                showNotification("Article deleted");
            }
        }

        // Open new article modal
        function openNewArticleModal() {
            const modal = new bootstrap.Modal(document.getElementById("newArticleModal"));
            document.getElementById("newArticleTitle").value = "";
            document.getElementById("newArticleTitle").focus();
            modal.show();
        }

        // Create new article (through API) - –ø—É—Å—Ç–∞—è —Å—Ç–∞—Ç—å—è –ë–ï–ó –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        async function createNewArticle() {
            console.log("[CREATE] –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç—å–∏");
            const title = document.getElementById("newArticleTitle").value.trim();
            console.log(`[CREATE] –í–≤–µ–¥—ë–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: "${title}"`);

            if (!title) {
                console.log("[CREATE] –û—à–∏–±–∫–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ");
                showNotification("Please enter an article title");
                return;
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById("newArticleModal"));
            modal.hide();

            // –í—ã–∑–≤–∞–µ–º API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ü–£–°–¢–û–ô —Å—Ç–∞—Ç—å–∏ (–ë–ï–ó –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞)
            console.log("[CREATE] –í—ã–∑—ã–≤–∞–µ–º createEmptyArticleViaAPI");
            const article = await createEmptyArticleViaAPI(title);
            if (!article) {
                console.log("[CREATE] –û—à–∏–±–∫–∞: API –Ω–µ –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—å—é");
                return;
            }

            console.log(`[CREATE] –°—Ç–∞—Ç—å—è —Å–æ–∑–¥–∞–Ω–∞! ID=${article.id}, title="${article.title}"`);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à –∏ –≤ sidebar
            // –í–ê–ñ–ù–û: –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º content –≤ articles - —Ç–æ–ª—å–∫–æ metadata!
            delete article.content;
            articles[article.id] = article;
            console.log(`[CREATE] –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫—ç—à`);

            addArticleToSidebar(article.id, article.title, true);
            console.log(`[CREATE] –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤ sidebar`);

            currentArticleId = article.id;
            console.log(`[CREATE] currentArticleId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${currentArticleId}`);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä - –ø—É—Å—Ç–æ, –ë–ï–ó typewriter effect
            const titleElem = document.getElementById("titleText");
            if (titleElem) titleElem.textContent = article.title;
            document.getElementById("editorContent").textContent = "";

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ (—Å–µ–π—á–∞—Å 0)
            updateCharCount();

            document.getElementById("promptInput").value = "";
            document.getElementById("promptInput").style.height = "auto";
            checkEnhanceButtonState();

            console.log("[CREATE] UI –æ–±–Ω–æ–≤–ª–µ–Ω. –ì–æ—Ç–æ–≤–æ –∫ –≤–≤–æ–¥—É –ø—Ä–æ–º–ø—Ç–∞");
            showNotification("–°—Ç–∞—Ç—å—è —Å–æ–∑–¥–∞–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –ø–ª–∞–Ω –≤ prompt bar.");
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement("div");
            notification.className = "notification-toast";
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = "slideIn 0.3s ease reverse";
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É Apply
        function lockApplyButton() {
            console.log("[UI] –ë–ª–æ–∫–∏—Ä—É—é –∫–Ω–æ–ø–∫—É Apply");
            isGenerating = true;
            const btn = document.querySelector(".btn-apply");
            if (btn) {
                btn.disabled = true;
                btn.classList.add("generating");
                console.log("[UI] –ö–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —Å–æ —Å–ø–∏–Ω–Ω–µ—Ä–æ–º");
            } else {
                console.error("[UI] –û–®–ò–ë–ö–ê: –∫–Ω–æ–ø–∫–∞ .btn-apply –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
        }

        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É Apply
        function unlockApplyButton() {
            console.log("[UI] –†–∞–∑–±–ª–æ–∫–∏—Ä—É—é –∫–Ω–æ–ø–∫—É Apply");
            isGenerating = false;
            const btn = document.querySelector(".btn-apply");
            if (btn) {
                btn.disabled = false;
                btn.classList.remove("generating");
                console.log("[UI] –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞");
            } else {
                console.error("[UI] –û–®–ò–ë–ö–ê: –∫–Ω–æ–ø–∫–∞ .btn-apply –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
        }

        /**
         * –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –ø—Ä–æ—Å–∏—Ç –ª–∏ –æ–Ω Markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
         * @param {string} prompt - –¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         * @returns {boolean} - true –µ—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç Markdown, false –µ—Å–ª–∏ plain text
         */
        function detectMarkdownRequest(prompt) {
            if (!prompt) return false;

            const lowerPrompt = prompt.toLowerCase();

            // –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è Markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const markdownTriggers = [
                "markdown",
                "–æ—Ñ–æ—Ä–º–∏",
                "–æ—Ñ–æ—Ä–º—å",
                "–æ—Ñ–æ—Ä–º–∏—Ç—å",
                "—Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏",
                "—Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏",
                "–≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞",
                "–∫–∞–∫ —Å–ø–∏—Å–æ–∫",
                "–∫–∞–∫ –∫–æ–¥",
                "–∫–æ–¥-–±–ª–æ–∫",
                "–∫–æ–¥–±–ª–æ–∫",
                "—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ",
                "—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ",
                "—Å—Ç—Ä—É–∫—Ç—É—Ä—É",
                "—Å—Ç—Ä—É–∫—Ç—É—Ä—É",
                "—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "##",
                "```",
                "-",
                "—Å–ø–∏—Å–æ–∫",
                "–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π",
                "–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
                "—Ç–∞–±–ª–∏—Ü–∞",
                "–∂–∏—Ä–Ω—ã–π",
                "–∫—É—Ä—Å–∏–≤",
                "–≤—ã–¥–µ–ª–µ–Ω–∏–µ",
                "–ø–æ–¥—Å–≤–µ—Ç–∫–∞"
            ];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –≤ –ø—Ä–æ–º–ø—Ç–µ
            for (const trigger of markdownTriggers) {
                if (lowerPrompt.includes(trigger)) {
                    console.log(`[MARKDOWN_DETECT] –ù–∞–π–¥–µ–Ω —Ç—Ä–∏–≥–≥–µ—Ä "${trigger}" –≤ –ø—Ä–æ–º–ø—Ç–µ`);
                    return true;
                }
            }

            console.log("[MARKDOWN_DETECT] Markdown –ù–ï –∑–∞–ø—Ä–æ—à–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ–º —Å plain text");
            return false;
        }

        // Extract topic from prompt and generate plan for current article
        async function applyPrompt() {
            // Guard clause: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            if (isGenerating) {
                console.log("[UI] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—é –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤");
                return;
            }

            try {
                lockApplyButton();

                console.log("[PROMPT] –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ - –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –° 4 –†–ï–ñ–ò–ú–ê–ú–ò");
                const promptText = document.getElementById("promptInput").value.trim();
                console.log(`[PROMPT] –¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞: "${promptText}"`);

                if (!promptText) {
                    console.log("[PROMPT] –û—à–∏–±–∫–∞: –ø—Ä–æ–º–ø—Ç –ø—É—Å—Ç");
                    return;
                }

                // ========== –†–ï–ñ–ò–ú 4: –ü–†–û–í–ï–†–Ø–ï–ú, –≠–¢–û YouTube URL? ==========
                const youtubeInfo = parseYoutubeUrl(promptText);
                if (youtubeInfo.isYoutube) {
                    console.log(`[PROMPT] –†–ï–ñ–ò–ú 4: YouTube URL –æ–±–Ω–∞—Ä—É–∂–µ–Ω - ${youtubeInfo.url}`);
                    return await handleYoutubeImport(youtubeInfo.url);
                }

                // ========== –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ï–ñ–ò–ú –ü–û –°–û–°–¢–û–Ø–ù–ò–Æ –†–ï–î–ê–ö–¢–û–†–ê ==========
                const modeInfo = detectMode();
                console.log(`[PROMPT] –û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–µ–∂–∏–º: ${modeInfo.mode} (${modeInfo.description})`);

                // ========== –û–ü–†–ï–î–ï–õ–Ø–ï–ú –§–û–†–ú–ê–¢ (MARKDOWN –∏–ª–∏ PLAIN TEXT) ==========
                const wantsMarkdown = detectMarkdownRequest(promptText);
                const format = wantsMarkdown ? "markdown" : "plain";
                console.log(`[PROMPT] –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: ${format}`);

                // ========== –†–ï–ñ–ò–ú 1: –°–û–ó–î–ê–ù–ò–ï –ü–õ–ê–ù–ê (—Ç–µ–∫—Å—Ç –ø—É—Å—Ç) ==========
                if (modeInfo.mode === 1) {
                    console.log("[PROMPT] –†–ï–ñ–ò–ú 1: –≤–µ—Å—å —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ ‚Üí —Ç–µ–º–∞ –¥–ª—è –ø–ª–∞–Ω–∞");

                    // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞—Ç—å–∏ - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
                    if (!currentArticleId) {
                        console.log("[PROMPT] –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é –¥–ª—è –ø–ª–∞–Ω–∞");
                        const newArticle = await createEmptyArticleViaAPI(promptText);
                        if (!newArticle) return;
                                addArticleToSidebar(newArticle.id, newArticle.title, true);
                        currentArticleId = newArticle.id;
                    }

                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω
                    showNotification("–ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏...");
                    const updatedArticle = await generatePlanForArticleViaAPI(currentArticleId, promptText, format);
                    if (!updatedArticle) return;

                    const titleElem = document.getElementById("titleText");
                    if (titleElem) titleElem.textContent = updatedArticle.title;
                    await typewriterEffect(document.getElementById("editorContent"), updatedArticle.content, 15);
                    updateDirtyState();
                    showNotification("–ü–ª–∞–Ω —Å—Ç–∞—Ç—å–∏ –≥–æ—Ç–æ–≤! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç.");
                }

                // ========== –†–ï–ñ–ò–ú 2: –ü–†–ê–í–ö–ê –í–°–ï–ì–û –¢–ï–ö–°–¢–ê (—Ç–µ–∫—Å—Ç –µ—Å—Ç—å, –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è) ==========
                else if (modeInfo.mode === 2) {
                    console.log("[PROMPT] –†–ï–ñ–ò–ú 2: –ø—Ä–æ–º–ø—Ç ‚Üí –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∫–∏ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞");

                    if (!currentArticleId) {
                        showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
                        return;
                    }

                    showNotification("–†–µ–¥–∞–∫—Ç–∏—Ä—É—é –≤–µ—Å—å —Ç–µ–∫—Å—Ç...");
                    const oldText = document.getElementById("editorContent").textContent;
                    const updatedArticle = await editFullTextViaAPI(currentArticleId, oldText, promptText, format);
                    if (!updatedArticle) return;


                    // –ü—Ä–∏–º–µ–Ω—è–µ–º typewriter effect –¥–ª—è –∑–∞–º–µ–Ω—ã —Ç–µ–∫—Å—Ç–∞
                    await animateTextReplacement(
                        document.getElementById("editorContent"),
                        oldText,
                        updatedArticle.content,
                        10  // speed
                    );
                    updateDirtyState();

                    // –û—á–∏—â–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤—ã–¥–µ–ª–µ–Ω–∏—è
                    clearSelectionHighlight();
                    savedSelection = null;

                    showNotification("–¢–µ–∫—Å—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω!");
                }

                // ========== –†–ï–ñ–ò–ú 3: –ü–†–ê–í–ö–ê –§–†–ê–ì–ú–ï–ù–¢–ê (—Ç–µ–∫—Å—Ç –µ—Å—Ç—å + –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ) ==========
                else if (modeInfo.mode === 3) {
                    console.log("[PROMPT] –†–ï–ñ–ò–ú 3: –ø—Ä–æ–º–ø—Ç ‚Üí –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∫–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞");

                    if (!currentArticleId) {
                        showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
                        return;
                    }

                    // –ü–æ–ª—É—á–∞–µ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
                    const selection = getSelectionWithContext();
                    if (!selection) {
                        showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç");
                        return;
                    }

                    showNotification("–†–µ–¥–∞–∫—Ç–∏—Ä—É—é –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç...");
                    const oldText = document.getElementById("editorContent").textContent;
                    const startOffset = savedSelection.startOffset;
                    const endOffset = savedSelection.endOffset;

                    const updatedArticle = await editFragmentViaAPI(
                        currentArticleId,
                        selection.before,
                        selection.fragment,
                        selection.after,
                        promptText,
                        format
                    );
                    if (!updatedArticle) return;


                    // –ü—Ä–∏–º–µ–Ω—è–µ–º typewriter effect –¢–û–õ–¨–ö–û –¥–ª—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∏–∑ backend (–ù–ï –∏–∑ content!)
                    await animateFragmentReplacement(
                        document.getElementById("editorContent"),
                        oldText,
                        startOffset,
                        endOffset,
                        updatedArticle.fragment,
                        10  // speed
                    );
                    updateDirtyState();

                    // –û—á–∏—â–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤—ã–¥–µ–ª–µ–Ω–∏—è
                    clearSelectionHighlight();
                    savedSelection = null;

                    showNotification("–§—Ä–∞–≥–º–µ–Ω—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω!");
                }

                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø—Ä–æ–º–ø—Ç–∞
                    document.getElementById("promptInput").value = "";
                    document.getElementById("promptInput").style.height = "auto";
                    checkEnhanceButtonState();
                    console.log("[PROMPT] –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ");
            } finally {
                unlockApplyButton();
            }
        }

        /**
         * –†–ï–ñ–ò–ú 5: –£—Å–∏–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
         * –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞:
         * - –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ ‚Üí —É—Å–∏–ª–∏—Ç—å –¢–û–õ–¨–ö–û —Ñ—Ä–∞–≥–º–µ–Ω—Ç
         * - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –µ—Å—Ç—å, –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ—Ç ‚Üí —É—Å–∏–ª–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç—å—é
         * - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç ‚Üí —É—Å–∏–ª–∏—Ç—å –ø–ª–∞–Ω –ø–æ —Ç–µ–º–µ –∏–∑ –ø—Ä–æ–º–ø—Ç–∞
         */
        async function enhanceText() {
            if (isGenerating) {
                console.log("[ENHANCE] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—é –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤");
                return;
            }

            try {
                lockApplyButton();
                const enhanceButton = document.getElementById("enhanceButton");
                if (enhanceButton) {
                    enhanceButton.classList.add("generating");
                    enhanceButton.disabled = true;
                }

                console.log("[ENHANCE] –ó–∞–ø—É—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —É—Å–∏–ª–µ–Ω–∏—è");

                const editorContent = document.getElementById("editorContent").textContent;
                const promptText = document.getElementById("promptInput").value.trim();

                let mode = null;
                let requestBody = null;

                // ========== –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ï–ñ–ò–ú ==========

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                if (savedSelection && savedSelection.text && savedSelection.text.length > 0) {
                    console.log("[ENHANCE] –†–µ–∂–∏–º: —É—Å–∏–ª–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç");
                    mode = "fragment";

                    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    const fullText = editorContent;
                    const { startOffset, endOffset } = savedSelection;

                    let beforeContext = "";
                    let afterContext = "";

                    // –ë–µ—Ä—ë–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–±–∑–∞—Ü –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    let beforeStart = startOffset;
                    let doubleNewlineCount = 0;
                    for (let i = startOffset - 1; i >= 0; i--) {
                        if (fullText[i] === "\n") doubleNewlineCount++;
                        if (doubleNewlineCount === 2) {
                            beforeStart = i + 1;
                            break;
                        }
                    }
                    beforeContext = fullText.substring(beforeStart, startOffset).trim();

                    // –ë–µ—Ä—ë–º —Å–ª–µ–¥—É—é—â–∏–π –∞–±–∑–∞—Ü –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    let afterEnd = endOffset;
                    doubleNewlineCount = 0;
                    for (let i = endOffset; i < fullText.length; i++) {
                        if (fullText[i] === "\n") doubleNewlineCount++;
                        if (doubleNewlineCount === 2) {
                            afterEnd = i;
                            break;
                        }
                    }
                    afterContext = fullText.substring(endOffset, afterEnd).trim();

                    requestBody = {
                        mode: "fragment",
                        text: savedSelection.text,
                        beforeContext: beforeContext,
                        afterContext: afterContext
                    };
                }

                // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è, –Ω–æ —Ç–µ–∫—Å—Ç –µ—Å—Ç—å
                else if (editorContent && editorContent.trim().length > 0) {
                    console.log("[ENHANCE] –†–µ–∂–∏–º: —É—Å–∏–ª–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç");
                    mode = "full";
                    requestBody = {
                        mode: "full",
                        text: editorContent
                    };
                }

                // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç
                else {
                    console.log("[ENHANCE] –†–µ–∂–∏–º: —É—Å–∏–ª–∏—Ç—å –ø–ª–∞–Ω –ø–æ —Ç–µ–º–µ");
                    if (!promptText) {
                        showNotification("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞");
                        return;
                    }
                    mode = "plan";
                    requestBody = {
                        mode: "plan",
                        userInstruction: promptText
                    };
                }

                // ========== –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ó–ê–ü–†–û–° –ù–ê BACKEND ==========
                console.log(`[ENHANCE] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å. mode=${mode}`);

                const url = `${API_BASE_URL}/enhance`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                });

                console.log(`[ENHANCE] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å–∏–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞");
                }

                const result = await response.json();

                // ========== –ü–†–ò–ú–ï–ù–Ø–ï–ú –†–ï–ó–£–õ–¨–¢–ê–¢ ==========

                if (mode === "fragment") {
                    console.log("[ENHANCE] –ü—Ä–∏–º–µ–Ω—è—é —É—Å–∏–ª–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç");
                    const newFragmentText = result.replacementText;
                    const fullText = editorContent;
                    const { startOffset, endOffset } = savedSelection;

                    const newText = fullText.substring(0, startOffset) +
                                    newFragmentText +
                                    fullText.substring(endOffset);

                    await animateTextReplacement(
                        document.getElementById("editorContent"),
                        fullText,
                        newText,
                        10
                    );
                }

                else if (mode === "full") {
                    console.log("[ENHANCE] –ü—Ä–∏–º–µ–Ω—è—é —É—Å–∏–ª–µ–Ω–Ω—ã–π –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç");
                    const newText = result.newText;
                    const oldText = editorContent;

                    await animateTextReplacement(
                        document.getElementById("editorContent"),
                        oldText,
                        newText,
                        10
                    );
                }

                else if (mode === "plan") {
                    console.log("[ENHANCE] –ü—Ä–∏–º–µ–Ω—è—é —É—Å–∏–ª–µ–Ω–Ω—ã–π –ø–ª–∞–Ω");
                    const planText = result.newText;

                    // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞—Ç—å–∏ - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
                    if (!currentArticleId) {
                        console.log("[ENHANCE] –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é –¥–ª—è –ø–ª–∞–Ω–∞");
                        const newArticle = await createEmptyArticleViaAPI(promptText);
                        if (!newArticle) return;
                        addArticleToSidebar(newArticle.id, newArticle.title, true);
                        currentArticleId = newArticle.id;
                    }

                    await typewriterEffect(document.getElementById("editorContent"), planText, 15);
                }

                updateDirtyState();
                clearSelectionHighlight();
                savedSelection = null;
                document.getElementById("promptInput").value = "";
                checkEnhanceButtonState();

                showNotification("–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ —É—Å–∏–ª–µ–Ω!");

            } catch (error) {
                console.error("[ENHANCE] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å–∏–ª–µ–Ω–∏–∏: " + error.message);
            } finally {
                const enhanceButton = document.getElementById("enhanceButton");
                if (enhanceButton) {
                    enhanceButton.classList.remove("generating");
                    enhanceButton.disabled = false;
                }
                unlockApplyButton();
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Enhance –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ promptInput
        function checkEnhanceButtonState() {
            const promptText = document.getElementById("promptInput").value.trim();
            const youtubeInfo = parseYoutubeUrl(promptText);
            const enhanceButton = document.getElementById("enhanceButton");

            if (enhanceButton) {
                // –£–±–∏—Ä–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
                enhanceButton.classList.remove("generating");

                // –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ - –¢–û–õ–¨–ö–û YouTube —Å—Å—ã–ª–∫–∞, –æ—Ç–∫–ª—é—á–∞–µ–º Enhance
                if (youtubeInfo.isYoutube && promptText === youtubeInfo.url) {
                    enhanceButton.disabled = true;
                    console.log("[UI] –ö–Ω–æ–ø–∫–∞ Enhance –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –≤ –ø—Ä–æ–º–ø—Ç–µ —Ç–æ–ª—å–∫–æ YouTube —Å—Å—ã–ª–∫–∞");
                } else if (promptText.length > 0) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç (–Ω–µ —Ç–æ–ª—å–∫–æ YouTube), –≤–∫–ª—é—á–∞–µ–º Enhance
                    enhanceButton.disabled = false;
                    console.log("[UI] –ö–Ω–æ–ø–∫–∞ Enhance –≤–∫–ª—é—á–µ–Ω–∞ - –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏");
                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ, –æ—Ç–∫–ª—é—á–∞–µ–º Enhance
                    enhanceButton.disabled = true;
                    console.log("[UI] –ö–Ω–æ–ø–∫–∞ Enhance –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –ø–æ–ª–µ –ø—É—Å—Ç–æ");
                }
            }
        }

        // === HUMANIZE FUNCTIONS ===

        /**
         * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—é –≤ backend
         */
        async function humanizeTextViaAPI(text, scope = "full") {
            try {
                console.log(`[HUMANIZE_API] –ù–∞—á–∏–Ω–∞—é –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—é. scope=${scope}, —Ä–∞–∑–º–µ—Ä=${text.length} —Å–∏–º–≤–æ–ª–æ–≤`);

                const url = `${API_BASE_URL}/articles/${currentArticleId}/humanize`;
                const body = {
                    text: text,
                    scope: scope
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                console.log(`[HUMANIZE_API] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–∏");
                }

                const article = await response.json();
                console.log(`[HUMANIZE_API] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –≥—É–º–∞–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω`);
                return article;
            } catch (error) {
                console.error("[HUMANIZE_API] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–∏: " + error.message);
                return null;
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Humanize
         */
        async function handleHumanizeClick() {
            if (!currentArticleId) {
                showNotification("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞—Ç—å–∏");
                return;
            }

            const editorContent = document.getElementById("editorContent");
            const fullText = editorContent.textContent.trim();

            if (!fullText) {
                showNotification("–¢–µ–∫—Å—Ç –ø—É—Å—Ç");
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –≥—É–º–∞–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            let textToHumanize;
            let scope = "full";

            if (savedSelection && savedSelection.text && savedSelection.text.length > 0) {
                // –ï—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç
                textToHumanize = savedSelection.text;
                scope = "fragment";
                console.log(`[HUMANIZE] –†–µ–∂–∏–º –§–†–ê–ì–ú–ï–ù–¢: ${textToHumanize.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            } else {
                // –ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç
                textToHumanize = fullText;
                scope = "full";
                console.log(`[HUMANIZE] –†–µ–∂–∏–º –í–°–ï: ${textToHumanize.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            isGenerating = true;
            lockApplyButton();
            const humanizeBtn = document.getElementById("humanizeButton");
            if (humanizeBtn) {
                humanizeBtn.classList.add("generating");
                humanizeBtn.disabled = true;
            }

            showNotification("–ì—É–º–∞–Ω–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç...");

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                const result = await humanizeTextViaAPI(textToHumanize, scope);
                if (!result) {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞");
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç scope
                if (scope === "fragment") {
                    // –ó–∞–º–µ–Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
                    await animateFragmentReplacement(
                        editorContent,
                        fullText,
                        savedSelection.startOffset,
                        savedSelection.endOffset,
                        result.content,
                        10
                    );
                } else {
                    // –ó–∞–º–µ–Ω–∞ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
                    await animateTextReplacement(editorContent, fullText, result.content, 10);
                }

                updateDirtyState();
                showNotification("–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –≥—É–º–∞–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω!");

            } catch (error) {
                console.error("[HUMANIZE] –û—à–∏–±–∫–∞:", error);
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–∏: " + error.message);
            } finally {
                isGenerating = false;
                unlockApplyButton();
                if (humanizeBtn) {
                    humanizeBtn.classList.remove("generating");
                    humanizeBtn.disabled = false;
                }
            }
        }

        // Auto-resize textarea (–¥–æ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–æ–≤, –ø–æ—Ç–æ–º —Å–∫—Ä–æ–ª–ª)
        const promptInput = document.getElementById("promptInput");
        promptInput.addEventListener("input", function() {
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 300) + "px";
            checkEnhanceButtonState();
        });

        // Allow Enter key to submit prompt (Shift+Enter for new line)
        promptInput.addEventListener("keypress", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                applyPrompt();
            }
        });

        // Allow Enter in modal to create article
        document.getElementById("newArticleTitle").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                createNewArticle();
            }
        });
    </script>

    <!-- === UNSAVED CHANGES MODAL === -->
    <div class="modal-overlay" id="unsavedChangesModal" onclick="onModalBackdropClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <p class="modal-text">You have unsaved changes. If you leave, they will be lost.</p>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" id="modalBtnCancel" onclick="onModalCancel()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-discard" id="modalBtnDiscard" onclick="onModalDiscard()">–ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å</button>
                <button class="modal-btn modal-btn-save" id="modalBtnSave" onclick="onModalSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</body>
</html>