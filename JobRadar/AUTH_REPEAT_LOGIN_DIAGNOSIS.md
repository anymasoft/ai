# üîç –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢: –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìã –ü–†–û–ë–õ–ï–ú–ê

–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–æ–≥–¥–∞ TelegramSession —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞) —Å–∏—Å—Ç–µ–º–∞ **–í–°–ï–ì–î–ê –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥** —á–µ—Ä–µ–∑ Telegram, –¥–∞–∂–µ —Ö–æ—Ç—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä—è–º–æ–π –≤—Ö–æ–¥ –±–µ–∑ –∫–æ–¥–æ–≤.

---

## üîé –ù–ê–ô–î–ï–ù–ù–ê–Ø –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

### –§–∞–π–ª: main.py, endpoint /api/auth/start (lines 884-982)

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø):**

```python
# –õ–∏–Ω–∏—è 899-904: –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ TelegramSession
telegram_session = (
    db.query(TelegramSession)
    .filter(TelegramSession.phone == phone)
    .first()
)

# –õ–∏–Ω–∏—è 907: –í–ê–†–ò–ê–ù–¢ –ê - –µ—Å–ª–∏ TelegramSession –ù–ê–ô–î–ï–ù–ê
if telegram_session:
    # –õ–∏–Ω–∏—è 918: –ü–æ–ª—É—á–∞–µ–º TelegramClient
    client = await get_user_client(user.id, db)

    # –õ–∏–Ω–∏—è 925: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ö–û–î (!!!)
    login_code = str(random.randint(10000, 99999))

    # –õ–∏–Ω–∏—è 928-932: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –≤ –ø–∞–º—è—Ç–∏
    pending_login_codes[phone] = {
        "code": login_code,
        "user_id": telegram_session.user_id,
        "expires_at": datetime.utcnow() + timedelta(seconds=300)
    }

    # –õ–∏–Ω–∏—è 936: –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ö–û–î –í TELEGRAM –õ–° (!!!)
    await client.send_message("me", f"–í–∞—à –∫–æ–¥ –≤—Ö–æ–¥–∞ –≤ JobRadar: {login_code}...")

    # –õ–∏–Ω–∏—è 943-946: –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á—Ç–æ –Ω—É–∂–µ–Ω –∫–æ–¥
    return {
        "ok": True,
        "login_via": "telegram_message"  # ‚Üê –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–Ω–∞–µ—Ç —á—Ç–æ –∫–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è!
    }
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ùå –î–∞–∂–µ –µ—Å–ª–∏ TelegramSession –µ—Å—Ç—å ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ö–û–î
- ‚ùå –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç login_via="telegram_message"
- ‚ùå –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –∫–æ–¥–∞
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é

**–¢—Ä–µ–±—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ –ï—Å–ª–∏ TelegramSession –µ—Å—Ç—å ‚Üí –ë–ï–ó –∫–æ–¥–∞!
- ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å auth_token –°–†–ê–ó–£
- ‚úÖ –í–µ—Ä–Ω—É—Ç—å auth_token –≤ –æ—Ç–≤–µ—Ç–µ
- ‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ dashboard –±–µ–∑ –≤–≤–æ–¥–∞ –∫–æ–¥–∞

---

## üìä –¢–ï–ö–£–©–ò–ô –§–õ–û–£ vs –¢–†–ï–ë–£–ï–ú–´–ô –§–õ–û–£

### –¢–ï–ö–£–©–ò–ô –§–õ–û–£ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô):

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä
         ‚Üì
POST /api/auth/start (phone)
         ‚Üì
Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TelegramSession
         ‚Üì
‚úì TelegramSession –Ω–∞–π–¥–µ–Ω–∞
         ‚Üì
Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ö–û–î –≤ Telegram –õ–° (!!!)
         ‚Üì
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: login_via="telegram_message"
         ‚Üì
–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –∫–æ–¥–∞
         ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
         ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥ –≤—Ä—É—á–Ω—É—é
         ‚Üì
POST /api/auth/login-by-telegram (phone, code)
         ‚Üì
Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥
         ‚Üì
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç auth_token
         ‚Üì
–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard
```

### –¢–†–ï–ë–£–ï–ú–´–ô –§–õ–û–£ (–ü–†–ê–í–ò–õ–¨–ù–´–ô):

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä
         ‚Üì
POST /api/auth/start (phone)
         ‚Üì
Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TelegramSession
         ‚Üì
‚úì TelegramSession –Ω–∞–π–¥–µ–Ω–∞
         ‚Üì
Backend –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ (!!)
         ‚Üì
Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç auth_token –°–†–ê–ó–£
         ‚Üì
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: auth_token + user_info
         ‚Üì
–§—Ä–æ–Ω—Ç–µ–Ω–¥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie
         ‚Üì
–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard (–ë–ï–ó –≤–≤–æ–¥–∞ –∫–æ–¥–∞!)
```

---

## üõ†Ô∏è –†–ï–®–ï–ù–ò–ï

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

#### 1. –ò–∑–º–µ–Ω–∏—Ç—å /api/auth/start (main.py, lines 884-982)

**–ü—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π TelegramSession:**
- ‚úÖ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–¥
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å auth_token —á–µ—Ä–µ–∑ create_user_session()
- ‚úÖ –ü–æ–ª—É—á–∏—Ç—å user_info
- ‚úÖ –í–µ—Ä–Ω—É—Ç—å auth_token + user_info –≤ –æ—Ç–≤–µ—Ç–µ
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cookie auth_token

#### 2. –ò–∑–º–µ–Ω–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (templates/login.html, line 602-615)

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ auth_token –≤ –æ—Ç–≤–µ—Ç–µ /api/auth/start:**
- ‚úÖ –ï—Å–ª–∏ auth_token –µ—Å—Ç—å ‚Üí —Å—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ dashboard
- ‚úÖ –ï—Å–ª–∏ auth_token –Ω–µ—Ç ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –∫–∞–∫ —Ä–∞–Ω—å—à–µ

---

## ‚úÖ –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –®–∞–≥ 1: Backend - Modify /api/auth/start

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (lines 906-951):**
```python
if telegram_session:
    # ... –ø–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç ...
    login_code = str(random.randint(10000, 99999))  ‚Üê –£–î–ê–õ–ò–¢–¨!
    pending_login_codes[phone] = {...}  ‚Üê –£–î–ê–õ–ò–¢–¨!
    await client.send_message(...)  ‚Üê –£–î–ê–õ–ò–¢–¨!
    return {"ok": True, "login_via": "telegram_message"}  ‚Üê –ò–ó–ú–ï–ù–ò–¢–¨!
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
if telegram_session:
    # ... –ø–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç ...
    user = db.query(User).filter(User.id == telegram_session.user_id).first()

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º auth_token –°–†–ê–ó–£ (–±–µ–∑ –∫–æ–¥–∞!)
    auth_token = create_user_session(user.id, db)

    # –ü–æ–ª—É—á–∞–µ–º user_info
    user_info = {...}

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º auth_token + user_info
    response = JSONResponse({
        "ok": True,
        "login_via": "telegram_direct",  ‚Üê –ù–û–í–´–ô –¢–ò–ü
        "auth_token": auth_token,
        "user": user_info
    })
    response.set_cookie(
        key="auth_token",
        value=auth_token,
        ...
    )
    return response
```

### –®–∞–≥ 2: Frontend - Detect auto-login

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (lines 519-552):**
```javascript
const data = await response.json();
const currentLoginVia = data.login_via || 'telegram_sms';

if (currentLoginVia === 'telegram_sms') {
    currentAuthId = data.auth_id;
}
const modeMsg = currentLoginVia === 'telegram_message'
    ? '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram'
    : '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ Telegram';
showToast(modeMsg, 'success');
showStage('code');  ‚Üê –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –∫–æ–¥–∞
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```javascript
const data = await response.json();
const currentLoginVia = data.login_via || 'telegram_sms';

// –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ auth_token –≤ –æ—Ç–≤–µ—Ç–µ
if (data.auth_token) {
    // Auto-login! TelegramSession —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (data.user) {
        localStorage.setItem('user', JSON.stringify(data.user));
    }
    showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
    showStage('success');
    setTimeout(() => {
        window.location.href = '/dashboard';
    }, 1500);
    return;  ‚Üê –í–´–•–û–î–ò–ú –ë–ï–ó –§–û–†–ú–´ –ö–û–î–ê
}

// –ï—Å–ª–∏ auth_token –Ω–µ—Ç ‚Üí –æ–±—ã—á–Ω—ã–π —Ñ–ª–æ—É (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–¥)
if (currentLoginVia === 'telegram_sms') {
    currentAuthId = data.auth_id;
}
const modeMsg = currentLoginVia === 'telegram_message'
    ? '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram'
    : '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ Telegram';
showToast(modeMsg, 'success');
showStage('code');
```

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ?

1. ‚úÖ **Auth_token –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –≤ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–º –≤–∏–¥–µ** - –æ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ httponly cookie
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ TelegramSession –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ phone –≤ –ë–î** - –Ω–µ–ª—å–∑—è –ø–æ–¥–¥–µ–ª–∞—Ç—å
3. ‚úÖ **TelegramClient –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º** - –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –º–µ—Ä—Ç–≤–∞ ‚Üí fallback
4. ‚úÖ **–¢—Ä–µ–±—É–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π session_string** - –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ —Ç–∞–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º

### –†–∏—Å–∫: –ß—Ç–æ –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∑–Ω–∞–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞?

- **–¢–µ–∫—É—â–∏–π —Å–∏—Å—Ç–µ–º–µ**: –ú–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–¥ –≤ Telegram –∏ –µ—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç –¥–æ—Å—Ç—É–ø ‚Üí –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏
- **–ù–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ**: –ú–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–¥ –≤ Telegram –∏ –µ—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç –¥–æ—Å—Ç—É–ø ‚Üí –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏

**–í—ã–≤–æ–¥:** –£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è! –ü—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π —à–∞–≥ –∫–æ–¥–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞.

---

## üìù –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

- [ ] –ù–∞–π—Ç–∏ –±–ª–æ–∫ –∫–æ–¥–∞ –≤ /api/auth/start –≥–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞–π–¥–µ–Ω–Ω–∞—è TelegramSession
- [ ] –£–¥–∞–ª–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–∫—É –∫–æ–¥–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é auth_token —á–µ—Ä–µ–∑ create_user_session()
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ user_info
- [ ] –î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É cookie auth_token
- [ ] –í–µ—Ä–Ω—É—Ç—å auth_token + user_info –≤ –æ—Ç–≤–µ—Ç–µ
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ auth_token –≤ –æ—Ç–≤–µ—Ç–µ /api/auth/start
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π TelegramSession

---

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
