<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobRadar - Lead Monitoring SaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Landwind color palette */
            --primary: #7c3aed; /* purple-600 */
            --primary-light: #a78bfa; /* purple-400 */
            --primary-dark: #6d28d9; /* purple-700 */
            --primary-darker: #581c87; /* purple-900 */

            /* Gray scale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            /* Dark mode background */
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --dark-border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: var(--dark-bg);
            color: #e5e7eb;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: background-color 0.3s, border-color 0.3s;
        }

        body.dark-mode .sidebar {
            background: var(--dark-surface);
            border-right-color: var(--dark-border);
        }

        .sidebar-brand {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        .sidebar-brand h5 {
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: var(--gray-600);
            cursor: pointer;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        body.dark-mode .nav-link {
            color: #cbd5e1;
        }

        .nav-link:hover {
            color: var(--primary);
            background: rgba(124, 58, 237, 0.08);
        }

        body.dark-mode .nav-link:hover {
            background: rgba(124, 58, 237, 0.15);
        }

        .nav-link.active {
            color: var(--primary);
            background: rgba(124, 58, 237, 0.12);
            border-left-color: var(--primary);
            border-top: 3px solid var(--primary);
            font-weight: 600;
        }

        body.dark-mode .nav-link.active {
            background: rgba(124, 58, 237, 0.2);
        }

        .nav-link i {
            width: 20px;
        }

        /* MAIN */
        .main-content {
            margin-left: 250px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s, border-color 0.3s;
        }

        body.dark-mode .header {
            background: var(--dark-surface);
            border-bottom-color: var(--dark-border);
        }

        .header-left h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--gray-900);
        }

        body.dark-mode .header-left h3 {
            color: #e5e7eb;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--gray-600);
            position: relative;
            transition: color 0.3s;
        }

        body.dark-mode .header-btn {
            color: #cbd5e1;
        }

        .header-btn:hover {
            color: var(--primary);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        /* Profile User */
        .user-profile {
            position: relative;
        }

        .profile-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            min-width: 250px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            margin-top: 0.5rem;
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }

        body.dark-mode .profile-menu {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .profile-menu.visible {
            display: block;
            animation: slideUp 0.2s ease-out;
        }

        .profile-header {
            padding: 1rem;
            background: rgba(124, 58, 237, 0.08);
            transition: background-color 0.3s;
        }

        body.dark-mode .profile-header {
            background: rgba(124, 58, 237, 0.15);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 0.95rem;
        }

        body.dark-mode .profile-name {
            color: #e5e7eb;
        }

        .profile-phone {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        body.dark-mode .profile-phone {
            color: #cbd5e1;
        }

        .profile-menu-item {
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            color: var(--gray-600);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s;
        }

        body.dark-mode .profile-menu-item {
            color: #cbd5e1;
        }

        .profile-menu-item:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        body.dark-mode .profile-menu-item:hover {
            background: rgba(124, 58, 237, 0.15);
        }

        .profile-menu-item i {
            font-size: 1rem;
        }

        .content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--gray-50);
            transition: background-color 0.3s;
        }

        body.dark-mode .content {
            background: var(--dark-bg);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* CARDS */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        body.dark-mode .stat-card {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .stat-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .stat-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        body.dark-mode .stat-label {
            color: #94a3b8;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            transition: color 0.3s;
        }

        body.dark-mode .stat-value {
            color: #e5e7eb;
        }

        /* BUTTONS */
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-200);
            background: white;
            color: var(--gray-700);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        body.dark-mode .btn {
            background: var(--dark-surface);
            border-color: var(--dark-border);
            color: #e5e7eb;
        }

        .btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-danger {
            color: #ef4444;
        }

        .btn-danger:hover {
            color: #dc2626;
            border-color: #ef4444;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            flex: 1;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s;
        }

        body.dark-mode .modal-content {
            background: var(--dark-surface);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--gray-900);
        }

        body.dark-mode .modal-header {
            color: #e5e7eb;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--gray-600);
            transition: color 0.3s;
        }

        body.dark-mode .modal-close {
            color: #cbd5e1;
        }

        .modal-close:hover {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        body.dark-mode .form-group label {
            color: #cbd5e1;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95rem;
            background: white;
            color: var(--gray-900);
            transition: all 0.3s;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group textarea {
            background: var(--dark-border);
            border-color: var(--dark-border);
            color: #e5e7eb;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        body.dark-mode .form-group input:focus,
        body.dark-mode .form-group textarea:focus {
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .form-hint {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--gray-500);
            transition: color 0.3s;
        }

        body.dark-mode .form-hint {
            color: #94a3b8;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-actions button {
            flex: 1;
        }

        /* LEADS TABLE */
        .leads-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .leads-filters select,
        .leads-filters input {
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95rem;
            flex: 1;
            min-width: 150px;
            background: white;
            color: var(--gray-900);
            transition: all 0.3s;
        }

        body.dark-mode .leads-filters select,
        body.dark-mode .leads-filters input {
            background: var(--dark-border);
            border-color: var(--dark-border);
            color: #e5e7eb;
        }

        .leads-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lead-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            padding: 1rem;
            transition: all 0.3s;
        }

        body.dark-mode .lead-item {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .lead-text {
            font-weight: 500;
            color: var(--gray-900);
            flex: 1;
            margin-right: 1rem;
            transition: color 0.3s;
        }

        body.dark-mode .lead-text {
            color: #e5e7eb;
        }

        .lead-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .lead-status.new {
            background: #d1ecf1;
            color: #0c5460;
        }

        body.dark-mode .lead-status.new {
            background: rgba(6, 78, 94, 0.3);
            color: #a0e7e5;
        }

        .lead-status.viewed {
            background: #e2e3e5;
            color: #383d41;
        }

        body.dark-mode .lead-status.viewed {
            background: rgba(56, 61, 65, 0.3);
            color: #cbd5e1;
        }

        .lead-status.archived {
            background: #f8d7da;
            color: #721c24;
        }

        body.dark-mode .lead-status.archived {
            background: rgba(114, 28, 36, 0.3);
            color: #f87171;
        }

        .lead-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
            transition: color 0.3s;
        }

        body.dark-mode .lead-meta {
            color: #94a3b8;
        }

        .lead-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .lead-actions button {
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
        }

        /* BILLING */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .pricing-card {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }

        body.dark-mode .pricing-card {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .pricing-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .pricing-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }

        .pricing-card.current {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.05);
        }

        body.dark-mode .pricing-card.current {
            background: rgba(124, 58, 237, 0.1);
        }

        .pricing-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .pricing-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
            transition: color 0.3s;
        }

        body.dark-mode .pricing-name {
            color: #e5e7eb;
        }

        .pricing-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .pricing-features {
            text-align: left;
            margin-bottom: 1.5rem;
        }

        .pricing-features li {
            list-style: none;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            color: var(--gray-700);
            transition: color 0.3s;
        }

        body.dark-mode .pricing-features li {
            color: #cbd5e1;
        }

        .pricing-features li:before {
            content: '‚úì ';
            color: var(--primary);
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
            transition: color 0.3s;
        }

        body.dark-mode .empty-state i {
            color: #475569;
        }

        .empty-state h4 {
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        body.dark-mode .empty-state h4 {
            color: #cbd5e1;
        }

        .empty-state p {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
            transition: color 0.3s;
        }

        body.dark-mode .empty-state p {
            color: #94a3b8;
        }

        /* TOAST NOTIFICATIONS */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            pointer-events: none;
        }

        .toast {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out;
            transition: all 0.3s;
        }

        body.dark-mode .toast {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .toast.success {
            border-left: 4px solid #22c55e;
            background: #f0fdf4;
        }

        body.dark-mode .toast.success {
            background: rgba(34, 197, 94, 0.15);
            border-left-color: #4ade80;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        body.dark-mode .toast.error {
            background: rgba(239, 68, 68, 0.15);
            border-left-color: #f87171;
        }

        .toast.warning {
            border-left: 4px solid #f97316;
            background: #fffbeb;
        }

        body.dark-mode .toast.warning {
            background: rgba(249, 115, 22, 0.15);
            border-left-color: #fb923c;
        }

        .toast.info {
            border-left: 4px solid var(--primary);
            background: #f5f3ff;
        }

        body.dark-mode .toast.info {
            background: rgba(124, 58, 237, 0.15);
            border-left-color: #a78bfa;
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { color: #22c55e; }
        .toast.error .toast-icon { color: #ef4444; }
        .toast.warning .toast-icon { color: #f97316; }
        .toast.info .toast-icon { color: var(--primary); }

        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-600);
            font-size: 1.25rem;
            padding: 0;
            margin-left: auto;
            flex-shrink: 0;
            transition: color 0.3s;
        }

        body.dark-mode .toast-close {
            color: #cbd5e1;
        }

        .toast-close:hover {
            color: var(--primary);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        .toast.removing {
            animation: slideOutRight 0.3s ease-in;
        }

        /* DIALOG/MODAL */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            align-items: center;
            justify-content: center;
        }

        .dialog-overlay.visible {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dialog-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            transition: background-color 0.3s;
        }

        body.dark-mode .dialog-content {
            background: var(--dark-surface);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dialog-header {
            margin-bottom: 1.5rem;
        }

        .dialog-header h3 {
            font-size: 1.25rem;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        body.dark-mode .dialog-header h3 {
            color: #e5e7eb;
        }

        .dialog-header p {
            color: var(--gray-500);
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        body.dark-mode .dialog-header p {
            color: #94a3b8;
        }

        .dialog-body {
            margin-bottom: 1.5rem;
            color: var(--gray-700);
            transition: color 0.3s;
        }

        body.dark-mode .dialog-body {
            color: #cbd5e1;
        }

        .dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .dialog-actions button {
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            border: 1px solid var(--gray-200);
            background: white;
            color: var(--gray-700);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        body.dark-mode .dialog-actions button {
            background: var(--dark-border);
            border-color: var(--dark-border);
            color: #cbd5e1;
        }

        .dialog-actions button:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .dialog-actions .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .dialog-actions .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--gray-200);
            }

            body.dark-mode .sidebar {
                border-bottom-color: var(--dark-border);
            }

            .main-content {
                margin-left: 0;
            }

            .tasks-grid {
                grid-template-columns: 1fr;
            }

            .stat-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .toast-container {
                left: 20px;
                right: 20px;
            }

            .toast {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <h5><i class="bi bi-speedometer2"></i> JobRadar</h5>
            </div>
            <ul class="nav-menu">
                <li><a class="nav-link active" data-section="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li><a class="nav-link" data-section="tasks"><i class="bi bi-list-check"></i> –ú–æ–∏ –∑–∞–¥–∞—á–∏</a></li>
                <li><a class="nav-link" data-section="leads"><i class="bi bi-fire"></i> –õ–∏–¥—ã</a></li>
                <li><a class="nav-link" data-section="billing"><i class="bi bi-credit-card"></i> –¢–∞—Ä–∏—Ñ—ã</a></li>
                <li><a class="nav-link" data-section="settings"><i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                <li style="display: none;" id="admin-nav-item"><hr style="margin: 0.5rem 0; border: none; border-top: 1px solid #e5e7eb;"><a class="nav-link" href="/admin" style="margin-top: 0.5rem;"><i class="bi bi-shield"></i> –ê–¥–º–∏–Ω–∫–∞</a></li>
            </ul>
        </aside>

        <!-- MAIN -->
        <div class="main-content">
            <!-- HEADER -->
            <div class="header">
                <div class="header-left"></div>
                <div class="header-right">
                    <div style="position: relative;">
                        <button class="header-btn" id="notifications-btn" onclick="toggleNotificationsMenu()">
                            <i class="bi bi-bell"></i>
                            <span class="badge-count" id="notification-count" style="display: none;"></span>
                        </button>
                        <div class="notifications-menu" id="notifications-menu" style="
                            display: none;
                            position: absolute;
                            top: 100%;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            min-width: 300px;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                            z-index: 1000;
                            margin-top: 0.5rem;
                        ">
                            <div style="padding: 1rem; border-bottom: 1px solid #eee; font-weight: 600;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                            <div id="notifications-list" style="max-height: 400px; overflow-y: auto;"></div>
                            <button class="btn btn-primary" style="width: 100%; margin: 0;" onclick="switchToSection('leads'); toggleNotificationsMenu();">
                                –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ª–∏–¥—ã
                            </button>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button class="header-btn" id="profile-btn" onclick="toggleProfileMenu()">
                            <i class="bi bi-person-circle"></i>
                        </button>
                        <div class="profile-menu" id="profile-menu">
                            <div class="profile-header">
                                <div class="profile-info">
                                    <div class="profile-name" id="profile-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                    <div class="profile-phone" id="profile-phone">-</div>
                                </div>
                            </div>
                            <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid #e5e7eb;">
                            <button class="profile-menu-item" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> –í—ã—Ö–æ–¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BREADCRUMBS NAVIGATION -->
            <nav id="breadcrumbs" style="
                font-size: 0.9rem;
                color: #6b7280;
                padding: 0.75rem 2rem;
                background: white;
                border-bottom: 1px solid #e5e7eb;
                margin-bottom: 0;
            ">
                <span style="color: #5856d6; font-weight: 600;">–î–∞—à–±–æ—Ä–¥</span>
            </nav>

            <!-- CONTENT -->
            <div class="content">
                <!-- DISABLED ACCOUNT ALERT -->
                <div id="disabledAccountAlert" style="display: none; background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.375rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <i class="bi bi-exclamation-triangle" style="color: #ef4444; font-size: 1.25rem; flex-shrink: 0; margin-top: 0.125rem;"></i>
                        <div>
                            <p style="font-weight: 600; color: #991b1b; margin: 0 0 0.25rem 0;">–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω</p>
                            <p style="color: #7f1d1d; margin: 0; font-size: 0.9rem;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫–ª—é—á–∏–ª –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å–æ —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏.</p>
                        </div>
                    </div>
                </div>

                <!-- DASHBOARD SECTION -->
                <section id="dashboard" class="content-section active">
                    <div class="stat-cards">
                        <div class="stat-card">
                            <div class="stat-label">Active Tasks</div>
                            <div class="stat-value" id="stat-tasks">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sources</div>
                            <div class="stat-value" id="stat-sources">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Keywords</div>
                            <div class="stat-value" id="stat-keywords">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Leads Today</div>
                            <div class="stat-value" id="stat-leads">0</div>
                        </div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 1rem;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–∏–¥—ã</h4>
                        <div id="recent-leads" style="display: flex; flex-direction: column; gap: 1rem;"></div>
                    </div>
                </section>

                <!-- TASKS SECTION -->
                <section id="tasks" class="content-section">
                    <div class="flex justify-between items-center mb-8">
                        <h4 class="text-2xl font-semibold">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h4>
                        <button class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" onclick="openTaskModal()">
                            <i class="bi bi-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                        </button>
                    </div>
                    <div id="tasks-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </section>

                <!-- LEADS SECTION -->
                <section id="leads" class="content-section" style="background: #f7f8fb; padding: 2rem 1rem;">
                    <!-- –§–∏–ª—å—Ç—Ä—ã –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ -->
                    <div style="
                        max-width: 820px;
                        margin: 0 auto 2rem;
                        display: flex;
                        gap: 1rem;
                        flex-wrap: wrap;
                    ">
                        <select id="filter-task" style="
                            flex: 1;
                            min-width: 150px;
                            padding: 0.6rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 0.9rem;
                        ">
                            <option value="">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
                        </select>
                        <select id="filter-status" style="
                            flex: 1;
                            min-width: 150px;
                            padding: 0.6rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 0.9rem;
                        ">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="new">–ù–æ–≤—ã–µ</option>
                            <option value="viewed">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ</option>
                        </select>
                        <input type="text" id="filter-search" placeholder="–ò—Å–∫–∞—Ç—å –ª–∏–¥—ã..." style="
                            flex: 1;
                            min-width: 200px;
                            padding: 0.6rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 0.9rem;
                        ">
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ª–∏–¥–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ª–µ–π–∞—É—Ç–æ–º -->
                    <div style="
                        max-width: 820px;
                        margin: 0 auto;
                    ">
                        <div id="leads-container" class="leads-list"></div>
                    </div>
                </section>

                <!-- BILLING SECTION -->
                <section id="billing" class="content-section">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</h4>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem;">Trial (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</div>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 3 –¥–Ω—è. –û–±–Ω–æ–≤–∏—Ç–µ—Å—å –Ω–∞ –ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –∑–∞–¥–∞—á.</p>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.9rem; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-weight: 600;">1 –ó–∞–¥–∞—á–∞</div>
                                <div style="color: var(--text-light); font-size: 0.85rem;">–ú–∞–∫—Å–∏–º—É–º</div>
                            </div>
                            <div>
                                <div style="font-weight: 600;">–î–æ 10 –∫–∞–Ω–∞–ª–æ–≤</div>
                                <div style="color: var(--text-light); font-size: 0.85rem;">–í –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showToast('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞ –ø–ª–∞—Ç–Ω—ã–π</button>
                    </div>

                    <div style="background: #f0f3ff; padding: 1.5rem; border-radius: 8px; border: 1px solid #d0deff; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 0.5rem;">üéØ –ù–∞—á–Ω–∏—Ç–µ —Å Trial</h4>
                        <p style="color: #5850d6; font-size: 0.95rem; margin: 0;">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –¥–Ω–µ–π. 1 –∑–∞–¥–∞—á–∞ —Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤. –î–æ 10 –∫–∞–Ω–∞–ª–æ–≤ –≤ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ. Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.</p>
                    </div>

                    <h4 style="margin-bottom: 1rem;">–ü–ª–∞—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã</h4>
                    <div class="pricing-grid">
                        <div class="pricing-card">
                            <div class="pricing-name">Start</div>
                            <div class="pricing-price">990 ‚ÇΩ</div>
                            <div style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">–≤ –º–µ—Å—è—Ü</div>
                            <ul class="pricing-features">
                                <li>1 –∑–∞–¥–∞—á–∞</li>
                                <li>–î–æ 10 –∫–∞–Ω–∞–ª–æ–≤ –≤ –∑–∞–¥–∞—á–µ</li>
                                <li>Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                            </ul>
                            <button class="btn btn-primary" onclick="showToast('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">–í—ã–±—Ä–∞—Ç—å</button>
                        </div>

                        <div class="pricing-card">
                            <div class="pricing-badge">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</div>
                            <div class="pricing-name">Pro</div>
                            <div class="pricing-price">1 990 ‚ÇΩ</div>
                            <div style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">–≤ –º–µ—Å—è—Ü</div>
                            <ul class="pricing-features">
                                <li>–î–æ 3 –∑–∞–¥–∞—á</li>
                                <li>–î–æ 10 –∫–∞–Ω–∞–ª–æ–≤ –≤ –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–µ</li>
                                <li>Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                            </ul>
                            <button class="btn btn-primary" onclick="showToast('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">–í—ã–±—Ä–∞—Ç—å</button>
                        </div>

                        <div class="pricing-card">
                            <div class="pricing-name">Business</div>
                            <div class="pricing-price">4 990 ‚ÇΩ</div>
                            <div style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">–≤ –º–µ—Å—è—Ü</div>
                            <ul class="pricing-features">
                                <li>–î–æ 6 –∑–∞–¥–∞—á</li>
                                <li>–î–æ 10 –∫–∞–Ω–∞–ª–æ–≤ –≤ –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–µ</li>
                                <li>Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                            </ul>
                            <button class="btn btn-primary" onclick="showToast('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">–í—ã–±—Ä–∞—Ç—å</button>
                        </div>
                    </div>
                </section>

                <!-- SETTINGS SECTION -->
                <section id="settings" class="content-section">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">–ê–∫–∫–∞—É–Ω—Ç</h4>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ê–∫–∫–∞—É–Ω—Ç Telegram</label>
                            <div id="telegram-account-status"></div>
                        </div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h4>
                        <p style="color: var(--text-gray); margin-bottom: 1rem; font-size: 0.9rem;">–ù–æ–≤—ã–µ –ª–∏–¥—ã:</p>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="checkbox-group">
                                <input type="checkbox" id="notify-personal" checked>
                                <span>–ü—Ä–∏—Å—ã–ª–∞—Ç—å –≤ –º–æ–π –ª–∏—á–Ω—ã–π —á–∞—Ç</span>
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>

                    <div style="background: #fff5f5; padding: 1.5rem; border-radius: 8px; border: 1px solid #fdd; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: #d32f2f;">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h4>
                        <button class="btn btn-danger" onclick="showDeleteConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => showToast('–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'))">
                            <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toast-container"></div>

    <!-- DIALOG -->
    <div class="dialog-overlay" id="delete-dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            </div>
            <div class="dialog-body" id="delete-dialog-message"></div>
            <div class="dialog-actions">
                <button onclick="closeDeleteDialog()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal-title">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</span>
                <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="task-form">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                    <input type="text" id="task-name" required>
                </div>

                <div class="form-group">
                    <label>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ (–∫–∞–Ω–∞–ª—ã/—á–∞—Ç—ã)</label>
                    <textarea id="task-sources" placeholder="telegram.me/channel&#10;https://t.me/+xxxxx&#10;–ü–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ"></textarea>
                    <span class="form-hint">–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã Telegram, –ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫—É</span>
                </div>

                <div class="form-group">
                    <label>–í–∫–ª—é—á–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ *</label>
                    <textarea id="task-include" placeholder="python&#10;remote&#10;–ü–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ" required></textarea>
                    <span class="form-hint">–ù–∞–π—Ç–∏ –ª–∏–¥—ã —Å —ç—Ç–∏–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏</span>
                </div>

                <div class="form-group">
                    <label>–ò—Å–∫–ª—é—á–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                    <textarea id="task-exclude" placeholder="junior&#10;internship&#10;–ü–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ"></textarea>
                    <span class="form-hint">–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥—ã —Å —ç—Ç–∏–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏</span>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== UI COMPONENTS ====================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'bi-check-circle',
                error: 'bi-exclamation-circle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle'
            };

            toast.innerHTML = `
                <i class="bi ${icons[type]} toast-icon"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        let deletePendingCallback = null;

        function showDeleteConfirm(message, onConfirm) {
            deletePendingCallback = onConfirm;
            document.getElementById('delete-dialog-message').textContent = message;
            document.getElementById('delete-dialog-overlay').classList.add('visible');
        }

        function closeDeleteDialog() {
            document.getElementById('delete-dialog-overlay').classList.remove('visible');
            deletePendingCallback = null;
        }

        function confirmDelete() {
            if (deletePendingCallback) {
                deletePendingCallback();
            }
            closeDeleteDialog();
        }

        // ==================== API FUNCTIONS ====================
        const API_BASE = '';

        async function getTasks() {
            try {
                const response = await fetch(`${API_BASE}/api/tasks`, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch tasks');
                return await response.json();
            } catch (error) {
                console.error('Error fetching tasks:', error);
                return [];
            }
        }

        async function getLeads(page = 1, limit = 20, status = null) {
            try {
                let url = `${API_BASE}/api/leads?page=${page}&limit=${limit}`;
                if (status && status !== "") {
                    url += `&status=${encodeURIComponent(status)}`;
                }
                const response = await fetch(url, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch leads');
                return await response.json();
            } catch (error) {
                console.error('Error fetching leads:', error);
                return { leads: [], has_more: false };
            }
        }

        async function markAllLeadsAsRead() {
            try {
                const response = await fetch(`${API_BASE}/api/leads/mark-read`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to mark leads as read');
                return await response.json();
            } catch (error) {
                console.error('Error marking leads as read:', error);
                return null;
            }
        }

        async function getUnreadCount() {
            try {
                const response = await fetch(`${API_BASE}/api/leads/unread-count`, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch unread count');
                return await response.json();
            } catch (error) {
                console.error('Error fetching unread count:', error);
                return { count: 0 };
            }
        }

        async function getStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch stats');
                return await response.json();
            } catch (error) {
                console.error('Error fetching stats:', error);
                return {
                    active_tasks: 0,
                    total_tasks: 0,
                    total_sources: 0,
                    total_keywords: 0,
                    total_matches: 0
                };
            }
        }

        async function createTask(taskData) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                if (!response.ok) throw new Error('Failed to create task');
                return await response.json();
            } catch (error) {
                console.error('Error creating task:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏: ' + error.message, 'error');
                return null;
            }
        }

        async function updateTask(taskId, taskData) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                if (!response.ok) throw new Error('Failed to update task');
                return await response.json();
            } catch (error) {
                console.error('Error updating task:', error);
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ' + error.message, 'error');
                return null;
            }
        }

        async function deleteTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to delete task');
                return await response.json();
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ' + error.message, 'error');
                return null;
            }
        }

        // ==================== NAVIGATION & HASH MANAGEMENT ====================
        let leadsPollingInterval = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è breadcrumbs
        function updateBreadcrumbs(breadcrumbsArray) {
            const breadcrumbsNav = document.getElementById('breadcrumbs');
            breadcrumbsNav.innerHTML = breadcrumbsArray.map((item, index) => {
                if (item.href) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ hash, hashchange handler —Å–¥–µ–ª–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ
                    return `<a href="#${item.href}" style="color: #5856d6; text-decoration: none; cursor: pointer;">${item.label}</a>${index < breadcrumbsArray.length - 1 ? '<span style="margin: 0 0.5rem; color: #d1d5db;">/</span>' : ''}`;
                } else {
                    return `<span style="color: #${index === breadcrumbsArray.length - 1 ? '5856d6; font-weight: 600;' : '6b7280;'}">${item.label}</span>${index < breadcrumbsArray.length - 1 ? '<span style="margin: 0 0.5rem; color: #d1d5db;">/</span>' : ''}`;
                }
            }).join('');
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π hash
        async function switchToSection(section) {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å hash –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ hashchange)
            if (window.location.hash.substring(1) !== section) {
                window.location.hash = section;
            }

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—É–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å display:none –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç displayLeadPage)
            document.querySelectorAll('.content-section').forEach(el => el.style.display = '');

            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            const titles = {
                dashboard: '–î–∞—à–±–æ—Ä–¥',
                tasks: '–ú–æ–∏ –∑–∞–¥–∞—á–∏',
                leads: '–õ–∏–¥—ã',
                billing: '–¢–∞—Ä–∏—Ñ—ã',
                settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
            };

            // –û–±–Ω–æ–≤–∏—Ç—å breadcrumbs
            updateBreadcrumbs([{ label: titles[section] }]);

            // –ó–∞–ø—É—Å—Ç–∏—Ç—å polling —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ Leads
            if (section === 'leads') {
                loadLeads();
                startLeadsPolling();
            } else {
                stopLeadsPolling();
            }

            // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –ú–æ–∏ –∑–∞–¥–∞—á–∏
            if (section === 'tasks') renderTasks();

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ Settings
            if (section === 'settings') loadUserSettings();
        }

        // –ó–∞–ø—É—Å–∫ polling –ª–∏–¥–æ–≤ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        function startLeadsPolling() {
            if (leadsPollingInterval) return; // –£–∂–µ –∑–∞–ø—É—â–µ–Ω
            leadsPollingInterval = setInterval(() => {
                const section = window.location.hash.substring(1) || 'dashboard';
                if (section === 'leads') {
                    loadLeads();
                }
            }, 3000);
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ polling –ª–∏–¥–æ–≤
        function stopLeadsPolling() {
            if (leadsPollingInterval) {
                clearInterval(leadsPollingInterval);
                leadsPollingInterval = null;
            }
        }

        // –ö–ª–∏–∫–∏ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å hash –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
        document.querySelectorAll('[data-section]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                window.location.hash = section;
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è hash (F5, –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ, –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥)
        async function handleHashChange() {
            const hash = window.location.hash.substring(1) || 'dashboard';

            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å–ª–∏ —ç—Ç–æ lead/ID
            if (hash.startsWith('lead/')) {
                const leadId = parseInt(hash.split('/')[1]);

                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ª–∏–¥ —á–µ—Ä–µ–∑ displayLeadPage
                await displayLeadPage(leadId);
            } else {
                // –û–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏
                switchToSection(hash);
            }
        }

        window.addEventListener('hashchange', handleHashChange);

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É –∏–∑ hash
        document.addEventListener('DOMContentLoaded', async () => {
            await handleHashChange();
        });

        // ==================== TASK MANAGEMENT ====================
        let currentEditTaskId = null;

        async function openTaskModal(taskId = null) {
            currentEditTaskId = taskId;
            const modal = document.getElementById('task-modal');
            const form = document.getElementById('task-form');

            form.reset();

            if (taskId) {
                // Fetch the specific task
                try {
                    const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Failed to fetch task');
                    const task = await response.json();

                    document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
                    document.getElementById('task-name').value = task.name;
                    document.getElementById('task-sources').value = task.sources;
                    document.getElementById('task-include').value = task.include_keywords;
                    document.getElementById('task-exclude').value = task.exclude_keywords || '';
                } catch (error) {
                    console.error('Error loading task:', error);
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏', 'error');
                    return;
                }
            } else {
                document.getElementById('modal-title').textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
            }

            modal.classList.add('active');
        }

        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('active');
            currentEditTaskId = null;
        }

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('task-name').value.trim();
            const sources = document.getElementById('task-sources').value.trim();
            const include = document.getElementById('task-include').value.trim();
            const exclude = document.getElementById('task-exclude').value.trim();

            if (!name) {
                showToast('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', 'warning');
                return;
            }

            if (!include) {
                showToast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤–∫–ª—é—á–∞—é—â–µ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ', 'warning');
                return;
            }

            const taskData = {
                name: name,
                status: 'running',
                sources: sources,
                include_keywords: include,
                exclude_keywords: exclude
            };

            let result;
            if (currentEditTaskId) {
                result = await updateTask(currentEditTaskId, taskData);
            } else {
                result = await createTask(taskData);
            }

            if (result) {
                closeTaskModal();
                await renderTasks();
                await updateStats();
                showToast(currentEditTaskId ? '–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
            }
        });

        async function deleteTaskHandler(taskId) {
            showDeleteConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', async () => {
                const result = await deleteTask(taskId);
                if (result) {
                    await renderTasks();
                    await updateStats();
                    showToast('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                }
            });
        }

        async function toggleTaskStatus(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to fetch task');
                const task = await response.json();

                const newStatus = task.status === 'running' ? 'paused' : 'running';
                const result = await updateTask(taskId, { status: newStatus });

                if (result) {
                    await renderTasks();
                }
            } catch (error) {
                console.error('Error toggling task status:', error);
            }
        }

        async function renderTasks() {
            const tasks = await getTasks();
            const container = document.getElementById('tasks-container');

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                        <h4 class="text-xl font-semibold text-gray-900 mb-2">–ù–µ—Ç –∑–∞–¥–∞—á</h4>
                        <p class="text-gray-600 mb-4">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
                        <button class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" onclick="openTaskModal()">
                            <i class="bi bi-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                        </button>
                    </div>
                `;
                return;
            }

            const countItems = (str) => str ? str.split(',').filter(s => s.trim()).length : 0;

            container.innerHTML = tasks.map(task => {
                const sources = countItems(task.sources);
                const includes = countItems(task.include_keywords);
                const excludes = countItems(task.exclude_keywords);
                const isRunning = task.status === 'running';
                const statusColor = isRunning
                    ? 'bg-emerald-100 text-emerald-700'
                    : 'bg-gray-200 text-gray-600';

                return `
                    <div class="bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all duration-200 p-5 hover:-translate-y-0.5">
                        <!-- Gradient –ø–æ–ª–æ—Å–∫–∞ -->
                        <div class="h-1 bg-gradient-to-r from-indigo-500 via-sky-500 to-cyan-400 rounded-t-2xl -mx-5 -mt-5 mb-4"></div>

                        <!-- Header -->
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(task.name)}</h3>
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusColor}">
                                ${isRunning ? 'üü¢ –†–∞–±–æ—Ç–∞–µ—Ç' : '‚è∏ –ü–∞—É–∑–∞'}
                            </span>
                        </div>

                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <div class="flex gap-3 mb-4">
                            <div class="flex-1 bg-gray-50 rounded-xl p-3 text-center hover:bg-gray-100 transition">
                                <div class="text-xl font-bold text-indigo-600">üì°${sources}</div>
                                <div class="text-xs text-gray-500 mt-1">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</div>
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-xl p-3 text-center hover:bg-gray-100 transition">
                                <div class="text-xl font-bold text-indigo-600">‚ûï${includes}</div>
                                <div class="text-xs text-gray-500 mt-1">–í–∫–ª—é—á–∏—Ç—å</div>
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-xl p-3 text-center hover:bg-gray-100 transition">
                                <div class="text-xl font-bold text-indigo-600">‚ûñ${excludes}</div>
                                <div class="text-xs text-gray-500 mt-1">–ò—Å–∫–ª—é—á–∏—Ç—å</div>
                            </div>
                        </div>

                        <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                        <div class="border-t border-gray-100 my-4"></div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="flex gap-2">
                            <button onclick="toggleTaskStatus(${task.id})" class="h-9 px-3 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg text-sm font-medium transition active:scale-95">
                                ‚è∏ ${isRunning ? '–ü–∞—É–∑–∞' : '–ó–∞–ø—É—Å–∫'}
                            </button>
                            <button onclick="openTaskModal(${task.id})" class="h-9 px-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition active:scale-95">
                                ‚úè –†–µ–¥–∞–∫—Ç
                            </button>
                            <button onclick="deleteTaskHandler(${task.id})" class="h-9 px-3 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-sm font-medium transition active:scale-95">
                                üóë
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== LEADS MANAGEMENT ====================

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–∏–¥–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞
        function renderLeadCard(lead, taskName) {
            const foundDate = new Date(lead.found_at).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // –û–±—Ä–µ–∑–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–æ 3 —Å—Ç—Ä–æ–∫ (~180 —Å–∏–º–≤–æ–ª–æ–≤)
            let displayText = lead.text.replace(/\n+/g, ' ').trim();
            if (displayText.length > 180) {
                displayText = displayText.substring(0, 180) + '...';
            }

            // –°—Ç–∏–ª—å –¥–ª—è –Ω–æ–≤—ã—Ö –ª–∏–¥–æ–≤ (status='new')
            const isNew = lead.status === 'new';
            const cardBgColor = isNew ? '#FFFBEB' : 'white';
            const cardBorderColor = isNew ? '#FCD34D' : '#e5e7eb';
            const cardBorderLeft = isNew ? '4px solid #F59E0B' : 'none';

            return `
                <div class="lead-card" data-lead-id="${lead.id}" style="
                    background: ${cardBgColor};
                    border-radius: 12px;
                    border: 1px solid ${cardBorderColor};
                    border-left: ${cardBorderLeft};
                    padding: 12px;
                    margin-bottom: 10px;
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                    transition: all 0.2s ease;
                    cursor: pointer;
                    display: grid;
                    grid-template-columns: 1fr auto;
                    gap: 8px;
                    align-items: start;
                ">
                    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ª–∏–¥–∞) -->
                    <div style="min-width: 0; overflow: hidden;">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫: –∏—Å—Ç–æ—á–Ω–∏–∫ + –¥–∞—Ç–∞ -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 6px;
                            gap: 8px;
                        ">
                            <span style="color: #5856d6; font-weight: 600; font-size: 12px; flex-shrink: 0;">
                                ${lead.source_channel}
                            </span>
                            <span style="color: #9ca3af; font-size: 11px; flex-shrink: 0; display: flex; align-items: center; gap: 4px;">
                                ${isNew ? '<span style="width: 6px; height: 6px; background: #F59E0B; border-radius: 50%;"></span>' : ''}
                                ${foundDate}
                            </span>
                        </div>

                        <!-- –û–±—Ä–µ–∑–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç -->
                        <div style="
                            color: #374151;
                            font-size: 13px;
                            line-height: 1.4;
                            text-overflow: ellipsis;
                            overflow: hidden;
                        ">
                            ${linkifyText(displayText)}
                        </div>

                        <!-- –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                        ${lead.matched_keyword ? `
                            <div style="
                                color: #9ca3af;
                                font-size: 11px;
                                margin-top: 4px;
                            ">
                                –∫–ª—é—á: <strong>${escapeHtml(lead.matched_keyword)}</strong>
                            </div>
                        ` : ''}
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                    <button
                        class="delete-lead-btn"
                        data-lead-id="${lead.id}"
                        onclick="event.stopPropagation(); deleteLead(${lead.id})"
                        style="
                            background: none;
                            border: none;
                            cursor: pointer;
                            font-size: 18px;
                            color: #9ca3af;
                            flex-shrink: 0;
                            transition: color 0.2s;
                            padding: 4px;
                            line-height: 1;
                        "
                        onmouseover="this.style.color='#dc2626'"
                        onmouseout="this.style.color='#9ca3af'"
                        title="–£–¥–∞–ª–∏—Ç—å">
                        üóë
                    </button>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –≤ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        function linkifyText(text) {
            let safe = escapeHtml(text);

            // –°—Å—ã–ª–∫–∏ https://... –∏ http://...
            safe = safe.replace(
                /(https?:\/\/[^\s]+)/g,
                '<a href="$1" target="_blank" style="color: #5856d6; text-decoration: underline;">$1</a>'
            );

            // –°—Å—ã–ª–∫–∏ t.me/...
            safe = safe.replace(
                /(t\.me\/[^\s]+)/g,
                '<a href="https://$1" target="_blank" style="color: #5856d6; text-decoration: underline;">$1</a>'
            );

            // @username
            safe = safe.replace(
                /@([a-zA-Z0-9_]+)/g,
                '<a href="https://t.me/$1" target="_blank" style="color: #5856d6; text-decoration: underline;">@$1</a>'
            );

            return safe;
        }

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ –¥–µ–±–∞—É–Ω—Å–∞
        let leadsState = {
            page: 1,
            limit: 20,
            isLoading: false,
            hasMore: true,
            allLeads: []
        };

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ª–∏–¥–æ–≤
        async function loadLeads(reset = true) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
            if (leadsState.isLoading) return;
            leadsState.isLoading = true;

            const container = document.getElementById('leads-container');

            try {
                if (reset) {
                    leadsState.page = 1;
                    leadsState.allLeads = [];
                }

                // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏
                const statusFilter = document.getElementById('filter-status')?.value || '';

                const response = await getLeads(leadsState.page, leadsState.limit, statusFilter);
                const leads = response.leads || [];
                leadsState.hasMore = response.has_more || false;

                // DEBUG: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç API
                console.log(`[DEBUG] –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${leads.length} –ª–∏–¥–æ–≤, —Å—Ç–∞—Ç—É—Å —Ñ–∏–ª—å—Ç—Ä–∞: "${statusFilter}", first lead status:`, leads[0]?.status);

                // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ª–∏–¥—ã –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                leadsState.allLeads = leadsState.allLeads.concat(leads);

                const tasks = await getTasks();

                // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const taskFilter = document.getElementById('filter-task')?.value || '';
                const searchFilter = document.getElementById('filter-search')?.value.toLowerCase() || '';

                // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∫ –í–°–ï –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –ª–∏–¥–∞–º
                let filtered = leadsState.allLeads;

                if (taskFilter) {
                    filtered = filtered.filter(lead => lead.task_id === parseInt(taskFilter));
                }

                if (searchFilter) {
                    filtered = filtered.filter(lead =>
                        lead.text.toLowerCase().includes(searchFilter) ||
                        lead.source_channel.toLowerCase().includes(searchFilter) ||
                        (lead.matched_keyword && lead.matched_keyword.toLowerCase().includes(searchFilter))
                    );
                }

                // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
                if (statusFilter) {
                    filtered = filtered.filter(lead => lead.status === statusFilter);
                }

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                filtered.sort((a, b) => new Date(b.found_at) - new Date(a.found_at));

                // –ï—Å–ª–∏ –Ω–µ—Ç –ª–∏–¥–æ–≤ - –ø–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (leadsState.allLeads.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üî•</div>
                            <h4>–õ–∏–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</h4>
                            <p style="color: #888;">–õ–∏–¥—ã –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
                        </div>
                    `;
                    return;
                }

                // –ï—Å–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª–æ—Å—å 0 –ª–∏–¥–æ–≤
                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                            <h4>–õ–∏–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                            <p style="color: #888;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                        </div>
                    `;
                    return;
                }

                // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å HTML –∫–∞—Ä—Ç–æ—á–µ–∫ –ª–∏–¥–æ–≤
                let html = '';
                filtered.forEach(lead => {
                    const taskName = tasks.find(t => t.id === lead.task_id)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞';
                    html += renderLeadCard(lead, taskName);
                });

                container.innerHTML = html;

                // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ª–∏–¥–∞
                document.querySelectorAll('.lead-card').forEach(card => {
                    card.addEventListener('click', async (e) => {
                        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                        const leadId = card.getAttribute('data-lead-id');
                        openLeadPage(leadId);
                    });

                    // –î–æ–±–∞–≤–∏—Ç—å hover —ç—Ñ—Ñ–µ–∫—Ç
                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'translateY(-1px)';
                        card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                        card.style.backgroundColor = '#f9fafb';
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'translateY(0)';
                        card.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                        card.style.backgroundColor = 'white';
                    });
                });

                // –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –µ—â—ë –ª–∏–¥—ã
                if (leadsState.hasMore) {
                    const paginationHtml = `
                        <div style="text-align: center; margin-top: 1rem; padding: 1rem;">
                            <button class="btn btn-primary" id="load-more-btn" onclick="loadMoreLeads()" style="padding: 0.6rem 1.5rem;">
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë
                            </button>
                        </div>
                    `;
                    container.innerHTML += paginationHtml;
                }

            } catch (error) {
                console.error('Error loading leads:', error);
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                        <h4>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
                        <p style="color: #888;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                    </div>
                `;
            } finally {
                leadsState.isLoading = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–µ –ª–∏–¥–æ–≤
        async function loadMoreLeads() {
            leadsState.page += 1;
            loadLeads(false);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏–¥–∞
        async function openLeadPage(leadId) {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å hash - —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç handleHashChange
            // –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∑–∏—Ç –ª–∏–¥ —Å API –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.hash = `lead/${leadId}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏–¥–∞
        async function displayLeadPage(leadId) {
            try {
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–¥ —Å API
                const response = await fetch(`${API_BASE}/api/leads/${leadId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    showToast('–õ–∏–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    window.location.hash = 'leads';
                    return;
                }

                const lead = await response.json();

                const foundDate = new Date(lead.found_at).toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const channelUsername = lead.source_channel.replace('@', '');
                const telegramProfileUrl = `https://t.me/${channelUsername}`;

                // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
                document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));

                // –û–±–Ω–æ–≤–∏—Ç—å breadcrumbs
                updateBreadcrumbs([
                    { label: '–õ–∏–¥—ã', href: 'leads' },
                    { label: `–õ–∏–¥ #${lead.id}` }
                ]);

                // –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏–¥–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                let leadPageContainer = document.getElementById('lead-page-section');
                if (!leadPageContainer) {
                    leadPageContainer = document.createElement('div');
                    leadPageContainer.id = 'lead-page-section';
                    leadPageContainer.className = 'content-section active';
                    leadPageContainer.style.display = 'block';
                    document.querySelector('.content').appendChild(leadPageContainer);
                } else {
                    leadPageContainer.classList.add('active');
                    leadPageContainer.style.display = 'block';
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ø–æ—Å—Ç
                const postUrl = lead.source_url || telegramProfileUrl;
                const isDirectPostLink = lead.source_url ? true : false;

                leadPageContainer.innerHTML = `

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ª–∏–¥–∞ -->
                    <div style="
                        background: white;
                        border-radius: 12px;
                        border: 1px solid #e5e7eb;
                        padding: 2rem;
                        max-width: 800px;
                    ">
                        <!-- Header -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: start;
                            margin-bottom: 1.5rem;
                            padding-bottom: 1rem;
                            border-bottom: 1px solid #e5e7eb;
                        ">
                            <div>
                                ${isDirectPostLink ? `
                                <a href="${postUrl}" target="_blank" style="
                                    margin: 0 0 0.5rem 0;
                                    font-size: 1.5rem;
                                    font-weight: 700;
                                    color: #5856d6;
                                    text-decoration: none;
                                    display: inline-block;
                                ">
                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç—É –≤ Telegram ‚Üí
                                </a>
                                ` : `
                                <h2 style="
                                    margin: 0 0 0.5rem 0;
                                    font-size: 1.5rem;
                                    font-weight: 700;
                                    color: #111827;
                                ">
                                    –õ–∏–¥ #${lead.id}
                                </h2>
                                `}
                                <div style="
                                    display: flex;
                                    gap: 1.5rem;
                                    font-size: 0.9rem;
                                    color: #6b7280;
                                ">
                                    <div>
                                        <strong style="color: #111827;">–ò—Å—Ç–æ—á–Ω–∏–∫:</strong>
                                        <a href="${telegramProfileUrl}" target="_blank" style="
                                            color: #5856d6;
                                            text-decoration: none;
                                            margin-left: 0.5rem;
                                        ">
                                            ${lead.source_channel}
                                        </a>
                                    </div>
                                    <div>
                                        <strong style="color: #111827;">–î–∞—Ç–∞:</strong>
                                        <span style="margin-left: 0.5rem;">${foundDate}</span>
                                    </div>
                                </div>
                            </div>
                            <button
                                onclick="deleteLead(${lead.id}, true)"
                                style="
                                    background: #fee2e2;
                                    color: #dc2626;
                                    border: 1px solid #fecaca;
                                    padding: 0.5rem 0.75rem;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    flex-shrink: 0;
                                    font-size: 1.2rem;
                                    line-height: 1;
                                "
                                onmouseover="this.style.background='#fecaca'"
                                onmouseout="this.style.background='#fee2e2'"
                                title="–£–¥–∞–ª–∏—Ç—å –ª–∏–¥">
                                üóë
                            </button>
                        </div>

                        <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
                        <div id="lead-content-div" style="
                            font-size: 1rem;
                            line-height: 1.6;
                            color: #374151;
                            white-space: pre-line;
                            word-break: break-word;
                            margin-bottom: 1.5rem;
                            padding: 1.5rem;
                            background: #f9fafb;
                            border-radius: 8px;
                        "></div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
                        ${lead.matched_keyword ? `
                            <div style="
                                font-size: 0.9rem;
                                color: #6b7280;
                                padding-top: 1rem;
                                border-top: 1px solid #e5e7eb;
                            ">
                                <strong style="color: #111827;">–°–æ–≤–ø–∞–≤—à–µ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ:</strong>
                                <span style="margin-left: 0.5rem; color: #5856d6; font-weight: 600;">
                                    ${escapeHtml(lead.matched_keyword)}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `;

                // –í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å linkify –≤ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                setTimeout(() => {
                    const contentDiv = document.getElementById('lead-content-div');
                    if (contentDiv) {
                        contentDiv.innerHTML = linkifyText(lead.text);
                    }
                }, 0);

                // –ü–æ–º–µ—Ç–∏—Ç—å –ª–∏–¥ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π
                fetch(`${API_BASE}/api/leads/${leadId}/viewed`, {
                    method: 'PUT',
                    credentials: 'include'
                }).catch(() => {}); // Silently ignore errors
            } catch (error) {
                console.error('Error displaying lead:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–∞', 'error');
                window.location.hash = 'leads';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ª–∏–¥–∞
        async function deleteLead(leadId, fromPage = false) {
            showDeleteConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ª–∏–¥? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/leads/${leadId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (!response.ok) throw new Error('Failed to delete lead');

                    showToast('–õ–∏–¥ —É–¥–∞–ª—ë–Ω', 'success');

                    if (fromPage) {
                        // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏–¥–∞ - –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–ø–∏—Å–æ–∫
                        switchToSection('leads');
                    } else {
                        // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ - —É–±—Ä–∞—Ç—å –∏–∑ DOM
                        const card = document.querySelector(`[data-lead-id="${leadId}"]`);
                        if (card) {
                            card.style.opacity = '0';
                            card.style.transform = 'translateX(-20px)';
                            setTimeout(() => card.remove(), 200);
                        }
                        // –£–¥–∞–ª–∏—Ç—å –∏–∑ leadsState
                        leadsState.allLeads = leadsState.allLeads.filter(l => l.id !== parseInt(leadId));
                    }
                } catch (error) {
                    console.error('Error deleting lead:', error);
                    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ª–∏–¥–∞', 'error');
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –ª–∏–¥–∞ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ
        async function markLeadAsViewed(leadId) {
            try {
                await fetch(`${API_BASE}/api/leads/${leadId}/viewed`, {
                    method: 'PUT',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Error marking lead as viewed:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ –∫ –ª–∏–¥—É –ø–æ ID
        function scrollToLead(leadId) {
            const card = document.querySelector(`[data-lead-id="${leadId}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Highlight —ç—Ñ—Ñ–µ–∫—Ç
                card.style.backgroundColor = '#fffacd';
                setTimeout(() => {
                    card.style.backgroundColor = 'white';
                }, 1500);
            }
        }

        // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è renderLeads –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç loadLeads)
        async function renderLeads(page = 1) {
            loadLeads();
        }

        async function setLeadStatus(leadId, status) {
            // TODO: Implement when leads API is ready
            console.log('Set lead status:', leadId, status);
        }

        async function updateStats() {
            const stats = await getStats();

            document.getElementById('stat-tasks').textContent = stats.active_tasks;
            document.getElementById('stat-sources').textContent = stats.total_sources;
            document.getElementById('stat-keywords').textContent = stats.total_keywords;
            document.getElementById('stat-leads').textContent = stats.total_matches;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ª–∏–¥–æ–≤ –¥–ª—è Dashboard
            const response = await getLeads(1, 5);
            const recentLeads = response.leads || [];
            const tasks = await getTasks();

            const recentLeadsContainer = document.getElementById('recent-leads');

            if (recentLeads.length === 0) {
                recentLeadsContainer.innerHTML = '<div style="color: var(--text-light); padding: 0.75rem;">–õ–∏–¥—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</div>';
                return;
            }

            let html = '';
            recentLeads.forEach(lead => {
                const taskName = tasks.find(t => t.id === lead.task_id)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞';
                html += renderLeadCard(lead, taskName);
            });

            recentLeadsContainer.innerHTML = html;

            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
            document.querySelectorAll('#recent-leads .lead-card').forEach(card => {
                card.addEventListener('click', async (e) => {
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                    const leadId = card.getAttribute('data-lead-id');
                    openLeadPage(leadId);
                });

                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-1px)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    card.style.backgroundColor = '#f9fafb';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    card.style.backgroundColor = 'white';
                });
            });
        }

        async function loadUserSettings() {
            console.log("LOAD_SETTINGS_CALLED");
            try {
                const response = await fetch(`${API_BASE}/api/user/settings`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("SETTINGS_RESPONSE", data);

                    const checkbox = document.getElementById('notify-personal');
                    if (checkbox) {
                        checkbox.checked = data.alerts_personal;
                        console.log("CHECKBOX_SET_TO", data.alerts_personal);
                    }
                } else {
                    console.log("SETTINGS_LOAD_ERROR", response.status);
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async function saveSettings() {
            console.log("SAVE_SETTINGS_CLICK_VERSION_2");
            console.log("SAVE_SETTINGS_CLICK");
            try {
                const alertsPersonal = document.getElementById('notify-personal').checked;
                console.log("CHECKBOX_VALUE", alertsPersonal);

                const payload = { alerts_personal: alertsPersonal };
                console.log("REQUEST_PAYLOAD", payload);

                const response = await fetch(`${API_BASE}/api/user/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                console.log("RESPONSE_STATUS", response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log("RESPONSE_JSON", result);
                    showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.log("ERROR_RESPONSE", response.status, errorData);
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }

        // Update task filter in leads
        async function updateTaskFilter() {
            const tasks = await getTasks();
            const select = document.getElementById('filter-task');
            const current = select.value;
            select.innerHTML = '<option value="">–í—Å–µ –∑–∞–¥–∞—á–∏</option>' +
                tasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            select.value = current;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–æ–≤
        document.getElementById('filter-task').addEventListener('change', loadLeads);
        document.getElementById('filter-status').addEventListener('change', loadLeads);
        document.getElementById('filter-search').addEventListener('input', loadLeads);

        // ==================== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ====================
        function updateTelegramAccountStatus() {
            const userJSON = localStorage.getItem('user');
            const statusDiv = document.getElementById('telegram-account-status');

            try {
                const user = JSON.parse(userJSON);
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const phone = user.phone || '-';

                statusDiv.innerHTML = `
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 4px; border: 1px solid #22c55e; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <i class="bi bi-check-circle-fill" style="color: #22c55e; font-size: 1.2rem;"></i>
                            <span style="font-weight: 600; color: #22c55e;">–ê–≤—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω</span>
                        </div>
                        <div style="color: var(--text-dark); margin-bottom: 0.5rem;">
                            <strong>${fullName}</strong>
                        </div>
                        <div style="color: var(--text-gray); font-size: 0.9rem;">
                            ${phone}
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫–∫–∞—É–Ω—Ç–∞:', e);
            }
        }

        function loadUserProfile() {
            const userJSON = localStorage.getItem('user');
            if (!userJSON) {
                console.log('‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞...');
                window.location.href = '/login';
                return;
            }

            try {
                const user = JSON.parse(userJSON);
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('profile-name').textContent = fullName;
                document.getElementById('profile-phone').textContent = user.phone || '-';
                console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω:', fullName);

                // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Telegram –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ Settings
                updateTelegramAccountStatus();
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:', e);
                window.location.href = '/login';
            }
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('visible');

            // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –Ω–µ–≥–æ
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-profile')) {
                    menu.classList.remove('visible');
                }
            });
        }

        function logout() {
            showDeleteConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?', async () => {
                try {
                    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å POST –∑–∞–ø—Ä–æ—Å –∫ /api/logout –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ Telegram —Å–µ—Å—Å–∏–∏
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ logout');
                    }

                    // –£–¥–∞–ª–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ localStorage
                    localStorage.removeItem('user');
                    showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'info');

                    // –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ logout:', error);
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞: ' + error.message, 'error');
                }
            });
        }

        // ==================== NOTIFICATIONS & REALTIME ====================

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        let unreadLeadsCount = 0;
        let recentNotifications = [];
        let leadsRealtimeInterval = null;

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        async function toggleNotificationsMenu() {
            const menu = document.getElementById('notifications-menu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';

            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é - —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫, —Å—Ç–∞—Ç—É—Å—ã –Ω–µ –º–µ–Ω—è–µ–º
            if (menu.style.display === 'block') {
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.notifications-menu') && !e.target.closest('#notifications-btn')) {
                        menu.style.display = 'none';
                    }
                }, { once: true });
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞
        function updateNotificationsBell() {
            const badge = document.getElementById('notification-count');
            if (unreadLeadsCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = unreadLeadsCount > 99 ? '99+' : unreadLeadsCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        async function updateNotifications() {
            try {
                const result = await getUnreadCount();
                unreadLeadsCount = result.count || 0;
                updateNotificationsBell();

                const response = await fetch(`${API_BASE}/api/leads/new`, {
                    credentials: 'include'
                });
                const data = await response.json();
                const newLeads = data.leads || [];

                const notificationsList = document.getElementById('notifications-list');
                if (newLeads.length === 0) {
                    notificationsList.innerHTML = `
                        <div style="padding: 1rem; text-align: center; color: #888;">
                            –ù–µ—Ç –Ω–æ–≤—ã—Ö –ª–∏–¥–æ–≤
                        </div>
                    `;
                    return;
                }

                let html = '';
                newLeads.forEach(lead => {
                    const preview = lead.text.substring(0, 60).replace(/\n/g, ' ') + (lead.text.length > 60 ? '...' : '');
                    html += `
                        <div style="
                            padding: 0.75rem 1rem;
                            border-bottom: 1px solid #f0f0f0;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onclick="openLeadPage(${lead.id}); toggleNotificationsMenu();" onmouseover="this.style.background='#f7f8fb'" onmouseout="this.style.background='white'">
                            <div style="font-size: 12px; color: #888;">${lead.source_channel}</div>
                            <div style="font-size: 14px; color: #222; font-weight: 500;">üî• ${escapeHtml(preview)}</div>
                        </div>
                    `;
                });
                notificationsList.innerHTML = html;
            } catch (error) {
                console.error('Error updating notifications:', error);
            }
        }

        // Realtime polling –ª–∏–¥–æ–≤ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        function startLeadsRealtimePolling() {
            if (leadsRealtimeInterval) return;

            leadsRealtimeInterval = setInterval(async () => {
                const section = window.location.hash.substring(1) || 'dashboard';

                // –û–±–Ω–æ–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                try {
                    await updateNotifications();
                } catch (e) {
                    console.error('Error updating notifications:', e);
                }

                // –ï—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Leads - –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ (–Ω–æ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏—é)
                if (section === 'leads' && leadsState.page === 1) {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –ª–∏–¥—ã
                        const response = await getLeads(1, leadsState.limit);
                        const newLeads = response.leads || [];

                        // –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –ª–∏–¥—ã - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                        if (newLeads.length > 0 &&
                            (leadsState.allLeads.length === 0 || newLeads[0].id > leadsState.allLeads[0].id)) {
                            loadLeads(true);
                            console.log('üîÑ –ù–æ–≤—ã–µ –ª–∏–¥—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                        }
                    } catch (e) {
                        console.error('Error loading leads:', e);
                    }
                }

                // –ï—Å–ª–∏ –Ω–∞ Dashboard - –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ª–∏–¥–æ–≤
                if (section === 'dashboard') {
                    try {
                        const stats = await getStats();
                        document.getElementById('stat-leads').textContent = stats.total_matches;

                        // –û–±–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –ª–∏–¥–∞–º–∏
                        const response = await getLeads(1, 5);
                        const recentLeads = response.leads || [];
                        const recentLeadsContainer = document.getElementById('recent-leads');

                        if (recentLeads.length === 0) {
                            recentLeadsContainer.innerHTML = '<div style="color: var(--text-light); padding: 0.75rem;">–õ–∏–¥—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</div>';
                        } else {
                            const tasks = await getTasks();
                            let html = '';
                            recentLeads.forEach(lead => {
                                const taskName = tasks.find(t => t.id === lead.task_id)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞';
                                html += renderLeadCard(lead, taskName);
                            });
                            recentLeadsContainer.innerHTML = html;

                            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
                            document.querySelectorAll('#recent-leads .lead-card').forEach(card => {
                                card.addEventListener('click', async (e) => {
                                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                                    const leadId = card.getAttribute('data-lead-id');
                                    openLeadPage(leadId);
                                });

                                card.addEventListener('mouseenter', () => {
                                    card.style.transform = 'translateY(-1px)';
                                    card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                                    card.style.backgroundColor = '#f9fafb';
                                });

                                card.addEventListener('mouseleave', () => {
                                    card.style.transform = 'translateY(0)';
                                    card.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                                    card.style.backgroundColor = 'white';
                                });
                            });
                        }
                    } catch (e) {
                        console.error('Error updating dashboard:', e);
                    }
                }
            }, 3000);  // –û–ø—Ä–∞—à–∏–≤–∞—Ç—å Dashboard –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        }

        function stopLeadsRealtimePolling() {
            if (leadsRealtimeInterval) {
                clearInterval(leadsRealtimeInterval);
                leadsRealtimeInterval = null;
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('notifications-menu');
            if (menu.style.display === 'block' && !e.target.closest('.notifications-menu') && !e.target.closest('#notifications-btn')) {
                menu.style.display = 'none';
            }
        });

        // Init
        (async () => {
            loadUserProfile();
            await updateStats();
            await updateTaskFilter();
            await updateNotifications();
            startLeadsRealtimePolling();
            checkAdminStatus();

            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å–ª–∏ –±—ã–ª–∞ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –∏–∑ –∞–¥–º–∏–Ω–∫–∏ —Å –Ω—É–∂–Ω–æ–π —Å–µ–∫—Ü–∏–µ–π
            const targetSection = sessionStorage.getItem('targetSection');
            if (targetSection) {
                sessionStorage.removeItem('targetSection');
                switchToSection(targetSection);
            }
        })();

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞ –∏ –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø—É–Ω–∫—Ç "–ê–¥–º–∏–Ω–∫–∞"
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å disabled –∏ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const data = await response.json();
                    const adminNavItem = document.getElementById('admin-nav-item');
                    if (data.is_admin && adminNavItem) {
                        adminNavItem.style.display = 'block';
                    }

                    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å disabled –∏ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    const disabledAlert = document.getElementById('disabledAccountAlert');
                    if (data.disabled && disabledAlert) {
                        disabledAlert.style.display = 'block';
                    } else if (disabledAlert) {
                        disabledAlert.style.display = 'none';
                    }
                }
            } catch (err) {
                console.log('Failed to check admin status');
            }
        }
    </script>
</body>
</html>
