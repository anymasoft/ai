<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobRadar - Lead Monitoring SaaS</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: 88, 86, 214;
        }
        .bg-primary { @apply bg-purple-600; }
        .text-primary { @apply text-purple-600; }
        .border-primary { @apply border-purple-600; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="drawer drawer-end lg:drawer-open">
        <input id="nav-drawer" type="checkbox" class="drawer-toggle" />

        <!-- MAIN CONTENT -->
        <div class="drawer-content flex flex-col">
            <!-- HEADER -->
            <div class="navbar bg-white shadow-sm sticky top-0 z-40">
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800" id="page-title">Dashboard</h3>
                </div>
                <div class="flex-none gap-2">
                    <!-- Notifications -->
                    <button class="btn btn-ghost btn-circle relative" id="notifications-btn">
                        <i class="bi bi-bell text-lg"></i>
                        <span class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden" id="notification-count"></span>
                    </button>

                    <!-- User Profile Dropdown -->
                    <div class="dropdown dropdown-end">
                        <button class="btn btn-ghost btn-circle" tabindex="0">
                            <i class="bi bi-person-circle text-2xl"></i>
                        </button>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                            <li class="menu-title">
                                <span id="profile-name">Загрузка...</span>
                                <span class="text-xs text-gray-500" id="profile-phone">-</span>
                            </li>
                            <li><a onclick="logout()"><i class="bi bi-box-arrow-right"></i> Выход</a></li>
                        </ul>
                    </div>

                    <!-- Mobile Menu Button -->
                    <label for="nav-drawer" class="btn btn-ghost btn-circle lg:hidden">
                        <i class="bi bi-list text-lg"></i>
                    </label>
                </div>
            </div>

            <!-- PAGE CONTENT -->
            <div class="flex-1 p-4 lg:p-6 overflow-y-auto">
                <!-- DASHBOARD SECTION -->
                <section id="dashboard" class="content-section active">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="card bg-white shadow-sm border-l-4 border-purple-600">
                            <div class="card-body p-4">
                                <p class="text-xs font-semibold text-gray-500 uppercase">Active Tasks</p>
                                <p class="text-3xl font-bold text-gray-800" id="stat-tasks">0</p>
                            </div>
                        </div>
                        <div class="card bg-white shadow-sm border-l-4 border-blue-600">
                            <div class="card-body p-4">
                                <p class="text-xs font-semibold text-gray-500 uppercase">Sources</p>
                                <p class="text-3xl font-bold text-gray-800" id="stat-sources">0</p>
                            </div>
                        </div>
                        <div class="card bg-white shadow-sm border-l-4 border-green-600">
                            <div class="card-body p-4">
                                <p class="text-xs font-semibold text-gray-500 uppercase">Keywords</p>
                                <p class="text-3xl font-bold text-gray-800" id="stat-keywords">0</p>
                            </div>
                        </div>
                        <div class="card bg-white shadow-sm border-l-4 border-orange-600">
                            <div class="card-body p-4">
                                <p class="text-xs font-semibold text-gray-500 uppercase">Leads Today</p>
                                <p class="text-3xl font-bold text-gray-800" id="stat-leads">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Start Card -->
                    <div class="card bg-white shadow-sm mb-6">
                        <div class="card-body">
                            <h4 class="card-title text-lg">Начните за 60 секунд</h4>
                            <p class="text-gray-600 text-sm">Создайте свою первую задачу мониторинга и начните находить лиды в каналах Telegram.</p>
                            <div class="card-actions justify-start mt-4">
                                <button class="btn btn-primary btn-sm" onclick="openTaskModal()">
                                    <i class="bi bi-plus"></i> Создать первую задачу
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Leads -->
                    <div class="card bg-white shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title">Последние лиды</h4>
                            <div id="recent-leads" class="text-gray-500 text-sm">Лиды появятся после запуска мониторинга</div>
                        </div>
                    </div>
                </section>

                <!-- TASKS SECTION -->
                <section id="tasks" class="content-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Ваши задачи</h2>
                        <button class="btn btn-primary btn-sm" onclick="openTaskModal()">
                            <i class="bi bi-plus"></i> Новая задача
                        </button>
                    </div>
                    <div id="tasks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </section>

                <!-- LEADS SECTION -->
                <section id="leads" class="content-section hidden">
                    <h2 class="text-2xl font-bold mb-6">Лиды</h2>
                    <div class="flex gap-4 mb-6">
                        <select id="filter-task" class="select select-bordered select-sm w-full max-w-xs">
                            <option>Все задачи</option>
                        </select>
                        <select id="filter-status" class="select select-bordered select-sm w-full max-w-xs">
                            <option value="">Все статусы</option>
                            <option value="new">Новые</option>
                            <option value="viewed">Просмотренные</option>
                            <option value="archived">Архивированные</option>
                        </select>
                        <input type="text" id="filter-search" placeholder="Поиск лидов..." class="input input-bordered input-sm w-full max-w-xs" />
                    </div>
                    <div id="leads-container" class="space-y-4"></div>
                </section>

                <!-- BILLING SECTION -->
                <section id="billing" class="content-section hidden">
                    <h2 class="text-2xl font-bold mb-6">Billing</h2>

                    <!-- Current Plan -->
                    <div class="card bg-white shadow-sm mb-6">
                        <div class="card-body">
                            <h3 class="card-title">Current Plan</h3>
                            <p class="text-4xl font-bold text-purple-600 my-2">Free</p>
                            <p class="text-gray-600">You're on the free plan. Upgrade to unlock more tasks and sources.</p>
                            <div class="grid grid-cols-3 gap-4 my-4 text-sm">
                                <div><strong>2/3 Tasks</strong><br><span class="text-gray-500">Used</span></div>
                                <div><strong>5/10 Sources</strong><br><span class="text-gray-500">Used</span></div>
                                <div><strong>10/25 Keywords</strong><br><span class="text-gray-500">Used</span></div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="showToast('Интеграция платежей в разработке', 'info')">Upgrade Now</button>
                        </div>
                    </div>

                    <!-- Pricing Plans -->
                    <h3 class="text-lg font-bold mb-4">Pricing Plans</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Starter -->
                        <div class="card bg-white shadow-sm border-2 border-purple-600">
                            <div class="card-body">
                                <span class="badge badge-primary absolute -top-3 left-4">Current</span>
                                <h3 class="card-title">Starter</h3>
                                <p class="text-3xl font-bold text-purple-600">Free</p>
                                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 my-4">
                                    <li>3 Tasks</li>
                                    <li>10 Sources</li>
                                    <li>25 Keywords</li>
                                    <li>Email support</li>
                                </ul>
                                <button class="btn btn-disabled btn-sm w-full">Current Plan</button>
                            </div>
                        </div>

                        <!-- Pro -->
                        <div class="card bg-white shadow-sm">
                            <div class="card-body">
                                <h3 class="card-title">Pro</h3>
                                <p class="text-3xl font-bold text-purple-600">$29<span class="text-sm text-gray-500">/mo</span></p>
                                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 my-4">
                                    <li>20 Tasks</li>
                                    <li>100 Sources</li>
                                    <li>500 Keywords</li>
                                    <li>Priority support</li>
                                </ul>
                                <button class="btn btn-primary btn-sm w-full" onclick="showToast('Интеграция платежей в разработке', 'info')">Upgrade</button>
                            </div>
                        </div>

                        <!-- Team -->
                        <div class="card bg-white shadow-sm">
                            <div class="card-body">
                                <h3 class="card-title">Team</h3>
                                <p class="text-3xl font-bold text-purple-600">$99<span class="text-sm text-gray-500">/mo</span></p>
                                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 my-4">
                                    <li>Unlimited Tasks</li>
                                    <li>Unlimited Sources</li>
                                    <li>Unlimited Keywords</li>
                                    <li>24/7 support</li>
                                </ul>
                                <button class="btn btn-primary btn-sm w-full" onclick="showToast('Интеграция платежей в разработке', 'info')">Contact</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SETTINGS SECTION -->
                <section id="settings" class="content-section hidden">
                    <h2 class="text-2xl font-bold mb-6">Settings</h2>

                    <!-- Account -->
                    <div class="card bg-white shadow-sm mb-4">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Account</h3>
                            <p class="text-sm text-gray-600 mb-4">Telegram Account</p>
                            <div id="telegram-account-status"></div>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="card bg-white shadow-sm mb-4">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Notifications</h3>
                            <label class="form-control">
                                <div class="label cursor-pointer gap-2">
                                    <input type="checkbox" class="checkbox" id="notify-telegram" checked />
                                    <span class="label-text">New leads via Telegram</span>
                                </div>
                            </label>
                            <label class="form-control">
                                <div class="label cursor-pointer gap-2">
                                    <input type="checkbox" class="checkbox" id="notify-email" />
                                    <span class="label-text">Email digest (daily)</span>
                                </div>
                            </label>
                            <button class="btn btn-primary btn-sm mt-4" onclick="saveSettings()">Save Settings</button>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="card bg-red-50 shadow-sm border border-red-200">
                        <div class="card-body">
                            <h3 class="card-title text-lg text-red-600">Danger Zone</h3>
                            <button class="btn btn-error btn-sm" onclick="showDeleteConfirm('Вы уверены, что хотите удалить аккаунт? Это действие нельзя отменить.', () => showToast('Удаление аккаунта в разработке', 'info'))">
                                <i class="bi bi-trash"></i> Delete Account
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- SIDEBAR (NAVIGATION) -->
        <div class="drawer-side">
            <label for="nav-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <div class="menu p-4 w-80 min-h-full bg-white shadow-lg">
                <!-- Logo -->
                <div class="mb-8 pb-4 border-b">
                    <h2 class="text-xl font-bold text-purple-600 flex items-center gap-2">
                        <i class="bi bi-speedometer2"></i> JobRadar
                    </h2>
                </div>

                <!-- Navigation Menu -->
                <ul class="space-y-2">
                    <li><a data-section="dashboard" class="nav-item active" onclick="selectNav(this)"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                    <li><a data-section="tasks" class="nav-item" onclick="selectNav(this)"><i class="bi bi-list-check"></i> Tasks</a></li>
                    <li><a data-section="leads" class="nav-item" onclick="selectNav(this)"><i class="bi bi-fire"></i> Leads</a></li>
                    <li><a data-section="billing" class="nav-item" onclick="selectNav(this)"><i class="bi bi-credit-card"></i> Billing</a></li>
                    <li><a data-section="settings" class="nav-item" onclick="selectNav(this)"><i class="bi bi-gear"></i> Settings</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast toast-top toast-end gap-2"></div>

    <!-- Modal: Task Form -->
    <dialog id="task-modal" class="modal">
        <div class="modal-box w-full max-w-md">
            <h3 class="font-bold text-lg mb-4" id="modal-title">Create Task</h3>
            <form id="task-form" class="space-y-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">Task Name *</span></label>
                    <input type="text" id="task-name" class="input input-bordered" required />
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Sources (channels/chats)</span></label>
                    <textarea id="task-sources" class="textarea textarea-bordered" placeholder="telegram.me/channel&#10;https://t.me/+xxxxx&#10;One per line"></textarea>
                    <label class="label"><span class="label-text-alt">Enter Telegram channel links, one per line</span></label>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Include Keywords *</span></label>
                    <textarea id="task-include" class="textarea textarea-bordered" placeholder="python&#10;remote&#10;One per line" required></textarea>
                    <label class="label"><span class="label-text-alt">Find leads containing these keywords</span></label>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Exclude Keywords (minus-words)</span></label>
                    <textarea id="task-exclude" class="textarea textarea-bordered" placeholder="junior&#10;internship&#10;One per line"></textarea>
                    <label class="label"><span class="label-text-alt">Ignore leads containing these keywords</span></label>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Alerts</span></label>
                    <label class="flex gap-2 items-center"><input type="checkbox" id="alert-telegram" class="checkbox" checked /><span>Telegram</span></label>
                    <label class="flex gap-2 items-center"><input type="checkbox" id="alert-email" class="checkbox" /><span>Email</span></label>
                    <label class="flex gap-2 items-center"><input type="checkbox" id="alert-webhook" class="checkbox" /><span>Webhook</span></label>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn" onclick="closeTaskModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button></button></form>
    </dialog>

    <!-- Modal: Delete Confirm -->
    <dialog id="delete-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Подтверждение удаления</h3>
            <p id="delete-modal-message" class="py-4"></p>
            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('delete-modal').close()">Отмена</button>
                <button class="btn btn-error" onclick="confirmDelete()">Удалить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button></button></form>
    </dialog>

    <style>
        .nav-item {
            @apply btn btn-ghost btn-block justify-start gap-3 text-gray-700;
        }
        .nav-item.active {
            @apply bg-purple-100 text-purple-600;
        }
        .content-section {
            @apply hidden;
        }
        .content-section.active {
            @apply block;
        }
    </style>

    <script>
        const API_BASE = '';

        // ==================== UI COMPONENTS ====================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info'} shadow-lg`;

            const icons = {
                success: 'bi-check-circle',
                error: 'bi-exclamation-circle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle'
            };

            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="bi ${icons[type]}"></i>
                    <span>${message}</span>
                    <button class="btn btn-ghost btn-sm" onclick="this.closest('.alert').remove()">×</button>
                </div>
            `;

            container.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => toast.remove(), duration);
            }
        }

        let deletePendingCallback = null;

        function showDeleteConfirm(message, onConfirm) {
            deletePendingCallback = onConfirm;
            document.getElementById('delete-modal-message').textContent = message;
            document.getElementById('delete-modal').showModal();
        }

        function confirmDelete() {
            if (deletePendingCallback) {
                deletePendingCallback();
            }
            document.getElementById('delete-modal').close();
        }

        // ==================== API FUNCTIONS ====================
        async function getTasks() {
            try {
                const response = await fetch(`${API_BASE}/api/tasks`);
                if (!response.ok) throw new Error('Failed to fetch tasks');
                return await response.json();
            } catch (error) {
                console.error('Error fetching tasks:', error);
                return [];
            }
        }

        async function getStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                if (!response.ok) throw new Error('Failed to fetch stats');
                return await response.json();
            } catch (error) {
                console.error('Error fetching stats:', error);
                return {
                    active_tasks: 0,
                    total_tasks: 0,
                    total_sources: 0,
                    total_keywords: 0,
                    total_matches: 0
                };
            }
        }

        async function createTask(taskData) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                if (!response.ok) throw new Error('Failed to create task');
                return await response.json();
            } catch (error) {
                console.error('Error creating task:', error);
                showToast('Ошибка создания задачи: ' + error.message, 'error');
                return null;
            }
        }

        async function updateTask(taskId, taskData) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                if (!response.ok) throw new Error('Failed to update task');
                return await response.json();
            } catch (error) {
                console.error('Error updating task:', error);
                showToast('Ошибка обновления задачи: ' + error.message, 'error');
                return null;
            }
        }

        async function deleteTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete task');
                return await response.json();
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('Ошибка удаления задачи: ' + error.message, 'error');
                return null;
            }
        }

        // ==================== NAVIGATION ====================
        function selectNav(element) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            const section = element.getAttribute('data-section');
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            const titles = {
                dashboard: 'Dashboard',
                tasks: 'Tasks',
                leads: 'Leads',
                billing: 'Billing',
                settings: 'Settings'
            };
            document.getElementById('page-title').textContent = titles[section];

            if (section === 'tasks') renderTasks();
            if (section === 'leads') renderLeads();
        }

        // ==================== TASK MANAGEMENT ====================
        let currentEditTaskId = null;

        async function openTaskModal(taskId = null) {
            currentEditTaskId = taskId;
            const form = document.getElementById('task-form');

            form.reset();

            if (taskId) {
                try {
                    const response = await fetch(`${API_BASE}/api/tasks/${taskId}`);
                    if (!response.ok) throw new Error('Failed to fetch task');
                    const task = await response.json();

                    document.getElementById('modal-title').textContent = 'Edit Task';
                    document.getElementById('task-name').value = task.name;
                    document.getElementById('task-sources').value = task.sources;
                    document.getElementById('task-include').value = task.include_keywords;
                    document.getElementById('task-exclude').value = task.exclude_keywords || '';
                    document.getElementById('alert-telegram').checked = task.alerts_telegram;
                    document.getElementById('alert-email').checked = task.alerts_email;
                    document.getElementById('alert-webhook').checked = task.alerts_webhook;
                } catch (error) {
                    console.error('Error loading task:', error);
                    showToast('Ошибка загрузки задачи', 'error');
                    return;
                }
            } else {
                document.getElementById('modal-title').textContent = 'Create Task';
            }

            document.getElementById('task-modal').showModal();
        }

        function closeTaskModal() {
            document.getElementById('task-modal').close();
            currentEditTaskId = null;
        }

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('task-name').value.trim();
            const sources = document.getElementById('task-sources').value.trim();
            const include = document.getElementById('task-include').value.trim();
            const exclude = document.getElementById('task-exclude').value.trim();

            if (!name) {
                showToast('Название задачи обязательно', 'warning');
                return;
            }

            if (!include) {
                showToast('Требуется хотя бы одно включающее ключевое слово', 'warning');
                return;
            }

            const taskData = {
                name: name,
                status: 'running',
                sources: sources,
                include_keywords: include,
                exclude_keywords: exclude,
                alerts_telegram: document.getElementById('alert-telegram').checked,
                alerts_email: document.getElementById('alert-email').checked,
                alerts_webhook: document.getElementById('alert-webhook').checked
            };

            let result;
            if (currentEditTaskId) {
                result = await updateTask(currentEditTaskId, taskData);
            } else {
                result = await createTask(taskData);
            }

            if (result) {
                closeTaskModal();
                await renderTasks();
                await updateStats();
                showToast(currentEditTaskId ? 'Задача обновлена!' : 'Задача создана!', 'success');
            }
        });

        async function deleteTaskHandler(taskId) {
            showDeleteConfirm('Вы уверены, что хотите удалить эту задачу? Это действие нельзя отменить.', async () => {
                const result = await deleteTask(taskId);
                if (result) {
                    await renderTasks();
                    await updateStats();
                    showToast('Задача удалена', 'success');
                }
            });
        }

        async function toggleTaskStatus(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`);
                if (!response.ok) throw new Error('Failed to fetch task');
                const task = await response.json();

                const newStatus = task.status === 'running' ? 'paused' : 'running';
                const result = await updateTask(taskId, { status: newStatus });

                if (result) {
                    await renderTasks();
                }
            } catch (error) {
                console.error('Error toggling task status:', error);
            }
        }

        async function renderTasks() {
            const tasks = await getTasks();
            const container = document.getElementById('tasks-container');

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="bi bi-briefcase text-4xl text-gray-300 mb-4"></i>
                        <h4 class="text-lg font-semibold text-gray-700">Нет задач</h4>
                        <p class="text-gray-500 mb-4">Создайте свою первую задачу мониторинга, чтобы начать</p>
                        <button class="btn btn-primary btn-sm" onclick="openTaskModal()">Создать задачу</button>
                    </div>
                `;
                return;
            }

            const countItems = (str) => str ? str.split(',').filter(s => s.trim()).length : 0;

            container.innerHTML = tasks.map(task => `
                <div class="card bg-white shadow-sm">
                    <div class="card-body">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="card-title text-base">${task.name}</h3>
                            <span class="badge ${task.status === 'running' ? 'badge-success' : 'badge-warning'}">${task.status}</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 py-3 border-y text-sm text-center">
                            <div>
                                <div class="font-bold text-purple-600">${countItems(task.sources)}</div>
                                <div class="text-gray-500 text-xs">Источники</div>
                            </div>
                            <div>
                                <div class="font-bold text-purple-600">${countItems(task.include_keywords)}</div>
                                <div class="text-gray-500 text-xs">Включить</div>
                            </div>
                            <div>
                                <div class="font-bold text-purple-600">${countItems(task.exclude_keywords)}</div>
                                <div class="text-gray-500 text-xs">Исключить</div>
                            </div>
                        </div>
                        <div class="card-actions justify-between mt-4">
                            <button class="btn btn-xs btn-outline" onclick="toggleTaskStatus(${task.id})">
                                <i class="bi bi-pause-circle"></i> ${task.status === 'running' ? 'Пауза' : 'Запуск'}
                            </button>
                            <button class="btn btn-xs btn-outline" onclick="openTaskModal(${task.id})">
                                <i class="bi bi-pencil"></i> Редактировать
                            </button>
                            <button class="btn btn-xs btn-outline btn-error" onclick="deleteTaskHandler(${task.id})">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function renderLeads() {
            const container = document.getElementById('leads-container');
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="bi bi-search text-4xl text-gray-300 mb-4"></i>
                    <h4 class="text-lg font-semibold text-gray-700">Функция лидов в разработке</h4>
                    <p class="text-gray-500">Скоро можно будет просматривать найденные лиды</p>
                </div>
            `;
        }

        async function updateStats() {
            const stats = await getStats();

            document.getElementById('stat-tasks').textContent = stats.active_tasks;
            document.getElementById('stat-sources').textContent = stats.total_sources;
            document.getElementById('stat-keywords').textContent = stats.total_keywords;
            document.getElementById('stat-leads').textContent = stats.total_matches;

            const newLeads = 0;
            if (newLeads > 0) {
                document.getElementById('notification-count').classList.remove('hidden');
                document.getElementById('notification-count').textContent = newLeads;
            } else {
                document.getElementById('notification-count').classList.add('hidden');
            }
        }

        function saveSettings() {
            showToast('Настройки сохранены!', 'success');
        }

        async function updateTaskFilter() {
            const tasks = await getTasks();
            const select = document.getElementById('filter-task');
            const current = select.value;
            select.innerHTML = '<option value="">Все задачи</option>' +
                tasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            select.value = current;
        }

        document.getElementById('filter-task').addEventListener('change', renderLeads);
        document.getElementById('filter-status').addEventListener('change', renderLeads);
        document.getElementById('filter-search').addEventListener('input', renderLeads);

        // ==================== УПРАВЛЕНИЕ ПРОФИЛЕМ ====================
        function updateTelegramAccountStatus() {
            const userJSON = localStorage.getItem('user');
            const statusDiv = document.getElementById('telegram-account-status');

            try {
                const user = JSON.parse(userJSON);
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'Пользователь';
                const phone = user.phone || '-';

                statusDiv.innerHTML = `
                    <div class="alert alert-success mb-4">
                        <i class="bi bi-check-circle-fill"></i>
                        <span>Авторизирован</span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <p class="font-semibold">${fullName}</p>
                        <p class="text-sm text-gray-600">${phone}</p>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="window.location.href='/login'">
                        <i class="bi bi-arrow-repeat"></i> Переавторизоваться
                    </button>
                `;
            } catch (e) {
                console.error('❌ Ошибка при обновлении статуса аккаунта:', e);
            }
        }

        function loadUserProfile() {
            const userJSON = localStorage.getItem('user');
            if (!userJSON) {
                console.log('❌ Информация о пользователе не найдена. Перенаправление на страницу входа...');
                window.location.href = '/login';
                return;
            }

            try {
                const user = JSON.parse(userJSON);
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'Пользователь';
                document.getElementById('profile-name').textContent = fullName;
                document.getElementById('profile-phone').textContent = user.phone || '-';
                console.log('✅ Профиль пользователя загружен:', fullName);

                updateTelegramAccountStatus();
            } catch (e) {
                console.error('❌ Ошибка при загрузке профиля:', e);
                window.location.href = '/login';
            }
        }

        function logout() {
            showDeleteConfirm('Вы уверены, что хотите выйти из аккаунта?', () => {
                localStorage.removeItem('user');
                showToast('Вы вышли из аккаунта', 'info');

                setTimeout(() => {
                    window.location.href = '/login';
                }, 1000);
            });
        }

        // Init
        (async () => {
            loadUserProfile();
            await updateStats();
            await updateTaskFilter();
        })();
    </script>
</body>
</html>
