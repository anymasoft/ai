<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobRadar - Lead Monitoring SaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #5856d6;
            --primary-dark: #4c4ab3;
            --gray-light: #f8f9fa;
            --gray-bg: #f5f5f5;
            --gray-border: #e0e0e0;
            --text-dark: #222;
            --text-gray: #666;
            --text-light: #999;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-bg);
            color: var(--text-dark);
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid var(--gray-border);
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-brand {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        .sidebar-brand h5 {
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: var(--text-gray);
            cursor: pointer;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            color: var(--primary);
            background: rgba(88, 86, 214, 0.05);
        }

        .nav-link.active {
            color: var(--primary);
            background: rgba(88, 86, 214, 0.1);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .nav-link i {
            width: 20px;
        }

        /* MAIN */
        .main-content {
            margin-left: 250px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--gray-border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-gray);
            position: relative;
            transition: color 0.3s;
        }

        .header-btn:hover {
            color: var(--primary);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        /* Профиль пользователя */
        .user-profile {
            position: relative;
        }

        .profile-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            min-width: 250px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .profile-menu.visible {
            display: block;
            animation: slideUp 0.2s ease-out;
        }

        .profile-header {
            padding: 1rem;
            background: rgba(88, 86, 214, 0.05);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .profile-phone {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 0.25rem;
        }

        .profile-menu-item {
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            color: var(--text-gray);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s;
        }

        .profile-menu-item:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        .profile-menu-item i {
            font-size: 1rem;
        }

        .content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* CARDS */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--gray-border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* TASK CARDS - используется Tailwind CSS (см. renderTasks) */
        /* Старые стили удалены - все теперь через Tailwind */

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-border);
            background: white;
            color: var(--text-gray);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-danger {
            color: #dc3545;
        }

        .btn-danger:hover {
            color: #c82333;
            border-color: #dc3545;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            flex: 1;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-gray);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(88, 86, 214, 0.1);
        }

        .form-hint {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-actions button {
            flex: 1;
        }

        /* LEADS TABLE */
        .leads-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .leads-filters select,
        .leads-filters input {
            padding: 0.75rem;
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95rem;
            flex: 1;
            min-width: 150px;
        }

        .leads-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lead-item {
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 4px;
            padding: 1rem;
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .lead-text {
            font-weight: 500;
            color: var(--text-dark);
            flex: 1;
            margin-right: 1rem;
        }

        .lead-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .lead-status.new {
            background: #d1ecf1;
            color: #0c5460;
        }

        .lead-status.viewed {
            background: #e2e3e5;
            color: #383d41;
        }

        .lead-status.archived {
            background: #f8d7da;
            color: #721c24;
        }

        .lead-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .lead-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .lead-actions button {
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
        }

        /* BILLING */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .pricing-card {
            background: white;
            border: 2px solid var(--gray-border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
        }

        .pricing-card.current {
            border-color: var(--primary);
            background: rgba(88, 86, 214, 0.02);
        }

        .pricing-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .pricing-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .pricing-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .pricing-features {
            text-align: left;
            margin-bottom: 1.5rem;
        }

        .pricing-features li {
            list-style: none;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .pricing-features li:before {
            content: '✓ ';
            color: var(--primary);
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--gray-border);
            margin-bottom: 1rem;
        }

        .empty-state h4 {
            color: var(--text-gray);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        /* TOAST NOTIFICATIONS */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            pointer-events: none;
        }

        .toast {
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out;
        }

        .toast.success {
            border-left: 4px solid #22c55e;
            background: #f0fdf4;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        .toast.warning {
            border-left: 4px solid #f97316;
            background: #fffbeb;
        }

        .toast.info {
            border-left: 4px solid var(--primary);
            background: #f5f3ff;
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { color: #22c55e; }
        .toast.error .toast-icon { color: #ef4444; }
        .toast.warning .toast-icon { color: #f97316; }
        .toast.info .toast-icon { color: var(--primary); }

        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-gray);
            font-size: 1.25rem;
            padding: 0;
            margin-left: auto;
            flex-shrink: 0;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        .toast.removing {
            animation: slideOutRight 0.3s ease-in;
        }

        /* DIALOG/MODAL */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            align-items: center;
            justify-content: center;
        }

        .dialog-overlay.visible {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dialog-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dialog-header {
            margin-bottom: 1.5rem;
        }

        .dialog-header h3 {
            font-size: 1.25rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .dialog-header p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .dialog-body {
            margin-bottom: 1.5rem;
            color: var(--text-gray);
        }

        .dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .dialog-actions button {
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            border: 1px solid var(--gray-border);
            background: white;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .dialog-actions button:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .dialog-actions .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .dialog-actions .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--gray-border);
            }

            .main-content {
                margin-left: 0;
            }

            .tasks-grid {
                grid-template-columns: 1fr;
            }

            .stat-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .toast-container {
                left: 20px;
                right: 20px;
            }

            .toast {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <h5><i class="bi bi-speedometer2"></i> JobRadar</h5>
            </div>
            <ul class="nav-menu">
                <li><a class="nav-link active" data-section="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li><a class="nav-link" data-section="tasks"><i class="bi bi-list-check"></i> Мои задачи</a></li>
                <li><a class="nav-link" data-section="leads"><i class="bi bi-fire"></i> Лиды</a></li>
                <li><a class="nav-link" data-section="billing"><i class="bi bi-credit-card"></i> Тарифы</a></li>
                <li><a class="nav-link" data-section="settings"><i class="bi bi-gear"></i> Настройки</a></li>
            </ul>
        </aside>

        <!-- MAIN -->
        <div class="main-content">
            <!-- HEADER -->
            <div class="header">
                <div class="header-left">
                    <h3 id="page-title">Дашборд</h3>
                </div>
                <div class="header-right">
                    <div style="position: relative;">
                        <button class="header-btn" id="notifications-btn" onclick="toggleNotificationsMenu()">
                            <i class="bi bi-bell"></i>
                            <span class="badge-count" id="notification-count" style="display: none;"></span>
                        </button>
                        <div class="notifications-menu" id="notifications-menu" style="
                            display: none;
                            position: absolute;
                            top: 100%;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            min-width: 300px;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                            z-index: 1000;
                            margin-top: 0.5rem;
                        ">
                            <div style="padding: 1rem; border-bottom: 1px solid #eee; font-weight: 600;">Уведомления</div>
                            <div id="notifications-list" style="max-height: 400px; overflow-y: auto;"></div>
                            <button class="btn btn-primary" style="width: 100%; margin: 0;" onclick="switchToSection('leads'); toggleNotificationsMenu();">
                                Показать все лиды
                            </button>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button class="header-btn" id="profile-btn" onclick="toggleProfileMenu()">
                            <i class="bi bi-person-circle"></i>
                        </button>
                        <div class="profile-menu" id="profile-menu">
                            <div class="profile-header">
                                <div class="profile-info">
                                    <div class="profile-name" id="profile-name">Загрузка...</div>
                                    <div class="profile-phone" id="profile-phone">-</div>
                                </div>
                            </div>
                            <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid var(--gray-border);">
                            <button class="profile-menu-item" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> Выход
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENT -->
            <div class="content">
                <!-- DASHBOARD SECTION -->
                <section id="dashboard" class="content-section active">
                    <div class="stat-cards">
                        <div class="stat-card">
                            <div class="stat-label">Active Tasks</div>
                            <div class="stat-value" id="stat-tasks">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sources</div>
                            <div class="stat-value" id="stat-sources">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Keywords</div>
                            <div class="stat-value" id="stat-keywords">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Leads Today</div>
                            <div class="stat-value" id="stat-leads">0</div>
                        </div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-border);">
                        <h4 style="margin-bottom: 1rem;">Последние лиды</h4>
                        <div id="recent-leads" style="display: flex; flex-direction: column; gap: 1rem;"></div>
                    </div>
                </section>

                <!-- TASKS SECTION -->
                <section id="tasks" class="content-section">
                    <div class="flex justify-between items-center mb-8">
                        <h4 class="text-2xl font-semibold">Мои задачи</h4>
                        <button class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" onclick="openTaskModal()">
                            <i class="bi bi-plus"></i> Создать задачу
                        </button>
                    </div>
                    <div id="tasks-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </section>

                <!-- LEADS SECTION -->
                <section id="leads" class="content-section" style="background: #f7f8fb; padding: 2rem 1rem;">
                    <!-- Фильтры компактные -->
                    <div style="
                        max-width: 820px;
                        margin: 0 auto 2rem;
                        display: flex;
                        gap: 1rem;
                        flex-wrap: wrap;
                    ">
                        <select id="filter-task" style="
                            flex: 1;
                            min-width: 150px;
                            padding: 0.6rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 0.9rem;
                        ">
                            <option value="">Все задачи</option>
                        </select>
                        <select id="filter-status" style="
                            flex: 1;
                            min-width: 150px;
                            padding: 0.6rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 0.9rem;
                        ">
                            <option value="">Все статусы</option>
                            <option value="new">Новые</option>
                            <option value="viewed">Просмотренные</option>
                        </select>
                        <input type="text" id="filter-search" placeholder="Искать лиды..." style="
                            flex: 1;
                            min-width: 200px;
                            padding: 0.6rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 0.9rem;
                        ">
                    </div>

                    <!-- Контейнер лидов с правильным лейаутом -->
                    <div style="
                        max-width: 820px;
                        margin: 0 auto;
                    ">
                        <div id="leads-container" class="leads-list"></div>
                    </div>
                </section>

                <!-- BILLING SECTION -->
                <section id="billing" class="content-section">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-border); margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">Текущий тариф</h4>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem;">Бесплатный</div>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">Вы на бесплатном плане. Обновитесь, чтобы разблокировать больше задач и источников.</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.9rem; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-weight: 600;">2/3 Задачи</div>
                                <div style="color: var(--text-light); font-size: 0.85rem;">Использовано</div>
                            </div>
                            <div>
                                <div style="font-weight: 600;">5/10 Источников</div>
                                <div style="color: var(--text-light); font-size: 0.85rem;">Использовано</div>
                            </div>
                            <div>
                                <div style="font-weight: 600;">10/25 Ключевых слов</div>
                                <div style="color: var(--text-light); font-size: 0.85rem;">Использовано</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showToast('Интеграция платежей в разработке', 'info')">Обновить</button>
                    </div>

                    <h4 style="margin-bottom: 1rem;">Тарифные планы</h4>
                    <div class="pricing-grid">
                        <div class="pricing-card current">
                            <div class="pricing-badge">Текущий</div>
                            <div class="pricing-name">Стартер</div>
                            <div class="pricing-price">Бесплатно</div>
                            <ul class="pricing-features">
                                <li>3 Задачи</li>
                                <li>10 Источников</li>
                                <li>25 Ключевых слов</li>
                                <li>Поддержка по почте</li>
                            </ul>
                            <button class="btn" disabled>Текущий план</button>
                        </div>

                        <div class="pricing-card">
                            <div class="pricing-name">Профессиональный</div>
                            <div class="pricing-price">$29</div>
                            <div style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">в месяц</div>
                            <ul class="pricing-features">
                                <li>20 Задач</li>
                                <li>100 Источников</li>
                                <li>500 Ключевых слов</li>
                                <li>Приоритетная поддержка</li>
                            </ul>
                            <button class="btn btn-primary" onclick="showToast('Интеграция платежей в разработке', 'info')">Обновить</button>
                        </div>

                        <div class="pricing-card">
                            <div class="pricing-name">Команда</div>
                            <div class="pricing-price">$99</div>
                            <div style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">в месяц</div>
                            <ul class="pricing-features">
                                <li>Неограниченные задачи</li>
                                <li>Неограниченные источники</li>
                                <li>Неограниченные ключевые слова</li>
                                <li>Поддержка 24/7</li>
                            </ul>
                            <button class="btn btn-primary" onclick="showToast('Интеграция платежей в разработке', 'info')">Связаться</button>
                        </div>
                    </div>
                </section>

                <!-- SETTINGS SECTION -->
                <section id="settings" class="content-section">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-border); margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Аккаунт</h4>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Аккаунт Telegram</label>
                            <div id="telegram-account-status"></div>
                        </div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-border); margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Уведомления</h4>
                        <p style="color: var(--text-gray); margin-bottom: 1rem; font-size: 0.9rem;">Куда отправлять новые лиды:</p>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="checkbox-group">
                                <input type="checkbox" id="notify-personal" checked>
                                <span>Отправлять в мой личный чат</span>
                            </label>
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="checkbox-group">
                                <input type="checkbox" id="notify-channel">
                                <span>Пересылать в канал (из настроек задачи)</span>
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">Сохранить</button>
                    </div>

                    <div style="background: #fff5f5; padding: 1.5rem; border-radius: 8px; border: 1px solid #fdd; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: #d32f2f;">Опасная зона</h4>
                        <button class="btn btn-danger" onclick="showDeleteConfirm('Вы уверены, что хотите удалить аккаунт? Это действие нельзя отменить.', () => showToast('Удаление аккаунта в разработке', 'info'))">
                            <i class="bi bi-trash"></i> Удалить аккаунт
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toast-container"></div>

    <!-- DIALOG -->
    <div class="dialog-overlay" id="delete-dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>Подтверждение удаления</h3>
            </div>
            <div class="dialog-body" id="delete-dialog-message"></div>
            <div class="dialog-actions">
                <button onclick="closeDeleteDialog()">Отмена</button>
                <button class="btn-primary" onclick="confirmDelete()">Удалить</button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal-title">Создать задачу</span>
                <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="task-form">
                <div class="form-group">
                    <label>Название задачи *</label>
                    <input type="text" id="task-name" required>
                </div>

                <div class="form-group">
                    <label>Источники (каналы/чаты)</label>
                    <textarea id="task-sources" placeholder="telegram.me/channel&#10;https://t.me/+xxxxx&#10;По одному в строке"></textarea>
                    <span class="form-hint">Введите ссылки на каналы Telegram, по одной в строку</span>
                </div>

                <div class="form-group">
                    <label>Включать ключевые слова *</label>
                    <textarea id="task-include" placeholder="python&#10;remote&#10;По одному в строке" required></textarea>
                    <span class="form-hint">Найти лиды с этими ключевыми словами</span>
                </div>

                <div class="form-group">
                    <label>Исключить ключевые слова</label>
                    <textarea id="task-exclude" placeholder="junior&#10;internship&#10;По одному в строке"></textarea>
                    <span class="form-hint">Игнорировать лиды с этими ключевыми словами</span>
                </div>

                <div class="form-group">
                    <label>Канал для пересылки (опционально)</label>
                    <input type="text" id="task-channel" placeholder="@mychannel или https://t.me/mychannel">
                    <span class="form-hint">Канал для пересылки найденных лидов</span>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeTaskModal()">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== UI COMPONENTS ====================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'bi-check-circle',
                error: 'bi-exclamation-circle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle'
            };

            toast.innerHTML = `
                <i class="bi ${icons[type]} toast-icon"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            container.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        let deletePendingCallback = null;

        function showDeleteConfirm(message, onConfirm) {
            deletePendingCallback = onConfirm;
            document.getElementById('delete-dialog-message').textContent = message;
            document.getElementById('delete-dialog-overlay').classList.add('visible');
        }

        function closeDeleteDialog() {
            document.getElementById('delete-dialog-overlay').classList.remove('visible');
            deletePendingCallback = null;
        }

        function confirmDelete() {
            if (deletePendingCallback) {
                deletePendingCallback();
            }
            closeDeleteDialog();
        }

        // ==================== API FUNCTIONS ====================
        const API_BASE = '';

        async function getTasks() {
            try {
                const response = await fetch(`${API_BASE}/api/tasks`, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch tasks');
                return await response.json();
            } catch (error) {
                console.error('Error fetching tasks:', error);
                return [];
            }
        }

        async function getLeads(page = 1, limit = 20) {
            try {
                const response = await fetch(`${API_BASE}/api/leads?page=${page}&limit=${limit}`, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch leads');
                return await response.json();
            } catch (error) {
                console.error('Error fetching leads:', error);
                return { leads: [], has_more: false };
            }
        }

        async function markAllLeadsAsRead() {
            try {
                const response = await fetch(`${API_BASE}/api/leads/mark-read`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to mark leads as read');
                return await response.json();
            } catch (error) {
                console.error('Error marking leads as read:', error);
                return null;
            }
        }

        async function getUnreadCount() {
            try {
                const response = await fetch(`${API_BASE}/api/leads/unread-count`, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch unread count');
                return await response.json();
            } catch (error) {
                console.error('Error fetching unread count:', error);
                return { count: 0 };
            }
        }

        async function getStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`, {
                    credentials: "include"
                });
                if (!response.ok) throw new Error('Failed to fetch stats');
                return await response.json();
            } catch (error) {
                console.error('Error fetching stats:', error);
                return {
                    active_tasks: 0,
                    total_tasks: 0,
                    total_sources: 0,
                    total_keywords: 0,
                    total_matches: 0
                };
            }
        }

        async function createTask(taskData) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                if (!response.ok) throw new Error('Failed to create task');
                return await response.json();
            } catch (error) {
                console.error('Error creating task:', error);
                showToast('Ошибка создания задачи: ' + error.message, 'error');
                return null;
            }
        }

        async function updateTask(taskId, taskData) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                if (!response.ok) throw new Error('Failed to update task');
                return await response.json();
            } catch (error) {
                console.error('Error updating task:', error);
                showToast('Ошибка обновления задачи: ' + error.message, 'error');
                return null;
            }
        }

        async function deleteTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to delete task');
                return await response.json();
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('Ошибка удаления задачи: ' + error.message, 'error');
                return null;
            }
        }

        // ==================== NAVIGATION & HASH MANAGEMENT ====================
        let leadsPollingInterval = null;

        // Функция переключения вкладки с поддержкой hash
        async function switchToSection(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            const titles = {
                dashboard: 'Дашборд',
                tasks: 'Мои задачи',
                leads: 'Лиды',
                billing: 'Тарифы',
                settings: 'Настройки'
            };
            document.getElementById('page-title').textContent = titles[section];

            // Восстановить хлебные крошки (breadcrumbs)
            let breadcrumbsHtml = `<span style="color: #5856d6; font-weight: 600;">${titles[section]}</span>`;
            document.querySelector('.content').style.display = 'block';

            // Запустить polling только если вкладка Leads
            if (section === 'leads') {
                loadLeads();
                startLeadsPolling();
                // Пометить все лиды как прочитанные при открытии вкладки Лиды
                await markAllLeadsAsRead();
            } else {
                stopLeadsPolling();
            }

            // Обновить задачи если открыта вкладка Мои задачи
            if (section === 'tasks') renderTasks();
        }

        // Запуск polling лидов каждые 3 секунды
        function startLeadsPolling() {
            if (leadsPollingInterval) return; // Уже запущен
            leadsPollingInterval = setInterval(() => {
                const section = window.location.hash.substring(1) || 'dashboard';
                if (section === 'leads') {
                    loadLeads();
                }
            }, 3000);
        }

        // Остановка polling лидов
        function stopLeadsPolling() {
            if (leadsPollingInterval) {
                clearInterval(leadsPollingInterval);
                leadsPollingInterval = null;
            }
        }

        // Клики по вкладкам - установить hash и переключить
        document.querySelectorAll('[data-section]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                window.location.hash = section;
            });
        });

        // Обработка изменения hash (F5, переход по ссылке, кнопка назад/вперед)
        window.addEventListener('hashchange', () => {
            const section = window.location.hash.substring(1) || 'dashboard';
            switchToSection(section);
        });

        // При загрузке страницы - восстановить вкладку из hash
        document.addEventListener('DOMContentLoaded', () => {
            const section = window.location.hash.substring(1) || 'dashboard';
            switchToSection(section);
        });

        // ==================== TASK MANAGEMENT ====================
        let currentEditTaskId = null;

        async function openTaskModal(taskId = null) {
            currentEditTaskId = taskId;
            const modal = document.getElementById('task-modal');
            const form = document.getElementById('task-form');

            form.reset();

            if (taskId) {
                // Fetch the specific task
                try {
                    const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Failed to fetch task');
                    const task = await response.json();

                    document.getElementById('modal-title').textContent = 'Редактировать задачу';
                    document.getElementById('task-name').value = task.name;
                    document.getElementById('task-sources').value = task.sources;
                    document.getElementById('task-include').value = task.include_keywords;
                    document.getElementById('task-exclude').value = task.exclude_keywords || '';
                    document.getElementById('task-channel').value = task.forward_channel || '';
                } catch (error) {
                    console.error('Error loading task:', error);
                    showToast('Ошибка загрузки задачи', 'error');
                    return;
                }
            } else {
                document.getElementById('modal-title').textContent = 'Создать задачу';
            }

            modal.classList.add('active');
        }

        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('active');
            currentEditTaskId = null;
        }

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('task-name').value.trim();
            const sources = document.getElementById('task-sources').value.trim();
            const include = document.getElementById('task-include').value.trim();
            const exclude = document.getElementById('task-exclude').value.trim();
            const channel = document.getElementById('task-channel').value.trim();

            if (!name) {
                showToast('Название задачи обязательно', 'warning');
                return;
            }

            if (!include) {
                showToast('Требуется хотя бы одно включающее ключевое слово', 'warning');
                return;
            }

            const taskData = {
                name: name,
                status: 'running',
                sources: sources,
                include_keywords: include,
                exclude_keywords: exclude,
                forward_channel: channel
            };

            let result;
            if (currentEditTaskId) {
                result = await updateTask(currentEditTaskId, taskData);
            } else {
                result = await createTask(taskData);
            }

            if (result) {
                closeTaskModal();
                await renderTasks();
                await updateStats();
                showToast(currentEditTaskId ? 'Задача обновлена!' : 'Задача создана!', 'success');
            }
        });

        async function deleteTaskHandler(taskId) {
            showDeleteConfirm('Вы уверены, что хотите удалить эту задачу? Это действие нельзя отменить.', async () => {
                const result = await deleteTask(taskId);
                if (result) {
                    await renderTasks();
                    await updateStats();
                    showToast('Задача удалена', 'success');
                }
            });
        }

        async function toggleTaskStatus(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to fetch task');
                const task = await response.json();

                const newStatus = task.status === 'running' ? 'paused' : 'running';
                const result = await updateTask(taskId, { status: newStatus });

                if (result) {
                    await renderTasks();
                }
            } catch (error) {
                console.error('Error toggling task status:', error);
            }
        }

        async function renderTasks() {
            const tasks = await getTasks();
            const container = document.getElementById('tasks-container');

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                        <h4 class="text-xl font-semibold text-gray-900 mb-2">Нет задач</h4>
                        <p class="text-gray-600 mb-4">Создайте свою первую задачу мониторинга, чтобы начать</p>
                        <button class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" onclick="openTaskModal()">
                            <i class="bi bi-plus"></i> Создать задачу
                        </button>
                    </div>
                `;
                return;
            }

            const countItems = (str) => str ? str.split(',').filter(s => s.trim()).length : 0;

            container.innerHTML = tasks.map(task => {
                const sources = countItems(task.sources);
                const includes = countItems(task.include_keywords);
                const excludes = countItems(task.exclude_keywords);
                const isRunning = task.status === 'running';
                const statusColor = isRunning
                    ? 'bg-emerald-100 text-emerald-700'
                    : 'bg-gray-200 text-gray-600';

                return `
                    <div class="bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all duration-200 p-5 hover:-translate-y-0.5">
                        <!-- Gradient полоска -->
                        <div class="h-1 bg-gradient-to-r from-indigo-500 via-sky-500 to-cyan-400 rounded-t-2xl -mx-5 -mt-5 mb-4"></div>

                        <!-- Header -->
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(task.name)}</h3>
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusColor}">
                                ${isRunning ? '🟢 Работает' : '⏸ Пауза'}
                            </span>
                        </div>

                        <!-- Статистика -->
                        <div class="flex gap-3 mb-4">
                            <div class="flex-1 bg-gray-50 rounded-xl p-3 text-center hover:bg-gray-100 transition">
                                <div class="text-xl font-bold text-indigo-600">📡${sources}</div>
                                <div class="text-xs text-gray-500 mt-1">Источники</div>
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-xl p-3 text-center hover:bg-gray-100 transition">
                                <div class="text-xl font-bold text-indigo-600">➕${includes}</div>
                                <div class="text-xs text-gray-500 mt-1">Включить</div>
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-xl p-3 text-center hover:bg-gray-100 transition">
                                <div class="text-xl font-bold text-indigo-600">➖${excludes}</div>
                                <div class="text-xs text-gray-500 mt-1">Исключить</div>
                            </div>
                        </div>

                        <!-- Разделитель -->
                        <div class="border-t border-gray-100 my-4"></div>

                        <!-- Кнопки -->
                        <div class="flex gap-2">
                            <button onclick="toggleTaskStatus(${task.id})" class="h-9 px-3 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg text-sm font-medium transition active:scale-95">
                                ⏸ ${isRunning ? 'Пауза' : 'Запуск'}
                            </button>
                            <button onclick="openTaskModal(${task.id})" class="h-9 px-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition active:scale-95">
                                ✏ Редакт
                            </button>
                            <button onclick="deleteTaskHandler(${task.id})" class="h-9 px-3 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-sm font-medium transition active:scale-95">
                                🗑
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== LEADS MANAGEMENT ====================

        // Функция рендеринга компактной карточки лида для списка
        function renderLeadCard(lead, taskName) {
            const foundDate = new Date(lead.found_at).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Обрезать текст до 3 строк (~180 символов)
            let displayText = lead.text.replace(/\n+/g, ' ').trim();
            if (displayText.length > 180) {
                displayText = displayText.substring(0, 180) + '...';
            }

            return `
                <div class="lead-card" data-lead-id="${lead.id}" style="
                    background: white;
                    border-radius: 12px;
                    border: 1px solid #e5e7eb;
                    padding: 12px;
                    margin-bottom: 10px;
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                    transition: all 0.2s ease;
                    cursor: pointer;
                    display: grid;
                    grid-template-columns: 1fr auto;
                    gap: 8px;
                    align-items: start;
                ">
                    <!-- Левая часть (кликабельная для открытия лида) -->
                    <div style="min-width: 0; overflow: hidden;">
                        <!-- Заголовок: источник + дата -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 6px;
                            gap: 8px;
                        ">
                            <span style="color: #5856d6; font-weight: 600; font-size: 12px; flex-shrink: 0;">
                                ${lead.source_channel}
                            </span>
                            <span style="color: #9ca3af; font-size: 11px; flex-shrink: 0;">
                                ${foundDate}
                            </span>
                        </div>

                        <!-- Обрезанный текст -->
                        <div style="
                            color: #374151;
                            font-size: 13px;
                            line-height: 1.4;
                            text-overflow: ellipsis;
                            overflow: hidden;
                        ">
                            ${escapeHtml(displayText)}
                        </div>

                        <!-- Ключевое слово (если есть) -->
                        ${lead.matched_keyword ? `
                            <div style="
                                color: #9ca3af;
                                font-size: 11px;
                                margin-top: 4px;
                            ">
                                ключ: <strong>${escapeHtml(lead.matched_keyword)}</strong>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Кнопка удаления -->
                    <button
                        class="delete-lead-btn"
                        data-lead-id="${lead.id}"
                        onclick="event.stopPropagation(); deleteLead(${lead.id})"
                        style="
                            background: none;
                            border: none;
                            cursor: pointer;
                            font-size: 18px;
                            color: #9ca3af;
                            flex-shrink: 0;
                            transition: color 0.2s;
                            padding: 4px;
                            line-height: 1;
                        "
                        onmouseover="this.style.color='#dc2626'"
                        onmouseout="this.style.color='#9ca3af'"
                        title="Удалить">
                        🗑
                    </button>
                </div>
            `;
        }

        // Функция для экранирования HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Хранилище для пагинации и дебаунса
        let leadsState = {
            page: 1,
            limit: 20,
            isLoading: false,
            hasMore: true,
            allLeads: []
        };

        // Функция загрузки и отрисовки лидов
        async function loadLeads(reset = true) {
            const container = document.getElementById('leads-container');

            try {
                if (reset) {
                    leadsState.page = 1;
                    leadsState.allLeads = [];
                }

                const response = await getLeads(leadsState.page, leadsState.limit);
                const leads = response.leads || [];
                leadsState.hasMore = response.has_more || false;

                // Добавить новые лиды в хранилище
                leadsState.allLeads = leadsState.allLeads.concat(leads);

                const tasks = await getTasks();

                // Получить значения фильтров
                const taskFilter = document.getElementById('filter-task')?.value || '';
                const searchFilter = document.getElementById('filter-search')?.value.toLowerCase() || '';

                // Применить фильтры к ВСЕ загруженным лидам
                let filtered = leadsState.allLeads;

                if (taskFilter) {
                    filtered = filtered.filter(lead => lead.task_id === parseInt(taskFilter));
                }

                if (searchFilter) {
                    filtered = filtered.filter(lead =>
                        lead.text.toLowerCase().includes(searchFilter) ||
                        lead.source_channel.toLowerCase().includes(searchFilter) ||
                        (lead.matched_keyword && lead.matched_keyword.toLowerCase().includes(searchFilter))
                    );
                }

                // Сортировать по дате (новые сверху)
                filtered.sort((a, b) => new Date(b.found_at) - new Date(a.found_at));

                // Если нет лидов - показать пустое состояние
                if (leadsState.allLeads.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔥</div>
                            <h4>Лиды отсутствуют</h4>
                            <p style="color: #888;">Лиды будут появляться здесь после запуска мониторинга</p>
                        </div>
                    `;
                    return;
                }

                // Если отфильтровалось 0 лидов
                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔍</div>
                            <h4>Лиды не найдены</h4>
                            <p style="color: #888;">Попробуйте изменить фильтры поиска</p>
                        </div>
                    `;
                    return;
                }

                // Построить HTML карточек лидов
                let html = '';
                filtered.forEach(lead => {
                    const taskName = tasks.find(t => t.id === lead.task_id)?.name || 'Неизвестная задача';
                    html += renderLeadCard(lead, taskName);
                });

                container.innerHTML = html;

                // Добавить обработчики кликов на карточки для открытия лида
                document.querySelectorAll('.lead-card').forEach(card => {
                    card.addEventListener('click', async (e) => {
                        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                        const leadId = card.getAttribute('data-lead-id');
                        openLeadPage(leadId);
                    });

                    // Добавить hover эффект
                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'translateY(-1px)';
                        card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                        card.style.backgroundColor = '#f9fafb';
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'translateY(0)';
                        card.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                        card.style.backgroundColor = 'white';
                    });
                });

                // Добавить кнопку пагинации если есть ещё лиды
                if (leadsState.hasMore) {
                    const paginationHtml = `
                        <div style="text-align: center; margin-top: 1rem; padding: 1rem;">
                            <button class="btn btn-primary" id="load-more-btn" onclick="loadMoreLeads()" style="padding: 0.6rem 1.5rem;">
                                Загрузить ещё
                            </button>
                        </div>
                    `;
                    container.innerHTML += paginationHtml;
                }

            } catch (error) {
                console.error('Error loading leads:', error);
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚠️</div>
                        <h4>Ошибка загрузки</h4>
                        <p style="color: #888;">Не удалось загрузить лиды. Попробуйте позже.</p>
                    </div>
                `;
            }
        }

        // Функция загрузки больше лидов
        async function loadMoreLeads() {
            leadsState.page += 1;
            loadLeads(false);
        }

        // Функция открытия отдельной страницы лида
        async function openLeadPage(leadId) {
            // Найти лид в leadsState
            const lead = leadsState.allLeads.find(l => l.id === parseInt(leadId));
            if (!lead) {
                showToast('Лид не найден', 'error');
                return;
            }

            // Пометить как прочитанный
            await markAllLeadsAsRead();

            // Показать страницу лида
            displayLeadPage(leadId, lead);
        }

        // Функция отображения страницы лида
        function displayLeadPage(leadId, lead) {
            const foundDate = new Date(lead.found_at).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const channelUsername = lead.source_channel.replace('@', '');
            const telegramProfileUrl = `https://t.me/${channelUsername}`;

            const content = document.querySelector('.content');
            content.innerHTML = `
                <!-- Breadcrumbs -->
                <nav style="
                    font-size: 0.9rem;
                    color: #6b7280;
                    margin-bottom: 1.5rem;
                    padding: 0;
                ">
                    <a href="#" onclick="switchToSection('leads'); return false;" style="color: #5856d6; text-decoration: none; cursor: pointer;">
                        Лиды
                    </a>
                    <span style="margin: 0 0.5rem;">></span>
                    <span>Лид #${lead.id}</span>
                </nav>

                <!-- Карточка лида -->
                <div style="
                    background: white;
                    border-radius: 12px;
                    border: 1px solid #e5e7eb;
                    padding: 2rem;
                    max-width: 800px;
                ">
                    <!-- Header -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: start;
                        margin-bottom: 1.5rem;
                        padding-bottom: 1rem;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <div>
                            <h2 style="
                                margin: 0 0 0.5rem 0;
                                font-size: 1.5rem;
                                font-weight: 700;
                                color: #111827;
                            ">
                                Лид #${lead.id}
                            </h2>
                            <div style="
                                display: flex;
                                gap: 1.5rem;
                                font-size: 0.9rem;
                                color: #6b7280;
                            ">
                                <div>
                                    <strong style="color: #111827;">Источник:</strong>
                                    <a href="${telegramProfileUrl}" target="_blank" style="
                                        color: #5856d6;
                                        text-decoration: none;
                                        margin-left: 0.5rem;
                                    ">
                                        ${lead.source_channel}
                                    </a>
                                </div>
                                <div>
                                    <strong style="color: #111827;">Дата:</strong>
                                    <span style="margin-left: 0.5rem;">${foundDate}</span>
                                </div>
                            </div>
                        </div>
                        <button
                            onclick="deleteLead(${lead.id}, true)"
                            style="
                                background: #fee2e2;
                                color: #dc2626;
                                border: 1px solid #fecaca;
                                padding: 0.5rem 1rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                            onmouseover="this.style.background='#fecaca'"
                            onmouseout="this.style.background='#fee2e2'"
                        >
                            🗑 Удалить
                        </button>
                    </div>

                    <!-- Содержание -->
                    <div style="
                        font-size: 1rem;
                        line-height: 1.6;
                        color: #374151;
                        white-space: pre-wrap;
                        word-break: break-word;
                        margin-bottom: 1.5rem;
                        padding: 1.5rem;
                        background: #f9fafb;
                        border-radius: 8px;
                    ">
                        ${escapeHtml(lead.text)}
                    </div>

                    <!-- Дополнительно -->
                    ${lead.matched_keyword ? `
                        <div style="
                            font-size: 0.9rem;
                            color: #6b7280;
                            padding-top: 1rem;
                            border-top: 1px solid #e5e7eb;
                        ">
                            <strong style="color: #111827;">Совпавшее ключевое слово:</strong>
                            <span style="margin-left: 0.5rem; color: #5856d6; font-weight: 600;">
                                ${escapeHtml(lead.matched_keyword)}
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;

            // Скрыть все секции и показать новую
            document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
            document.getElementById('page-title').textContent = `Лид #${lead.id}`;
        }

        // Функция удаления лида
        async function deleteLead(leadId, fromPage = false) {
            showDeleteConfirm('Вы уверены, что хотите удалить этот лид? Это действие нельзя отменить.', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/leads/${leadId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (!response.ok) throw new Error('Failed to delete lead');

                    showToast('Лид удалён', 'success');

                    if (fromPage) {
                        // Если удаляем со страницы лида - вернуться на список
                        switchToSection('leads');
                    } else {
                        // Если удаляем из списка - убрать из DOM
                        const card = document.querySelector(`[data-lead-id="${leadId}"]`);
                        if (card) {
                            card.style.opacity = '0';
                            card.style.transform = 'translateX(-20px)';
                            setTimeout(() => card.remove(), 200);
                        }
                        // Удалить из leadsState
                        leadsState.allLeads = leadsState.allLeads.filter(l => l.id !== parseInt(leadId));
                    }
                } catch (error) {
                    console.error('Error deleting lead:', error);
                    showToast('Ошибка удаления лида', 'error');
                }
            });
        }

        // Функция для пометки лида как просмотренного
        async function markLeadAsViewed(leadId) {
            try {
                await fetch(`${API_BASE}/api/leads/${leadId}/viewed`, {
                    method: 'PUT',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Error marking lead as viewed:', error);
            }
        }

        // Функция скролла к лиду по ID
        function scrollToLead(leadId) {
            const card = document.querySelector(`[data-lead-id="${leadId}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Highlight эффект
                card.style.backgroundColor = '#fffacd';
                setTimeout(() => {
                    card.style.backgroundColor = 'white';
                }, 1500);
            }
        }

        // Старая функция renderLeads для совместимости (вызывает loadLeads)
        async function renderLeads(page = 1) {
            loadLeads();
        }

        async function setLeadStatus(leadId, status) {
            // TODO: Implement when leads API is ready
            console.log('Set lead status:', leadId, status);
        }

        async function updateStats() {
            const stats = await getStats();

            document.getElementById('stat-tasks').textContent = stats.active_tasks;
            document.getElementById('stat-sources').textContent = stats.total_sources;
            document.getElementById('stat-keywords').textContent = stats.total_keywords;
            document.getElementById('stat-leads').textContent = stats.total_matches;

            // Загрузить последние 5 лидов для Dashboard
            const response = await getLeads(1, 5);
            const recentLeads = response.leads || [];
            const tasks = await getTasks();

            const recentLeadsContainer = document.getElementById('recent-leads');

            if (recentLeads.length === 0) {
                recentLeadsContainer.innerHTML = '<div style="color: var(--text-light); padding: 0.75rem;">Лиды появятся после запуска мониторинга</div>';
                return;
            }

            let html = '';
            recentLeads.forEach(lead => {
                const taskName = tasks.find(t => t.id === lead.task_id)?.name || 'Неизвестная задача';
                html += renderLeadCard(lead, taskName);
            });

            recentLeadsContainer.innerHTML = html;

            // Добавить обработчики кликов на карточки
            document.querySelectorAll('#recent-leads .lead-card').forEach(card => {
                card.addEventListener('click', async (e) => {
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                    const leadId = card.getAttribute('data-lead-id');
                    // Нужно загрузить лид из API или из leadsState
                    const lead = recentLeads.find(l => l.id === parseInt(leadId));
                    if (lead) {
                        leadsState.allLeads = recentLeads;
                        displayLeadPage(leadId, lead);
                    }
                });

                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-1px)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    card.style.backgroundColor = '#f9fafb';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    card.style.backgroundColor = 'white';
                });
            });
        }

        function saveSettings() {
            showToast('Настройки сохранены!', 'success');
        }

        // Update task filter in leads
        async function updateTaskFilter() {
            const tasks = await getTasks();
            const select = document.getElementById('filter-task');
            const current = select.value;
            select.innerHTML = '<option value="">Все задачи</option>' +
                tasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            select.value = current;
        }

        // Обработчики фильтров для загрузки лидов
        document.getElementById('filter-task').addEventListener('change', loadLeads);
        document.getElementById('filter-status').addEventListener('change', loadLeads);
        document.getElementById('filter-search').addEventListener('input', loadLeads);

        // ==================== Управление профилем пользователя ====================
        function updateTelegramAccountStatus() {
            const userJSON = localStorage.getItem('user');
            const statusDiv = document.getElementById('telegram-account-status');

            try {
                const user = JSON.parse(userJSON);
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'Пользователь';
                const phone = user.phone || '-';

                statusDiv.innerHTML = `
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 4px; border: 1px solid #22c55e; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <i class="bi bi-check-circle-fill" style="color: #22c55e; font-size: 1.2rem;"></i>
                            <span style="font-weight: 600; color: #22c55e;">Авторизирован</span>
                        </div>
                        <div style="color: var(--text-dark); margin-bottom: 0.5rem;">
                            <strong>${fullName}</strong>
                        </div>
                        <div style="color: var(--text-gray); font-size: 0.9rem;">
                            ${phone}
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('❌ Ошибка при обновлении статуса аккаунта:', e);
            }
        }

        function loadUserProfile() {
            const userJSON = localStorage.getItem('user');
            if (!userJSON) {
                console.log('❌ Информация о пользователе не найдена. Перенаправление на страницу входа...');
                window.location.href = '/login';
                return;
            }

            try {
                const user = JSON.parse(userJSON);
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'Пользователь';
                document.getElementById('profile-name').textContent = fullName;
                document.getElementById('profile-phone').textContent = user.phone || '-';
                console.log('✅ Профиль пользователя загружен:', fullName);

                // Обновить статус Telegram аккаунта в Settings
                updateTelegramAccountStatus();
            } catch (e) {
                console.error('❌ Ошибка при загрузке профиля:', e);
                window.location.href = '/login';
            }
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('visible');

            // Закрыть меню при клике вне него
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-profile')) {
                    menu.classList.remove('visible');
                }
            });
        }

        function logout() {
            showDeleteConfirm('Вы уверены, что хотите выйти из аккаунта?', () => {
                // Удалить информацию о пользователе из localStorage
                localStorage.removeItem('user');
                showToast('Вы вышли из аккаунта', 'info');

                // Перейти на страницу логина
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1000);
            });
        }

        // ==================== NOTIFICATIONS & REALTIME ====================

        // Хранилище уведомлений
        let unreadLeadsCount = 0;
        let recentNotifications = [];
        let leadsRealtimeInterval = null;

        // Переключение меню уведомлений
        async function toggleNotificationsMenu() {
            const menu = document.getElementById('notifications-menu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';

            // Если открываем меню - пометить все как прочитанные
            if (menu.style.display === 'block') {
                await markAllLeadsAsRead();

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.notifications-menu') && !e.target.closest('#notifications-btn')) {
                        menu.style.display = 'none';
                    }
                }, { once: true });
            }
        }

        // Обновить иконку колокольчика
        function updateNotificationsBell() {
            const badge = document.getElementById('notification-count');
            if (unreadLeadsCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = unreadLeadsCount > 99 ? '99+' : unreadLeadsCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // Обновить список уведомлений
        async function updateNotifications() {
            try {
                const result = await getUnreadCount();
                unreadLeadsCount = result.count || 0;
                updateNotificationsBell();

                const response = await getLeads(1, 5);
                const allLeads = response.leads || [];
                const newLeads = allLeads.filter(l => !l.is_read).slice(0, 5);

                const notificationsList = document.getElementById('notifications-list');
                if (newLeads.length === 0) {
                    notificationsList.innerHTML = `
                        <div style="padding: 1rem; text-align: center; color: #888;">
                            Нет новых лидов
                        </div>
                    `;
                    return;
                }

                let html = '';
                newLeads.forEach(lead => {
                    const preview = lead.text.substring(0, 60).replace(/\n/g, ' ') + (lead.text.length > 60 ? '...' : '');
                    html += `
                        <div style="
                            padding: 0.75rem 1rem;
                            border-bottom: 1px solid #f0f0f0;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onclick="scrollToLead(${lead.id}); toggleNotificationsMenu();" onmouseover="this.style.background='#f7f8fb'" onmouseout="this.style.background='white'">
                            <div style="font-size: 12px; color: #888;">${lead.source_channel}</div>
                            <div style="font-size: 14px; color: #222; font-weight: 500;">🔥 ${escapeHtml(preview)}</div>
                        </div>
                    `;
                });
                notificationsList.innerHTML = html;
            } catch (error) {
                console.error('Error updating notifications:', error);
            }
        }

        // Realtime polling лидов каждые 10 секунд
        function startLeadsRealtimePolling() {
            if (leadsRealtimeInterval) return;

            leadsRealtimeInterval = setInterval(async () => {
                const section = window.location.hash.substring(1) || 'dashboard';

                // Обновить уведомления на любой странице
                await updateNotifications();

                // Если на странице Leads - обновить список
                if (section === 'leads') {
                    loadLeads();
                }
            }, 10000);
        }

        function stopLeadsRealtimePolling() {
            if (leadsRealtimeInterval) {
                clearInterval(leadsRealtimeInterval);
                leadsRealtimeInterval = null;
            }
        }

        // Закрыть меню уведомлений при клике вне его
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('notifications-menu');
            if (menu.style.display === 'block' && !e.target.closest('.notifications-menu') && !e.target.closest('#notifications-btn')) {
                menu.style.display = 'none';
            }
        });

        // Init
        (async () => {
            loadUserProfile();
            await updateStats();
            await updateTaskFilter();
            await updateNotifications();
            startLeadsRealtimePolling();
        })();
    </script>
</body>
</html>
