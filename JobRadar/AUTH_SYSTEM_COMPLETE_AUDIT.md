# üìã –ü–û–õ–ù–´–ô –ê–£–î–ò–¢ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò JobRadar

## A. –¢–û–ß–ö–ò –í–•–û–î–ê

### –û—Å–Ω–æ–≤–Ω—ã–µ endpoints –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

| ‚Ññ | Endpoint | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | HTTP –º–µ—Ç–æ–¥ |
|---|---|---|---|---|---|
| 1 | `/api/auth/start` | main.py | 884-1020 | –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å TelegramSession, –≤—ã–±—Ä–∞—Ç—å —Ñ–ª–æ—É | POST |
| 2 | `/api/auth/submit-code` | main.py | 1023-1071 | –û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS –∫–æ–¥, –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä–æ–ª—è | POST |
| 3 | `/api/auth/submit-password` | main.py | 1074-1113 | –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å 2FA (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è) | POST |
| 4 | `/api/auth/save` | main.py | 1115-1241 | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å TelegramSession –≤ –ë–î, —Å–æ–∑–¥–∞—Ç—å User, —Å–æ–∑–¥–∞—Ç—å auth_token | POST |
| 5 | `/api/auth/login-by-telegram` | main.py | 1244-1377 | –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô —Ñ–ª–æ—É: –≤—Ö–æ–¥ –ø–æ –∫–æ–¥—É –∏–∑ Telegram –õ–° | POST |
| 6 | `/api/logout` | main.py | 1798-1844 | –í—ã—Ö–æ–¥: —É–¥–∞–ª–∏—Ç—å UserSession, –æ—á–∏—Å—Ç–∏—Ç—å cookie | POST |

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

| ‚Ññ | –§—É–Ω–∫—Ü–∏—è | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|---|---|---|
| 1 | `create_user_session()` | main.py | 215-257 | –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å auth_token, —Å–æ–∑–¥–∞—Ç—å UserSession, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å user.auth_token |
| 2 | `get_current_user()` | main.py | 260-298 | Dependency: –ø—Ä–æ—á–∏—Ç–∞—Ç—å auth_token –∏–∑ cookie, –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| 3 | `save_session_to_db()` | telegram_auth.py | 15-98 | –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å User –∏ TelegramSession –≤ –ë–î |
| 4 | `normalize_phone()` | main.py | 879-882 | –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ —Ñ–æ—Ä–º–∞—Ç—É +7/8 |

---

## B. –ò–°–¢–û–ß–ù–ò–ö–ò –°–û–°–¢–û–Ø–ù–ò–Ø

### –¢–∞–±–ª–∏—Ü—ã –ë–î:

| –¢–∞–±–ª–∏—Ü–∞ | –ü–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°–æ–∑–¥–∞–µ—Ç—Å—è | –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è |
|---|---|---|---|---|
| **users** | id (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ù–∏–∫–æ–≥–¥–∞ |
| **users** | phone (UNIQUE) | –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π) | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ù–∏–∫–æ–≥–¥–∞ |
| **users** | auth_token (UNIQUE, INDEX) | LEGACY: –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–∫–µ–Ω –≤—Ö–æ–¥–∞ | –ü—Ä–∏ –≤—Ö–æ–¥–µ | –ü—Ä–∏ –≤—Ö–æ–¥–µ (fallback) |
| **telegram_sessions** | id (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏ Telegram | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ù–∏–∫–æ–≥–¥–∞ |
| **telegram_sessions** | user_id (FK, UNIQUE) | –°—Å—ã–ª–∫–∞ –Ω–∞ User (–æ–¥–∏–Ω User = –æ–¥–Ω–∞ Telegram —Å–µ—Å—Å–∏—è) | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ? (–ø–æ–∫–∞ –ù–ï –º–µ–Ω—è–µ—Ç—Å—è!) |
| **telegram_sessions** | phone (UNIQUE) | –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ Telegram | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ |
| **telegram_sessions** | session_string (TEXT) | –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è StringSession –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ü—Ä–∏ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ –∫–æ–¥ |
| **telegram_sessions** | telegram_user_id | Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ |
| **telegram_sessions** | telegram_username | Telegram @username (–±–µ–∑ @) | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ü—Ä–∏ –≤—Ö–æ–¥–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ |
| **telegram_sessions** | telegram_first_name | Telegram –ø–µ—Ä–≤–æ–µ –∏–º—è | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ü—Ä–∏ –≤—Ö–æ–¥–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ |
| **telegram_sessions** | telegram_last_name | Telegram —Ñ–∞–º–∏–ª–∏—è | –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ | –ü—Ä–∏ –≤—Ö–æ–¥–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ |
| **user_sessions** | id (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞ | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ | –ù–∏–∫–æ–≥–¥–∞ |
| **user_sessions** | user_id (FK, INDEX) | –°—Å—ã–ª–∫–∞ –Ω–∞ User | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ | –ù–∏–∫–æ–≥–¥–∞ |
| **user_sessions** | auth_token (UNIQUE, INDEX) | –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ç–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞ | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ | –ù–∏–∫–æ–≥–¥–∞ |
| **user_sessions** | created_at | –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–µ—Å—Å–∏—è | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ | –ù–∏–∫–æ–≥–¥–∞ |

### In-memory —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Python dict):

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∞ | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | TTL |
|---|---|---|---|---|---|
| `pending_auth_clients` | main.py | 166 | `{auth_id: {phone, client, created_at}}` | –•—Ä–∞–Ω–∏—Ç—å TelegramClient –ø–æ auth_id | 300 —Å–µ–∫ (5 –º–∏–Ω) |
| `pending_login_codes` | main.py | 170 | `{phone: {code, user_id, expires_at}}` | –•—Ä–∞–Ω–∏—Ç—å 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–ª—è LOGIN_BY_TELEGRAM | 300 —Å–µ–∫ (5 –º–∏–Ω) |

### Cookies:

| Cookie | –ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ | –ó–Ω–∞—á–µ–Ω–∏–µ | HTTPOnly | SameSite | Max-Age | –ü—É—Ç—å |
|---|---|---|---|---|---|---|
| `auth_token` | `/api/auth/save` –∏–ª–∏ `/api/auth/start` (–ø—Ä—è–º–æ–π –≤—Ö–æ–¥) –∏–ª–∏ `/api/auth/login-by-telegram` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ create_user_session() | ‚úÖ –î–∞ | lax | 10 –ª–µ—Ç | / |

---

## C. –ü–ê–ô–ü–õ–ê–ô–ù –°–¶–ï–ù–ê–†–ò–ï–í

### 1Ô∏è‚É£ –ü–ï–†–í–´–ô –í–•–û–î (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

```
–≠—Ç–∞–ø 1: –ò–ù–ò–¶–ò–ê–¶–ò–Ø
‚îú‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
‚îú‚îÄ Frontend: POST /api/auth/start {phone: "+79999999999"}
‚îú‚îÄ Backend:
‚îÇ  ‚îú‚îÄ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–æ–º–µ—Ä: "+79999999999" ‚Üí "+79999999999"
‚îÇ  ‚îú‚îÄ –ò—â–µ—Ç –≤ –ë–î: SELECT * FROM telegram_sessions WHERE phone = "+79999999999"
‚îÇ  ‚îú‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–ï –ù–ê–ô–î–ï–ù–û ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –í–ê–†–ò–ê–ù–¢ –ë
‚îÇ  ‚îî‚îÄ –í–ê–†–ò–ê–ù–¢ –ë: –†–µ–∂–∏–º SMS
‚îÇ     ‚îú‚îÄ TelegramClient = TelegramClient(StringSession(), API_ID, API_HASH)
‚îÇ     ‚îú‚îÄ await client.connect()
‚îÇ     ‚îú‚îÄ await client.send_code_request("+79999999999")  ‚Üê –û–¢–ü–†–ê–í–õ–Ø–ï–¢–°–Ø SMS –ö–û–î
‚îÇ     ‚îú‚îÄ auth_id = str(uuid.uuid4())
‚îÇ     ‚îú‚îÄ pending_auth_clients[auth_id] = {phone, client, created_at}
‚îÇ     ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {ok: true, auth_id, login_via: "telegram_sms"}

–≠—Ç–∞–ø 2: –ö–û–î –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
‚îú‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç SMS –∫–æ–¥
‚îú‚îÄ Frontend: POST /api/auth/submit-code {auth_id, code: "12345"}
‚îú‚îÄ Backend:
‚îÇ  ‚îú‚îÄ auth_data = pending_auth_clients[auth_id]
‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç TTL (5 –º–∏–Ω—É—Ç)
‚îÇ  ‚îú‚îÄ client = auth_data["client"]
‚îÇ  ‚îú‚îÄ await client.sign_in(phone, code)  ‚Üê –û–¢–ü–†–ê–í–õ–Ø–ï–¢ –ö–û–î –í TELEGRAM
‚îÇ  ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç telegram_user_id —á–µ—Ä–µ–∑ client.get_me()
‚îÇ  ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ pending_auth_clients[auth_id]["telegram_user_id"]
‚îÇ  ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {requires_password: false –∏–ª–∏ true}

–≠—Ç–∞–ø 3: –ü–ê–†–û–õ–¨ 2FA (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
‚îú‚îÄ –ï—Å–ª–∏ requires_password = true:
‚îÇ  ‚îú‚îÄ Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
‚îÇ  ‚îú‚îÄ Frontend: POST /api/auth/submit-password {auth_id, password}
‚îÇ  ‚îú‚îÄ Backend:
‚îÇ  ‚îÇ  ‚îú‚îÄ client = pending_auth_clients[auth_id]["client"]
‚îÇ  ‚îÇ  ‚îú‚îÄ await client.sign_in(password=password)
‚îÇ  ‚îÇ  ‚îî‚îÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∫ –≠–¢–ê–ü–£ 4
‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –ø–æ–≤—Ç–æ—Ä
‚îî‚îÄ –ï—Å–ª–∏ requires_password = false:
   ‚îî‚îÄ –°—Ä–∞–∑—É –∫ –≠–¢–ê–ü–£ 4

–≠—Ç–∞–ø 4: –°–û–•–†–ê–ù–ï–ù–ò–ï –°–ï–°–°–ò–ò –í –ë–î
‚îú‚îÄ Frontend: POST /api/auth/save {auth_id}
‚îú‚îÄ Backend:
‚îÇ  ‚îú‚îÄ auth_data = pending_auth_clients[auth_id]
‚îÇ  ‚îú‚îÄ client = auth_data["client"]
‚îÇ  ‚îú‚îÄ me = await client.get_me()  ‚Üê –ü–û–õ–£–ß–ò–¢–¨ –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
‚îÇ  ‚îú‚îÄ session_string = client.session.save()  ‚Üê –ü–û–õ–£–ß–ò–¢–¨ –°–¢–†–û–ö–£ –°–ï–°–°–ò–ò
‚îÇ  ‚îú‚îÄ await save_session_to_db(phone, session_string, me.id, me.username, me.first_name, me.last_name)
‚îÇ  ‚îÇ  ‚îî‚îÄ –í–ù–£–¢–†–ò save_session_to_db:
‚îÇ  ‚îÇ     ‚îú‚îÄ –ò—â–µ—Ç User –ø–æ phone
‚îÇ  ‚îÇ     ‚îú‚îÄ –ï—Å–ª–∏ –ù–ï –Ω–∞–π–¥–µ–Ω–∞:
‚îÇ  ‚îÇ     ‚îÇ  ‚îî‚îÄ –°–æ–∑–¥–∞–µ—Ç User(phone=phone, plan="trial", trial_expires_at=now+3–¥–Ω—è)
‚îÇ  ‚îÇ     ‚îú‚îÄ –ò—â–µ—Ç TelegramSession –ø–æ phone
‚îÇ  ‚îÇ     ‚îú‚îÄ –ï—Å–ª–∏ –ù–ï –Ω–∞–π–¥–µ–Ω–∞:
‚îÇ  ‚îÇ     ‚îÇ  ‚îî‚îÄ –°–æ–∑–¥–∞–µ—Ç TelegramSession(user_id, phone, session_string, ...)
‚îÇ  ‚îÇ     ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç user_id
‚îÇ  ‚îú‚îÄ user_id = —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚îÇ  ‚îú‚îÄ auth_token = create_user_session(user_id, db)
‚îÇ  ‚îÇ  ‚îî‚îÄ –í–ù–£–¢–†–ò create_user_session:
‚îÇ  ‚îÇ     ‚îú‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç auth_token = secrets.token_urlsafe(32)
‚îÇ  ‚îÇ     ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç UserSession(user_id, auth_token)
‚îÇ  ‚îÇ     ‚îú‚îÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç User.auth_token = auth_token (legacy)
‚îÇ  ‚îÇ     ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç auth_token
‚îÇ  ‚îú‚îÄ –£–¥–∞–ª—è–µ—Ç pending_auth_clients[auth_id]
‚îÇ  ‚îú‚îÄ await client.disconnect()
‚îÇ  ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {ok: true, user: user_info}

–≠—Ç–∞–ø 5: –£–°–¢–ê–ù–û–í–ö–ê COOKIE –ò –í–•–û–î
‚îú‚îÄ Backend —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie: Set-Cookie: auth_token=<token>; HttpOnly; Path=/; Max-Age=315360000
‚îú‚îÄ Frontend –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
‚îú‚îÄ localStorage.setItem("user", user_info)
‚îú‚îÄ showToast("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
‚îî‚îÄ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /dashboard

–ò–¢–û–ì–û –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞:
User: –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí SMS –ö–û–î ‚Üí –ü–ê–†–û–õ–¨ 2FA ‚Üí TelegramSession —Å–æ–∑–¥–∞–Ω–∞ ‚Üí User —Å–æ–∑–¥–∞–Ω ‚Üí auth_token —Å–æ–∑–¥–∞–Ω ‚Üí cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
```

---

### 2Ô∏è‚É£ –ü–û–í–¢–û–†–ù–´–ô –í–•–û–î (TelegramSession —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

```
–¢–ï–ö–£–©–ï–ï –ü–û–í–ï–î–ï–ù–ò–ï (–ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø):

–≠—Ç–∞–ø 1: –ò–ù–ò–¶–ò–ê–¶–ò–Ø
‚îú‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
‚îú‚îÄ Frontend: POST /api/auth/start {phone: "+79999999999"}
‚îú‚îÄ Backend:
‚îÇ  ‚îú‚îÄ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–æ–º–µ—Ä
‚îÇ  ‚îú‚îÄ –ò—â–µ—Ç –≤ –ë–î: SELECT * FROM telegram_sessions WHERE phone = "+79999999999"
‚îÇ  ‚îú‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–ê–ô–î–ï–ù–ê! ‚Üí –í–ê–†–ò–ê–ù–¢ –ê (–ü–†–Ø–ú–û–ô –í–•–û–î)
‚îÇ  ‚îî‚îÄ –í–ê–†–ò–ê–ù–¢ –ê: –†–µ–∂–∏–º –ü–†–Ø–ú–û–ì–û –≤—Ö–æ–¥–∞ –ë–ï–ó –ö–û–î–ê
‚îÇ     ‚îú‚îÄ user = db.query(User).filter(User.id = telegram_session.user_id).first()
‚îÇ     ‚îú‚îÄ ensure_active_subscription(user, db)  ‚Üê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
‚îÇ     ‚îú‚îÄ client = await get_user_client(user.id, db)
‚îÇ     ‚îÇ  ‚îî‚îÄ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é session_string –∏–∑ –ë–î
‚îÇ     ‚îú‚îÄ –ï—Å–ª–∏ client –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí fallback –Ω–∞ SMS
‚îÇ     ‚îú‚îÄ auth_token = create_user_session(user.id, db)
‚îÇ     ‚îÇ  ‚îî‚îÄ –°–æ–∑–¥–∞–µ—Ç –ù–û–í–£–Æ –∑–∞–ø–∏—Å—å UserSession (–Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –±—Ä–∞—É–∑–µ—Ä–∞!)
‚îÇ     ‚îú‚îÄ me = await client.get_me()  ‚Üê –ü–û–õ–£–ß–ò–¢–¨ –°–í–ï–ñ–ò–ï –î–ê–ù–ù–´–ï
‚îÇ     ‚îú‚îÄ user_info = {id, phone, first_name, last_name, username}
‚îÇ     ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {
‚îÇ          ok: true,
‚îÇ          login_via: "telegram_direct",
‚îÇ          auth_token: <token>,  ‚Üê –¢–û–ö–ï–ù –í –û–¢–í–ï–¢–ï!
‚îÇ          user: user_info
‚îÇ        }

–≠—Ç–∞–ø 2: –£–°–¢–ê–ù–û–í–ö–ê COOKIE –ò –†–ï–î–ò–†–ï–ö–¢
‚îú‚îÄ Backend —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie: Set-Cookie: auth_token=<token>
‚îú‚îÄ Frontend –ü–û–õ–£–ß–ê–ï–¢ auth_token –≤ –æ—Ç–≤–µ—Ç–µ
‚îú‚îÄ if (data.auth_token) {
‚îÇ  ‚îú‚îÄ console.log("üöÄ [AUTO-LOGIN] –ü—Ä—è–º–æ–π –≤—Ö–æ–¥ –ë–ï–ó –∫–æ–¥–∞!")
‚îÇ  ‚îú‚îÄ localStorage.setItem("user", user_info)
‚îÇ  ‚îú‚îÄ showToast("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –º–≥–Ω–æ–≤–µ–Ω–Ω–æ üöÄ")
‚îÇ  ‚îú‚îÄ showStage("success")
‚îÇ  ‚îî‚îÄ setTimeout(() => window.location.href = "/dashboard", 1500)
‚îÇ  }

–ò–¢–û–ì–û –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞:
TelegramSession –Ω–∞–π–¥–µ–Ω–∞ ‚Üí –ù–∏–∫–∞–∫–æ–π –∫–æ–¥ –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Üí auth_token —Å–æ–∑–¥–∞–Ω –°–†–ê–ó–£ ‚Üí cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard –∑–∞ 1.5 —Å–µ–∫
```

---

### 3Ô∏è‚É£ FALLBACK –°–¶–ï–ù–ê–†–ò–ô (TelegramSession –µ—Å—Ç—å, –Ω–æ TelegramClient –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

```
–≠—Ç–∞–ø 1: –ò–ù–ò–¶–ò–ê–¶–ò–Ø
‚îú‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
‚îú‚îÄ Frontend: POST /api/auth/start {phone: "+79999999999"}
‚îú‚îÄ Backend:
‚îÇ  ‚îú‚îÄ –ò—â–µ—Ç –≤ –ë–î: SELECT * FROM telegram_sessions WHERE phone
‚îÇ  ‚îú‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–ê–ô–î–ï–ù–ê!
‚îÇ  ‚îú‚îÄ –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å TelegramClient:
‚îÇ  ‚îÇ  ‚îú‚îÄ client = await get_user_client(user.id, db)
‚îÇ  ‚îÇ  ‚îî‚îÄ –û—à–∏–±–∫–∞: session_string –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
‚îÇ  ‚îú‚îÄ EXCEPTION ‚Üí fallback –∫ –í–ê–†–ò–ê–ù–¢ –ë
‚îÇ  ‚îî‚îÄ –í–ê–†–ò–ê–ù–¢ –ë: –†–µ–∂–∏–º Telegram SMS (–∫–∞–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
‚îÇ     ‚îú‚îÄ TelegramClient = TelegramClient(StringSession(), API_ID, API_HASH)
‚îÇ     ‚îú‚îÄ await client.connect()
‚îÇ     ‚îú‚îÄ await client.send_code_request(phone)  ‚Üê –û–¢–ü–†–ê–í–õ–Ø–ï–¢–°–Ø SMS –ö–û–î
‚îÇ     ‚îî‚îÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∫–∞–∫ –ü–ï–†–í–´–ô –í–•–û–î

–†–ï–ó–£–õ–¨–¢–ê–¢: –ï—Å–ª–∏ TelegramSession –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí fallback –Ω–∞ SMS –∫–æ–¥ (–Ω–µ—Ç —Ä–∞–∑–Ω–∏—Ü—ã –∫–∞–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
```

---

### 4Ô∏è‚É£ LOGOUT

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–í—ã—Ö–æ–¥"
‚îú‚îÄ Frontend: POST /api/logout (—Å auth_token –≤ cookie)
‚îú‚îÄ Backend:
‚îÇ  ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç response: JSONResponse({ok: true})
‚îÇ  ‚îú‚îÄ –£–¥–∞–ª—è–µ—Ç cookie: response.delete_cookie("auth_token", path="/")
‚îÇ  ‚îú‚îÄ –ò—â–µ—Ç –≤ –ë–î: SELECT * FROM user_sessions WHERE auth_token = cookie_value
‚îÇ  ‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞:
‚îÇ  ‚îÇ     ‚îú‚îÄ db.delete(user_session)
‚îÇ  ‚îÇ     ‚îú‚îÄ db.commit()
‚îÇ  ‚îÇ     ‚îî‚îÄ –õ–æ–≥–∏—Ä—É–µ—Ç: "[SESSION_DELETE] user_id=42 - —Å–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞"
‚îÇ  ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç response (—Å Set-Cookie header —É–¥–∞–ª–µ–Ω–∏—é)

–†–µ–∑—É–ª—å—Ç–∞—Ç: –£–¥–∞–ª—è–µ—Ç—Å—è user_sessions –∑–∞–ø–∏—Å—å, cookie —É–¥–∞–ª—è–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, users.auth_token –ù–ï –¢–†–û–ì–ê–ï–¢–°–Ø

–ü–æ—Å–ª–µ logout:
‚îú‚îÄ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–µ–≤–∞–π—Å–∞—Ö:
‚îÇ  ‚îú‚îÄ –ù–∞ —ç—Ç–æ–º –¥–µ–≤–∞–π—Å–µ: cookie —É–¥–∞–ª–µ–Ω–∞, session —É–¥–∞–ª–µ–Ω–∞ ‚Üí 401 –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ
‚îÇ  ‚îî‚îÄ –ù–∞ –¥—Ä—É–≥–∏—Ö –¥–µ–≤–∞–π—Å–∞—Ö: –∏—Ö cookies –æ—Å—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏! ‚Üí –º–æ–≥—É—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É
```

---

### 5Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –°–ï–°–°–ò–ò –ù–ê –ö–ê–ñ–î–û–ú –ó–ê–ü–†–û–°–ï

```
–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, GET /api/tasks)
‚îú‚îÄ FastAPI –¥–æ—Å—Ç–∞–µ—Ç dependency get_current_user()
‚îÇ  ‚îú‚îÄ auth_token = Cookie(default=None)  ‚Üê –ß–∏—Ç–∞–µ—Ç –∏–∑ request.cookies["auth_token"]
‚îÇ  ‚îú‚îÄ db = SessionLocal()
‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ auth_token is None:
‚îÇ     ‚îî‚îÄ HTTPException(401, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω")
‚îÇ
‚îú‚îÄ –ü–û–ü–´–¢–ö–ê 1: –ò—â–µ—Ç –≤ –ù–û–í–û–ô —Å–∏—Å—Ç–µ–º–µ
‚îÇ  ‚îú‚îÄ user_session = db.query(UserSession).filter(UserSession.auth_token == auth_token).first()
‚îÇ  ‚îú‚îÄ –ï—Å–ª–∏ –ù–ê–ô–î–ï–ù–ê:
‚îÇ  ‚îÇ  ‚îú‚îÄ user = db.query(User).filter(User.id == user_session.user_id).first()
‚îÇ  ‚îÇ  ‚îú‚îÄ logger.info("[SESSION_LOOKUP] –Ω–∞–π–¥–µ–Ω–∞ –≤ user_sessions")
‚îÇ  ‚îÇ  ‚îî‚îÄ return user  ‚Üê –£–°–ü–ï–•!
‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ –ù–ï –ù–ê–ô–î–ï–ù–ê:
‚îÇ     ‚îî‚îÄ –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –ü–û–ü–´–¢–ö–ï 2
‚îÇ
‚îú‚îÄ –ü–û–ü–´–¢–ö–ê 2: Fallback –Ω–∞ –°–¢–ê–†–£–Æ —Å–∏—Å—Ç–µ–º—É (legacy)
‚îÇ  ‚îú‚îÄ user = db.query(User).filter(User.auth_token == auth_token).first()
‚îÇ  ‚îú‚îÄ –ï—Å–ª–∏ –ù–ê–ô–î–ï–ù–ê:
‚îÇ  ‚îÇ  ‚îú‚îÄ logger.info("[SESSION_FALLBACK_LEGACY] –Ω–∞–π–¥–µ–Ω–∞ –≤ users.auth_token")
‚îÇ  ‚îÇ  ‚îî‚îÄ return user  ‚Üê –£–°–ü–ï–•!
‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ –ù–ï –ù–ê–ô–î–ï–ù–ê:
‚îÇ     ‚îî‚îÄ HTTPException(401, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞")

–†–µ–∑—É–ª—å—Ç–∞—Ç:
‚îú‚îÄ –ï—Å–ª–∏ token –≤ user_sessions ‚Üí –ë–´–°–¢–†–û –Ω–∞–π–¥–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å
‚îú‚îÄ –ï—Å–ª–∏ token —Ç–æ–ª—å–∫–æ –≤ users.auth_token ‚Üí fallback –Ω–∞–π–¥–µ—Ç
‚îî‚îÄ –ï—Å–ª–∏ token –Ω–∏–≥–¥–µ –Ω–µ—Ç ‚Üí 401 –æ—à–∏–±–∫–∞
```

---

## D. –ö–ê–†–¢–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### –§–∞–∫—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–º:

| –°—Ü–µ–Ω–∞—Ä–∏–π | –§–∞–∫—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è | –ì–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç | –ú–æ–∂–µ—Ç –ª–∏ –≤–æ–π—Ç–∏ –¢–û–õ–¨–ö–û –ø–æ –Ω–æ–º–µ—Ä—É |
|---|---|---|---|
| **–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥** | SMS –∫–æ–¥ (–æ—Ç Telegram) | TelegramClient.send_code_request() ‚Üí TelegramClient.sign_in(code) | ‚ùå –ù–ï–¢ - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–¥ –∏–∑ SMS |
| **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥** | –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è session_string –≤ –ë–î | –í–∞–ª–∏–¥–∞—Ü–∏—è TelegramClient —á–µ—Ä–µ–∑ get_user_client() | ‚ùå –ù–ï–¢ - —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–∞—è —Å–µ—Å—Å–∏—è –≤ –ë–î |
| **Fallback (session –º–µ—Ä—Ç–≤–∞)** | SMS –∫–æ–¥ | –ö–∞–∫ –ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥ | ‚ùå –ù–ï–¢ - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–¥ |

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:

```
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:
   ‚îî‚îÄ ensure_active_subscription(user, db)
      ‚îú‚îÄ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤:
      ‚îÇ  ‚îú‚îÄ /api/auth/start –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ (–í–ê–†–ò–ê–ù–¢ –ê)
      ‚îÇ  ‚îî‚îÄ /api/auth/login-by-telegram
      ‚îî‚îÄ –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ ‚Üí HTTPException(403)

2. –ó–∞—â–∏—Ç–∞ TTL:
   ‚îú‚îÄ pending_auth_clients: 300 —Å–µ–∫ (5 –º–∏–Ω—É—Ç)
   ‚îú‚îÄ pending_login_codes: 300 —Å–µ–∫ (5 –º–∏–Ω—É—Ç)
   ‚îî‚îÄ –ï—Å–ª–∏ TTL –∏—Å—Ç–µ–∫ ‚Üí –æ—à–∏–±–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –∏–∑ –ø–∞–º—è—Ç–∏

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ user_id —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:
   ‚îú‚îÄ –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ LOGIN_BY_TELEGRAM
   ‚îî‚îÄ if login_data.get("user_id") != user.id ‚Üí HTTPException(403)

4. –ü—Ä–æ–≤–µ—Ä–∫–∞ telegram_user_id —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:
   ‚îú‚îÄ –ü—Ä–∏ auth_submit_password
   ‚îú‚îÄ –ü—Ä–∏ auth_save
   ‚îî‚îÄ –ï—Å–ª–∏ ID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí Exception

5. HTTPOnly cookie:
   ‚îú‚îÄ auth_token —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å httponly=True
   ‚îî‚îÄ –ó–∞—â–∏—â–µ–Ω–æ –æ—Ç XSS –¥–æ—Å—Ç—É–ø–∞

6. SameSite cookie:
   ‚îú‚îÄ SameSite=lax
   ‚îî‚îÄ –ó–∞—â–∏—â–µ–Ω–æ –æ—Ç CSRF –∞—Ç–∞–∫
```

---

## E. –î–ò–ê–ì–†–ê–ú–ú–ê –ü–û–¢–û–ö–û–í (–¢–ï–ö–°–¢–û–í–ê–Ø)

### –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):

```
FIRST LOGIN FLOW:
         –¢–µ–ª–µ—Ñ–æ–Ω
            ‚Üì
[/api/auth/start]
            ‚Üì
   TelegramSession –ù–ï –Ω–∞–π–¥–µ–Ω–∞
            ‚Üì
[–í–ê–†–ò–ê–ù–¢ –ë: SMS —Ä–µ–∂–∏–º]
            ‚Üì
   TelegramClient —Å–æ–∑–¥–∞–Ω
            ‚Üì
  SMS –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
            ‚Üì
    Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –∫–æ–¥–∞
            ‚Üì
 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç SMS
            ‚Üì
 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥
            ‚Üì
[/api/auth/submit-code]
            ‚Üì
  await client.sign_in(code)
            ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ 2FA —Ç—Ä–µ–±—É–µ—Ç—Å—è?
    ‚îú‚îÄ –î–ê ‚Üí [/api/auth/submit-password]
    ‚îÇ         ‚Üì
    ‚îÇ   await client.sign_in(password)
    ‚îÇ         ‚Üì
    ‚îî‚îÄ –ù–ï–¢ ‚îÄ‚îÄ‚îò
            ‚Üì
[/api/auth/save]
            ‚Üì
session_string –ø–æ–ª—É—á–µ–Ω–∞
            ‚Üì
await save_session_to_db()
            ‚îú‚îÄ User —Å–æ–∑–¥–∞–Ω (–ø–ª–∞–Ω=trial)
            ‚îî‚îÄ TelegramSession —Å–æ–∑–¥–∞–Ω–∞
            ‚Üì
 auth_token —Å–æ–∑–¥–∞–Ω (create_user_session)
            ‚îú‚îÄ UserSession –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞
            ‚îî‚îÄ User.auth_token —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            ‚Üì
   Cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
   Set-Cookie: auth_token=...
            ‚Üì
Frontend: showStage("success")
            ‚Üì
–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /dashboard
            ‚Üì
           ‚úÖ –í–•–û–î –í–´–ü–û–õ–ù–ï–ù
```

### –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ (TelegramSession —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):

```
REPEAT LOGIN FLOW:
         –¢–µ–ª–µ—Ñ–æ–Ω
            ‚Üì
[/api/auth/start]
            ‚Üì
   TelegramSession –ù–ê–ô–î–ï–ù–ê!
            ‚Üì
[–í–ê–†–ò–ê–ù–¢ –ê: –ü—Ä—è–º–æ–π –≤—Ö–æ–¥]
            ‚Üì
TelegramClient –ø–æ–ª—É—á–µ–Ω –∏–∑ session_string
            ‚Üì
TelegramClient —Ä–∞–±–æ—Ç–∞–µ—Ç?
    ‚îú‚îÄ –î–ê ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
    ‚îÇ      ‚Üì
    ‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    ‚îÇ      ‚Üì
    ‚îÇ  auth_token —Å–æ–∑–¥–∞–Ω (create_user_session)
    ‚îÇ      ‚îú‚îÄ UserSession –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞
    ‚îÇ      ‚îî‚îÄ User.auth_token —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    ‚îÇ      ‚Üì
    ‚îÇ  user_info –ø–æ–ª—É—á–µ–Ω–∞
    ‚îÇ      ‚Üì
    ‚îÇ  –í –æ—Ç–≤–µ—Ç–µ: auth_token + user_info
    ‚îÇ      ‚Üì
    ‚îÇ  Frontend –≤–∏–¥–∏—Ç auth_token
    ‚îÇ      ‚Üì
    ‚îÇ  Cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    ‚îÇ      ‚Üì
    ‚îÇ  AUTO-LOGIN!
    ‚îÇ      ‚Üì
    ‚îÇ  showStage("success")
    ‚îÇ      ‚Üì
    ‚îÇ  –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /dashboard (1.5 —Å–µ–∫)
    ‚îÇ
    ‚îî‚îÄ –ù–ï–¢ ‚Üí Fallback –Ω–∞ SMS
            ‚Üì
        [FIRST LOGIN FLOW]
            ‚Üì
           ‚úÖ –í–•–û–î –í–´–ü–û–õ–ù–ï–ù
```

### Logout:

```
LOGOUT FLOW:
  –ù–∞–∂–∏–º–∞–µ—Ç "–í—ã—Ö–æ–¥"
            ‚Üì
[/api/logout]
            ‚Üì
–ß–∏—Ç–∞–µ—Ç auth_token –∏–∑ cookie
            ‚Üì
–ò—â–µ—Ç UserSession –≤ –ë–î
            ‚îú‚îÄ –ù–∞–π–¥–µ–Ω–∞ ‚Üí –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å
            ‚îî‚îÄ –ù–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí –ò—â–µ—Ç legacy, –Ω–æ –ù–ï —É–¥–∞–ª—è–µ—Ç
            ‚Üì
Cookie —É–¥–∞–ª—è–µ—Ç—Å—è: Set-Cookie: auth_token=; Max-Age=0
            ‚Üì
Frontend: localStorage.clear()
            ‚Üì
–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
            ‚Üì
           ‚úÖ –í–´–•–û–î –í–´–ü–û–õ–ù–ï–ù
```

---

## F. –§–ê–ö–¢–ò–ß–ï–°–ö–û–ï –†–ï–ó–Æ–ú–ï

### 1. –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Å–µ–π—á–∞—Å –∫–æ–¥ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ?

**–û–¢–í–ï–¢: ‚ùå –ù–ï–¢**

–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ (–∫–æ–≥–¥–∞ TelegramSession —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) –∫–æ–¥ –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è.

---

### 2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–æ–¥?

**–û–¢–í–ï–¢: –ö–æ–¥–∞ –≤–æ–æ–±—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç**

- ‚ùå –ö–æ–¥ –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
- ‚ùå –ö–æ–¥ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Telegram
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ù–ï –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –∏ –≤–≤–æ–¥–∏—Ç—å –∫–æ–¥
- ‚úÖ –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è session_string –∏–∑ –ë–î

---

### 3. –ó–∞ —Å—á–µ—Ç —á–µ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ–≤–µ—Ä–∏–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ?

**–û–¢–í–ï–¢: –ó–∞ —Å—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π TelegramSession**

```
–ú–µ—Ö–∞–Ω–∏–∑–º –¥–æ–≤–µ—Ä–∏—è:
‚îú‚îÄ –í –ë–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ session_string (—Å–µ—Å—Å–∏—è –º–µ–∂–¥—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏ Telegram)
‚îú‚îÄ –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ:
‚îÇ  ‚îú‚îÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç TelegramClient –∏—Å–ø–æ–ª—å–∑—É—è session_string
‚îÇ  ‚îú‚îÄ Telegram —Å–µ—Ä–≤–µ—Ä —ç—Ç–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç (—Å–µ—Å—Å–∏—è –±—ã–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–Ω–µ–µ)
‚îÇ  ‚îî‚îÄ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
‚îÇ  ‚îú‚îÄ session_string —É–Ω–∏–∫–∞–ª—å–Ω–∞ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞
‚îÇ  ‚îú‚îÄ session_string –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –º–µ–∂–¥—É –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
‚îÇ  ‚îú‚îÄ Telegram API –∑–Ω–∞–µ—Ç –∫–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–∞ —Å–µ—Å—Å–∏—è
‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ session_string —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞ ‚Üí TelegramClient –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è
‚îî‚îÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è:
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
   ‚îî‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ TelegramClient –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
```

---

### 4. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —ç—Ç–æ —Ç—Ä–µ–±—É–µ–º–æ–π –º–æ–¥–µ–ª–∏?

```
–¢—Ä–µ–±—É–µ–º–∞—è –º–æ–¥–µ–ª—å:
‚îú‚îÄ –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ = SMS
‚îú‚îÄ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ = –ö–æ–¥ –≤ Telegram –õ–°
‚îî‚îÄ (–ê –ù–ï: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –±–µ–∑ –∫–æ–¥–∞)

–§–ê–ö–¢–ò–ß–ï–°–ö–û–ï –ü–û–í–ï–î–ï–ù–ò–ï (–¢–ï–ö–£–©–ï–ï):
‚îú‚îÄ –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ = SMS ‚úÖ –°–û–í–ü–ê–î–ê–ï–¢
‚îú‚îÄ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ = –ë–ï–ó –ö–û–î–ê (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è session_string) ‚ùå –ù–ï –°–û–í–ü–ê–î–ê–ï–¢
‚îî‚îÄ Fallback (session –º–µ—Ä—Ç–≤–∞) = SMS ‚úÖ –°–û–í–ü–ê–î–ê–ï–¢

–í–´–í–û–î:
‚îú‚îÄ –¢—Ä–µ–±—É–µ–º–∞—è –º–æ–¥–µ–ª—å: "–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ = Telegram –∫–æ–¥"
‚îú‚îÄ –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: "–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ = session_string (–±–µ–∑ –∫–æ–¥–∞)"
‚îî‚îÄ –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú ‚Üê –û–¢–õ–ò–ß–ê–ï–¢–°–Ø –û–¢ –û–ñ–ò–î–ê–ù–ò–ô
```

---

## üìä –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê: –î–û –ò –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ö–æ–¥ –±—ã–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω. –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¢–ï–ö–£–©–ï–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

| –ê—Å–ø–µ–∫—Ç | –ë—ã–ª–æ | –°–µ–π—á–∞—Å | –°—Ç–∞—Ç—É—Å |
|---|---|---|---|
| –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | SMS –∫–æ–¥ | SMS –∫–æ–¥ | ‚úÖ –ù–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å |
| TelegramSession –Ω–∞–π–¥–µ–Ω–∞ + –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è | –û—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è –≤ Telegram –õ–° | –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è | ‚úÖ –ò–ó–ú–ï–ù–ò–õ–û–°–¨ |
| –¢—Ä–µ–±—É–µ—Ç –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç | ‚úÖ –ò–ó–ú–ï–ù–ò–õ–û–°–¨ |
| –í—Ä–µ–º—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ | ~1-2 –º–∏–Ω—É—Ç—ã | ~1.5 —Å–µ–∫—É–Ω–¥—ã | ‚úÖ –ò–ó–ú–ï–ù–ò–õ–û–°–¨ |
| auth_token –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ | –í –æ—Ç–≤–µ—Ç–µ –ø–æ—Å–ª–µ –∫–æ–¥–∞ | –í –æ—Ç–≤–µ—Ç–µ /api/auth/start | ‚úÖ –ò–ó–ú–ï–ù–ò–õ–û–°–¨ |
| AUTO-LOGIN —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ | ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û |
| Fallback –Ω–∞ SMS | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å |

---

## ‚úÖ –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–ï–ó–Æ–ú–ï

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```
1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ú–ù–û–ì–û–£–†–û–í–ù–ï–í–ê–Ø:
   ‚îú‚îÄ –£—Ä–æ–≤–µ–Ω—å 1: Telegram SMS (–¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
   ‚îú‚îÄ –£—Ä–æ–≤–µ–Ω—å 2: TelegramSession + session_string (–¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤)
   ‚îú‚îÄ –£—Ä–æ–≤–µ–Ω—å 3: UserSession —Ç–∞–±–ª–∏—Ü–∞ (–¥–ª—è multi-session –ø–æ–¥–¥–µ—Ä–∂–∫–∏)
   ‚îî‚îÄ –£—Ä–æ–≤–µ–Ω—å 4: Fallback –Ω–∞ legacy User.auth_token (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π)

2. –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
   ‚îú‚îÄ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥: –ú–ì–ù–û–í–ï–ù–ù–´–ô (1.5 —Å–µ–∫ –±–µ–∑ –∫–æ–¥–∞)
   ‚îú‚îÄ –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥: –°–¢–ê–ù–î–ê–†–¢–ù–´–ô (SMS –∫–æ–¥ + 2FA + 5-10 –º–∏–Ω—É—Ç)
   ‚îú‚îÄ Fallback: –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ô (–µ—Å–ª–∏ session –º–µ—Ä—Ç–≤–∞ ‚Üí SMS)
   ‚îî‚îÄ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏: –ü–û–î–î–ï–†–ñ–ò–í–ê–Æ–¢–°–Ø (user_sessions —Ç–∞–±–ª–∏—Ü–∞)

3. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
   ‚îú‚îÄ –§–∞–∫—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è session_string (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥)
   ‚îú‚îÄ –§–∞–∫—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: SMS –∫–æ–¥ (–ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥ / fallback)
   ‚îú‚îÄ –ó–∞—â–∏—Ç–∞ –æ—Ç replay: TTL 5 –º–∏–Ω—É—Ç –Ω–∞ –∫–æ–¥—ã
   ‚îú‚îÄ –ó–∞—â–∏—Ç–∞ –æ—Ç cross-session: UNIQUE –∏–Ω–¥–µ–∫—Å –Ω–∞ auth_token
   ‚îî‚îÄ –ó–∞—â–∏—Ç–∞ –æ—Ç XSS: HTTPOnly cookie

4. –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú:
   ‚îú‚îÄ "–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ = SMS": ‚úÖ –î–ê
   ‚îú‚îÄ "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ = –∫–æ–¥ –≤ Telegram": ‚ùå –ù–ï–¢ (–≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ session_string)
   ‚îú‚îÄ "–ü—Ä—è–º–æ–π –≤—Ö–æ–¥ –±–µ–∑ –∫–æ–¥–∞ –µ—Å–ª–∏ session —Å—É—â–µ—Å—Ç–≤—É–µ—Ç": ‚úÖ –î–ê
   ‚îî‚îÄ –§–ê–ö–¢–ò–ß–ï–°–ö–ò–ô –ü–ê–¢–¢–ï–†–ù: "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ = –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é (–ë–ï–ó –∫–æ–¥–∞)"
```

---

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2026-02-05
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω
