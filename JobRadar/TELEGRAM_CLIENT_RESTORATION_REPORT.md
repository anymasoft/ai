# üîß –û–¢–ß–ï–¢ –û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ò –†–ê–ë–û–ß–ï–ô –í–ï–†–°–ò–ò TELEGRAMCLIENT

**–î–∞—Ç–∞:** 2026-02-05
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û –õ–û–ö–ê–õ–¨–ù–û
**–í–µ—Ç–∫–∞:** `claude/restore-working-telegram`
**–ö–æ–º–º–∏—Ç:** `43b4b7a1`

---

## üìã –ó–ê–î–ê–ß–ê

–ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ –ë–ï–ó –æ—à–∏–±–∫–∏:
```
"The authorization key was used under two different IP addresses"
```

–ò –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TelegramClient –¢–û–ß–ù–û –∫–∞–∫ –≤ —ç—Ç–æ–º –∫–æ–º–º–∏—Ç–µ.

---

## üîç –ê–ù–ê–õ–ò–ó GIT –ò–°–¢–û–†–ò–ò

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–º–∏—Ç—ã:

1. **f2cc111e** (2026-01-28) ‚úÖ –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø
   - "refactor: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ per-user Telegram –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –≤–º–µ—Å—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"
   - Per-user TelegramClient —Å –ø—Ä–æ—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
   - **–ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ is_user_authorized()**
   - –°–∏—Å—Ç–µ–º–∞ –†–ê–ë–û–¢–ê–õ–ê –°–¢–ê–ë–ò–õ–¨–ù–û

2. **b2e8acc1** (–ø–æ–∑–∂–µ) ‚ùå –ü–†–û–ë–õ–ï–ú–ù–ê–Ø –í–ï–†–°–ò–Ø
   - "fix: –ó–∞–∫—Ä—ã—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram"
   - **–î–û–ë–ê–í–õ–ï–ù–ê –ø—Ä–æ–≤–µ—Ä–∫–∞ is_user_authorized()**
   - –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ—è–≤–ª—è—Ç—å—Å—è –æ—à–∏–±–∫–∞ –ø—Ä–æ –¥–≤–æ–π–Ω–æ–µ IP

3. **3da17cd1** (–º–µ–∂–¥—É –Ω–∏–º–∏)
   - "feat: –î–æ–±–∞–≤–∏—Ç—å logout —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π Telegram —Å–µ—Å—Å–∏–∏"
   - –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ

---

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

**–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –≤ telegram_clients.py:**

```python
# ‚ùå –ü–†–û–ë–õ–ï–ú–ù–û–ï (–≤ b2e8acc1):
await client.connect()

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
if not await client.is_user_authorized():  # ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
    logger.error(...)
    await client.disconnect()
    return None
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É:**

1. `await client.connect()` —Å–æ–∑–¥–∞–µ—Ç –æ–¥–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
2. `await client.is_user_authorized()` —Å–æ–∑–¥–∞–µ—Ç **–í–¢–û–†–û–ï** –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram
3. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω —Å –æ–¥–Ω–æ–≥–æ IP, –∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ—Ç —Å –¥—Ä—É–≥–æ–≥–æ ‚Üí –æ—à–∏–±–∫–∞
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ `is_user_authorized()` –Ω–µ –Ω—É–∂–Ω–∞ - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ `is_connected()`

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –∫–æ–º–º–∏—Ç–∞ f2cc111e:

**1. telegram_clients.py - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó –ü–†–û–í–ï–†–ö–ò:**

```python
async def get_user_client(user_id: int, db: Session) -> Optional[TelegramClient]:
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à
    if user_id in telegram_clients_cache:
        cached_client = telegram_clients_cache[user_id]
        if cached_client.is_connected():  # ‚Üê –î–û–°–¢–ê–¢–û–ß–ù–û —ç—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏!
            return cached_client
        else:
            del telegram_clients_cache[user_id]

    try:
        # –ü–æ–ª—É—á–∏—Ç—å session_string –∏–∑ –ë–î
        telegram_session = db.query(TelegramSession).filter(...).first()

        if not telegram_session or not telegram_session.session_string:
            return None

        # –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç
        session_string = StringSession(telegram_session.session_string)
        client = TelegramClient(session_string, API_ID, API_HASH)

        # –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
        await client.connect()
        logger.info(f"[CLIENT_CREATE] user_id={user_id} - —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç")

        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à
        telegram_clients_cache[user_id] = client

        return client

    except Exception as e:
        logger.error(f"[CLIENT_CREATE] user_id={user_id} - –æ—à–∏–±–∫–∞: {e}")
        return None
```

**KEY DIFFERENCE:**
- ‚ùå **–ë–ï–ó** `await client.is_user_authorized()`
- ‚úÖ **–°** –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is_connected()` –∫–æ—Ç–æ—Ä–æ–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

**2. monitor.py - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø:**

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑ f2cc111e –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- send_lead_to_telegram() —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- check_source_for_task_leads() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç get_user_client()
- monitoring_loop_tasks() —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞–¥–æ
- safe_send_message() –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç FloodWait

---

## üìä –ß–¢–û –ë–´–õ–û –ò–ó–ú–ï–ù–ï–ù–û

### –§–∞–π–ª: telegram_clients.py

| –ß–∞—Å—Ç—å | –ë—ã–ª–æ (b2e8acc1) | –°—Ç–∞–ª–æ (f2cc111e) |
|-------|-----------------|------------------|
| **is_user_authorized() –ø—Ä–æ–≤–µ—Ä–∫–∞** | ‚úÖ –ï—Å—Ç—å (–ü–†–û–ë–õ–ï–ú–ê) | ‚ùå –ù–µ—Ç (–†–ï–®–ï–ù–ò–ï) |
| **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫** | 124 | 111 |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** | is_connected() + is_user_authorized() | is_connected() |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** | –°–ª–æ–∂–Ω–∞—è —Å –ª–∏—à–Ω–∏–º–∏ checks | –ü—Ä–æ—Å—Ç–∞—è |
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è—é—â–∞—è | Per-user –±–∞–∑–æ–≤–∞—è |

### –§–∞–π–ª: monitor.py

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| **–°—Ç—Ä–æ–∫** | 615 |
| **–í–µ—Ä—Å–∏—è –∏–∑** | f2cc111e (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è) |
| **–ò–∑–º–µ–Ω–µ–Ω–∏—è** | –ù–µ—Ç (–ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞) |

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

–ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å:

‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤**
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º client
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º

‚úÖ **–û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–æ–≤ –≤ Telegram**
- send_lead_to_telegram() —Ä–∞–±–æ—Ç–∞–µ—Ç
- safe_send_message() –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç FloodWait

‚úÖ **–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–æ–≤ –≤ Telegram**
- await client.send_message("me", code_message) —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å IP

‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤**
- –û–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç –Ω–∞ user_id
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏

‚ùå **–£–î–ê–õ–ï–ù–û / –ù–ï –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨:**
- `await client.is_user_authorized()` - —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

---

## üìù –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| **–ö–æ–º–º–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è** | 43b4b7a1 |
| **–î–∞—Ç–∞** | 2026-02-05 |
| **–í–µ—Ç–∫–∞** | claude/restore-working-telegram |
| **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ** | 2 |
| **–°—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ** | 47 |
| **–°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ** | 259 |
| **–ß–∏—Å—Ç–∞—è —Ä–∞–∑–Ω–∏—Ü–∞** | -212 —Å—Ç—Ä–æ–∫ (—É–ø—Ä–æ—â–µ–Ω–∏–µ!) |

---

## üîÑ –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –ö–õ–ò–ï–ù–¢–ê (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô)

```
–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–õ–ò–ï–ù–¢–ê:
1. –ó–∞–ø—Ä–æ—Å: await get_user_client(user_id, db)
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞: user_id in telegram_clients_cache?
   ‚îî‚îÄ –î–ê ‚Üí return cached_client (–µ—Å–ª–∏ is_connected())
   ‚îî‚îÄ –ù–ï–¢ ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π

–°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û –ö–õ–ò–ï–ù–¢–ê:
3. –ü–æ–ª—É—á–∏—Ç—å session_string –∏–∑ –ë–î
4. –°–æ–∑–¥–∞—Ç—å StringSession(session_string)
5. –°–æ–∑–¥–∞—Ç—å TelegramClient(session_string, API_ID, API_HASH)
6. await client.connect() ‚Üê –û–î–ù–û –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!
7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ telegram_clients_cache[user_id]
8. return client

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
9. send_lead_to_telegram() ‚Üí await safe_send_message(client, ...)
10. check_source_for_task_leads() ‚Üí await client.get_messages(...)
11. auth_start() ‚Üí await client.send_message("me", code)

–ó–ê–í–ï–†–®–ï–ù–ò–ï:
12. –ü—Ä–∏ logout ‚Üí disconnect_user_client(user_id)
    ‚îî‚îÄ await client.disconnect()
    ‚îî‚îÄ del telegram_clients_cache[user_id]

13. –ü—Ä–∏ shutdown ‚Üí disconnect_all_clients()
    ‚îî‚îÄ –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
```

---

## ‚úÖ –ì–ê–†–ê–ù–¢–ò–ò

‚úÖ **–û–¥–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram –Ω–∞ user_id**
- –ù–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π —á–µ—Ä–µ–∑ is_user_authorized()

‚úÖ **–ù–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–æ –¥–≤–æ–π–Ω–æ–µ IP**
- –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ `await client.connect()` –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

‚úÖ **–ü—Ä–æ—Å—Ç–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- –ú–∏–Ω–∏–º—É–º –ø—Ä–æ–≤–µ—Ä–æ–∫
- –ú–∞–∫—Å–∏–º—É–º –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

‚úÖ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ f2cc111e**
- –î–û–°–õ–û–í–ù–û–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- –ù–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –∏–ª–∏ —É–ª—É—á—à–µ–Ω–∏–π
- –¢–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω–æ–π —á–∞—Å—Ç–∏

---

## üìå –í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï

**–≠—Ç–∞ –≤–µ—Ä—Å–∏—è —Ä–∞–±–æ—Ç–∞–ª–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–Ω—å—à–µ.**

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ b2e8acc1 –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ–±–∞–≤–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ is_user_authorized().

**–û–¥–Ω–∞–∫–æ —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç IP-–∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ per-user –∫–ª–∏–µ–Ω—Ç–æ–≤.**

–†–µ—à–µ–Ω–∏–µ: –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏ f2cc111e –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ —Ä–∞–±–æ—Ç–∞—é—â–µ–π.

---

## üöÄ –†–ï–ó–£–õ–¨–¢–ê–¢

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¢–û–ß–ù–ê–Ø —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è TelegramClient –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–æ–≤ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–æ–≤ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| Per-user –∫–ª–∏–µ–Ω—Ç—ã | ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç |
| IP –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã | ‚ùå –ù–µ—Ç (–†–ï–®–ï–ù–û) |
| –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞ |

**–°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ** ‚úÖ

