# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Å—Å–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –û–±–∑–æ—Ä

–í–Ω–µ–¥—Ä–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É `user_sessions`.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (legacy):**
- –û–¥–∏–Ω auth_token –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–æ–ª–µ `users.auth_token`
- –õ–æ–≥–∏–Ω —Å –ü–ö ‚Üí –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω
- –õ–æ–≥–∏–Ω —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω ‚Üí –ü–ö –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è

**–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è ‚Üí –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `user_sessions`
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- –õ–æ–≥–∏–Ω —Å –ü–ö ‚Üí —Å–æ–∑–¥–∞–µ—Ç UserSession #1
- –õ–æ–≥–∏–Ω —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí —Å–æ–∑–¥–∞–µ—Ç UserSession #2 ‚Üí –æ–±–µ –æ—Å—Ç–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏
- Logout –Ω–∞ –ü–ö ‚Üí —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ UserSession #1 ‚Üí —Ç–µ–ª–µ—Ñ–æ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã:
- –°—Ç–∞—Ä–æ–µ –ø–æ–ª–µ `users.auth_token` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ legacy
- `get_current_user()` –∏–º–µ–µ—Ç fallback –ª–æ–≥–∏–∫—É:
  1. –ü–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –≤ `user_sessions` (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
  2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí fallback –Ω–∞ `users.auth_token` (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)
  3. –ï—Å–ª–∏ –Ω–∏–≥–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí 401 –æ—à–∏–±–∫–∞
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (–ø–æ–¥–ø–∏—Å–∫–∏, TelegramSession, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –ø–ª–∞—Ç–µ–∂–∏) –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–µ–Ω—ã

---

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. models.py

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å `UserSession`

```python
class UserSession(Base):
    """–ú–æ–¥–µ–ª—å —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π"""
    __tablename__ = "user_sessions"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)  # –í–ª–∞–¥–µ–ª–µ—Ü —Å–µ—Å—Å–∏–∏
    auth_token = Column(String(128), unique=True, index=True, nullable=False)  # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π —Ç–æ–∫–µ–Ω
    created_at = Column(DateTime, default=datetime.utcnow)  # –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–µ—Å—Å–∏—è
    last_seen_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)  # –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
```

**–ò–∑–º–µ–Ω–µ–Ω–æ:** –ù–∏—á–µ–≥–æ. –°—Ç–∞—Ä–æ–µ –ø–æ–ª–µ `User.auth_token` –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

### 2. main.py

#### –ò–º–ø–æ—Ä—Ç—ã (line 32)

**–ë—ã–ª–æ:**
```python
from models import Task, Lead, User, TelegramSession, Payment
```

**–°—Ç–∞–ª–æ:**
```python
from models import Task, Lead, User, TelegramSession, Payment, UserSession
```

#### –§—É–Ω–∫—Ü–∏—è create_user_session() (lines 214-257)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏

```python
def create_user_session(user_id: int, db: Session) -> str:
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ user_sessions

    –õ–æ–≥–∏–∫–∞:
    1. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π token
    2. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å UserSession
    3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å user.auth_token = token (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    4. –í–µ—Ä–Ω—É—Ç—å token

    –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: [SESSION_CREATE]
    """
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –¥–≤—É—Ö –º–µ—Å—Ç:
1. SMS –ª–æ–≥–∏–Ω (line 1172)
2. Telegram –ª–æ–≥–∏–Ω (line 1259)

#### get_current_user() (lines 259-298)

**–ë—ã–ª–æ:** –ò—â–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ `users.auth_token`

**–°—Ç–∞–ª–æ:** –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å fallback
1. –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –≤ `user_sessions` (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) ‚Üí [SESSION_LOOKUP]
2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí fallback –Ω–∞ `users.auth_token` (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞) ‚Üí [SESSION_FALLBACK_LEGACY]
3. –ï—Å–ª–∏ –Ω–∏–≥–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí 401 –æ—à–∏–±–∫–∞

#### logout endpoint (lines 1760-1806)

**–ë—ã–ª–æ:**
```python
async def logout(current_user: User = Depends(get_current_user), db: Session = Depends(get_db)):
    current_user.auth_token = None
    db.commit()
    response.delete_cookie(key="auth_token", path="/")
    return response
```

**–°—Ç–∞–ª–æ:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–æ
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç** `get_current_user` (ÈÅøÂÖç race condition)
- –ß–∏—Ç–∞–µ—Ç `auth_token` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ cookie
- –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ `user_sessions`
- –£–¥–∞–ª—è–µ—Ç cookie
- **–ù–ï —Ç—Ä–æ–≥–∞–µ—Ç** `users.auth_token` (legacy field)
- –î–∞–∂–µ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –±–∏—Ç—ã–π ‚Üí –≤—Å–µ —Ä–∞–≤–Ω–æ —É–¥–∞–ª—è–µ—Ç cookie –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** [SESSION_DELETE]

---

### 3. database.py

#### migrate_schema() (lines 157-174)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã `user_sessions`

```python
# ==================== –¢–ê–ë–õ–ò–¶–ê USER_SESSIONS ====================
try:
    result = connection.execute(text("PRAGMA table_info(user_sessions)"))
    columns_user_sessions = {row[1] for row in result}
    print(f"   –ö–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ user_sessions: {columns_user_sessions}")
    # –õ–æ–≥–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã
except Exception as e:
    print(f"   ‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ user_sessions –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞...")
```

#### ensure_tables() (lines 257-266)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è `user_sessions`

```python
# –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ user_id
CREATE INDEX IF NOT EXISTS idx_user_session_user_id ON user_sessions (user_id)

# UNIQUE –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ auth_token
CREATE UNIQUE INDEX IF NOT EXISTS idx_user_session_auth_token ON user_sessions (auth_token)
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å–µ—Å—Å–∏—è–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:

| –ü—Ä–µ—Ñ–∏–∫—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|---------|
| `[SESSION_CREATE]` | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ |
| `[SESSION_LOOKUP]` | –ù–∞—à–ª–∏ —Å–µ—Å—Å–∏—é –≤ user_sessions –ø—Ä–∏ get_current_user |
| `[SESSION_FALLBACK_LEGACY]` | Fallback –Ω–∞ legacy user.auth_token |
| `[SESSION_DELETE]` | –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ logout |

---

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –õ–æ–≥–∏–Ω —Å –ü–ö

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
2. –õ–æ–≥–∏–Ω –∑–∞–≤–µ—Ä—à–µ–Ω ‚Üí create_user_session(user_id, db)
   ‚Üí –°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å UserSession #1 —Å auth_token="token1"
   ‚Üí users.auth_token = "token1" (–¥–ª—è legacy)
3. –ü–ö –ø–æ–ª—É—á–∞–µ—Ç cookie: auth_token="token1"
4. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ: get_current_user() –Ω–∞—Ö–æ–¥–∏—Ç UserSession #1 ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç User
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ–≥–∏–Ω —Å –ü–ö –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

```
1. –ü–ö –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Üí UserSession #1 (token1)
2. –¢–µ–ª–µ—Ñ–æ–Ω: –ª–æ–≥–∏–Ω ‚Üí create_user_session(user_id, db)
   ‚Üí –°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å UserSession #2 —Å auth_token="token2"
   ‚Üí users.auth_token = "token2" (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!)
3. –ü–ö –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º —Å token1 ‚Üí get_current_user() –Ω–∞—Ö–æ–¥–∏—Ç UserSession #1
4. –¢–µ–ª–µ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω —Å token2 ‚Üí get_current_user() –Ω–∞—Ö–æ–¥–∏—Ç UserSession #2
5. –û–ë–ê —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Logout –Ω–∞ –æ–¥–Ω–æ–º –¥–µ–≤–∞–π—Å–µ

```
1. –ü–ö: logout() —Å cookie auth_token="token1"
2. –£–¥–∞–ª—è–µ—Ç—Å—è UserSession #1 –∏–∑ –ë–î
3. –£–¥–∞–ª—è–µ—Ç—Å—è cookie –Ω–∞ –ü–ö
4. users.auth_token = "token2" (–æ—Å—Ç–∞–µ—Ç—Å—è, —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–æ–≥–∏–Ω)
5. –¢–µ–ª–µ—Ñ–æ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω —Å token2
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: Fallback –Ω–∞ legacy —Ç–æ–∫–µ–Ω—ã

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ (–¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ multi-session)
   ‚Üí –£ –Ω–µ–≥–æ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ users.auth_token="old_token"
   ‚Üí –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ user_sessions
2. get_current_user() —Å cookie auth_token="old_token"
   1. –ò—â–µ—Ç –≤ user_sessions ‚Üí –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
   2. Fallback –Ω–∞ users.auth_token ‚Üí –Ω–∞–π–¥–µ–Ω–æ!
   3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç User
3. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
```

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ –ß—Ç–æ –ù–ï –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

- –ü–æ–¥–ø–∏—Å–∫–∏ (subscription logic)
- TelegramSession (–æ—Å—Ç–∞–µ—Ç—Å—è 1 –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ leads
- Payments –∏ YooKassa
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –¢–µ–ª–µ–≥—Ä–∞–º-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

- –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- –ü–æ–∏—Å–∫ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ logout
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π

### ‚úÖ –†–∏—Å–∫–∏ –∏ —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è –∏—Ö –∏–∑–±–µ–∂–∞–Ω–∏—è:

| –†–∏—Å–∫ | –†–µ—à–µ–Ω–∏–µ |
|------|---------|
| –î–µ—Ç–∞—á–º–µ–Ω—Ç –æ–±—ä–µ–∫—Ç–æ–≤ SQLAlchemy | Logout –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_current_user`, —á–∏—Ç–∞–µ—Ç token –Ω–∞–ø—Ä—è–º—É—é |
| –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å legacy —Å–∏—Å—Ç–µ–º–æ–π | Fallback –ª–æ–≥–∏–∫–∞ –≤ `get_current_user` –∏ `logout` |
| Race conditions | –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞, —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ |
| –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö | legacy `users.auth_token` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ |

---

## –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```
üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...
...
üìç –ü—É—Ç—å –∫ –ë–î: ...
üìä –¢–∞–±–ª–∏—Ü—ã –≤ –ë–î: [..., 'user_sessions', ...]
...
‚úÖ –ò–Ω–¥–µ–∫—Å idx_user_session_user_id OK
‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å idx_user_session_auth_token OK
...
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
```

–¢–∞–±–ª–∏—Ü–∞ `user_sessions` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `Base.metadata.create_all()`.

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–õ–æ–≥–∏–Ω —Å –ü–ö** ‚Üí –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ
2. **–õ–æ–≥–∏–Ω —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞** ‚Üí –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ
3. **–û–±–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** ‚Üí –æ–±–∞ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å
4. **Logout –Ω–∞ –ü–ö** ‚Üí —Ç–µ–ª–µ—Ñ–æ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
5. **Logout –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ** ‚Üí –ü–ö –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
6. **–°—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã** ‚Üí legacy fallback –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

–í–∫–ª—é—á–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Å–µ—Å—Å–∏—è–º–∏:

```
[SESSION_CREATE] user_id=42 - –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞, token=Abc1234...
[SESSION_LOOKUP] token=Abc1234... - –Ω–∞–π–¥–µ–Ω–∞ –≤ user_sessions, user_id=42
[SESSION_DELETE] user_id=42 - —Å–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞ –∏–∑ user_sessions
[SESSION_FALLBACK_LEGACY] token=Old1234... - –Ω–∞–π–¥–µ–Ω–∞ –≤ users.auth_token, user_id=42
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Å—Å–∏–π —Å –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Å –Ω–æ–≤—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏ –≤ `user_sessions`, —Ç–∞–∫ –∏ —Å legacy —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ `users.auth_token`. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏.
