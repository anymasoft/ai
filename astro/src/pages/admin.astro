---
import { getUserFromSession, isAdmin } from '../lib/auth';
import AppLayout from '../layouts/AppLayout.astro';
import { getDb } from '../lib/db';

// –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–∏–Ω–∞–º–∏—á–Ω–æ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å cookies
export const prerender = false;

// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Å—Å–∏–∏
const sessionToken = Astro.cookies.get('session_token')?.value;
const user = sessionToken ? getUserFromSession(sessionToken) : null;

// –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ sign-in
if (!user) {
  return Astro.redirect('/sign-in');
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
if (!isAdmin(user.email)) {
  return Astro.redirect('/app');
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
const db = getDb();

interface UserWithBalance {
  id: string;
  name: string;
  email: string;
  generation_balance: number;
  generation_used: number;
  createdAt: number;
}

// –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
const url = new URL(Astro.request.url);
const searchEmail = url.searchParams.get('search') || '';
const page = Math.max(1, parseInt(url.searchParams.get('page') || '1', 10));
const perPage = 20;
const offset = (page - 1) * perPage;

// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
const allUsers = db.prepare(`
  SELECT id, name, email, generation_balance, generation_used, createdAt
  FROM users
  ORDER BY createdAt DESC
`).all() as UserWithBalance[];

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
let query = `
  SELECT id, name, email, generation_balance, generation_used, createdAt
  FROM users
`;

if (searchEmail) {
  query += ` WHERE email LIKE ?`;
}

query += ` ORDER BY createdAt DESC LIMIT ? OFFSET ?`;

const params = searchEmail ? [`%${searchEmail}%`, perPage, offset] : [perPage, offset];
const users = db.prepare(query).all(...params) as UserWithBalance[];

// –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
let totalResults = allUsers.length;
if (searchEmail) {
  const countQuery = 'SELECT COUNT(*) as count FROM users WHERE email LIKE ?';
  const countResult = db.prepare(countQuery).get(`%${searchEmail}%`) as any;
  totalResults = countResult?.count || 0;
}

const totalPages = Math.ceil(totalResults / perPage);
const totalUsers = allUsers.length;

const totalGenerationCredits = allUsers.reduce((sum, u) => sum + (u.generation_balance + u.generation_used), 0);
const totalBalance = allUsers.reduce((sum, u) => sum + u.generation_balance, 0);
---

<AppLayout title="Admin Settings - Beem">
  <div class="h-full overflow-auto">
    <div class="max-w-6xl mx-auto p-4 md:p-6">
      <!-- Back Button -->
      <a href="/app" class="inline-flex items-center justify-center p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition cursor-pointer mb-4">
        <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>

      <!-- Search Box -->
      <div class="mb-4">
        <form method="GET" class="flex gap-2">
          <input
            type="text"
            name="search"
            placeholder="–ü–æ–∏—Å–∫ –ø–æ email..."
            value={searchEmail}
            class="flex-1 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"
          />
          <button
            type="submit"
            class="px-6 py-2 rounded-lg bg-primary text-white font-semibold hover:opacity-90 transition"
          >
            –ü–æ–∏—Å–∫
          </button>
          {searchEmail && (
            <a
              href="/admin"
              class="px-6 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition"
            >
              –û—á–∏—Å—Ç–∏—Ç—å
            </a>
          )}
        </form>
        {searchEmail && (
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ "{searchEmail}": <strong>{totalResults}</strong> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          </p>
        )}
      </div>

      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-1 gap-4 mb-6">
        <!-- Total Users -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6">
          <div class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-1">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          <div class="text-3xl font-bold text-gray-900 dark:text-white" data-stat="totalUsers">{totalUsers}</div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ</p>
        </div>
      </div>

      <!-- Users Table -->
      <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
        <!-- Table Header -->
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
          <h2 class="text-lg font-bold text-gray-900 dark:text-white">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-800">
                <th class="px-6 py-3 text-left font-semibold text-gray-700 dark:text-gray-300">–ò–º—è</th>
                <th class="px-6 py-3 text-left font-semibold text-gray-700 dark:text-gray-300">Email</th>
                <th class="px-6 py-3 text-left font-semibold text-gray-700 dark:text-gray-300">–ë–∞–ª–∞–Ω—Å</th>
                <th class="px-6 py-3 text-left font-semibold text-gray-700 dark:text-gray-300">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                <th class="px-6 py-3 text-left font-semibold text-gray-700 dark:text-gray-300">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                <th class="px-6 py-3 text-left font-semibold text-gray-700 dark:text-gray-300">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody>
              {users.map((u) => (
                <tr class="border-b border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition" data-user-id={u.id}>
                  <td class="px-6 py-3 font-medium text-gray-900 dark:text-white">{u.name}</td>
                  <td class="px-6 py-3 text-gray-600 dark:text-gray-400 text-xs">{u.email}</td>
                  <td class="px-6 py-3">
                    <span class="inline-flex items-center gap-2">
                      <span class="font-semibold text-green-600 dark:text-green-400">{u.generation_balance}</span>
                      <button
                        class="edit-balance-btn text-xs px-2 py-1 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900/50 transition"
                        data-user-id={u.id}
                      >
                        –ò–∑–º–µ–Ω–∏—Ç—å
                      </button>
                    </span>
                  </td>
                  <td class="px-6 py-3 text-gray-600 dark:text-gray-400">{u.generation_used}</td>
                  <td class="px-6 py-3 text-xs text-gray-500 dark:text-gray-500">{new Date(u.createdAt * 1000).toLocaleDateString('ru-RU')}</td>
                  <td class="px-6 py-3">
                    <button
                      class="reset-balance-btn text-xs px-3 py-1 rounded bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/50 transition"
                      data-user-id={u.id}
                    >
                      –û–±–Ω—É–ª–∏—Ç—å
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {totalPages > 1 && (
          <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex items-center justify-between">
            <p class="text-sm text-gray-600 dark:text-gray-400">
              –°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong>{page}</strong> –∏–∑ <strong>{totalPages}</strong> ¬∑ –ü–æ–∫–∞–∑–∞–Ω–æ <strong>{users.length}</strong> –∏–∑ <strong>{totalResults}</strong>
            </p>
            <div class="flex gap-2">
              {page > 1 && (
                <a
                  href={searchEmail ? `/admin?search=${encodeURIComponent(searchEmail)}&page=${page - 1}` : `/admin?page=${page - 1}`}
                  class="px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                >
                  ‚Üê –ù–∞–∑–∞–¥
                </a>
              )}
              {page < totalPages && (
                <a
                  href={searchEmail ? `/admin?search=${encodeURIComponent(searchEmail)}&page=${page + 1}` : `/admin?page=${page + 1}`}
                  class="px-4 py-2 rounded-lg bg-primary text-white font-semibold hover:opacity-90 transition"
                >
                  –î–∞–ª–µ–µ ‚Üí
                </a>
              )}
            </div>
          </div>
        )}
      </div>

      <!-- Financial Overview Section -->
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>

        <!-- Financial Filters -->
        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
          <button
            class="financial-filter whitespace-nowrap px-4 py-2 rounded-lg font-semibold transition cursor-pointer bg-primary text-white"
            data-filter="all"
          >
            –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
          </button>
          <button
            class="financial-filter whitespace-nowrap px-4 py-2 rounded-lg font-semibold transition cursor-pointer bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700"
            data-filter="–ê–∫—Ç–∏–≤–Ω—ã–π"
          >
            üü¢ –ê–∫—Ç–∏–≤–Ω—ã–π
          </button>
          <button
            class="financial-filter whitespace-nowrap px-4 py-2 rounded-lg font-semibold transition cursor-pointer bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700"
            data-filter="–ü–æ–¥ —Ä–∏—Å–∫–æ–º"
          >
            üü° –ü–æ–¥ —Ä–∏—Å–∫–æ–º
          </button>
          <button
            class="financial-filter whitespace-nowrap px-4 py-2 rounded-lg font-semibold transition cursor-pointer bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700"
            data-filter="–°–ø—è—â–∏–π"
          >
            ‚ö´ –°–ø—è—â–∏–π
          </button>
        </div>

        <!-- Top Payers & High Balance Indicators -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-2xl border border-yellow-200 dark:border-yellow-800 p-4">
            <div class="text-sm font-semibold text-yellow-800 dark:text-yellow-300 mb-2">üî• –¢–æ–ø –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤</div>
            <div id="top-payers" class="text-sm text-yellow-700 dark:text-yellow-400">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
          <div class="bg-gradient-to-br from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-2xl border border-red-200 dark:border-red-800 p-4">
            <div class="text-sm font-semibold text-red-800 dark:text-red-300 mb-2">‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π –±–∞–ª–∞–Ω—Å (–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–∏—Å–∫)</div>
            <div id="high-balance" class="text-sm text-red-700 dark:text-red-400">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>

        <!-- Financial Table -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
          <!-- Table Header -->
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ–±–∑–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
          </div>

          <!-- Scrollable Table -->
          <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
            <table class="w-full text-xs">
              <thead class="sticky top-0 bg-gray-50 dark:bg-gray-800">
                <tr class="border-b border-gray-200 dark:border-gray-800">
                  <th class="px-4 py-3 text-left font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="email">Email</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="name">–ò–º—è</th>
                  <th class="px-4 py-3 text-right font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="totalCreditsBought">–ö—É–ø–ª–µ–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤</th>
                  <th class="px-4 py-3 text-right font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="totalCreditsUsed">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                  <th class="px-4 py-3 text-right font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="currentBalance">–ë–∞–ª–∞–Ω—Å</th>
                  <th class="px-4 py-3 text-right font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="totalRevenue">–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                  <th class="px-4 py-3 text-right font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="avgPricePerCredit">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="lastPaymentDate">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂</th>
                  <th class="px-4 py-3 text-left font-semibold text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="status">–°—Ç–∞—Ç—É—Å</th>
                </tr>
              </thead>
              <tbody id="financial-table-body">
                <tr class="text-center py-8">
                  <td colspan="9" class="px-6 py-8 text-gray-500 dark:text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Edit Balance Modal -->
      <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 max-w-sm w-full mx-4">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤</h3>

          <div class="mb-4">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
              –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <span id="current-balance" class="font-bold text-gray-900 dark:text-white">0</span>
            </p>

            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
            <input
              type="number"
              id="balance-input"
              class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
              min="0"
            />
          </div>

          <div class="flex gap-3">
            <button
              id="cancel-edit"
              class="flex-1 px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition"
            >
              –û—Ç–º–µ–Ω–∞
            </button>
            <button
              id="save-balance"
              class="flex-1 px-4 py-2 rounded-lg bg-primary text-white font-semibold hover:opacity-90 transition"
            >
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
          </div>
        </div>
      </div>

      <!-- Reset Confirmation Modal -->
      <div id="reset-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 max-w-sm w-full mx-4">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å?</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
            –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å.
          </p>
          <div class="flex gap-3">
            <button
              id="cancel-reset"
              class="flex-1 px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition"
            >
              –û—Ç–º–µ–Ω–∞
            </button>
            <button
              id="confirm-reset"
              class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition"
            >
              –û–±–Ω—É–ª–∏—Ç—å
            </button>
          </div>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="status-message" class="hidden fixed bottom-4 right-4 px-4 py-3 rounded-lg text-sm font-semibold max-w-sm z-50"></div>
    </div>
  </div>
</AppLayout>

<script>
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  async function updateStats() {
    try {
      const response = await fetch('/api/admin/stats');
      if (!response.ok) return;

      const data = await response.json();
      if (!data.success) return;

      const totalUsersEl = document.querySelector('[data-stat="totalUsers"]');
      if (totalUsersEl && data.totalUsers.toString() !== totalUsersEl.textContent?.trim()) {
        totalUsersEl.textContent = data.totalUsers;
      }
    } catch (error) {
      console.error('[ADMIN_STATS] Error fetching stats:', error);
    }
  }

  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  const statsInterval = setInterval(updateStats, 5000);

  // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('unload', () => {
    clearInterval(statsInterval);
  });

  const editModal = document.getElementById('edit-modal') as HTMLDivElement;
  const cancelEditBtn = document.getElementById('cancel-edit') as HTMLButtonElement;
  const saveBalanceBtn = document.getElementById('save-balance') as HTMLButtonElement;
  const balanceInput = document.getElementById('balance-input') as HTMLInputElement;
  const currentBalanceSpan = document.getElementById('current-balance') as HTMLSpanElement;
  const statusMessage = document.getElementById('status-message') as HTMLDivElement;

  const resetModal = document.getElementById('reset-modal') as HTMLDivElement;
  const cancelResetBtn = document.getElementById('cancel-reset') as HTMLButtonElement;
  const confirmResetBtn = document.getElementById('confirm-reset') as HTMLButtonElement;

  let selectedUserId: string | null = null;
  let resetUserId: string | null = null;

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å-—Å–æ–æ–±—â–µ–Ω–∏—è
  function showStatus(message: string, type: 'success' | 'error') {
    statusMessage.textContent = message;
    statusMessage.classList.remove('hidden', 'bg-green-50', 'dark:bg-green-900/20', 'border-green-200', 'dark:border-green-800', 'text-green-700', 'dark:text-green-400', 'bg-red-50', 'dark:bg-red-900/20', 'border-red-200', 'dark:border-red-800', 'text-red-700', 'dark:text-red-400');

    if (type === 'success') {
      statusMessage.classList.add('bg-green-50', 'dark:bg-green-900/20', 'border', 'border-green-200', 'dark:border-green-800', 'text-green-700', 'dark:text-green-400');
    } else {
      statusMessage.classList.add('bg-red-50', 'dark:bg-red-900/20', 'border', 'border-red-200', 'dark:border-red-800', 'text-red-700', 'dark:text-red-400');
    }

    setTimeout(() => {
      statusMessage.classList.add('hidden');
    }, 4000);
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ "–ò–∑–º–µ–Ω–∏—Ç—å"
  document.querySelectorAll('.edit-balance-btn').forEach(btn => {
    btn.addEventListener('click', (e: Event) => {
      const target = e.target as HTMLButtonElement;
      selectedUserId = target.getAttribute('data-user-id');

      if (selectedUserId) {
        const row = document.querySelector(`tr[data-user-id="${selectedUserId}"]`);
        if (row) {
          const currentBalance = row.querySelector('.font-semibold.text-green-600')?.textContent || '0';
          currentBalanceSpan.textContent = currentBalance;
          balanceInput.value = currentBalance;
          editModal.classList.remove('hidden');
          balanceInput.focus();
        }
      }
    });
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  cancelEditBtn.addEventListener('click', () => {
    editModal.classList.add('hidden');
    selectedUserId = null;
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
  editModal.addEventListener('click', (e: Event) => {
    if (e.target === editModal) {
      editModal.classList.add('hidden');
      selectedUserId = null;
    }
  });

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
  saveBalanceBtn.addEventListener('click', async () => {
    if (!selectedUserId) return;

    const newBalance = parseInt(balanceInput.value, 10);

    if (isNaN(newBalance) || newBalance < 0) {
      showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ', 'error');
      return;
    }

    saveBalanceBtn.disabled = true;
    saveBalanceBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

    try {
      const response = await fetch('/api/admin/users', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: selectedUserId,
          generation_balance: newBalance
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        showStatus(`–û—à–∏–±–∫–∞: ${errorData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å'}`, 'error');
        saveBalanceBtn.disabled = false;
        saveBalanceBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
      const row = document.querySelector(`tr[data-user-id="${selectedUserId}"]`);
      if (row) {
        const balanceCell = row.querySelector('.font-semibold.text-green-600');
        if (balanceCell) {
          balanceCell.textContent = newBalance.toString();
        }
      }

      editModal.classList.add('hidden');
      showStatus('‚úì –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
      selectedUserId = null;
      saveBalanceBtn.disabled = false;
      saveBalanceBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      showStatus(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
      saveBalanceBtn.disabled = false;
      saveBalanceBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ "–û–±–Ω—É–ª–∏—Ç—å"
  document.querySelectorAll('.reset-balance-btn').forEach(btn => {
    btn.addEventListener('click', (e: Event) => {
      const target = e.target as HTMLButtonElement;
      const userId = target.getAttribute('data-user-id');

      if (!userId) return;

      resetUserId = userId;
      resetModal.classList.remove('hidden');
    });
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–±–Ω—É–ª–µ–Ω–∏—è
  cancelResetBtn.addEventListener('click', () => {
    resetModal.classList.add('hidden');
    resetUserId = null;
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
  resetModal.addEventListener('click', (e: Event) => {
    if (e.target === resetModal) {
      resetModal.classList.add('hidden');
      resetUserId = null;
    }
  });

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
  confirmResetBtn.addEventListener('click', async () => {
    if (!resetUserId) return;

    const target = document.querySelector(`button[data-user-id="${resetUserId}"].reset-balance-btn`) as HTMLButtonElement;
    if (target) {
      target.disabled = true;
      target.textContent = '–û–±–Ω—É–ª–µ–Ω–∏–µ...';
    }

    resetModal.classList.add('hidden');

    try {
      const response = await fetch('/api/admin/users', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: resetUserId,
          generation_balance: 0
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        showStatus(`–û—à–∏–±–∫–∞: ${errorData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å'}`, 'error');
        if (target) {
          target.disabled = false;
          target.textContent = '–û–±–Ω—É–ª–∏—Ç—å';
        }
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
      const row = document.querySelector(`tr[data-user-id="${resetUserId}"]`);
      if (row) {
        const balanceCell = row.querySelector('.font-semibold.text-green-600');
        if (balanceCell) {
          balanceCell.textContent = '0';
        }
      }

      showStatus('‚úì –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω', 'success');
      if (target) {
        target.disabled = false;
        target.textContent = '–û–±–Ω—É–ª–∏—Ç—å';
      }
      resetUserId = null;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      showStatus(`–û—à–∏–±–∫–∞: ${errorMessage}`, 'error');
      if (target) {
        target.disabled = false;
        target.textContent = '–û–±–Ω—É–ª–∏—Ç—å';
      }
      resetUserId = null;
    }
  });

  // ========== –§–ò–ù–ê–ù–°–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê ==========
  interface UserFinancial {
    userId: string;
    email: string;
    name: string;
    totalCreditsBought: number;
    totalCreditsUsed: number;
    currentBalance: number;
    lastPaymentDate: number | null;
    totalRevenue: number;
    avgPricePerCredit: number;
    status: '–ê–∫—Ç–∏–≤–Ω—ã–π' | '–ü–æ–¥ —Ä–∏—Å–∫–æ–º' | '–°–ø—è—â–∏–π';
  }

  let allFinancialData: UserFinancial[] = [];
  let currentFilter: string = 'all';
  let currentSort: { field: string; direction: 'asc' | 'desc' } = { field: 'totalRevenue', direction: 'desc' };
  const financialTableBody = document.getElementById('financial-table-body') as HTMLTableSectionElement;
  const topPayersEl = document.getElementById('top-payers') as HTMLDivElement;
  const highBalanceEl = document.getElementById('high-balance') as HTMLDivElement;

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  async function loadFinancialData() {
    try {
      const response = await fetch('/api/admin/financial-overview');
      if (!response.ok) throw new Error('Failed to fetch financial data');

      const result = await response.json();
      if (!result.success) throw new Error('API error');

      allFinancialData = result.data;
      renderFinancialTable();
      updateFinancialIndicators();
    } catch (error) {
      console.error('[FINANCIAL_TABLE] Error:', error);
      financialTableBody.innerHTML = '<tr class="text-center"><td colspan="9" class="px-6 py-8 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (Top Payers –∏ High Balance)
  function updateFinancialIndicators() {
    // Top Payers - 3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π –≤—ã—Ä—É—á–∫–æ–π
    const topPayers = allFinancialData
      .filter(u => u.totalRevenue > 0)
      .sort((a, b) => b.totalRevenue - a.totalRevenue)
      .slice(0, 3);

    if (topPayers.length > 0) {
      topPayersEl.innerHTML = topPayers
        .map(u => `<div>${u.email}: <strong>${u.totalRevenue}‚ÇΩ</strong></div>`)
        .join('');
    } else {
      topPayersEl.textContent = '–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π';
    }

    // High Balance - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –≤—ã—Å–æ–∫–∏–º –±–∞–ª–∞–Ω—Å–æ–º (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫)
    const highBalance = allFinancialData
      .filter(u => u.currentBalance > 100)
      .sort((a, b) => b.currentBalance - a.currentBalance)
      .slice(0, 3);

    if (highBalance.length > 0) {
      highBalanceEl.innerHTML = highBalance
        .map(u => `<div>${u.email}: <strong>${u.currentBalance} –∫—Ä–µ–¥–∏—Ç–æ–≤</strong></div>`)
        .join('');
    } else {
      highBalanceEl.textContent = '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤—ã—Å–æ–∫–∏–º –±–∞–ª–∞–Ω—Å–æ–º';
    }
  }

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  function getFilteredAndSortedData(): UserFinancial[] {
    let filtered = allFinancialData;

    // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (currentFilter !== 'all') {
      filtered = filtered.filter(u => u.status === currentFilter);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    return filtered.sort((a, b) => {
      let aVal: any = a[currentSort.field as keyof UserFinancial];
      let bVal: any = b[currentSort.field as keyof UserFinancial];

      if (typeof aVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }

      if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
      return 0;
    });
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
  function formatDate(timestamp: number | null): string {
    if (!timestamp) return '–ù–∏–∫–æ–≥–¥–∞';
    const date = new Date(timestamp * 1000);
    const now = Date.now();
    const diffMs = now - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (diffDays === 1) return '–í—á–µ—Ä–∞';
    if (diffDays < 7) return `${diffDays} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} –Ω–µ–¥–µ–ª—å –Ω–∞–∑–∞–¥`;
    return date.toLocaleDateString('ru-RU');
  }

  // –°—Ç–∞—Ç—É—Å —Ü–≤–µ—Ç
  function getStatusColor(status: string): string {
    switch (status) {
      case '–ê–∫—Ç–∏–≤–Ω—ã–π': return 'text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded';
      case '–ü–æ–¥ —Ä–∏—Å–∫–æ–º': return 'text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 px-2 py-1 rounded';
      case '–°–ø—è—â–∏–π': return 'text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded';
      default: return '';
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
  function renderFinancialTable() {
    const filtered = getFilteredAndSortedData();

    if (filtered.length === 0) {
      financialTableBody.innerHTML = '<tr class="text-center"><td colspan="9" class="px-6 py-8 text-gray-500 dark:text-gray-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
      return;
    }

    financialTableBody.innerHTML = filtered
      .map(user => `
        <tr class="border-b border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition">
          <td class="px-4 py-3 font-medium text-gray-900 dark:text-white truncate max-w-xs">${user.email}</td>
          <td class="px-4 py-3 text-gray-600 dark:text-gray-400 truncate">${user.name}</td>
          <td class="px-4 py-3 text-right font-semibold text-gray-900 dark:text-white">${user.totalCreditsBought}</td>
          <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-400">${user.totalCreditsUsed}</td>
          <td class="px-4 py-3 text-right font-semibold ${user.currentBalance > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${user.currentBalance}</td>
          <td class="px-4 py-3 text-right font-semibold text-blue-600 dark:text-blue-400">${Math.round(user.totalRevenue)}‚ÇΩ</td>
          <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-400">${user.avgPricePerCredit.toFixed(2)}‚ÇΩ</td>
          <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${formatDate(user.lastPaymentDate)}</td>
          <td class="px-4 py-3"><span class="${getStatusColor(user.status)}">${user.status}</span></td>
        </tr>
      `)
      .join('');
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  document.querySelectorAll('.financial-filter').forEach(btn => {
    btn.addEventListener('click', (e: Event) => {
      const target = e.target as HTMLButtonElement;
      const filter = target.getAttribute('data-filter') || 'all';

      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.financial-filter').forEach(b => {
        b.classList.remove('bg-primary', 'text-white');
        b.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
      });
      target.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
      target.classList.add('bg-primary', 'text-white');

      currentFilter = filter;
      renderFinancialTable();
    });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  document.querySelectorAll('[data-sort]').forEach(th => {
    th.addEventListener('click', (e: Event) => {
      const target = e.target as HTMLElement;
      const field = target.getAttribute('data-sort');

      if (!field) return;

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –æ–¥–Ω–æ–º—É –ø–æ–ª—é
      if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.direction = 'desc';
      }

      renderFinancialTable();
    });
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  loadFinancialData();

  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  setInterval(loadFinancialData, 10000);
</script>
