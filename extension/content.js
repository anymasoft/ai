// –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
function waitForElement(selector, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const element = document.querySelector(selector);
    if (element) {
      return resolve(element);
    }

    const observer = new MutationObserver(() => {
      const element = document.querySelector(selector);
      if (element) {
        observer.disconnect();
        resolve(element);
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    setTimeout(() => {
      observer.disconnect();
      reject(new Error('Element not found'));
    }, timeout);
  });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
function createTranscriptPanel() {
  const panel = document.createElement('div');
  panel.id = 'yt-transcript-panel';
  panel.innerHTML = `
    <div id="yt-transcript-panel-header">
      <div id="yt-transcript-panel-title">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/>
        </svg>
        Transcript
      </div>
      <button id="yt-transcript-get-btn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
        </svg>
        Get Transcript
      </button>
    </div>
    <div id="yt-transcript-content"></div>
  `;

  return panel;
}

// –í—Å—Ç–∞–≤–∫–∞ –ø–∞–Ω–µ–ª–∏ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É
async function injectPanel() {
  try {
    // –ò—â–µ–º secondary column (—Å–ø—Ä–∞–≤–∞ –æ—Ç –≤–∏–¥–µ–æ)
    const secondary = await waitForElement('#secondary-inner, #secondary');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–∏ —É–∂–µ –ø–∞–Ω–µ–ª—å
    if (document.getElementById('yt-transcript-panel')) {
      return;
    }

    const panel = createTranscriptPanel();

    // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ secondary column
    secondary.insertBefore(panel, secondary.firstChild);

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ
    const btn = document.getElementById('yt-transcript-get-btn');
    btn.addEventListener('click', handleGetTranscript);

    console.log('‚úÖ –ü–∞–Ω–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –ø–∞–Ω–µ–ª–∏:', error);
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
async function handleGetTranscript() {
  const btn = document.getElementById('yt-transcript-get-btn');
  const content = document.getElementById('yt-transcript-content');

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  btn.disabled = true;
  btn.textContent = 'Loading...';

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
  content.innerHTML = `
    <div class="yt-transcript-loader">
      <div class="yt-transcript-loader-spinner"></div>
      <span>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞...</span>
    </div>
  `;

  try {
    const subtitles = await getTranscript();

    if (!subtitles || subtitles.length === 0) {
      content.innerHTML = `
        <div class="yt-transcript-empty">
          –°—É–±—Ç–∏—Ç—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ
        </div>
      `;
      return;
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É–±—Ç–∏—Ç—Ä—ã - –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    const processedSubtitles = subtitles.map(sub => ({
      ...sub,
      text: sub.text.toUpperCase() // –û–ë–†–ê–ë–û–¢–ö–ê: –í–ï–†–•–ù–ò–ô –†–ï–ì–ò–°–¢–†
    }));

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
    displayTranscript(processedSubtitles);

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞:', error);
    content.innerHTML = `
      <div class="yt-transcript-error">
        –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞: ${error.message}
      </div>
    `;
  } finally {
    btn.disabled = false;
    btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
      </svg>
      Refresh
    `;
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
async function getTranscript() {
  console.log('üé¨ –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç...');

  // –ò—â–µ–º –∫–Ω–æ–ø–∫—É "Show transcript"
  const transcriptButton = await findTranscriptButton();

  if (!transcriptButton) {
    throw new Error('–ö–Ω–æ–ø–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã—Ç –ª–∏ —É–∂–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
  const isOpen = transcriptButton.getAttribute('aria-pressed') === 'true';

  if (!isOpen) {
    transcriptButton.click();
    console.log('üñ±Ô∏è –û—Ç–∫—Ä—ã–ª–∏ –ø–∞–Ω–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞');
    await new Promise(resolve => setTimeout(resolve, 1500));
  }

  // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
  const transcriptItems = document.querySelectorAll('ytd-transcript-segment-renderer');

  console.log('üìù –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞:', transcriptItems.length);

  if (transcriptItems.length === 0) {
    throw new Error('–≠–ª–µ–º–µ–Ω—Ç—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
  }

  const subtitles = [];
  transcriptItems.forEach((item, index) => {
    const timeElement = item.querySelector('.segment-timestamp');
    const textElement = item.querySelector('yt-formatted-string.segment-text');

    if (textElement) {
      const text = textElement.textContent.trim();
      const timeText = timeElement?.textContent.trim() || '';

      subtitles.push({
        index: index + 1,
        time: timeText,
        text: text
      });
    }
  });

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
  if (!isOpen) {
    transcriptButton.click();
    console.log('üñ±Ô∏è –ó–∞–∫—Ä—ã–ª–∏ –ø–∞–Ω–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞');
  }

  console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${subtitles.length} —Å—É–±—Ç–∏—Ç—Ä–æ–≤`);
  return subtitles;
}

// –ü–æ–∏—Å–∫ –∫–Ω–æ–ø–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
async function findTranscriptButton() {
  // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–æ–ø–æ–∫
  await waitForElement('#description ytd-video-description-transcript-section-renderer', 5000).catch(() => null);

  const selectors = [
    '#description ytd-video-description-transcript-section-renderer button[aria-label*="transcript" i]',
    '#description ytd-video-description-transcript-section-renderer button[aria-label*="—Ç–µ–∫—Å—Ç" i]',
    'ytd-video-description-transcript-section-renderer button',
  ];

  for (const selector of selectors) {
    const btn = document.querySelector(selector);
    if (btn) {
      console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞');
      return btn;
    }
  }

  return null;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
function displayTranscript(subtitles) {
  const content = document.getElementById('yt-transcript-content');

  content.innerHTML = subtitles.map(sub => `
    <div class="yt-transcript-item" data-time="${sub.time}">
      <div class="yt-transcript-item-time">${sub.time}</div>
      <div class="yt-transcript-item-text">${sub.text}</div>
    </div>
  `).join('');

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –≤—Ä–µ–º–µ–Ω–∏
  content.querySelectorAll('.yt-transcript-item').forEach(item => {
    item.addEventListener('click', () => {
      const time = item.dataset.time;
      seekToTime(time);
    });
  });
}

// –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –≤ –≤–∏–¥–µ–æ
function seekToTime(timeStr) {
  // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –≤–∏–¥–∞ "0:00", "1:23", "12:34:56"
  const parts = timeStr.split(':').reverse();
  const seconds = parseInt(parts[0] || 0) +
                 parseInt(parts[1] || 0) * 60 +
                 parseInt(parts[2] || 0) * 3600;

  const video = document.querySelector('video');
  if (video) {
    video.currentTime = seconds;
    video.play();
  }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π URL
let currentUrl = location.href;
new MutationObserver(() => {
  if (location.href !== currentUrl) {
    currentUrl = location.href;
    if (currentUrl.includes('/watch')) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å
      const oldPanel = document.getElementById('yt-transcript-panel');
      if (oldPanel) {
        oldPanel.remove();
      }
      // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —á–µ—Ä–µ–∑ —Ç–∞–π–º–∞—É—Ç
      setTimeout(injectPanel, 1500);
    }
  }
}).observe(document.body, { childList: true, subtree: true });

// –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å—Ç–∞–≤–∫—É –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if (location.href.includes('/watch')) {
  injectPanel();
}
