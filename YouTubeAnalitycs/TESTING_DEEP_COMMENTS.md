# Инструкция по тестированию Deep Comments Analysis (Премиум анализ)

## Проверка данных для GPT

Промпт получает комментарии со следующими полями:
- **authorName** — имя автора комментария ✓
- **likes** — количество лайков комментария ✓
- **content** — текст комментария ✓

Все необходимые данные присутствуют для анализа.

## Переменные с новым промптом

```
src/lib/ai/comments-analysis.ts:
  - DEEP_COMMENTS_PROMPT_RU (строка 200)
  - DEEP_COMMENTS_PROMPT_EN (строка 296)
```

Обе переменные содержат полный промпт с 10 разделами структурированного анализа.

## Процедура тестирования

### Шаг 1: Запуск анализа
1. Откройте приложение в браузере
2. Выберите канал конкурента (убедитесь, что видео и комментарии синхронизированы)
3. Нажмите кнопку "Глубокий анализ комментариев" (Deep Comments Analysis)

### Шаг 2: Мониторинг прогресса
- Должна отобразиться полоса прогресса обработки чанков
- Ждите завершения обработки (может занять 30-60 секунд в зависимости от количества чанков)

### Шаг 3: Проверка логов в консоли (DevTools → Console)
Ищите сообщения:
```
[DeepCommentAI] Запрос анализа для competitor ID: X
[DeepCommentAI] Канал найден: название
[DeepCommentAI] Найдено Y видео для анализа
[DeepCommentAI] Найдено Z комментариев
[DeepAnalysis] Generating analysis for chunk (X chars, language: ru)
[DeepAnalysis] Successfully generated analysis
[analyzeChannelComments] Analysis completed successfully
[DeepCommentAI] Результат сохранён
```

### Шаг 4: Проверка JSON структуры
1. DevTools → Network tab
2. Отфильтруйте по `/api/channel/[id]/comments/ai`
3. Найдите POST запрос (тот, который вернул анализ)
4. Откройте вкладку Response
5. Проверьте наличие всех полей:

```json
{
  "emotionalOverview": "...",      // ✓ Описание эмоциональной картины
  "keyTopics": [...],               // ✓ Массив ключевых тем (5+ штук)
  "positiveTriggers": [...],        // ✓ Позитивные триггеры
  "negativeTriggers": [...],        // ✓ Негативные триггеры
  "faq": [...],                     // ✓ FAQ из комментариев
  "audienceSegments": [...],        // ✓ Сегменты аудитории (3-6)
  "behavioralInsights": [...],      // ✓ Поведенческие инсайты
  "missingElements": [...],         // ✓ Что не хватает аудитории
  "growthOpportunities": [...],     // ✓ Возможности роста
  "checklist": [...]                // ✓ Чек-лист (8 пунктов: Убрать, Добавить, Усилить, Изменить, Частить, Упростить, Углубить, Делать регулярно)
}
```

## Критерии успеха

✓ Анализ загружается без ошибок парсинга JSON
✓ Все 10 разделов присутствуют в ответе
✓ `keyTopics` содержит 5+ тем с названиями, описаниями и примерами
✓ `audienceSegments` содержит 3-6 сегментов с описаниями
✓ `checklist` содержит ровно 8 пунктов
✓ Все тексты на русском языке (если language: "ru")
✓ Нет HTML или markdown форматирования в JSON значениях

## Отладка проблем

### Если ошибка "JSON parse error"
- Проверьте формат JSON в DEEP_COMMENTS_PROMPT_RU (строка 208-286)
- Убедитесь, что все кавычки корректные (используйте IDE с подсветкой синтаксиса)

### Если недостаточно данных в анализе
- Синхронизируйте видео: нужно минимум 30 видео
- Синхронизируйте комментарии: нужно минимум 100 комментариев
- Проверьте логи: "Найдено X видео", "Найдено Z комментариев"

### Если timeout или медленная обработка
- Максимальное количество токенов: 2000 (`max_tokens` в generateDeepAnalysis)
- Увеличить если нужны более подробные ответы (макс. ~4000)
- Проверьте количество чанков: каждый чанк отправляется отдельно с задержкой 500ms

### Если качество анализа низкое
- Убедитесь, что комментарии нормализованы (удалены emoji, URL, HTML)
- Проверьте, что выбраны ТОП 30 видео (максимальная вовлечённость)
- Проверьте, что TOP 1000 комментариев по лайкам (важнейшие)

## Файлы для проверки

- `/home/user/ai/YouTubeAnalitycs/src/lib/ai/comments-analysis.ts` (DEEP_COMMENTS_PROMPT_RU, DEEP_COMMENTS_PROMPT_EN)
- `/home/user/ai/YouTubeAnalitycs/src/app/api/channel/[id]/comments/ai/route.ts` (API endpoint)
