# Инструкции по тестированию Content Intelligence

## Обзор обновлений

Content Intelligence модуль был полностью переработан с целью повышения качества и глубины анализа контента. Основные изменения:

- **Формат ответа**: JSON → Markdown-отчёт (7 структурированных разделов)
- **Глубина анализа**: Краткие точки → Детальный профессиональный анализ
- **Требования к выводам**: Без галлюцинаций, только данные, конкретные примеры
- **max_tokens**: 1500 → 4000 (для полного отчёта)
- **temperature**: 0.7 → 0.6 (для более консервативных выводов)

## Структура тестирования

### 1. Предварительная подготовка

#### 1.1 Убедитесь, что у канала есть видео

```bash
# Проверьте, что канал имеет синхронизированные видео
# Если нет видео, выполните:
# 1. Перейдите на страницу канала в UI
# 2. Нажмите кнопку "Sync Top Videos"
# 3. Дождитесь завершения синхронизации
```

#### 1.2 Проверьте окружение

Убедитесь, что переменные окружения установлены:
- `OPENAI_API_KEY` - ключ доступа к OpenAI API
- `DATABASE_URL` - путь к SQLite базе данных

### 2. Функциональное тестирование

#### 2.1 Запуск анализа (POST запрос)

**Как запустить:**
1. Откройте страницу канала в dashboard (например: `/dashboard/channel/123`)
2. Найдите секцию "Content Intelligence"
3. Нажмите кнопку "Generate Content Intelligence"
4. Дождитесь завершения анализа (обычно 30-60 секунд)

**Или через API:**
```bash
curl -X POST http://localhost:3000/api/channel/[id]/content-intelligence \
  -H "Authorization: Bearer [session-token]"
```

**Ожидаемый результат:**
```json
{
  "report": "## 1. РЕЗЮМЕ\n...",
  "format": "markdown",
  "generatedAt": 1733564000000
}
```

#### 2.2 Получение сохранённого анализа (GET запрос)

**Как проверить:**
1. Перезагрузите страницу канала
2. Проверьте, что Content Intelligence раздел отображает отчёт
3. Текст должен быть отформатирован как markdown с заголовками

**Или через API:**
```bash
curl http://localhost:3000/api/channel/[id]/content-intelligence
```

**Ожидаемый результат:**
- Структурированный markdown отчёт с 7 разделами
- Каждый раздел содержит конкретные данные из видео канала

### 3. Проверка качества анализа

#### 3.1 Проверка структуры отчёта

Отчёт должен содержать ровно **7 разделов** в этом порядке:

1. **РЕЗЮМЕ (summary)** - 3-5 предложений с конкретными цифрами
2. **ОСНОВНЫЕ ТЕМЫ (themes)** - 5-10 тем с количеством видео и среднее просмотром
3. **ФОРМАТЫ КОНТЕНТА (formats)** - 4-8 форматов с анализом эффективности
4. **ПОВТОРЯЮЩИЕСЯ ПАТТЕРНЫ (patterns)** - 5-8 явных паттернов успешных видео
5. **СЛАБЫЕ СТОРОНЫ (weaknesses)** - анализ неудачных элементов
6. **ВОЗМОЖНОСТИ (opportunities)** - недозаполненные ниши
7. **РЕКОМЕНДАЦИИ (recommendations)** - конкретные практичные рекомендации

**Проверка:**
```bash
# Подсчитайте количество ## заголовков в отчёте
# Должно быть ровно 7
```

#### 3.2 Проверка отсутствия галлюцинаций

Анализ должен ссылаться ТОЛЬКО на реальные видео из набора данных:

- ✅ Названия видео соответствуют данным в базе
- ✅ Цифры просмотров реальные (из videosData)
- ✅ Не упоминаются тренды, которых нет в данных
- ❌ Не должны быть общие фразы вроде "важно делать интересный контент"
- ❌ Не должны быть придуманные видео или каналы

#### 3.3 Проверка конкретности

Каждый пункт анализа должен содержать:

**Для themes (тем):**
- Точное название темы (из названий реальных видео)
- Количество видео на эту тему
- Средний просмотр (с расчётом)
- Пример видео с их просмотрами

**Для patterns (паттернов):**
- Конкретные примеры из названий видео
- Реальные цифры (длина названия, количество слов)
- Ссылка на видео, которые этот паттерн содержат

**Для recommendations (рекомендаций):**
- Привязка к конкретным паттернам/темам из анализа выше
- Объяснение "почему это сработает"
- Примеры, на какие видео смотреть как на образец

### 4. Тестирование граничных случаев

#### 4.1 Малое количество видео (< 10)

**Сценарий:** Канал имеет менее 10 видео

**Ожидаемое поведение:**
- Анализ должен быть генерирован
- Отчёт должен явно указать: "Анализ имеет ограничения из-за малого набора данных"
- Выводы должны быть более консервативными

#### 4.2 Очень большое количество видео (> 100)

**Сценарий:** Канал имеет более 100 видео в выборке

**Ожидаемое поведение:**
- API отправляет ТОП 50 видео (как указано в коде: `LIMIT 50`)
- Анализ работает только с этими 50 видео
- Должно быть указано, что анализ основан на ТОП видео

#### 4.3 Однородный контент

**Сценарий:** Все видео по одной теме в одном формате

**Ожидаемое поведение:**
- Раздел themes: одна доминирующая тема
- Раздел formats: один основной формат
- Раздел patterns: подробный анализ вариаций в названиях
- Раздел opportunities: предложения по диверсификации

### 5. Тестирование кэширования

#### 5.1 Проверка 7-дневного кэша

**Сценарий:** Запросите анализ дважды для одного канала

**Первый запрос:**
```bash
curl -X POST http://localhost:3000/api/channel/123/content-intelligence
# Результат: новый анализ, `generatedAt` = текущее время
```

**Второй запрос (сразу же):**
```bash
curl -X GET http://localhost:3000/api/channel/123/content-intelligence
# Результат: тот же анализ, `generatedAt` = то же время
```

**Проверка в логах:**
- В логе должно быть: `[ContentIntelligence] Найден свежий анализ`
- Не должно быть нового запроса к OpenAI

#### 5.2 Проверка инвалидации кэша (7+ дней)

**Способ проверки:**
- Вручную изменить `generatedAt` в БД на дату > 7 дней назад
- Запросить анализ снова
- Должен быть сгенерирован новый анализ

### 6. Тестирование производительности

#### 6.1 Время генерации

**Ожидаемое время:**
- 30-60 секунд для стандартного канала (50 видео)
- Первый запрос медленнее (генерация)
- Последующие запросы быстрые (кэш)

**Проверка:**
```bash
# Включите логирование
# Начало: [ContentIntelligence] Генерируем новый анализ через OpenAI...
# Конец: [ContentIntelligence] Анализ сохранён в БД
# Время между ними = время генерации
```

#### 6.2 Размер ответа

**Ожидаемый размер:**
- Markdown отчёт: 2000-5000 символов
- JSON в БД: 2500-6000 символов (с экранированием)

**Проверка:**
```bash
curl http://localhost:3000/api/channel/123/content-intelligence | jq '.report | length'
```

### 7. Тестирование API ответов

#### 7.1 Успешный ответ (200/201)

**POST запрос (создание):**
```json
{
  "report": "## 1. РЕЗЮМЕ\n...",
  "format": "markdown",
  "generatedAt": 1733564000000
}
```
**Status:** 201

**GET запрос (получение):**
```json
{
  "report": "## 1. РЕЗЮМЕ\n...",
  "format": "markdown",
  "generatedAt": 1733564000000
}
```
**Status:** 200

#### 7.2 Ошибка: видео не синхронизированы (400)

**Сценарий:** POST запрос для канала без видео

**Ожидаемый ответ:**
```json
{
  "error": "Sync Top Videos first"
}
```
**Status:** 400

#### 7.3 Ошибка: отсутствие аутентификации (401)

**Сценарий:** Запрос без сессии

**Ожидаемый ответ:**
```json
{
  "error": "Unauthorized"
}
```
**Status:** 401

#### 7.4 Ошибка: канал не найден (404)

**Сценарий:** POST запрос для несуществующего канала

**Ожидаемый ответ:**
```json
{
  "error": "Competitor not found or access denied"
}
```
**Status:** 404

### 8. Интеграционное тестирование (UI)

#### 8.1 Проверка отображения в dashboard

1. Откройте страницу канала (`/dashboard/channel/[id]`)
2. Найдите секцию "Content Intelligence"
3. Проверьте, что:
   - Кнопка "Generate" доступна
   - При клике появляется loading состояние
   - После генерации отчёт отображается
   - Markdown форматирование работает (заголовки, списки, жирный текст)

#### 8.2 Проверка toast уведомлений

1. Нажмите "Generate Content Intelligence"
2. Должны появиться toast уведомления:
   - Loading: "Generating Content Intelligence..."
   - Success: "Content Intelligence generated successfully"
   - Error (если ошибка): сообщение об ошибке

#### 8.3 Проверка обновления после генерации

1. Сгенерируйте анализ
2. Отчёт должен отобразиться на странице
3. Перезагрузите страницу
4. Отчёт должен остаться (из кэша)
5. Нажмите "Generate" снова
6. Должен загрузиться тот же отчёт из кэша (не заново генерироваться)

### 9. Чеклист для финального тестирования

- [ ] POST запрос создаёт новый анализ (201)
- [ ] Ответ содержит `report`, `format` и `generatedAt`
- [ ] Отчёт имеет ровно 7 разделов (## заголовков)
- [ ] Все данные взяты из videosData (без галлюцинаций)
- [ ] Все рекомендации привязаны к реальным паттернам
- [ ] GET запрос возвращает сохранённый анализ (200)
- [ ] Кэш работает 7 дней
- [ ] Ошибки возвращают корректные статусы (400, 401, 404)
- [ ] UI отображает markdown отчёт с форматированием
- [ ] Toast уведомления работают корректно
- [ ] Логирование фиксирует все этапы (логи должны быть полезны для дебага)

### 10. Примеры тестовых команд

```bash
# Проверить структуру отчёта
curl http://localhost:3000/api/channel/123/content-intelligence | jq '.report' | grep -c "## "

# Проверить размер отчёта
curl http://localhost:3000/api/channel/123/content-intelligence | jq '.report | length'

# Проверить наличие требуемых разделов
curl http://localhost:3000/api/channel/123/content-intelligence | jq '.report' | grep -E "РЕЗЮМЕ|ОСНОВНЫЕ ТЕМЫ|ФОРМАТЫ КОНТЕНТА|ПОВТОРЯЮЩИЕСЯ ПАТТЕРНЫ|СЛАБЫЕ СТОРОНЫ|ВОЗМОЖНОСТИ|РЕКОМЕНДАЦИИ"

# Проверить, что отчёт не содержит JSON объектов
curl http://localhost:3000/api/channel/123/content-intelligence | jq '.report' | grep -v "^{" | grep -v "^}"
```

### 11. Документирование результатов

При обнаружении проблем, записывайте:
- Канал ID и название
- Количество видео в выборке
- Текст ошибки / неожиданное поведение
- Логи сервера
- Screenshot UI (если применимо)

