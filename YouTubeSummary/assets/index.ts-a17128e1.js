var w=Object.defineProperty;var I=(t,s,n)=>s in t?w(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n;var l=(t,s,n)=>(I(t,typeof s!="symbol"?s+"":s,n),n);import{s as b,c as N}from"./jsx-runtime-4286988b.js";import{e as R,f as m,q as g,w as y,l as h,g as _,s as C,h as L,i as c,j as u,o as v,U as P,I as T}from"./firebase-997f25e3.js";import{a as o}from"./browser-polyfill-45feeee0.js";import{g as x,D as F,a as k}from"./cache-background-1cdd5f3d.js";import"./index-cd77e154.js";class S{constructor(){l(this,"db");this.db=R}}class U extends S{async isUserPremium(s){if(!s||s==="")return!1;try{const n=`isUserPremium-${s}`,e=x(n);if(e)return e;const a=m(this.db,"stripe_customers",s,"subscriptions"),r=g(a,y("status","in",["active","trialing"]),h(1)),i=await _(r);if(!i)return!1;const p=i.docs.length>0,f=p?F:5*60*1e3;return k(n,p,f),p}catch{return!1}}async getUserCurrPlan(s){if(!s||s==="")return"Free";try{const n=m(this.db,"stripe_customers",s,"subscriptions"),e=g(n,y("status","in",["active","trialing"]),h(1)),a=await _(e);if(!a)return"Free";const r=a.docs[0].data();if(!r)return"Free";const i=(r==null?void 0:r.metadata)??null;return i?(i==null?void 0:i.plan)??"Free":"Free"}catch{return"Free"}}}const D=async({token:t})=>{try{const s=await C(L,t),n=(s==null?void 0:s.user)??null;await b("user",{uid:n.uid,displayName:(n==null?void 0:n.displayName)??"Guest",photoURL:(n==null?void 0:n.photoURL)??"https://glasp.co/images/icons/userphoto.png"})}catch{return}},E=async()=>(await c(u,"sync-isIntegratedWithNotion")()).data,O=async()=>(await c(u,"sync-getNotionPages")()).data,Y=async t=>(await c(u,"sync-createYsNotionDatabase")(t)).data,A=async t=>(await c(u,"sync-exportYsToNotion")(t)).data;class G{constructor(){l(this,"prompt","")}getInstance(){return this}}let d=new G;const q=async({data:t})=>{try{c(u,"api-sendGlaspLog")(t)}catch{return}};async function W(t){return(await c(u,"api-getYtScripts")(t)).data}const z=async t=>(await c(u,"api-getSummaryOnPage")(t)).data,K=t=>{c(u,"api-addSummaryOnNewPage")(t)},B=()=>{o.runtime.onMessage.addListener((t,s,n)=>{const e=t,a=n;if(!e.action)return!0;switch(e.action){case"openOptions":{const r=o.runtime.getURL("src/options/index.html");o.tabs.create({url:r}),a(void 0);break}case"get_prompt":{a({prompt:d.prompt}),d.prompt="";break}case"set_prompt":{d.prompt=e.prompt??"",a(void 0);break}case"summarize_on_page":return z({prompt:e.prompt,title:e.title,thumbnail:e.thumbnail,url:e.url,retry:e.retry,transcripts:(e==null?void 0:e.transcripts)??[]}).then(r=>{a(r)}),!0;case"get_yt_scripts":return W({title:(e==null?void 0:e.title)??"",videoId:(e==null?void 0:e.videoId)??"",vssId:(e==null?void 0:e.vssId)??""}).then(r=>{a(r)}),!0;case"summarize_on_new_page":return K({...e}),a(void 0),!0;case"send_glasp_log":{const{data:r}=e;q({data:r});break}case"is_user_premium":return(async()=>{const{contextUid:r=""}=e,p=await new U().isUserPremium(r);a(p)})(),!0;case"chrome_ext_signin_token":{const r=e.data;return D({token:r}).then(()=>{a(void 0)}),!0}case"is_integrated_with_notion":return E().then(r=>{a(r)}),!0;case"get_notion_pages":return O().then(r=>{a(r)}),!0;case"create_ys_notion_database":return Y({pageId:e.pageId}).then(r=>{a(r)}),!0;case"export_ys_notion":return A({databaseId:e.databaseId,title:e.title,url:e.url,summary:e.summary,transcripts:(e==null?void 0:e.transcripts)??[]}).then(r=>{a(r)}),!0}})},M=()=>{v(L,async t=>{t?await b("user",{uid:t.uid,displayName:(t==null?void 0:t.displayName)??"Guest",photoURL:(t==null?void 0:t.photoURL)??"https://glasp.co/images/icons/userphoto.png"}):await N("user")})},V=()=>{o.runtime.onInstalled.addListener(function(t){t.reason==="install"?o.tabs.create({url:T}):t.reason})};o.runtime.setUninstallURL(P);function j(){o.action.onClicked.addListener(function(){const t=o.runtime.getURL("src/options/index.html");o.tabs.create({url:t})})}M();B();V();j();
