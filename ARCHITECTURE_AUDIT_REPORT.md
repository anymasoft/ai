## üîç –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–£–î–ò–¢ –ê–†–•–ò–¢–ï–ö–¢–£–†–´ JOBRADAR

**–î–∞—Ç–∞:** 2026-02-05
**–ê–≤—Ç–æ—Ä:** Backend Architecture Analysis
**–°—Ç–∞—Ç—É—Å:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π

---

## üìã –ß–ê–°–¢–¨ 1: –≠–¢–ê–õ–û–ù–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (–ò–°–¢–ò–ù–ê)

### –ü—Ä–∏–Ω—Ü–∏–ø 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram SMS
- ‚úì –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–≤–æ–¥–∞ SMS: –ø–æ–ª—É—á–∞–µ–º session_string
- ‚úì –°–æ—Ö—Ä–∞–Ω—è–µ–º session_string –≤ telegram_sessions
- ‚úì –ù–∞ —ç—Ç–æ–º –≤—Å—ë ‚Äî TelegramSession —Å–æ–∑–¥–∞—ë—Ç—Å—è –û–î–ò–ù –†–ê–ó

### –ü—Ä–∏–Ω—Ü–∏–ø 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úì –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ telegram_sessions –ø–æ phone
- ‚úì –ï—Å–ª–∏ –µ—Å—Ç—å:
  - **–ó–ê–ü–†–ï–©–ï–ù–û:** —Å–æ–∑–¥–∞–≤–∞—Ç—å TelegramClient
  - **–ó–ê–ü–†–ï–©–ï–ù–û:** —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram
  - **–†–ê–ó–†–ï–®–ï–ù–û:** –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
  - **–†–ê–ó–†–ï–®–ï–ù–û:** –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ —á–µ—Ä–µ–∑ "—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Ä–≤–∏—Å–∞"
  - **–†–ê–ó–†–ï–®–ï–ù–û:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥, —Å–æ–∑–¥–∞—ë—Ç—Å—è auth_token
- ‚úì TelegramSession = —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø 3: TelegramSession
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è –ª–æ–≥–∏–Ω–∞
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è silent-login
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–æ–≤ –∏ –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞

### –ü—Ä–∏–Ω—Ü–∏–ø 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ user_id —Å–æ–∑–¥–∞—ë—Ç—Å—è –û–î–ò–ù TelegramClient
- –ö–ª–∏–µ–Ω—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (–∫–µ—à)
- –í–µ—Å—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–æ–≤, safe_send_message –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≠–¢–û–¢ –∫–ª–∏–µ–Ω—Ç
- –î–ª—è –æ–¥–Ω–æ–≥–æ user_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω TelegramClient –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### –ü—Ä–∏–Ω—Ü–∏–ø 5: –ó–∞–ø—Ä–µ—â–µ–Ω–æ
- ‚ùå –°–æ–∑–¥–∞–≤–∞—Ç—å TelegramClient –≤ `/api/auth/start` –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å session_string –≤ –ª–æ–≥–∏–Ω–µ
- ‚ùå –ü—Ä–æ–≤–µ—Ä—è—Ç—å is_user_authorized() –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- ‚ùå –°–æ–∑–¥–∞–≤–∞—Ç—å TelegramClient –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–æ–≤
- ‚ùå –°–æ–∑–¥–∞–≤–∞—Ç—å TelegramClient –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è

---

## üìä –ß–ê–°–¢–¨ 2: –ê–ù–ê–õ–ò–ó –¢–ï–ö–£–©–ï–ì–û –ö–û–î–ê

### 2.1 –í–°–ï –ú–ï–°–¢–ê –°–û–ó–î–ê–ù–ò–Ø TelegramClient

#### –ú–µ—Å—Ç–æ 1: `telegram_clients.py:75` ‚úÖ‚úÖ‚úÖ
```python
client = TelegramClient(session_string, TELEGRAM_API_ID, TELEGRAM_API_HASH)
```
- **–§—É–Ω–∫—Ü–∏—è:** `async def get_user_client(user_id: int, db: Session)`
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ per-user –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–ö–µ—à–∏—Ä—É–µ—Ç—Å—è:** –î–∞, –≤ `telegram_clients_cache[user_id]`
- **TTL:** –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π (–¥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∞–ª–æ–Ω—É:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

#### –ú–µ—Å—Ç–æ 2: `main.py:969` ‚úÖ
```python
client = TelegramClient(StringSession(), TELEGRAM_API_ID, TELEGRAM_API_HASH)
await client.connect()
await client.send_code_request(phone)
```
- **–§—É–Ω–∫—Ü–∏—è:** `async def auth_start(request: AuthStartRequest)` ‚Äî –í–∞—Ä–∏–∞–Ω—Ç –ë
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** SMS –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (TelegramSession –Ω–µ –Ω–∞–π–¥–µ–Ω–∞)
- **–í—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å:** –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:** –í `pending_auth_clients[auth_id]`
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∞–ª–æ–Ω—É:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

---

### 2.2 –ê–ù–ê–õ–ò–ó –ü–û–í–¢–û–†–ù–û–ì–û –í–•–û–î–ê (–í–ê–†–ò–ê–ù–¢ –ê)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ –≤ `main.py:906-958`:**

```python
telegram_session = (
    db.query(TelegramSession)
    .filter(TelegramSession.phone == phone)
    .order_by(TelegramSession.id.desc())
    .first()
)

if telegram_session:
    # ...
    client = await get_user_client(user.id, db)  # <-- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê
    if not client:
        raise Exception("TelegramClient –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")

    # ...
    message_text = f"üîê –ö–æ–¥ –≤—Ö–æ–¥–∞ –≤ JobRadar: {code}"
    await safe_send_message(client, chat_id, message_text)  # <-- –û–¢–ü–†–ê–í–ö–ê –ß–ï–†–ï–ó –ö–õ–ò–ï–ù–¢
```

**–ê–Ω–∞–ª–∏–∑:**

| –≠—Ç–∞–ª–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –¢–µ–∫—É—â–∏–π –∫–æ–¥ | –°—Ç–∞—Ç—É—Å |
|----------------------|------------|--------|
| –ù–ò–ö–ê–ö–û–ô TelegramClient –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è | `await get_user_client(user.id, db)` —Å–æ–∑–¥–∞—ë—Ç/–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç TelegramClient | ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï |
| –ù–ò–ö–ê–ö–ò–• –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ Telegram –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç | `client = TelegramClient(...); await client.connect()` –≤ `get_user_client()` | ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï |
| –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ "—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–µ—Ä–≤–∏—Å–∞" | –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `safe_send_message(client, telegram_user_id, ...)` | ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï |
| TelegramSession = —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥ | TelegramSession –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è session_string –∏ –ª–æ–≥–∏–Ω–∞ | ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï |

---

### 2.3 –õ–û–ì–ò–ß–ï–°–ö–ê–Ø –¶–ï–ü–û–ß–ö–ê –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø

**–≠—Ç–∞–ª–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–∂–∏–¥–∞–µ—Ç:**
```
POST /api/auth/start (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
  ‚îî‚îÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –µ—Å—Ç—å –ª–∏ telegram_sessions[phone]
  ‚îî‚îÄ –î–∞ ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
  ‚îî‚îÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ "—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Ä–≤–∏—Å–∞"
  ‚îî‚îÄ –í–µ—Ä–Ω—É—Ç—å auth_token (–∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤–≤–µ—Å—Ç–∏ –∫–æ–¥)

  ‚ùå –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Telegram
  ‚ùå –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å TelegramClient
  ‚ùå –ù–ï –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ Telegram
```

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ —Ä–µ–∞–ª–∏–∑—É–µ—Ç:**
```
POST /api/auth/start (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
  ‚îî‚îÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –µ—Å—Ç—å –ª–∏ telegram_sessions[phone]
  ‚îî‚îÄ –î–∞ ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
  ‚îî‚îÄ –ü–æ–ª—É—á–∏—Ç—å TelegramClient:
     ‚îî‚îÄ SELECT telegram_session.session_string –ò–ó –ë–î
     ‚îî‚îÄ StringSession(saved_string)
     ‚îî‚îÄ TelegramClient(session_string, ...) ‚Äî –°–û–ó–î–ê–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê ‚ùå
     ‚îî‚îÄ await client.connect() ‚Äî –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö TELEGRAM ‚ùå
     ‚îî‚îÄ –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –≤ telegram_clients_cache[user_id]
  ‚îî‚îÄ await safe_send_message(client, telegram_user_id, code_message)
     ‚îî‚îÄ await client.send_message(chat_id, text) ‚Äî –û–¢–ü–†–ê–í–ö–ê –ß–ï–†–ï–ó TELEGRAM ‚ùå
  ‚îî‚îÄ –í–µ—Ä–Ω—É—Ç—å {"login_via": "telegram_message"} –ë–ï–ó auth_token
```

**–ì–¥–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ:**
- **–í—ã–∑–æ–≤:** `await get_user_client(user.id, db)` –≤ `main.py:929`
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ò–∑ session_string –≤ `telegram_clients.py:72-75`
- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** `await client.connect()` –≤ `telegram_clients.py:77`
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** `telegram_clients_cache[user_id] = client` –≤ `telegram_clients.py:81`

---

### 2.4 –¢–ê–ë–õ–ò–¶–ê –í–°–ï–• –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ô –ö–õ–Æ–ß–ï–í–´–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ get_user_client()

| –ú–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞ | –§—É–Ω–∫—Ü–∏—è | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∞ | –ö–æ–Ω—Ç–µ–∫—Å—Ç | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ |
|--------------|---------|------|--------|----------|--------------|
| 1 | auth_start | main.py | 929 | –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ | ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å |
| 2 | send_lead_to_telegram | monitor.py | 312 | –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–∞ –≤ –ª–∏—á–Ω—ã–π Telegram | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| 3 | check_source_for_task_leads | monitor.py | 473 | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| 4 | login_by_telegram | main.py | 1287 | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | ‚ùå –ö–û–°–í–ï–ù–ù–û–ï |

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:**
- **–°—Ç—Ä–æ–∫–∞ 929 (auth_start):** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞ ‚Äî —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ
- **–°—Ç—Ä–æ–∫–∞ 312 (send_lead_to_telegram):** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–°—Ç—Ä–æ–∫–∞ 473 (check_source_for_task_leads):** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–°—Ç—Ä–æ–∫–∞ 1287 (login_by_telegram):** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–∑–æ–≤–∞ `await client.get_me()` ‚Äî —ç—Ç–æ –°–û–ó–î–ê–Å–¢ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ session_string

| –ú–µ—Å—Ç–æ | –û–ø–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª | –ö–æ–Ω—Ç–µ–∫—Å—Ç | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ |
|-------|----------|------|----------|--------------|
| telegram_auth.py:15-98 | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î | telegram_auth.py | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –Ω–æ–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| main.py:1159-1168 | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ | main.py | –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ SMS | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| telegram_clients.py:72 | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ | telegram_clients.py | –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ per-user –∫–ª–∏–µ–Ω—Ç–∞ | ‚úÖ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| telegram_clients.py:72 | **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏–Ω–∞** | main.py:929 | **–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é** | ‚ùå –ù–ï –î–û–õ–ñ–ù–û |

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ telegram_sessions —Ç–∞–±–ª–∏—Ü—ã

| –û–ø–µ—Ä–∞—Ü–∏—è | –§—É–Ω–∫—Ü–∏—è | –§–∞–π–ª | –õ–∏–Ω–∏—è | –ö–æ–Ω—Ç–µ–∫—Å—Ç | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ |
|----------|---------|------|-------|----------|--------------|
| SELECT | auth_start | main.py | 898-904 | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è (–í–∞—Ä–∏–∞–Ω—Ç –ê vs –ë) | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| SELECT | get_user_client | telegram_clients.py | 57-61 | –ü–æ–ª—É—á–µ–Ω–∏–µ session_string –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| SELECT | get_user_me | main.py | 745-746 | –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| SELECT | login_by_telegram | main.py | 1276-1277 | –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û |
| SELECT | Multiple admin | main.py | 307, 746, 785, 816... | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞ | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| INSERT/UPDATE | save_session_to_db | telegram_auth.py | 56-71 | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| UPDATE | login_by_telegram | main.py | 1301-1304 | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö | ‚ùå –ö–û–°–í–ï–ù–ù–û–ï |
| DELETE | admin_logout_telegram | main.py | 1514 | –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∞–¥–º–∏–Ω–æ–º | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |
| DELETE | admin_delete_user | main.py | 1609 | –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ safe_send_message()

| –ú–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞ | –§—É–Ω–∫—Ü–∏—è | –§–∞–π–ª | –õ–∏–Ω–∏—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ | –ö–æ–Ω—Ç–µ–∫—Å—Ç | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ |
|--------------|---------|------|-------|----------------|----------|--------------|
| 1 | auth_start | main.py | 939 | –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ | "üîê –ö–æ–¥ –≤—Ö–æ–¥–∞..." | ‚ùå –ù–ï –î–û–õ–ñ–ù–û |
| 2 | send_lead_to_telegram | monitor.py | 328 | –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ª–∏–¥–∞ | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ª–∏–¥–∞ | ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û |

---

### 2.5 –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–ù–û–ô –§–£–ù–ö–¶–ò–ò login_by_telegram()

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ –≤ `main.py:1218-1351`:**

```python
async def login_by_telegram(request: AuthLoginTelegramRequest):
    # ...
    telegram_session = db.query(TelegramSession).filter(...).first()
    # ...
    client = await get_user_client(user.id, db)  # <-- ‚ùå –°–û–ó–î–ê–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê –ü–†–ò –õ–û–ì–ò–ù–ï
    if client:
        me = await client.get_me()  # <-- –í–´–ó–û–í –ö TELEGRAM
        first_name_fresh = me.first_name
        last_name_fresh = me.last_name
        username_fresh = me.username

        # –û–±–Ω–æ–≤–∏—Ç—å –≤ –ë–î —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
        telegram_session.telegram_first_name = first_name_fresh
        telegram_session.telegram_last_name = last_name_fresh
        telegram_session.telegram_username = username_fresh
        db.commit()
```

**–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- **–≠—Ç–∞–ª–æ–Ω:** TelegramSession –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –ª–æ–≥–∏–Ω–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –ù–ï –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
- **–¢–µ–∫—É—â–∏–π –∫–æ–¥:** `await get_user_client(user.id, db)` –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `await client.get_me()` –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, —á—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

---

## üö® –ß–ê–°–¢–¨ 3: –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –†–ê–°–•–û–ñ–î–ï–ù–ò–ô

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è 1: –õ–û–ì–ò–ù –¢–†–û–ì–ê–ï–¢ TELEGRAM

| ‚Ññ | –ß—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç | –§–∞–π–ª | –õ–∏–Ω–∏—è | –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ | –≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ | –°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å |
|----|-------------|------|-------|-------------------|-------------------|-------------|
| 1.1 | auth_start (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π) —Å–æ–∑–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç | main.py | 929 | `await get_user_client(user.id, db)` | –ù–ò–ö–ê–ö–û–ì–û –ö–õ–ò–ï–ù–¢–ê | üî¥ –í–´–°–û–ö–ê–Ø |
| 1.2 | auth_start (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π) –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è | telegram_clients.py | 77 | `await client.connect()` | –ù–ò–ö–ê–ö–û–ì–û –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø | üî¥ –í–´–°–û–ö–ê–Ø |
| 1.3 | auth_start (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç | main.py | 939 | `await safe_send_message(client, ...)` | –ß–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å, –Ω–µ Telegram | üî¥ –í–´–°–û–ö–ê–Ø |
| 2.1 | login_by_telegram –ø–æ–ª—É—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç | main.py | 1287 | `await get_user_client(user.id, db)` | –î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î, –Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ | üü° –°–†–ï–î–ù–Ø–Ø |
| 2.2 | login_by_telegram –≤—ã–∑—ã–≤–∞–µ—Ç get_me() | main.py | 1290 | `me = await client.get_me()` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î (telegram_session) | üü° –°–†–ï–î–ù–Ø–Ø |

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è 2: –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï SESSION_STRING

| ‚Ññ | –ß—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç | –§–∞–π–ª | –õ–∏–Ω–∏—è | –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ | –≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ | –°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å |
|----|-------------|------|-------|-------------------|-------------------|-------------|
| 3.1 | get_user_client –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | main.py | 929 | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ | –õ–æ–≥–∏–Ω –ë–ï–ó Telegram | üî¥ –í–´–°–û–ö–ê–Ø |
| 3.2 | session_string –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏–Ω–∞ | telegram_clients.py | 72 | StringSession(telegram_session.session_string) | –¢–æ–ª—å–∫–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ | üî¥ –í–´–°–û–ö–ê–Ø |

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è 3: –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

| ‚Ññ | –ü—Ä–æ–±–ª–µ–º–∞ | –≠—Ñ—Ñ–µ–∫—Ç | –°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å |
|----|----------|--------|-------------|
| 4.1 | –õ–æ–≥–∏–Ω —Å–æ–∑–¥–∞—ë—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã IP, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | üî¥ –í–´–°–û–ö–ê–Ø |
| 4.2 | session_string –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏–Ω–∞ | –õ–æ–≥–∏–Ω –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Telegram, –º–æ–∂–µ—Ç —Ñ–µ–π–ª–∏—Ç—å—Å—è | üî¥ –í–´–°–û–ö–ê–Ø |
| 4.3 | TelegramSession –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | –ù–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ | üî¥ –í–´–°–û–ö–ê–Ø |

---

## üìç –ß–ê–°–¢–¨ 4: –ö–û–ù–ö–†–ï–¢–ù–´–ï –§–ê–ô–õ–´ –ò –§–£–ù–ö–¶–ò–ò

### –§–∞–π–ª 1: `main.py`

#### –§—É–Ω–∫—Ü–∏—è: `auth_start(request: AuthStartRequest)` ‚Äî –ª–∏–Ω–∏–∏ 895-987

```python
# –í–ê–†–ò–ê–ù–¢ –ê: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ª–∏–Ω–∏–∏ 906-958)
if telegram_session:
    # –õ–∏–Ω–∏—è 929: ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï
    client = await get_user_client(user.id, db)
    if not client:
        raise Exception("TelegramClient –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")

    # –õ–∏–Ω–∏—è 939: ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï
    await safe_send_message(client, chat_id, message_text)

# –í–ê–†–ò–ê–ù–¢ –ë: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ª–∏–Ω–∏–∏ 966-987)
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî —Å–æ–∑–¥–∞—ë—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è SMS
client = TelegramClient(StringSession(), TELEGRAM_API_ID, TELEGRAM_API_HASH)
await client.send_code_request(phone)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∞—Ä–∏–∞–Ω—Ç –ê (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç get_user_client() –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, —á—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —ç—Ç–∞–ª–æ–Ω—É

---

#### –§—É–Ω–∫—Ü–∏—è: `login_by_telegram(request: AuthLoginTelegramRequest)` ‚Äî –ª–∏–Ω–∏–∏ 1218-1351

```python
# –õ–∏–Ω–∏—è 1276-1277: SELECT –∏–∑ –ë–î ‚Äî ‚úÖ
telegram_session = db.query(TelegramSession).filter(...).first()

# –õ–∏–Ω–∏—è 1287: ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
client = await get_user_client(user.id, db)

# –õ–∏–Ω–∏—è 1290: ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï ‚Äî –≤—ã–∑–æ–≤ Telegram –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
me = await client.get_me()

# –õ–∏–Ω–∏—è 1301-1304: ‚ùå –ö–û–°–í–ï–ù–ù–û–ï ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞
telegram_session.telegram_first_name = first_name_fresh
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–Ω —Ç—Ä–µ–±—É–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤—ã–∑–æ–≤–∞ get_me() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

### –§–∞–π–ª 2: `telegram_clients.py`

#### –§—É–Ω–∫—Ü–∏—è: `get_user_client(user_id: int, db: Session)` ‚Äî –ª–∏–Ω–∏–∏ 22-88

```python
# –õ–∏–Ω–∏—è 57-61: SELECT session_string ‚Äî ‚úÖ (–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
telegram_session = db.query(TelegramSession).filter(...).first()

# –õ–∏–Ω–∏—è 72-75: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
client = TelegramClient(session_string, TELEGRAM_API_ID, TELEGRAM_API_HASH)

# –õ–∏–Ω–∏—è 77: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
await client.connect()

# –õ–∏–Ω–∏—è 81: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
telegram_clients_cache[user_id] = client
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ `send_lead_to_telegram()` ‚Äî —ç—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ `check_source_for_task_leads()` ‚Äî —ç—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚ùå **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û** –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ `auth_start()` –≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ ‚Äî —ç—Ç–æ –ª–æ–≥–∏–Ω, –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å
- ‚ùå **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û** –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ `login_by_telegram()` ‚Äî —ç—Ç–æ –ª–æ–≥–∏–Ω, –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å

---

### –§–∞–π–ª 3: `monitor.py`

#### –§—É–Ω–∫—Ü–∏—è: `send_lead_to_telegram(task: Task, lead: Lead, db: Session)` ‚Äî –ª–∏–Ω–∏–∏ 282-339

```python
# –õ–∏–Ω–∏—è 312: ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —ç—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
client = await get_user_client(task.user_id, db)

# –õ–∏–Ω–∏—è 328: ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–∞
await safe_send_message(client, telegram_session.telegram_user_id, text)
```

**–°—Ç–∞—Ç—É—Å:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É ‚úÖ

---

#### –§—É–Ω–∫—Ü–∏—è: `check_source_for_task_leads(...)` ‚Äî –ª–∏–Ω–∏–∏ 447-615

```python
# –õ–∏–Ω–∏—è 473: ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —ç—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
client = await get_user_client(task.user_id, db)

# –õ–∏–Ω–∏–∏ –¥–∞–ª–µ–µ: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–∞–ª–∞, –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
entity = await client.get_entity(f"@{source_username}")
messages = await client.get_messages(entity, ...)
```

**–°—Ç–∞—Ç—É—Å:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É ‚úÖ

---

## üéØ –ß–ê–°–¢–¨ 5: –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–Ø –†–ê–°–•–û–ñ–î–ï–ù–ò–ô

### –ö–ê–¢–ï–ì–û–†–ò–Ø A: –õ–æ–≥–∏–Ω —Å–æ–∑–¥–∞—ë—Ç TelegramClient –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–ú–µ—Å—Ç–∞:**
1. `main.py:929` ‚Äî `await get_user_client(user.id, db)` –≤ `auth_start()`
2. `telegram_clients.py:77` ‚Äî `await client.connect()` –∏–∑ get_user_client()
3. `main.py:1287` ‚Äî `await get_user_client(user.id, db)` –≤ `login_by_telegram()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –≠—Ç–∞–ª–æ–Ω —Ç—Ä–µ–±—É–µ—Ç ‚Äî –ù–ò–ö–ê–ö–û–ì–û –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ

**–í—ã–∑—ã–≤–∞—é—â–∏–µ —Ü–µ–ø–æ—á–∫–∏:**
```
auth_start() ‚Üí get_user_client() ‚Üí StringSession() ‚Üí TelegramClient() ‚Üí connect()
login_by_telegram() ‚Üí get_user_client() ‚Üí StringSession() ‚Üí TelegramClient() ‚Üí connect()
```

---

### –ö–ê–¢–ï–ì–û–†–ò–Ø B: –õ–æ–≥–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ —á–µ—Ä–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç

**–ú–µ—Å—Ç–∞:**
1. `main.py:939` ‚Äî `await safe_send_message(client, chat_id, message_text)` –≤ `auth_start()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –≠—Ç–∞–ª–æ–Ω —Ç—Ä–µ–±—É–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ "—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Ä–≤–∏—Å–∞", –Ω–µ —á–µ—Ä–µ–∑ Telegram –∫–ª–∏–µ–Ω—Ç

**–¢–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫:**
```
auth_start() ‚Üí get_user_client() ‚Üí safe_send_message() ‚Üí client.send_message()
```

---

### –ö–ê–¢–ï–ì–û–†–ò–Ø C: session_string –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–ú–µ—Å—Ç–∞:**
1. `telegram_clients.py:72` ‚Äî `session_string = StringSession(telegram_session.session_string)`
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `auth_start()` (–ª–æ–≥–∏–Ω) ‚Äî ‚ùå
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `send_lead_to_telegram()` (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥) ‚Äî ‚úÖ
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `check_source_for_task_leads()` (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥) ‚Äî ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** session_string –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ª–æ–≥–∏–Ω–∞, —á—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç —ç—Ç–∞–ª–æ–Ω

---

### –ö–ê–¢–ï–ì–û–†–ò–Ø D: TelegramSession –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–ú–µ—Å—Ç–∞:**
1. `main.py:898-904` ‚Äî SELECT –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
2. `main.py:929` ‚Äî `await get_user_client(user.id, db)` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç telegram_session.session_string
3. `main.py:1276-1277` ‚Äî SELECT –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
4. `main.py:1287` ‚Äî `await get_user_client(user.id, db)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** TelegramSession –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–≠—Ç–∞–ª–æ–Ω —Ç—Ä–µ–±—É–µ—Ç:** TelegramSession = —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è, –Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø (–î–õ–Ø –°–ü–†–ê–í–ö–ò)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Äî –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚úÖ

```
monitoring_loop_tasks()
  ‚îî‚îÄ process_task_for_leads()
    ‚îî‚îÄ check_source_for_task_leads()
      ‚îî‚îÄ get_user_client() ‚úÖ
        ‚îî‚îÄ client.get_entity()
        ‚îî‚îÄ client.get_messages()
    ‚îî‚îÄ send_lead_to_telegram()
      ‚îî‚îÄ get_user_client() ‚úÖ
        ‚îî‚îÄ safe_send_message() ‚úÖ
          ‚îî‚îÄ client.send_message()
```

### –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (SMS) ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚úÖ

```
auth_start() ‚Äî –í–∞—Ä–∏–∞–Ω—Ç –ë
  ‚îî‚îÄ TelegramClient(StringSession()) ‚úÖ
  ‚îî‚îÄ client.send_code_request(phone) ‚úÖ
  ‚îî‚îÄ pending_auth_clients[auth_id] ‚úÖ

submit_code()
  ‚îî‚îÄ client.sign_in() ‚úÖ

auth_save()
  ‚îî‚îÄ session_string = client.session.save() ‚úÖ
  ‚îî‚îÄ save_session_to_db() ‚úÖ
```

---

## üìä –°–í–û–î–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ | –ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è |
|-----------|-----------|------------|---------------------|
| –°–æ–∑–¥–∞–Ω–∏–µ TelegramClient | 2 | 0 | 100% ‚úÖ |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ | 4 | 0 | 100% ‚úÖ |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ** | **0** | **3** | **0%** ‚ùå |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ session_string | 2 | 2 | 50% ‚ö†Ô∏è |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ telegram_sessions | 4 | 2 | 67% ‚ö†Ô∏è |
| safe_send_message | 1 | 1 | 50% ‚ö†Ô∏è |
| **–ò–¢–û–ì–û** | **13** | **8** | **62%** ‚ö†Ô∏è |

---

## üî¥ –§–ò–ù–ê–õ–¨–ù–´–ô –í–´–í–û–î

### –ì–ª–∞–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å: –°–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ü–û–õ–ù–û–°–¢–¨–Æ?

**–û–¢–í–ï–¢: –ù–ï–¢, –ù–ï –°–û–í–ü–ê–î–ê–ï–¢**

**–ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è: 62%**

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

#### 1Ô∏è‚É£ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø: "–õ–æ–≥–∏–Ω —Ç—Ä–æ–≥–∞–µ—Ç Telegram"** üî¥

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
- –°–æ–∑–¥–∞—ë—Ç TelegramClient
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Telegram API
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ —á–µ—Ä–µ–∑ Telegram
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç session_string –∏–∑ –ë–î

**–≠—Ç–∞–ª–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç:**
- –ù–ò–ö–ê–ö–û–ì–û TelegramClient –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- –ù–ò–ö–ê–ö–ò–• –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ Telegram –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ "—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–µ—Ä–≤–∏—Å–∞"
- session_string –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–§–∞–π–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏:**
- `main.py:929` ‚Äî get_user_client() –≤ auth_start()
- `main.py:939` ‚Äî safe_send_message() –≤ auth_start()
- `main.py:1287` ‚Äî get_user_client() –≤ login_by_telegram()

**–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
1. `auth_start()` ‚Äî –≤–∞—Ä–∏–∞–Ω—Ç –ê (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
2. `login_by_telegram()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

#### 2Ô∏è‚É£ **–°–ï–†–¨–ï–ó–ù–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø: "–õ–æ–≥–∏–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç session_string"** üü°

**–ü—Ä–æ–±–ª–µ–º–∞:** session_string –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, —á—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å

**–ù–∞—Ä—É—à–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Ü–µ–ø–æ—á–∫–∏:**
```
auth_start() ‚Üí get_user_client() ‚Üí session_string = StringSession(telegram_session.session_string)
login_by_telegram() ‚Üí get_user_client() ‚Üí session_string = StringSession(telegram_session.session_string)
```

**–≠—Ç–∞–ª–æ–Ω —Ç—Ä–µ–±—É–µ—Ç:** session_string –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ, –ù–ï –≤ –ª–æ–≥–∏–Ω–µ

---

#### 3Ô∏è‚É£ **–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø: "TelegramSession –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"** üü°

**–ü—Ä–æ–±–ª–µ–º–∞:** TelegramSession –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–≠—Ç–∞–ª–æ–Ω —Ç—Ä–µ–±—É–µ—Ç:**
- TelegramSession = —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
- TelegramSession = –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—Ö—Ä–∞–Ω–∏—Ç telegram_user_id –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–∏–¥–æ–≤)
- TelegramSession = –ù–ï –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–í—ã–∑–æ–≤—ã –∏–∑ –ª–æ–≥–∏–Ω–∞:**
- `main.py:898-904` ‚Äî SELECT –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è
- `main.py:929` ‚Äî –î–æ—Å—Ç—É–ø –∫ session_string
- `main.py:1276-1277` ‚Äî SELECT –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- `main.py:1287` ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ telegram_session

---

## üìù –ê–ù–ê–õ–ò–ó –¶–ï–ü–û–ß–ï–ö –í–´–ó–û–í–û–í –° –ù–ê–†–£–®–ï–ù–ò–Ø–ú–ò

### –¶–µ–ø–æ—á–∫–∞ 1: auth_start() –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ

```
POST /api/auth/start (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
‚îÇ
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: SELECT telegram_sessions WHERE phone ‚úÖ
‚îÇ ‚îî‚îÄ if telegram_session:
‚îÇ    ‚îú‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ ‚úÖ
‚îÇ    ‚îÇ
‚îÇ    ‚îú‚îÄ ‚ùå await get_user_client(user.id, db)  [–ù–ê–†–£–®–ï–ù–ò–ï –≠–¢–ê–õ–û–ù–ê]
‚îÇ    ‚îÇ  ‚îú‚îÄ SELECT telegram_session WHERE user_id
‚îÇ    ‚îÇ  ‚îú‚îÄ session_string = StringSession(telegram_session.session_string)
‚îÇ    ‚îÇ  ‚îú‚îÄ TelegramClient(session_string, ...) ‚Äî –°–û–ó–î–ê–ù–ò–ï ‚ùå
‚îÇ    ‚îÇ  ‚îú‚îÄ await client.connect() ‚Äî –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ‚ùå
‚îÇ    ‚îÇ  ‚îî‚îÄ telegram_clients_cache[user_id] = client
‚îÇ    ‚îÇ
‚îÇ    ‚îî‚îÄ ‚ùå await safe_send_message(client, chat_id, code) [–û–¢–ü–†–ê–í–ö–ê –ß–ï–†–ï–ó TELEGRAM ‚ùå]
‚îÇ       ‚îî‚îÄ await client.send_message(chat_id, text)
‚îÇ
‚îî‚îÄ return {"login_via": "telegram_message"}
```

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ —ç—Ç–∞–ª–æ–Ω—É:**
```
POST /api/auth/start (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
‚îÇ
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: SELECT telegram_sessions WHERE phone ‚úÖ
‚îÇ ‚îî‚îÄ if telegram_session:
‚îÇ    ‚îú‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ ‚úÖ
‚îÇ    ‚îú‚îÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ —á–µ—Ä–µ–∑ "—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–µ—Ä–≤–∏—Å–∞" ‚úÖ
‚îÇ    ‚îÇ  (–ë–ï–ó —Å–æ–∑–¥–∞–Ω–∏—è TelegramClient)
‚îÇ    ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–¥ –≤ –ø–∞–º—è—Ç–∏ ‚úÖ
‚îÇ
‚îî‚îÄ return {"login_via": "telegram_message"}
```

---

### –¶–µ–ø–æ—á–∫–∞ 2: login_by_telegram() –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ

```
POST /api/auth/login-by-telegram
‚îÇ
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –∏–∑ pending_login_codes ‚úÖ
‚îÇ ‚îî‚îÄ if code_correct:
‚îÇ    ‚îú‚îÄ SELECT user WHERE phone ‚úÖ
‚îÇ    ‚îú‚îÄ SELECT telegram_session WHERE user_id ‚úÖ
‚îÇ    ‚îÇ
‚îÇ    ‚îú‚îÄ ‚ùå await get_user_client(user.id, db) [–°–û–ó–î–ê–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê ‚ùå]
‚îÇ    ‚îÇ  ‚îî‚îÄ (–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏–∑ session_string)
‚îÇ    ‚îÇ
‚îÇ    ‚îú‚îÄ ‚ùå me = await client.get_me() [–í–´–ó–û–í –ö TELEGRAM ‚ùå]
‚îÇ    ‚îÇ  ‚îú‚îÄ me.first_name
‚îÇ    ‚îÇ  ‚îú‚îÄ me.last_name
‚îÇ    ‚îÇ  ‚îî‚îÄ me.username
‚îÇ    ‚îÇ
‚îÇ    ‚îú‚îÄ –û–±–Ω–æ–≤–∏—Ç—å –ë–î —Å fresh –¥–∞–Ω–Ω—ã–º–∏ ‚úÖ
‚îÇ    ‚îÇ  (–Ω–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∏–∑ Telegram, –Ω–µ –ë–î)
‚îÇ    ‚îÇ
‚îÇ    ‚îî‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å auth_token ‚úÖ
‚îÇ       ‚îî‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cookie ‚úÖ
‚îÇ
‚îî‚îÄ return {"ok": True, "auth_token": ...}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤—ã–∑–æ–≤ get_me()

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ —ç—Ç–∞–ª–æ–Ω—É:**
```
POST /api/auth/login-by-telegram
‚îÇ
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –∏–∑ pending_login_codes ‚úÖ
‚îú‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å auth_token ‚úÖ
‚îî‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cookie ‚úÖ
‚îÇ
(–î–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —É–∂–µ –µ—Å—Ç—å –≤ telegram_session –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
```

---

## üîç –ü–û–î–†–û–ë–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê: –í–°–ï –í–´–ó–û–í–´ get_user_client()

| ‚Ññ | –§–∞–π–ª | –§—É–Ω–∫—Ü–∏—è | –õ–∏–Ω–∏—è | –ö–æ–Ω—Ç–µ–∫—Å—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ | –¢–∏–ø —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è |
|----|------|---------|-------|----------|-----------|--------------|-----------------|
| 1 | main.py | auth_start | 929 | –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ | –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –≤ Telegram | ‚ùå | –õ–æ–≥–∏–Ω —Ç—Ä–æ–≥–∞–µ—Ç Telegram |
| 2 | monitor.py | send_lead_to_telegram | 312 | –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–∞ | –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram | ‚úÖ | ‚Äî |
| 3 | monitor.py | check_source_for_task_leads | 473 | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∫–∞–Ω–∞–ª–∞ | ‚úÖ | ‚Äî |
| 4 | main.py | login_by_telegram | 1287 | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö | –í—ã–∑–æ–≤ get_me() –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | ‚ùå | –õ–æ–≥–∏–Ω —Ç—Ä–æ–≥–∞–µ—Ç Telegram |

---

## üìå –ò–¢–û–ì–û–í–´–ô –°–ü–ò–°–û–ö –ö–û–ù–ö–†–ï–¢–ù–´–• –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞ #1: auth_start() —Å–æ–∑–¥–∞—ë—Ç TelegramClient –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ

**–§–∞–π–ª:** `main.py`
**–§—É–Ω–∫—Ü–∏—è:** `async def auth_start(request: AuthStartRequest)`
**–°—Ç—Ä–æ–∫–∏:** 929, 939
**–ö–æ–¥:**
```python
client = await get_user_client(user.id, db)
await safe_send_message(client, chat_id, message_text)
```
**–ù–∞—Ä—É—à–µ–Ω–∏–µ:** –≠—Ç–∞–ª–æ–Ω –∑–∞–ø—Ä–µ—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ TelegramClient –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
**–¢–∏–ø:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (Category A)

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: login_by_telegram() –≤—ã–∑—ã–≤–∞–µ—Ç get_me() –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–§–∞–π–ª:** `main.py`
**–§—É–Ω–∫—Ü–∏—è:** `async def login_by_telegram(request: AuthLoginTelegramRequest)`
**–°—Ç—Ä–æ–∫–∏:** 1287, 1290
**–ö–æ–¥:**
```python
client = await get_user_client(user.id, db)
me = await client.get_me()
```
**–ù–∞—Ä—É—à–µ–Ω–∏–µ:** –≠—Ç–∞–ª–æ–Ω —Ç—Ä–µ–±—É–µ—Ç ‚Äî –ª–æ–≥–∏–Ω –ù–ï –¥–æ–ª–∂–µ–Ω —Ç—Ä–æ–≥–∞—Ç—å Telegram
**–¢–∏–ø:** –°–µ—Ä—å—ë–∑–Ω—ã–π (Category B)

---

### –ü—Ä–æ–±–ª–µ–º–∞ #3: get_user_client() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–§–∞–π–ª:** `telegram_clients.py`
**–§—É–Ω–∫—Ü–∏—è:** `async def get_user_client(user_id: int, db: Session)`
**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑:** auth_start(), login_by_telegram()
**–ù–∞—Ä—É—à–µ–Ω–∏–µ:** session_string –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, —á—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —ç—Ç–∞–ª–æ–Ω—É
**–¢–∏–ø:** –°–µ—Ä—å—ë–∑–Ω—ã–π (Category C)

---

### –ü—Ä–æ–±–ª–µ–º–∞ #4: TelegramSession –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–§–∞–π–ª:** `telegram_clients.py`
**–§—É–Ω–∫—Ü–∏—è:** `async def get_user_client(user_id: int, db: Session)`
**–°—Ç—Ä–æ–∫–∏:** 57-72
**–ö–æ–¥:**
```python
telegram_session = (
    db.query(TelegramSession)
    .filter(TelegramSession.user_id == user_id)
    .first()
)
session_string = StringSession(telegram_session.session_string)
```
**–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–∑–æ–≤–∞:** –ò–∑ auth_start() –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ
**–ù–∞—Ä—É—à–µ–Ω–∏–µ:** TelegramSession –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¢–û–õ–¨–ö–û —Ñ–ª–∞–≥–æ–º, –Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
**–¢–∏–ø:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π (Category D)

---

## ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–û–°–õ–ï–î–°–¢–í–ò–Ø –†–ê–°–•–û–ñ–î–ï–ù–ò–ô

| –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ | –í–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è |
|------------|---------------------|
| –°–æ–∑–¥–∞–Ω–∏–µ TelegramClient –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã IP-–∞–¥—Ä–µ—Å–æ–≤, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Telegram API, –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ |
| –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ª–æ–≥–∏–Ω–∞ –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Telegram, —É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞ –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ session_string –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | –õ–æ–≥–∏–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î |
| –í—ã–∑–æ–≤ get_me() –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Telegram, –∑–∞–¥–µ—Ä–∂–∫–∞ –ª–æ–≥–∏–Ω–∞, –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ rate limit |

---

## üìã –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ù–ï –°–û–í–ü–ê–î–ê–ï–¢ —Å —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö:

1. **–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ (auth_start):**
   - ‚ùå –°–æ–∑–¥–∞—ë—Ç—Å—è TelegramClient (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ)
   - ‚ùå –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ)
   - ‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–µ—Ä–µ–∑ "—Å–µ—Ä–≤–∏—Å")

2. **–ü—Ä–∏ –ª–æ–≥–∏–Ω–µ —á–µ—Ä–µ–∑ Telegram (login_by_telegram):**
   - ‚ùå –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è TelegramClient —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ª–æ–≥–∏–Ω–∞
   - ‚ùå –í—ã–∑—ã–≤–∞–µ—Ç—Å—è get_me() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
   - ‚ùå –õ–æ–≥–∏–Ω –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ session_string

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ session_string:**
   - ‚ùå –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ)

4. **–†–æ–ª—å TelegramSession:**
   - ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥–æ–º –∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)

### –ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ: **62%**

### –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å: **–í–´–°–û–ö–ê–Ø** üî¥

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Ä—É—à–∞–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
- –õ–æ–≥–∏–Ω –ù–ï –¥–æ–ª–∂–µ–Ω —Ç—Ä–æ–≥–∞—Ç—å Telegram
- session_string –ù–ï –¥–æ–ª–∂–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- TelegramSession ‚Äî —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥, –Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–æ–≥–∏–Ω–∞

---

**–û—Ç—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –≠—Ç–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç, —Ñ–∏–∫—Å–∏—Ä—É—é—â–∏–π —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —Å —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π. –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞ –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª–æ—Å—å.**
