# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π

## üìã –†–ï–ó–Æ–ú–ï

–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—à–∞–µ—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É** –ø–æ—Ç–µ—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ HTML –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ OpenAI –º–æ–¥–µ–ª–µ–π –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.

### –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞:** "Generation completed but confirmation signal was not received"

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
1. Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML —Å –ø–æ–º–æ—â—å—é LLM
2. HTML –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ WebSocket
3. –ï—Å–ª–∏ WebSocket –∑–∞–∫—Ä–æ–µ—Ç—Å—è –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (disconnect, timeout, browser close):
   - –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–º
   - HTML –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
   - –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- –ü–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ API —Ç–æ–∫–µ–Ω—ã –≤–ø—É—Å—Ç—É—é
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å —Ç–µ–º –∂–µ ID

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. **–í–≤–µ–¥–µ–Ω–∏–µ Generation ID**

```python
# –ö–∞–∂–¥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
generation_id: str = str(uuid.uuid4())
```

- –°–æ–∑–¥–∞–µ—Ç—Å—è –≤ **–Ω–∞—á–∞–ª–µ pipeline** (WebSocketSetupMiddleware)
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –≤–µ—Å—å pipeline
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∫–ª—é—á –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### 2. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î**

```python
# –í _process_variant_completion():
# CRITICAL: Save to database immediately
update_generation(
    generation_id=self.generation_id,
    status="completed",
    html=extracted_html,
)
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–°–†–ê–ó–£ –ü–û–°–õ–ï** –ø–æ–ª—É—á–µ–Ω–∏—è HTML –æ—Ç –º–æ–¥–µ–ª–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ **–ù–ï–ó–ê–í–ò–°–ò–ú–û** –æ—Ç WebSocket —Å—Ç–∞—Ç—É—Å–∞
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–ü–ï–†–ï–î** post-processing, image generation
- –ï—Å–ª–∏ WebSocket –∑–∞–∫—Ä–æ–µ—Ç—Å—è ‚Üí HTML —É–∂–µ –≤ –ë–î

### 3. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**

```
Pipeline (—Å—Ç–∞—Ä–æ–µ):
HTML –ø–æ–ª—É—á–µ–Ω ‚Üí post-processing ‚Üí WebSocket send ‚Üí [–º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è]

Pipeline (–Ω–æ–≤–æ–µ):
HTML –ø–æ–ª—É—á–µ–Ω ‚Üí [SAVE TO DB] ‚Üí post-processing ‚Üí WebSocket send
              ‚Üë –ö–†–ò–¢–ò–ß–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ ‚Üë
```

### 4. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**

–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ API:
```bash
GET /api/generations/{generation_id}

–û—Ç–≤–µ—Ç:
{
  "success": true,
  "data": {
    "id": "abc-123",
    "html": "<html>...</html>",
    "status": "completed",
    "created_at": "2025-12-22T10:00:00",
    "duration_ms": 2500,
    "model": "gpt-4o-2024-11-20"
  }
}
```

---

## üîÑ –ú–û–î–ï–õ–ò: –¢–û–õ–¨–ö–û OpenAI

–í—Å–µ –º–æ–¥–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –∏–∑ **–æ–¥–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞** –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:

| –í–∞—Ä–∏–∞–Ω—Ç | –ú–æ–¥–µ–ª—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|--------|-----------|
| 1 | `gpt-4o-2024-11-20` | –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è |
| 2 | `gpt-4.1-2025-04-14` | Turbo (–±—ã—Å—Ç—Ä–µ–µ, –º–æ—â–Ω–µ–µ) |
| 3 | `gpt-4.1-mini-2025-04-14` | –ú–∏–Ω–∏ (–¥–µ—à–µ–≤–ª–µ, –±—ã—Å—Ç—Ä–µ–µ) |
| 4 | `gpt-4o-2024-08-06` | –°—Ç–∞–±–∏–ª—å–Ω–∞—è (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) |

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—Å–µ—Ö:**
- `temperature: 0` (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
- `max_tokens: 20000`
- `streaming: –∫–∞–∫ –±—ã–ª–æ –≤ baseline`

**–ß—Ç–æ —Å Claude/Gemini/Anthropic?**
- –ö–æ–¥ –≤–µ—Ç–≤–∏ –æ—Å—Ç–∞—é—Ç—Å—è (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
- –ù–æ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** –≤ –º–æ–¥–µ–ª–∏ –≤—ã–±–æ—Ä–∞
- –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–∫–ª—é—á–∏—Ç—å –≤ `_get_variant_models()`

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –§–∞–π–ª: `backend/routes/generate_code.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
import uuid
from db import save_generation, update_generation

# –í PipelineContext:
generation_id: str = field(default_factory=lambda: str(uuid.uuid4()))

# –í ParallelGenerationStage.__init__:
generation_id: str  # –Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä

# –í WebSocketSetupMiddleware.process():
save_generation(model="", status="started", generation_id=context.generation_id)

# –í _process_variant_completion():
# CRITICAL: Save to database immediately
update_generation(
    generation_id=self.generation_id,
    status="completed",
    html=extracted_html,
)
```

### –§–∞–π–ª: `backend/db/sqlite.py`

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:**
```python
def save_generation(
    ...,
    generation_id: Optional[str] = None,  # –Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
):
    if generation_id is None:
        generation_id = str(uuid.uuid4())
```

### –§–∞–π–ª: `backend/main.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
from db import init_db
from routes import history  # –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

init_db()  # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
```

---

## üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞

```bash
$ python3 backend/test_generation_persistence.py
```

**–¢–µ—Å—Ç—ã –≤–∫–ª—é—á–∞—é—Ç:**
1. ‚úì –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
2. ‚úì –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ generation
3. ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML
4. ‚úì –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ë–î
5. ‚úì **–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç–∫–∞–∑–∞ WebSocket** (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úì Database persistence: WORKING
‚úì Generation creation: WORKING
‚úì HTML storage: WORKING
‚úì WebSocket failure recovery: WORKING
```

---

## üöÄ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

–†–µ–∑—É–ª—å—Ç–∞—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (–∫–∞–∫ –≤—Å–µ–≥–¥–∞)
2. –ï—Å–ª–∏ WebSocket —Ä–∞–∑–æ—Ä–≤–µ—Ç—Å—è ‚Üí –∑–∞–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä / –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∫–ª–∞–¥–∫—É / –ø–æ—Ç–µ—Ä—è —Å–∏–≥–Ω–∞–ª–∞
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω** –≤ –ë–î
4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç: `GET /api/generations/{generation_id}`

---

## ‚ú® –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

| –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|----------|---|---|
| –ü–æ—Ç–µ—Ä—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ WS | ‚ùå –î–∞ | ‚úÖ –ù–µ—Ç |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ | ‚úÖ GET /api/generations/{id} |
| –ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è | ‚ùå –ó–∞–≤–∏—Å–∏—Ç –æ—Ç WS | ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç WS |
| –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π | ‚ùå –°–º–µ—à–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã | ‚úÖ –¢–æ–ª—å–∫–æ OpenAI (—á–µ—Å—Ç–Ω–æ) |
| Backwards compatible | - | ‚úÖ –î–∞ |

---

## üîê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –û–ö–†–£–ñ–ï–ù–ò–ï

- ‚úÖ **–ö–ª—é—á–∏ —Ç–æ–ª—å–∫–æ –≤ `.env`** ‚Äî –Ω–µ –≤ –∫–æ–¥–µ, –Ω–µ –≤ –ª–æ–≥–∞—Ö
- ‚úÖ **–ö–ª—é—á–∏ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ HTML** ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ backend
- ‚úÖ **–ù–ò–ö–ê–ö–ò–• thinking/reasoning —Ä–µ–∂–∏–º–æ–≤** ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ results
- ‚úÖ **–¢–æ–ª—å–∫–æ OpenAI** ‚Äî —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å—Ç–µ–∫, –º–µ–Ω—å—à–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

## üìù –ß–¢–û –ù–ï –¢–†–û–ì–ê–õ–ò (–ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é)

- ‚ùå Prompt –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚ùå Post-processing HTML/CSS
- ‚ùå Pipeline –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
- ‚ùå –í–∏–∑—É–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–ª–æ–Ω–∞
- ‚ùå –ù–æ–≤—ã–µ —Ñ–∏—á–∏

---

## üîÑ –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•

–°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î (–µ—Å–ª–∏ –±—ã–ª–∏) ‚Äî **–Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π**.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:
```bash
# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
sqlite3 backend/data/app.db ".dump generations" > backup.sql
```

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î reinit:
```python
from db import init_db
init_db()  # —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
```

---

## ‚ö†Ô∏è –ò–ó–í–ï–°–¢–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

1. **Variant 4 –º–æ–¥–µ–ª—å**: –ï—Å–ª–∏ `gpt-4o-realtime-preview` –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `gpt-4o-2024-08-06`
2. **–°—Ç–∞—Ä—ã–µ endpoints**: –†–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã)
3. **Concurrent generations**: SQLite –Ω–µ –æ–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

---

## üìû –ö–û–ù–¢–ê–ö–¢

–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º:
- –°–º–æ—Ç—Ä–∏ commit message:
  ```
  Fix critical generation result loss and standardize to OpenAI-only models
  ```
- –°–º–æ—Ç—Ä–∏ —Ç–µ—Å—Ç—ã: `backend/test_generation_persistence.py`
- –°–º–æ—Ç—Ä–∏ –∫–æ–¥: `backend/routes/generate_code.py` (—Å—Ç—Ä–æ–∫–∏ 730-741)

---

**Version:** 1.0
**Date:** 2025-12-22
**Status:** ‚úÖ READY FOR TESTING
