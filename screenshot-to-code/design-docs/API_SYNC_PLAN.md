# –ü–ª–∞–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ API —Å WEB (–∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã)

## –ü–†–û–ë–õ–ï–ú–ê

–°–µ–π—á–∞—Å WEB –∏ API –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–†–ê–ó–ù–´–ï —Å–∏—Å—Ç–µ–º—ã –±–∏–ª–ª–∏–Ω–≥–∞**:

```
WEB (–ü–†–ê–í–ò–õ–¨–ù–û):
  user_id ‚Üí users.credits (–æ–¥–∏–Ω –±–∞–ª–∞–Ω—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

API (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
  api_key ‚Üí api_keys.credits_total - api_keys.credits_used (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã –≤ WEB –∏ API. –≠—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ "–ë–∞–ª–∞–Ω—Å –û–î–ò–ù".

---

## –†–ï–®–ï–ù–ò–ï: API KEY –¥–æ–ª–∂–µ–Ω —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è –≤ USER_ID

API key ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ø–æ—Å–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ó–∞ –Ω–∏–º –¥–æ–ª–∂–µ–Ω —Å—Ç–æ—è—Ç—å user_id.
–ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ `users.credits`, –∫–∞–∫ –∏ –≤ WEB.

---

## –ù–ï–û–ë–•–û–î–ò–ú–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –§–ê–ó–ê 1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î

#### 1.1 –î–æ–±–∞–≤–∏—Ç—å user_id –≤ api_keys —Ç–∞–±–ª–∏—Ü—É

```sql
ALTER TABLE api_keys ADD COLUMN user_id TEXT NOT NULL DEFAULT 'unknown' REFERENCES users(id);

-- –ó–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç—å credits_total –∏ credits_used –∏–∑ api_keys
-- (–æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã, –±–∞–ª–∞–Ω—Å –≤ users)
```

#### 1.2 –ú–∏–≥—Ä–∞—Ü–∏—è: —Å–æ–∑–¥–∞—Ç—å API keys –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```python
# –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ –æ–¥–Ω–æ–º—É API key
for user in all_users:
    api_key = generate_key()
    api_key_hash = hash_api_key(api_key)
    insert_api_key(
        key_hash=api_key_hash,
        user_id=user.id,
        tier=user.plan  # free –∏–ª–∏ pro
    )
```

---

### –§–ê–ó–ê 2: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ API

#### 2.1 –ò–∑–º–µ–Ω–∏—Ç—å verify_api_key() –≤ `/backend/api/auth.py`

**–ë–´–õ–û:**
```python
def verify_api_key(api_key: str) -> dict:
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {id, tier, credits_total, credits_used, ...}
    cursor.execute("""
        SELECT id, tier, credits_total, credits_used, ...
        FROM api_keys
        WHERE key_hash = ?
    """)
    return dict(row)
```

**–°–¢–ê–õ–û:**
```python
def verify_api_key(api_key: str) -> dict:
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {api_key_id, user_id, tier}
    cursor.execute("""
        SELECT id, user_id, tier
        FROM api_keys
        WHERE key_hash = ? AND is_active = 1
    """)
    return dict(row)
    # –ù–∞ —ç—Ç–æ–º –≤—Å—ë! –ö—Ä–µ–¥–∏—Ç—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ users —Ç–∞–±–ª–∏—Ü—ã –ø–æ user_id
```

#### 2.2 –ò–∑–º–µ–Ω–∏—Ç—å `/api/generate` (—Å—Ç—Ä–æ–∫–∞ 88-98)

**–ë–´–õ–û:**
```python
@app.post("/api/generate")
def generate_code(request, api_key_info: dict = Depends(get_api_key)):
    # –°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ –≤ API
    deduct_credits_atomic(api_key_info["id"], cost)  # ‚Üê api_key id
    save_generation(generation_id, api_key_info["id"], ...)  # ‚Üê api_key id
```

**–°–¢–ê–õ–û:**
```python
@app.post("/api/generate")
def generate_code(request, api_key_info: dict = Depends(get_api_key)):
    user_id = api_key_info["user_id"]  # ‚Üê –ü–æ–ª—É—á–∏—Ç—å user_id –∏–∑ key

    # –°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ –û–ë–©–£–Æ —Ñ—É–Ω–∫—Ü–∏—é (–∫–∞–∫ –≤ WEB)
    deduct_credits_user(user_id, cost)  # ‚Üê user_id, –Ω–µ api_key_id

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –û–ë–©–£–Æ –∏—Å—Ç–æ—Ä–∏—é (–∫–∞–∫ –≤ WEB)
    save_generation_to_history(generation_id, user_id, ...)  # ‚Üê user_id
```

#### 2.3 –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É api_generations (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞)

–ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –û–î–ù–ê –¥–ª—è WEB –∏ API:
```python
# –í–º–µ—Å—Ç–æ api_generations –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
# (TBD) –µ–¥–∏–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏, –¥–æ—Å—Ç—É–ø–Ω–∞—è –¥–ª—è WEB –∏ API
```

#### 2.4 –ò–∑–º–µ–Ω–∏—Ç—å `/api/limits` endpoint

**–ë–´–õ–û:**
```python
GET /api/limits
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {credits_total, credits_used, rate_limits}
# –≠—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ api_keys —Ç–∞–±–ª–∏—Ü—ã
```

**–°–¢–ê–õ–û:**
```python
GET /api/limits
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {credits: current_balance}
# –≠—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ users —Ç–∞–±–ª–∏—Ü—ã (–∫–∞–∫ –≤ WEB)

# –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç endpoint
# API –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å GET /api/billing/balance –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
```

---

### –§–ê–ó–ê 3: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ WEB UI

#### 3.1 –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/api`

**–ü–æ–∫–∞–∑–∞—Ç—å:**
- API key –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å copy –∫–Ω–æ–ø–∫–æ–π)
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (cURL, JS, Python)
- –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–£–ë–†–ê–¢–¨:**
- "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤" –∫–∞—Ä—Ç–æ—á–∫–∞ (—ç—Ç–æ –∏–∑ playground, –Ω–µ –∏–∑ API)
- "–õ–∏–º–∏—Ç—ã —Å–∫–æ—Ä–æ—Å—Ç–∏" –∫–∞—Ä—Ç–æ—á–∫–∞ (–Ω–µ –Ω—É–∂–Ω–æ –≤ API section)

---

## –ü–†–ò–û–†–ò–¢–ï–¢

üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô** (–±–ª–æ–∫–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ):
1. –î–æ–±–∞–≤–∏—Ç—å user_id –≤ api_keys
2. –ò–∑–º–µ–Ω–∏—Ç—å verify_api_key() –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å user_id
3. –ò–∑–º–µ–Ω–∏—Ç—å /api/generate –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user_id –¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞

üü° **–í–´–°–û–ö–ò–ô** (–Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å):
4. –£–¥–∞–ª–∏—Ç—å api_generations —Ç–∞–±–ª–∏—Ü—É
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
6. –ò—Å–ø—Ä–∞–≤–∏—Ç—å UI —Å—Ç—Ä–∞–Ω–∏—Ü—ã /api

üü¢ **–ù–ò–ó–ö–ò–ô** (nice to have):
7. –£–¥–∞–ª–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å /api/limits endpoint
8. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## –ü–†–û–í–ï–†–ö–ê (Test Plan)

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```
–¢–ï–°–¢ 1: WEB –∏ API –∏—Å–ø–æ–ª—å–∑—É—é—Ç –û–î–ò–ù –±–∞–ª–∞–Ω—Å
1. WEB –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç (–ø–ª–∞—Ç–∏—Ç 1 –∫—Ä–µ–¥–∏—Ç) ‚Üí –±–∞–ª–∞–Ω—Å 99
2. –¢–æ—Ç –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–µ—Ä–µ–∑ API –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ‚Üí –±–∞–ª–∞–Ω—Å 98
3. ‚úÖ PASS: –±–∞–ª–∞–Ω—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω

–¢–ï–°–¢ 2: API key —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è –≤ user_id
1. curl -H "X-API-Key: sk_..." /api/generate
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–¥ user_id, –Ω–µ api_key_id
3. ‚úÖ PASS: –∏—Å—Ç–æ—Ä–∏—è –æ–¥–Ω–∞ –¥–ª—è WEB –∏ API

–¢–ï–°–¢ 3: WEB –∏ API –≤–∏–¥—è—Ç –æ–¥–Ω—É –∏—Å—Ç–æ—Ä–∏—é
1. WEB –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
2. API –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ‚Üí –≤–∏–¥–Ω–æ –≤ WEB –∏—Å—Ç–æ—Ä–∏–∏
3. ‚úÖ PASS: –æ–¥–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –æ–±–æ–∏—Ö
```

---

## –§–ê–ô–õ–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø

```
BACKEND:
‚ñ° /backend/api/auth.py
  - –ò–∑–º–µ–Ω–∏—Ç—å verify_api_key() –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å user_id

‚ñ° /backend/api/routes/generate.py
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user_id –¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞
  - –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –æ–±—â—É—é –∏—Å—Ç–æ—Ä–∏—é

‚ñ° /backend/api/routes/stream.py
  - –ü—Ä–æ–≤–µ—Ä—è—Ç—å ownership –ø–æ user_id

‚ñ° /backend/api/credits.py
  - –£–¥–∞–ª–∏—Ç—å FORMAT_COSTS (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ 1)
  - –£–¥–∞–ª–∏—Ç—å api_keys —Ñ—É–Ω–∫—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å users)

‚ñ° /backend/api/generation_service.py
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user_id –≤–º–µ—Å—Ç–æ api_key_id

‚ñ° /backend/db/sqlite.py
  - –î–æ–±–∞–≤–∏—Ç—å user_id –≤ api_keys
  - –£–¥–∞–ª–∏—Ç—å api_generations —Ç–∞–±–ª–∏—Ü—É

FRONTEND:
‚ñ° /frontend/src/app/api/page.tsx
  - –ü–æ–∫–∞–∑–∞—Ç—å API key –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –£–±—Ä–∞—Ç—å "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤" –±–ª–æ–∫
  - –£–±—Ä–∞—Ç—å "–õ–∏–º–∏—Ç—ã —Å–∫–æ—Ä–æ—Å—Ç–∏" –±–ª–æ–∫
```

---

## –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´

‚úÖ **WEB Playground** ‚Äî –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
- –ë–∞–ª–∞–Ω—Å –≤ `users.credits`
- –°–ø–∏—Å–∞–Ω–∏–µ –≤ `/api/billing/deduct-credits` –ü–ï–†–ï–î –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
- –ò—Å—Ç–æ—Ä–∏—è –≤ localStorage (–ø–æ–∫–∞)
- –§–æ—Ä–º–∞—Ç —Å—Ç–æ–∏—Ç 1 –∫—Ä–µ–¥–∏—Ç

‚úÖ **API –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–ø–∏–µ–π** –ª–æ–≥–∏–∫–∏ WEB:
- –ë–∞–ª–∞–Ω—Å –∏–∑ `users.credits` (—á–µ—Ä–µ–∑ user_id)
- –°–ø–∏—Å–∞–Ω–∏–µ –≤ `deduct_credits_user(user_id, 1)` –ü–ï–†–ï–î –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
- –ò—Å—Ç–æ—Ä–∏—è –≤ –ë–î (–æ–¥–Ω–æ–π –¥–ª—è WEB –∏ API)
- –§–æ—Ä–º–∞—Ç —Å—Ç–æ–∏—Ç 1 –∫—Ä–µ–¥–∏—Ç

---

–≠—Ç–æ—Ç –ø–ª–∞–Ω –ø—Ä–∏–≤–æ–¥–∏—Ç API –≤ **–ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ** —Å WEB.
