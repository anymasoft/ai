# –ê–£–î–ò–¢ –°–û–ì–õ–ê–°–û–í–ê–ù–ù–û–°–¢–ò –õ–û–ì–ò–ö–ò –ì–ï–ù–ï–†–ê–¶–ò–ò: WEB vs API

**–î–∞—Ç–∞:** 2025-12-25
**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–£–î–ò–¢ (—Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
**–§–æ–∫—É—Å:** –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ª–æ–≥–∏–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –º–µ–∂–¥—É WEB-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ –ø—É–±–ª–∏—á–Ω—ã–º API

---

## –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ï –†–ï–ó–Æ–ú–ï

### ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø –ù–ê–ô–î–ï–ù–´

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|----------|--------|-----------|
| –°—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞–∑–Ω–∞—è (1 vs 2 –∫—Ä–µ–¥–∏—Ç–∞) | üî¥ –†–ê–°–•–û–î–ò–¢–°–Ø –° –ó–ê–î–ê–ß–ï–ô | –ë–õ–û–ö–ò–†–£–ï–¢ |
| Moment —Å–ø–∏—Å–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ —Ä–∞–∑–Ω—ã–µ | üü° –†–ê–ó–ù–´–ï –ú–ï–°–¢–ê | –í–´–°–û–ö–ò–ô |
| –õ–æ–≥–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–µ–∑–¥–µ | üî¥ –ü–û–¢–ï–†–Ø –î–ï–ù–ï–ì –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô | –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô |
| –ó–∞–ø–∏—Å–∏ –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è—Ö —Ç–æ–ª—å–∫–æ –≤ API | üü° –ê–°–ò–ú–ú–ï–¢–†–ò–Ø | –°–†–ï–î–ù–ò–ô |

**–í—ã–≤–æ–¥:** WEB –∏ API —Ä–∞–±–æ—Ç–∞—é—Ç –†–ê–ó–ù–û. –ù—É–∂–Ω–∞ —Å—Ä–æ—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.

---

---

## –ß–ê–°–¢–¨ A: –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ì–ï–ù–ï–†–ê–¶–ò–Ø –í WEB (Playground)

### –ü–æ—à–∞–≥–æ–≤—ã–π flow `/app/playground`

#### –®–ê–ì 0: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```
–§–∞–π–ª: /frontend/src/app/playground/page.tsx (—Å—Ç—Ä–æ–∫–∞ 38-81)

useState:
- credits: null | number (—Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å)
- selectedFormat: "html_tailwind" | "html_css" | "react_tailwind" | "vue_tailwind"
- isStreaming: boolean
- chunks: string[]

useEffect (—Å—Ç—Ä–æ–∫–∞ 64-81):
  fetchJSON("/api/billing/balance")
  ‚Üí setCredits(data.credits)
  ‚Üë –ó–∞–≥—Ä—É–∂–∞–µ—Ç –†–ï–ê–õ–¨–ù–´–ô –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

#### –®–ê–ì 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª "–°–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç"
```
–§—É–Ω–∫—Ü–∏—è: handleGenerate() (—Å—Ç—Ä–æ–∫–∞ 125-262)

–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- imageFile: File | null
- url: string | null
- selectedFormat: string
- instructions: string

–î–µ–π—Å—Ç–≤–∏—è (—Å—Ç—Ä–æ–∫–∞ 126-136):
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞:
   if (credits === null || credits === 0) {
     setShowPaywall(true)
     return
   }
   ‚Üë –ë–õ–û–ö–ò–†–£–ï–¢ –µ—Å–ª–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–µ—Ç

2. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–∞:
   if (!imageFile && !url) {
     setValidationError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –ª–∏–±–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ª–∏–±–æ URL")
     return
   }
```

#### –®–ê–ì 2: –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –°–ü–ò–°–ê–ù–ò–ï –ö–†–ï–î–ò–¢–û–í (–ö–†–ò–¢–ò–ß–ù–û!)
```
–°—Ç—Ä–æ–∫–∞ 143-175:

POST /api/billing/deduct-credits
{
  "format": "html_tailwind"
}

–û—Ç–≤–µ—Ç:
{
  "success": true,
  "credits_deducted": 1,
  "remaining_credits": 8764,
  "message": "–°–ø–∏—Å–∞–Ω–æ 1 –∫—Ä–µ–¥–∏—Ç. –û—Å—Ç–∞–ª–æ—Å—å: 8764"
}

–õ–æ–≥–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 144-175):
1. POST –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ü–ï–†–ï–î –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
2. –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ:
   - setCredits(newCredits)
   - toast.success("–°–ø–∏—Å–∞–Ω–æ 1 –∫—Ä–µ–¥–∏—Ç...")
   - –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 177)
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (402):
   - setIsStreaming(false)
   - return (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)
   - toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤")

‚ö†Ô∏è –í–ê–ñ–ù–û: Credits —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!
–ï—Å–ª–∏ –ø–æ—Ç–æ–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫—Ä–∞—Ö ‚Üí –∫—Ä–µ–¥–∏—Ç—ã –ø–æ—Ç–µ—Ä—è–Ω—ã –ë–ï–ó–í–û–ó–í–†–ê–¢–ù–û
```

#### –®–ê–ì 3: –ó–∞–ø—É—Å–∫ –õ–û–ö–ê–õ–¨–ù–û–ô –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```
–°—Ç—Ä–æ–∫–∞ 177-202:

const params: FullGenerationSettings = {
  generationType: "create",
  inputMode: imageFile ? "image" : "text",
  prompt: {
    text: instructions || "Generate code...",
    images: images  // data:image/png;base64,... –¥–ª—è —Ñ–∞–π–ª–æ–≤
  },
  generatedCodeConfig: selectedFormat,  // "html_tailwind" –∏ —Ç.–¥.
  codeGenerationModel: CodeGenerationModel.CLAUDE_4_5_SONNET_2025_09_29,
  isTermOfServiceAccepted: true,
  openAiApiKey: null,  // –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–ª—é—á–∏
  anthropicApiKey: null
}

generateCode(wsRef, params, callbacks)  // –õ–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è!
‚Üë –≠—Ç–æ –ù–ï –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ API /api/generate
‚Üë –≠—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω
```

#### –®–ê–ì 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–∞ (Streaming)
```
–°—Ç—Ä–æ–∫–∞ 204-259: Callbacks

const callbacks: CodeGenerationCallbacks = {
  onChange: (chunk) => {
    setChunks((prev) => [...prev, chunk])  // –î–æ–±–∞–≤–∏—Ç—å chunk
  },

  onSetCode: (code) => {
    setChunks([code])  // –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ chunks
  },

  onComplete: async () => {
    setIsStreaming(false)
    addHistoryItem({...})  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
    console.log("[CREDITS] Generation completed. Credits already deducted upfront.")
    // ‚Üë –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: credits —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã
  },

  onVariantError: (variantIndex, error) => {
    setError(error)
    setIsStreaming(false)
    // ‚Üë –ù–∞ –æ—à–∏–±–∫–µ: credits –£–ñ–ï –ø–æ—Ç–µ—Ä—è–Ω—ã
  },

  onVariantComplete: () => {
    console.log("Variant complete")
  }
}
```

#### –®–ê–ì 5: –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
```
–°—Ç—Ä–æ–∫–∞ 565-650:

–ö–æ–≥–¥–∞ chunks.length > 0:
- Tab "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä": live iframe —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º HTML
- Tab "–ö–æ–¥": –∫–æ–¥ —Å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º, –∫–Ω–æ–ø–∫–∏ Copy/Download
- –ü–æ–∫–∞–∑–∞—Ç—å: "–ü–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã: -1"

–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (onVariantError):
- –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Å–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º –æ—à–∏–±–∫–∏
- Credits –£–ñ–ï —Å–ø–∏—Å–∞–Ω—ã (–Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞)
```

#### –®–ê–ì 6: –§–∏–Ω–∏—à
```
–°—Ç—Ä–æ–∫–∞ 231-258:

onComplete():
  - addHistoryItem({
      sourceType: "image" | "url",
      sourceLabel: filename –∏–ª–∏ –¥–æ–º–µ–Ω,
      instructions: user_text,
      result: –∫–æ–¥,
      format: selectedFormat
    })
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage

Credits –æ—Å—Ç–∞—é—Ç—Å—è —Å–ø–∏—Å–∞–Ω–Ω—ã–º–∏ –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
```

### –†–µ–∑—é–º–µ WEB

| –≠—Ç–∞–ø | –î–µ–π—Å—Ç–≤–∏–µ | –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º–æ—Å—Ç—å |
|------|----------|--------------|
| –ö–ª–∏–∫ –∫–Ω–æ–ø–∫–∏ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ | ‚úÖ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞) |
| –î–û –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | POST /api/billing/deduct-credits | ‚ùå (—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ) |
| –í–æ –≤—Ä–µ–º—è | Streaming chunks –≤ UI | ‚úÖ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è) |
| –û—à–∏–±–∫–∞ | generation.status = error | ‚ùå (credits –ø–æ—Ç–µ—Ä—è–Ω—ã) |
| –ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ | addHistoryItem() | ‚úÖ (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å) |

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ:** 1 –∫–ª–∏–∫ = 1 –∫—Ä–µ–¥–∏—Ç —Å–ø–∏—Å–∞–Ω, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

---

---

## –ß–ê–°–¢–¨ B: –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ì–ï–ù–ï–†–ê–¶–ò–Ø –í API

### –ü–æ—à–∞–≥–æ–≤—ã–π flow –ø—É–±–ª–∏—á–Ω–æ–≥–æ API

#### –®–ê–ì 1: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST /api/generate
```
–§–∞–π–ª: /backend/api/routes/generate.py (—Å—Ç—Ä–æ–∫–∞ 59-160)

–ö–ª–∏–µ–Ω—Ç:
POST https://api.example.com/api/generate
Headers: {
  "X-API-Key": "sk_live_xxxxxx",
  "Content-Type": "application/json"
}
Body: {
  "input": {
    "type": "url" | "image",
    "data": "https://example.com" | "data:image/png;base64,..."
  },
  "format": "html_tailwind" | "html_css" | "react_tailwind" | "vue_tailwind",
  "instructions": "optional text"
}
```

#### –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ tier –¥–æ—Å—Ç—É–ø–∞
```
–°—Ç—Ä–æ–∫–∞ 77-86:

tier = api_key_info["tier"]  // "free" | "pro"

if request.format in ["react_tailwind", "vue_tailwind"] and tier != "pro":
    raise HTTPException(403, {
        "error": "forbidden",
        "message": "Format 'react_tailwind' requires 'pro' tier"
    })

‚Üë –ë–ª–æ–∫–∏—Ä—É–µ—Ç React/Vue –¥–ª—è free tier
‚Üë –ï—Å—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ tier (–≤ WEB —Ç–∞–∫–æ–≥–æ –Ω–µ—Ç)
```

#### –®–ê–ì 3: –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
```
–°—Ç—Ä–æ–∫–∞ 88-89:

cost = get_format_cost(request.format)

–ò–∑ /backend/api/credits.py (—Å—Ç—Ä–æ–∫–∞ 8-18):

FORMAT_COSTS = {
    "html_tailwind": 1,      ‚Üê 1 –∫—Ä–µ–¥–∏—Ç
    "html_css": 1,           ‚Üê 1 –∫—Ä–µ–¥–∏—Ç
    "react_tailwind": 2,     ‚Üê 2 –∫—Ä–µ–¥–∏—Ç–∞
    "vue_tailwind": 2,       ‚Üê 2 –∫—Ä–µ–¥–∏—Ç–∞
}

return FORMAT_COSTS.get(format, 1)

‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞!
   React/Vue = 2 –∫—Ä–µ–¥–∏—Ç–∞
   HTML = 1 –∫—Ä–µ–¥–∏—Ç

   –ù–æ –≤ –∑–∞–¥–∞—á–µ —Å–∫–∞–∑–∞–Ω–æ:
   "1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 1 –∫—Ä–µ–¥–∏—Ç, —Ñ–æ—Ä–º–∞—Ç –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å"
```

#### –®–ê–ì 4: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ID (–î–û —Å–ø–∏—Å–∞–Ω–∏—è)
```
–°—Ç—Ä–æ–∫–∞ 91-92:

generation_id = create_generation_id()  # "gen_" + uuid16

def create_generation_id() -> str:
    return f"gen_{uuid.uuid4().hex[:16]}"

‚Üë ID —Å–æ–∑–¥–∞–µ—Ç—Å—è –ü–ï–†–ï–î —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
‚Üë –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
```

#### –®–ê–ì 5: –ê–¢–û–ú–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –°–ü–ò–°–ê–ù–ò–ï –ö–†–ï–î–ò–¢–û–í
```
–°—Ç—Ä–æ–∫–∞ 94-98:

deduct_credits_atomic(api_key_id, cost)

–ò–∑ /backend/api/credits.py (—Å—Ç—Ä–æ–∫–∞ 21-86):

UPDATE api_keys
SET credits_used = credits_used + ?
WHERE id = ? AND (credits_total - credits_used) >= ?

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: (cost, api_key_id, cost)

–õ–æ–≥–∏–∫–∞:
1. –í –û–î –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
   (credits_total - credits_used) >= cost?

2. –ï—Å–ª–∏ –î–ê:
   - –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç credits_used –Ω–∞ cost
   - cursor.rowcount = 1 (—É—Å–ø–µ—Ö)

3. –ï—Å–ª–∏ –ù–ï–¢:
   - –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç
   - cursor.rowcount = 0 (fail)

–ï—Å–ª–∏ rowcount == 0 (—Å—Ç—Ä–æ–∫–∞ 53-83):
   - –î–µ–ª–∞–µ—Ç SELECT –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   - –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω:
     ‚Üí 404 Not Found (–∫—Ä–µ–¥–∏—Ç—ã –Ω–µ —Å–ø–∏—Å–∞–Ω—ã)
   - –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤:
     ‚Üí 402 Payment Required (–∫—Ä–µ–¥–∏—Ç—ã –Ω–µ —Å–ø–∏—Å–∞–Ω—ã)

‚ö†Ô∏è –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∑–¥–µ—Å—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 402 ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ù–ï –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
          –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None (–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç)
```

#### –®–ê–ì 6: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```
–°—Ç—Ä–æ–∫–∞ 100-101:

save_generation(generation_id, api_key_id, request, cost)

–ò–∑ generate.py (—Å—Ç—Ä–æ–∫–∞ 21-56):

INSERT INTO api_generations (
    id, api_key_id, status, format, input_type, input_data,
    input_thumbnail, instructions, credits_charged, created_at
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)

–ó–Ω–∞—á–µ–Ω–∏—è:
- status = "processing"
- credits_charged = cost  (1 –∏–ª–∏ 2)
- created_at = datetime.utcnow()

‚ö†Ô∏è –ù–∞ —ç—Ç–æ–º –º–æ–º–µ–Ω—Ç–µ:
   - Generation –°–£–©–ï–°–¢–í–£–ï–¢ –≤ –ë–î
   - Credits –£–ñ–ï —Å–ø–∏—Å–∞–Ω—ã
   - –ï—Å–ª–∏ –∑–¥–µ—Å—å –∫—Ä–∞—Ö ‚Üí credits –ø–æ—Ç–µ—Ä—è–Ω—ã
```

#### –®–ê–ì 7: –ó–∞–ø—É—Å–∫ –§–û–ù–û–í–û–ô –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```
–°—Ç—Ä–æ–∫–∞ 103-127:

task = asyncio.create_task(trigger_generation(generation_id))

def handle_generation_error(task_obj):
    try:
        task_obj.result()
    except Exception as e:
        logger.error(f"Unexpected error: {e}")

task.add_done_callback(handle_generation_error)

‚Üë trigger_generation() –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ê–°–ò–ù–•–†–û–ù–ù–û
‚Üë –ï—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç HTTP response
‚Üë –ï—Å–ª–∏ —É–ø–∞–¥–µ—Ç ‚Üí callback –∑–∞–ª–æ–≥–∏—Ä—É–µ—Ç, –Ω–æ credits –£–ñ–ï —Å–ø–∏—Å–∞–Ω—ã

–ò–∑ /backend/api/generation_service.py (—Å—Ç—Ä–æ–∫–∞ 135-233):

async def trigger_generation(generation_id: str):
    try:
        # 1. –ß–∏—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –ë–î
        cursor.execute("""
            SELECT format, input_type, input_data, instructions
            FROM api_generations
            WHERE id = ?
        """, (generation_id,))

        # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        params = {
            "generatedCodeConfig": format_type,
            "inputMode": input_type,
            ...
        }

        # 3. –°–æ–∑–¥–∞–µ—Ç mock WebSocket
        mock_websocket = DatabaseWebSocket(generation_id)

        # 4. Enqueue –≤ –æ—á–µ—Ä–µ–¥—å
        job = GenerationJob(...)
        await enqueue_generation(job)

    except Exception as e:
        # –ï—Å–ª–∏ –õ–Æ–ë–ê–Ø –æ—à–∏–±–∫–∞ ‚Üí mark as failed
        logger.error(f"Error triggering generation: {e}")
        UPDATE api_generations
        SET status = 'failed', error_message = ?
        WHERE id = ?
```

#### –®–ê–ì 8: –í–æ–∑–≤—Ä–∞—Ç stream_url –∫–ª–∏–µ–Ω—Ç—É
```
–°—Ç—Ä–æ–∫–∞ 154-159:

return GenerateResponse(
    generation_id=generation_id,
    status="processing",
    credits_charged=cost,  # –°–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–Ω–æ
    stream_url=stream_url
)

HTTP 201 Created:
{
  "generation_id": "gen_abc123",
  "status": "processing",
  "credits_charged": 1,
  "stream_url": "wss://api.example.com/api/stream/gen_abc123"
}

‚ö†Ô∏è –ù–∞ —ç—Ç–æ–º –º–æ–º–µ–Ω—Ç–µ:
   - Credits –£groot–∂–µ —Å–ø–∏—Å–∞–Ω—ã
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ —Ñ–æ–Ω–æ–º
   - –ö–ª–∏–µ–Ω—Ç –ú–û–ñ–ï–¢ –ø–æ—Ç–µ—Ä—è—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
   - –ù–æ stream_url –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ –¥–ª—è reconnect
```

#### –®–ê–ì 9: –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket
```
–§–∞–π–ª: /backend/api/routes/stream.py (—Å—Ç—Ä–æ–∫–∞ 13-233)

–ö–ª–∏–µ–Ω—Ç:
new WebSocket(stream_url + "?api_key=sk_live_xxxxx")

–°–µ—Ä–≤–µ—Ä (—Å—Ç—Ä–æ–∫–∞ 13-68):

1. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç API key:
   if not api_key:
       await websocket.close(code=1008, reason="API key required")
   ‚Üë –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞

2. –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–ª—é—á:
   api_key_info = verify_api_key(api_key)
   ‚Üë –ï—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π ‚Üí close

3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç ownership:
   cursor.execute("""
       SELECT id, status FROM api_generations
       WHERE id = ? AND api_key_id = ?
   """, (generation_id, api_key_info["id"]))
   ‚Üë –≠—Ç–æ generation –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ–º—É –∫–ª—é—á—É?

4. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:
   await websocket.accept()
```

#### –®–ê–ì 10: Streaming —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
```
–°—Ç—Ä–æ–∫–∞ 79-129:

generation_status = row[1]

if generation_status in ("completed", "failed"):
    if status == "completed":
        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ chunks —Å—Ä–∞–∑—É
        cursor.execute("""
            SELECT chunk_index, chunk_data
            FROM api_generation_chunks
            WHERE generation_id = ?
            ORDER BY chunk_index ASC
        """, (generation_id,))

        for chunk_index, chunk_data in chunks:
            await websocket.send_json({
                "type": "chunk",
                "data": chunk_data,
                "variant_index": 0
            })

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å completion
        await websocket.send_json({
            "type": "variant_complete",
            "variant_index": 0
        })

        await websocket.close(code=1000)
        return

    elif status == "failed":
        await websocket.send_json({
            "type": "error",
            "error": "generation_failed",
            "message": error_message,
            "variant_index": 0
        })
        await websocket.close(code=1011)
```

#### –®–ê–ì 11: Polling –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```
–°—Ç—Ä–æ–∫–∞ 131-205:

last_chunk_index = -1
poll_count = 0
max_polls = 1200  # 10 –º–∏–Ω—É—Ç –ø–æ 0.5 —Å–µ–∫

while poll_count < max_polls:
    poll_count += 1

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
    cursor.execute("""
        SELECT error_message, status
        FROM api_generations
        WHERE id = ?
    """, (generation_id,))

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ chunks
    cursor.execute("""
        SELECT chunk_index, chunk_data
        FROM api_generation_chunks
        WHERE generation_id = ? AND chunk_index > ?
        ORDER BY chunk_index ASC
    """, (generation_id, last_chunk_index))

    for chunk_index, chunk_data in chunks:
        await websocket.send_json({
            "type": "chunk",
            "data": chunk_data,
            "variant_index": 0
        })
        last_chunk_index = chunk_index

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    if status == "completed":
        await websocket.send_json({...})
        await websocket.close(code=1000)
        return

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å–ª–∏ failed
    if status == "failed":
        await websocket.send_json({...})
        await websocket.close(code=1011)
        return

    # –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º poll
    await asyncio.sleep(0.5)

# Timeout –ø–æ—Å–ª–µ 10 –º–∏–Ω—É—Ç
await websocket.send_json({
    "type": "error",
    "error": "generation_timeout",
    "message": "Generation took too long (10 minute timeout)",
    "variant_index": 0
})
await websocket.close(code=1011)
```

#### –®–ê–ì 12: Reconnect –±–µ–∑ –¥—É–±–ª–µ–π
```
‚ö†Ô∏è –ö–ª—é—á–µ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º: chunk_index

–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:
- –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª—É—á–µ–Ω–Ω—ã–π chunk_index –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è
- –ü—Ä–∏ reconnect: last_chunk_index = -1 (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –Ω—É–ª—è)
- Query: WHERE chunk_index > last_chunk_index
- –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º: no duplicates on reconnect

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø –∏–∑ STEP 5 –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞—É–¥–∏—Ç–∞.
```

#### –®–ê–ì 13: –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
```
–ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç:
GET /api/generations/{generation_id}

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
{
  "id": "gen_abc123",
  "status": "completed" | "failed" | "processing",
  "format": "html_tailwind",
  "input_type": "url",
  "input_data": "https://example.com",
  "instructions": "optional",
  "result_code": null –∏–ª–∏ HTML –∫–æ–¥,  // —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ
  "credits_charged": 1,
  "error_message": null –∏–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏,
  "created_at": "2025-12-25T12:34:56",
  "completed_at": "2025-12-25T12:35:10"
}
```

### –†–µ–∑—é–º–µ API

| –≠—Ç–∞–ø | –î–µ–π—Å—Ç–≤–∏–µ | –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º–æ—Å—Ç—å |
|------|----------|--------------|
| POST /api/generate | –ü—Ä–æ–≤–µ—Ä–∫–∞ tier | ‚úÖ (–µ—Å–ª–∏ fail ‚Üí 403, –Ω–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è) |
| –†–∞—Å—á–µ—Ç cost | –°—Ç–æ–∏–º–æ—Å—Ç—å = FORMAT_COSTS | ‚úÖ (–ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç) |
| deduct_credits_atomic() | –ü—Ä–æ–≤–µ—Ä–∫–∞ + —Å–ø–∏—Å–∞–Ω–∏–µ | ‚ùå (–µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ) |
| –ï—Å–ª–∏ 402 | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ | ‚úÖ (–Ω–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è) |
| INSERT api_generations | –ó–∞–ø–∏—Å—å –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | ‚ùå (—É–∂–µ —Å credits_charged) |
| asyncio.create_task() | –§–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è | ‚ùå (–µ—Å–ª–∏ —É–ø–∞–¥–µ—Ç ‚Üí –ë–î updated) |
| HTTP 201 | –í–æ–∑–≤—Ä–∞—Ç stream_url | ‚ùå (credits —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã) |
| WS /api/stream/:id | Streaming chunks | ‚úÖ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è) |
| –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | status = "failed" | ‚ùå (credits –ø–æ—Ç–µ—Ä—è–Ω—ã) |

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ:** 1 POST = cost –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å–ø–∏—Å–∞–Ω–æ, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

---

---

## –ß–ê–°–¢–¨ C: –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï)

### 1Ô∏è‚É£ –õ–û–ì–ò–ß–ï–°–ö–ò–ï –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ A: –°—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ —Ñ–æ—Ä–º–∞—Ç—É

| –ü–∞—Ä–∞–º–µ—Ç—Ä | WEB (/api/billing/deduct-credits) | API (/api/generate) | –ó–∞–¥–∞—á–∞ | –ü—Ä–æ–±–ª–µ–º–∞ |
|----------|-----------------------------------|---------------------|--------|----------|
| html_tailwind | 1 –∫—Ä–µ–¥–∏—Ç | 1 –∫—Ä–µ–¥–∏—Ç | 1 –∫—Ä–µ–¥–∏—Ç | ‚úÖ OK |
| html_css | 1 –∫—Ä–µ–¥–∏—Ç | 1 –∫—Ä–µ–¥–∏—Ç | 1 –∫—Ä–µ–¥–∏—Ç | ‚úÖ OK |
| react_tailwind | 2 –∫—Ä–µ–¥–∏—Ç–∞ | 2 –∫—Ä–µ–¥–∏—Ç–∞ | 1 –∫—Ä–µ–¥–∏—Ç | üî¥ –†–ê–°–•–û–î–ò–¢–°–Ø |
| vue_tailwind | 2 –∫—Ä–µ–¥–∏—Ç–∞ | 2 –∫—Ä–µ–¥–∏—Ç–∞ | 1 –∫—Ä–µ–¥–∏—Ç | üî¥ –†–ê–°–•–û–î–ò–¢–°–Ø |

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–í –∑–∞–¥–∞—á–µ —á–µ—Ç–∫–æ —Å–∫–∞–∑–∞–Ω–æ:
"1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 1 –∫—Ä–µ–¥–∏—Ç
—Ñ–æ—Ä–º–∞—Ç (HTML / React / Vue) –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å
–ª—é–±–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–æ–≤–Ω–æ 1 credit"

–ù–æ –≤ –∫–æ–¥–µ:
- FORMAT_COSTS –≤ credits.py: React/Vue = 2 –∫—Ä–µ–¥–∏—Ç–∞
- WEB endpoint /api/billing/deduct-credits: React/Vue = 2 –∫—Ä–µ–¥–∏—Ç–∞
- API endpoint /api/generate: React/Vue = 2 –∫—Ä–µ–¥–∏—Ç–∞

–í–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ù–û –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
```

**–õ–æ–∫–∞—Ü–∏—è –æ—à–∏–±–∫–∏:**
- `/backend/api/credits.py` —Å—Ç—Ä–æ–∫–∞ 8-18 (FORMAT_COSTS)
- `/backend/api/routes/billing.py` —Å—Ç—Ä–æ–∫–∞ 433-438 (format_costs –ª–æ–∫–∞–ª—å–Ω–æ)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ (—Ç–æ –µ—Å—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–µ)

---

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ B: –ú–æ–º–µ–Ω—Ç —Å–ø–∏—Å–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | WEB | API | –ü—Ä–æ–±–ª–µ–º–∞ |
|----------|-----|-----|----------|
| **–ö–æ–≥–¥–∞ —Å–ø–∏—Å—ã–≤–∞—Ç—å** | –ü–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π | –ü–µ—Ä–µ–¥ —Ñ–æ–Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π | ‚úÖ OK (–æ–¥–∏–Ω–∞–∫–æ–≤–æ) |
| **–ù–∞ –∫–∞–∫–æ–º endpoint** | /api/billing/deduct-credits | /api/generate | üü° –†–ê–ó–ù–´–ï –ú–ï–°–¢–ê |
| **–Ø–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞** | –î–ê (–ø–µ—Ä–µ–¥ POST) | –î–ê (atomically) | ‚úÖ OK |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ 402** | –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é | –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É | ‚úÖ OK |

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
WEB: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–≤–∞–∂–¥—ã:
  1. –í UI: if (credits === 0) ‚Üí setShowPaywall()
  2. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: POST /api/billing/deduct-credits ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤ deduct_credits()

API: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å—Å–∞ –û–î–ò–ù —Ä–∞–∑:
  1. –í deduct_credits_atomic() (atomic check+deduct)

–†–ê–ó–ù–´–ï –ú–ï–°–¢–ê –°–ü–ò–°–ê–ù–ò–Ø:
- WEB: /api/billing/deduct-credits (–≤ billing endpoint, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å users table)
- API: /api/generate ‚Üí deduct_credits_atomic() (–≤ api endpoint, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å api_keys table)

–≠–¢–û –†–ê–ó–ù–´–ï –¢–ê–ë–õ–ò–¶–´!
- users —Ç–∞–±–ª–∏—Ü–∞ (–¥–ª—è WEB –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- api_keys —Ç–∞–±–ª–∏—Ü–∞ (–¥–ª—è API –∫–ª–∏–µ–Ω—Ç–æ–≤)

–†–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –±–∏–ª–ª–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–¥–µ–ª—å–Ω–æ!
```

**–õ–æ–∫–∞—Ü–∏—è:**
- WEB: `/backend/api/routes/billing.py` —Å—Ç—Ä–æ–∫–∞ 396-471
- API: `/backend/api/routes/generate.py` —Å—Ç—Ä–æ–∫–∞ 88-98 + `/backend/api/credits.py` —Å—Ç—Ä–æ–∫–∞ 21-86

---

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ C: –ó–∞–ø–∏—Å—å –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | WEB | API | –ü—Ä–æ–±–ª–µ–º–∞ |
|----------|-----|-----|----------|
| **–°–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –ë–î** | –ù–ï–¢ (—Ç–æ–ª—å–∫–æ –≤ localStorage) | –î–ê (api_generations table) | üü° –ê–°–ò–ú–ú–ï–¢–†–ò–Ø |
| **–ï—Å—Ç—å –ª–∏ –∏—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π** | –î–ê –≤ localStorage (–∫–ª–∏–µ–Ω—Ç) | –î–ê –≤ api_generations (—Å–µ—Ä–≤–µ—Ä) | üü° –†–ê–ó–ù–´–ï –ú–ï–°–¢–ê |
| **–¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏** | –ù–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ | api_generations | üî¥ –ê–°–ò–ú–ú–ï–¢–†–ò–Ø |
| **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é** | –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–Ω–∏—Ç | /api/generations/:id | üü° –†–ê–ó–ù–û–ï |

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
WEB –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¢–û–õ–¨–ö–û –ª–æ–∫–∞–ª—å–Ω–æ –≤ localStorage
- –ò—Å—Ç–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ API
- –ï—Å–ª–∏ browser cache –æ—á–∏—â–µ–Ω–∞ ‚Üí –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞

API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ api_generations table
- –î–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ GET /api/generations/:id
- –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –æ—à–∏–±–∫–∏

–ü–†–û–ë–õ–ï–ú–ê: WEB –∏ API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ù–ï –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞!
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å WEB –Ω–µ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é API –≥–µ–Ω–µ—Ä–∞—Ü–∏–π.
API –∫–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é WEB –≥–µ–Ω–µ—Ä–∞—Ü–∏–π.
```

**–õ–æ–∫–∞—Ü–∏—è:**
- WEB: `/frontend/src/app/playground/page.tsx` —Å—Ç—Ä–æ–∫–∞ 244-251 (addHistoryItem –≤ localStorage)
- API: `/backend/api/routes/generate.py` —Å—Ç—Ä–æ–∫–∞ 100-101 (save_generation –≤ –ë–î)

---

### 2Ô∏è‚É£ –ö–û–ù–¢–†–ê–ö–¢–ù–´–ï –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ D: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å

**WEB endpoint `/api/billing/deduct-credits`:**
```json
{
  "success": true,
  "credits_deducted": 1,
  "remaining_credits": 8764,
  "message": "–°–ø–∏—Å–∞–Ω–æ 1 –∫—Ä–µ–¥–∏—Ç. –û—Å—Ç–∞–ª–æ—Å—å: 8764"
}
```

**API endpoint `POST /api/generate`:**
```json
{
  "generation_id": "gen_abc123",
  "status": "processing",
  "credits_charged": 1,
  "stream_url": "wss://..."
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–≠—Ç–æ —Å–æ–≤—Å–µ–º –†–ê–ó–ù–´–ï –æ—Ç–≤–µ—Ç—ã!

WEB deduct-credits:
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ ("remaining_credits")
- –ù–µ—Ç generation_id
- –ù–µ—Ç stream_url
- –ü—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ—Ç —á—Ç–æ —Å–ø–∏—Å–∞–Ω–æ

API generate:
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç generation_id –∏ stream_url
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–Ω–æ ("credits_charged")
- –ù–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ
- –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–∞–º –≤—ã–∑–≤–∞—Ç—å /api/limits –µ—Å–ª–∏ —Ö–æ—á–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫

–û–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:
- deduct-credits: –≥–æ—Ç–æ–≤–∏—Ç –¥–µ–Ω—å–≥–∏ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (WEB)
- generate: –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç stream_url (API)
```

---

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ E: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**WEB `/api/billing/deduct-credits` –Ω–∞ 402:**
```json
{
  "error": "insufficient_credits",
  "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤. –£ –≤–∞—Å 0, —Ç—Ä–µ–±—É–µ—Ç—Å—è 1.",
  "current_credits": 0,
  "required_credits": 1
}
```

**API `/api/generate` –Ω–∞ 402:**
```json
{
  "error": "insufficient_credits",
  "message": "Required: 1, Available: 0"
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
WEB –æ—à–∏–±–∫–∞: –ë–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º
API –æ—à–∏–±–∫–∞: –ë–æ–ª–µ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è, –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º

WEB: "–£ –≤–∞—Å 0, —Ç—Ä–µ–±—É–µ—Ç—Å—è 1"
API: "Required: 1, Available: 0"

–≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ —Ä–∞–∑–Ω—ã–π UX/DX.
```

---

### 3Ô∏è‚É£ BILLING / CREDITS –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ F: –í–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ

| –°—Ü–µ–Ω–∞—Ä–∏–π | WEB | API | –ü—Ä–æ–±–ª–µ–º–∞ |
|----------|-----|-----|----------|
| **–£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã (–û–ö) | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã (–û–ö) | ‚úÖ OK |
| **–û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è streaming** | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | üî¥ –ü–û–¢–ï–†–Ø –î–ï–ù–ï–ì |
| **Timeout (10 –º–∏–Ω)** | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | üî¥ –ü–û–¢–ï–†–Ø –î–ï–ù–ï–ì |
| **Server crash –ø–æ—Å–ª–µ deduct** | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | üî¥ –ü–û–¢–ï–†–Ø –î–ï–ù–ï–ì |
| **User cancels generation** | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | Credits –ø–æ—Ç–µ—Ä—è–Ω—ã ‚ùå | üî¥ –ü–û–¢–ï–†–Ø –î–ï–ù–ï–ì |

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤!

–°—Ü–µ–Ω–∞—Ä–∏–π: WEB –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç React –∫–æ–¥ (2 –∫—Ä–µ–¥–∏—Ç–∞)
1. POST /api/billing/deduct-credits ‚Üí —É—Å–ø–µ—à–Ω–æ (2 –∫—Ä–µ–¥–∏—Ç–∞ —Å–ø–∏—Å–∞–Ω–æ)
2. generateCode() –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å
3. –ù–∞ 50% –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚Üí –∫—Ä–∞—Ö –º–æ–¥–µ–ª–∏
4. onVariantError() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É: "Model failed"
6. –†–ï–ó–£–õ–¨–¢–ê–¢: 2 –∫—Ä–µ–¥–∏—Ç–∞ –ø–æ—Ç–µ—Ä—è–Ω—ã + –∫–æ–¥ –Ω–µ –ø–æ–ª—É—á–µ–Ω

–î—Ä—É–≥–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π: API –∫–ª–∏–µ–Ω—Ç
1. POST /api/generate ‚Üí —É—Å–ø–µ—à–Ω–æ (cost –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å–ø–∏—Å–∞–Ω–æ)
2. –§–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞
3. –ú–æ–¥–µ–ª—å —É–ø–∞–ª–∞, trigger_generation() –≤—ã–±—Ä–æ—Å–∏–ª Exception
4. generation.status = "failed", error_message = "..."
5. WS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç error —Å–æ–æ–±—â–µ–Ω–∏–µ
6. –†–ï–ó–£–õ–¨–¢–ê–¢: cost –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ—Ç–µ—Ä—è–Ω—ã + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è failed

–í –û–ë–û–ò–• –°–õ–£–ß–ê–Ø–•: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–µ—Ç –¥–µ–Ω—å–≥–∏ –∑–∞ –Ω–µ—É–¥–∞—á–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é!

–ù–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ refund.
```

**–õ–æ–∫–∞—Ü–∏—è:**
- –ù–µ—Ç –∫–æ–¥–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∏–≥–¥–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ
- –≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, —Ç—Ä–µ–±—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

---

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ G: –¢–∞–±–ª–∏—Ü—ã –±–∏–ª–ª–∏–Ω–≥–∞ –†–ê–ó–ù–´–ï

**WEB –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç–∞–±–ª–∏—Ü–∞ `users`):**
```
users —Ç–∞–±–ª–∏—Ü–∞:
- id
- email
- credits  ‚Üê –±–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤
- used_generations ‚Üê —Å—á–µ—Ç—á–∏–∫
- ...
```

**API –∫–ª–∏–µ–Ω—Ç—ã (—Ç–∞–±–ª–∏—Ü–∞ `api_keys`):**
```
api_keys —Ç–∞–±–ª–∏—Ü–∞:
- id
- key (sha256 hash)
- credits_total  ‚Üê –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∫—É–ø–ª–µ–Ω–æ
- credits_used   ‚Üê –ø–æ—Ç—Ä–∞—á–µ–Ω–æ
- tier ‚Üê "free" | "pro"
- created_at
- ...
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–≠—Ç–æ –†–ê–ó–ù–´–ï —Å–∏—Å—Ç–µ–º—ã –±–∏–ª–ª–∏–Ω–≥–∞!

WEB: credits –≤ users —Ç–∞–±–ª–∏—Ü–µ
     –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑: /api/billing/checkout, /api/billing/status
     –ü–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è: —á–µ—Ä–µ–∑ YooKassa –ø–ª–∞—Ç–µ–∂–∏

API: credits_total - credits_used –≤ api_keys —Ç–∞–±–ª–∏—Ü–µ
     –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑: API admin panel (–Ω–µ –≤–∏–¥–Ω–æ –≤ –∫–æ–¥–µ)
     –ü–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è: ???? (–Ω–µ—è—Å–Ω–æ –∫–∞–∫)

WEB –∏ API –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –û–¢–î–ï–õ–¨–ù–´–ï!
–û–¥–∏–Ω WEB –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API –∫–ª—é—á–∏.
–û–¥–∏–Ω API –∫–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WEB –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

–†–ê–ó–ù–´–ï –ú–û–î–ï–õ–ò –ë–ò–õ–õ–ò–ù–ì–ê –î–õ–Ø –†–ê–ó–ù–´–• –°–ò–°–¢–ï–ú.
```

---

### 4Ô∏è‚É£ UX-–†–ê–°–•–û–ñ–î–ï–ù–ò–Ø

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ H: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

**WEB:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
- "–û—Å—Ç–∞–ª–æ—Å—å: 8,765 –∫—Ä–µ–¥–∏—Ç–æ–≤" (–ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π)
- –í—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç (html/react/vue)
- –ü–æ—Å–ª–µ: "–ü–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã: -1" –∏–ª–∏ "-2"
- –Ø—Å–Ω–æ –≤–∏–¥–∏—Ç —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```

**API:**
```
–ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç:
- POST /api/generate –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç "format"
- –û—Ç–≤–µ—Ç: {"credits_charged": 1}
- –î–æ–ª–∂–µ–Ω –≤—ã–∑–≤–∞—Ç—å GET /api/limits —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫
- –ò–ª–∏ –∑–∞–ø–æ–º–Ω–∏—Ç—å —Å–∞–º
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
WEB: –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ –∏ –ø–æ—Å–ª–µ
API: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω—É–∂–Ω–æ –¥–æ–¥—É–º—ã–≤–∞—Ç—å
```

---

#### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ I: –í–∏–¥–∏–º–æ—Å—Ç—å –æ—à–∏–±–æ–∫

**WEB:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
- –ö—Ä–∞—Å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –æ—à–∏–±–∫–æ–π –≤ UI
- –ú–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ
- –ù–æ –ü–û–ß–ï–ú–£ –ø—Ä–æ–∏–∑–æ—à–ª–æ - –Ω–µ—è—Å–Ω–æ (—á–∞—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ "error")
```

**API:**
```
–ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç:
- WS —Å–æ–æ–±—â–µ–Ω–∏–µ: {
    "type": "error",
    "error": "generation_failed",
    "message": "...",
    "variant_index": 0
  }
- –ò–ª–∏: {
    "type": "error",
    "error": "generation_timeout",
    "message": "Generation took too long (10 minute timeout)"
  }
- –ú–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
WEB: –ß–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º–æ, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ
API: –ú–∞—à–∏–Ω–æ-—á–∏—Ç–∞–µ–º–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ

–ù–æ —ç—Ç–æ –Ω–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏.
```

---

### üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –†–ê–°–•–û–ñ–î–ï–ù–ò–ô

| # | –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---|-----------|-----------|--------|-----------|
| A | –õ–æ–≥–∏–∫–∞ | –°—Ç–æ–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞ (2 –∫—Ä–µ–¥–∏—Ç–∞ –≤–º–µ—Å—Ç–æ 1) | üî¥ –†–ê–°–•–û–î–ò–¢–°–Ø –° –ó–ê–î–ê–ß–ï–ô | –ë–õ–û–ö–ò–†–£–ï–¢ |
| B | –õ–æ–≥–∏–∫–∞ | –ú–æ–º–µ–Ω—Ç —Å–ø–∏—Å–∞–Ω–∏—è (—Ä–∞–∑–Ω—ã–µ endpoints) | üü° –†–ê–ó–ù–´–ï –ú–ï–°–¢–ê, –û–ö –õ–û–ì–ò–ß–ï–°–ö–ò | –í–´–°–û–ö–ò–ô |
| C | –õ–æ–≥–∏–∫–∞ | –ó–∞–ø–∏—Å—å –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Ä–∞–∑–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã) | üü° –ê–°–ò–ú–ú–ï–¢–†–ò–Ø | –°–†–ï–î–ù–ò–ô |
| D | –ö–æ–Ω—Ç—Ä–∞–∫—Ç | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å | üü° –†–ê–ó–ù–´–ï –¶–ï–õ–ò | –ù–ò–ó–ö–ò–ô |
| E | –ö–æ–Ω—Ç—Ä–∞–∫—Ç | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—Ç–µ–∫—Å—Ç –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–∞—Ö) | üü° –ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï | –ù–ò–ó–ö–ò–ô |
| F | Billing | –ù–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ | üî¥ –ü–û–¢–ï–†–Ø –î–ï–ù–ï–ì | –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô |
| G | Billing | –†–∞–∑–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –±–∏–ª–ª–∏–Ω–≥–∞ (users vs api_keys) | üü° –ü–û –î–ò–ó–ê–ô–ù–£ | –°–†–ï–î–ù–ò–ô |
| H | UX | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (WEB –ª—É—á—à–µ) | üü° –ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï | –ù–ò–ó–ö–ò–ô |
| I | UX | –í–∏–¥–∏–º–æ—Å—Ç—å –æ—à–∏–±–æ–∫ (API —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–µ–µ) | üü° –ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï | –ù–ò–ó–ö–ò–ô |

---

---

## –ß–ê–°–¢–¨ D: –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

### 1Ô∏è‚É£ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (–ë–õ–û–ö–ò–†–£–Æ–¢ –õ–ê–£–ù–ß)

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –°—Ç–æ–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞ ‚Üí –í–°–ï–ì–î–ê 1 –∫—Ä–µ–¥–∏—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
React/Vue = 2 –∫—Ä–µ–¥–∏—Ç–∞ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
HTML = 1 –∫—Ä–µ–¥–∏—Ç (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

–ó–∞–¥–∞—á–∞ –≥–æ–≤–æ—Ä–∏—Ç: "1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 1 –∫—Ä–µ–¥–∏—Ç, —Ñ–æ—Ä–º–∞—Ç –ù–ï –≤–ª–∏—è–µ—Ç"
```

**–†–µ—à–µ–Ω–∏–µ:**
```
FORMAT_COSTS = {
    "html_tailwind": 1,
    "html_css": 1,
    "react_tailwind": 1,  ‚Üê –ò–ó–ú–ï–ù–ò–¢–¨ —Å 2 –Ω–∞ 1
    "vue_tailwind": 1,    ‚Üê –ò–ó–ú–ï–ù–ò–¢–¨ —Å 2 –Ω–∞ 1
}

–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- /backend/api/credits.py (—Å—Ç—Ä–æ–∫–∞ 8-18)
  –ò–∑–º–µ–Ω–∏ FORMAT_COSTS

- /backend/api/routes/billing.py (—Å—Ç—Ä–æ–∫–∞ 433-438)
  –ò–∑–º–µ–Ω–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π format_costs dict
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
1. WEB: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å React ‚Üí –¥–æ–ª–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å 1 (–Ω–µ 2)
2. API: POST /api/generate —Å react_tailwind ‚Üí credits_charged: 1
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö 4 —Ñ–æ—Ä–º–∞—Ç–æ–≤
```

**–°—Ç–∞—Ç—É—Å:** üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û. –≠—Ç–æ —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è —Å –∑–∞–¥–∞—á–µ–π.

---

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ú–µ—Ö–∞–Ω–∏–∑–º –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç –¥–µ–Ω—å–≥–∏ –µ—Å–ª–∏:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø–∞–¥–µ—Ç –≤–æ –≤—Ä–µ–º—è streaming
- WebSocket timeout (10 –º–∏–Ω—É—Ç)
- Server crash –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (cancel)

–≠–¢–û –ö–†–ò–¢–ò–ß–ù–ê–Ø –ü–û–¢–ï–†–Ø –î–ï–ù–ï–ì.
```

**–†–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç A (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è - –±–æ–ª–µ–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ)**

```
–õ–æ–≥–∏–∫–∞: –í–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ –µ—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è failed –∏–ª–∏ timeout

–ú–µ—Å—Ç–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. /backend/api/generation_service.py
   –ö–æ–≥–¥–∞ trigger_generation() —É–ø–∞–¥–µ—Ç (—Å—Ç—Ä–æ–∫–∞ 210-232):
   - –í–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ update status = "failed"
   - –°–¥–µ–ª–∞—Ç—å: refund_credits(api_key_id, credits_charged)

2. /backend/api/routes/stream.py
   –ù–∞ timeout (—Å—Ç—Ä–æ–∫–∞ 207-214):
   - –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π error —Å–æ–æ–±—â–µ–Ω–∏—è
   - –°–¥–µ–ª–∞—Ç—å: refund_credits(api_key_id, credits_charged)

–õ–æ–≥–∏–∫–∞ refund_credits():
- –ß–∏—Ç–∞–µ—Ç –∏–∑ api_generations: credits_charged, api_key_id
- –í—ã—á–∏—Ç–∞–µ—Ç credits_used –æ–±—Ä–∞—Ç–Ω–æ:
  UPDATE api_keys
  SET credits_used = credits_used - ?
  WHERE id = ?

–î–ª—è WEB (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è):
- –í onVariantError() callback
- –°–¥–µ–ª–∞—Ç—å POST /api/billing/refund-credits
- –î–æ–±–∞–≤–∏—Ç—å endpoint refund-credits –≤ billing.py
```

**–†–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç B (–ë–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ - "–∑–∞ –∏–≥—Ä—É –æ—Ç–ø–ª–∞—á–µ–Ω–∞")**

```
–õ–æ–≥–∏–∫–∞: Credits –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ —ç—Ç–æ —á–µ—Ç–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

–ú–∏–Ω—É—Å—ã:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–µ–Ω—å–≥–∏ –Ω–∞ failed –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ù–µ–ø–æ–ø—É–ª—è—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –ù–æ –ø—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å: –í–∞—Ä–∏–∞–Ω—Ç A (—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–µ–µ)
```

**–°—Ç–∞—Ç—É—Å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô. –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

---

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
FORMAT_COSTS –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
1. /backend/api/credits.py (—Å—Ç—Ä–æ–∫–∞ 8-18)
2. /backend/api/routes/billing.py (—Å—Ç—Ä–æ–∫–∞ 433-438)

–ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ ‚Üí –∑–∞–±—É–¥—É—Ç –≤ –¥—Ä—É–≥–æ–º
```

**–†–µ—à–µ–Ω–∏–µ:**

```
–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å FORMAT_COSTS –∏–∑ credits.py –≤–µ–∑–¥–µ:

–î–û:
# –≤ billing.py
format_costs = {
    "html_tailwind": 1,
    "react_tailwind": 2,
    ...
}
cost = format_costs.get(format_type, 1)

–ü–û–°–õ–ï:
# –≤ billing.py
from api.credits import get_format_cost  # —É–∂–µ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è!

cost = get_format_cost(format_type)

–≠—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (credits.py).
```

**–°—Ç–∞—Ç—É—Å:** üü¢ –õ–ï–ì–ö–û. –ü—Ä–æ—Å—Ç–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏–º–ø–æ—Ä—Ç–∞.

---

### 2Ô∏è‚É£ –í–´–°–û–ö–û–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ API –æ—Ç–≤–µ—Ç–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–ö–ª–∏–µ–Ω—Ç –Ω–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—ã–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –¥–æ —Å–ø–∏—Å–∞–Ω–∏—è.
–û–Ω –≤–∏–¥–∏—Ç –≤ –æ—Ç–≤–µ—Ç–µ "credits_charged": 1
–ù–æ –Ω–µ –∑–Ω–∞–µ—Ç: —ç—Ç–æ –±—ã–ª–∞ —Ü–µ–Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è?
```

**–†–µ—à–µ–Ω–∏–µ:**

```
–î–æ–±–∞–≤–∏—Ç—å –≤ GenerateResponse:

return GenerateResponse(
    generation_id=generation_id,
    status="processing",
    credits_charged=cost,
    format_cost=cost,  ‚Üê –î–æ–±–∞–≤–∏—Ç—å –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    tier=api_key_info["tier"],  ‚Üê –î–æ–±–∞–≤–∏—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    stream_url=stream_url
)

JSON –æ—Ç–≤–µ—Ç:
{
  "generation_id": "gen_abc",
  "status": "processing",
  "credits_charged": 1,
  "format_cost": 1,  ‚Üê –Ø—Å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  "stream_url": "wss://..."
}
```

**–°—Ç–∞—Ç—É—Å:** üü° –°–†–ï–î–ù–ò–ô. –£–ª—É—á—à–∞–µ—Ç DX, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω.

---

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 5: –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ FORMAT

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
API –∫–ª–∏–µ–Ω—Ç –Ω–µ –∑–Ω–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∫–∞–∂–¥—ã–π —Ñ–æ—Ä–º–∞—Ç.
–î–æ–ª–∂–µ–Ω –≥–∞–¥–∞—Ç—å –∏–ª–∏ —Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.
```

**–†–µ—à–µ–Ω–∏–µ:**

```
–î–æ–±–∞–≤–∏—Ç—å endpoint:

GET /api/formats

–û—Ç–≤–µ—Ç:
{
  "formats": [
    {
      "id": "html_tailwind",
      "name": "HTML + Tailwind",
      "cost_credits": 1,
      "requires_tier": "free"
    },
    {
      "id": "react_tailwind",
      "name": "React + Tailwind",
      "cost_credits": 1,
      "requires_tier": "pro"
    },
    ...
  ]
}

–§–∞–π–ª: /backend/api/routes/formats.py (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç? –ü—Ä–æ–≤–µ—Ä–∏—Ç—å)
```

**–°—Ç–∞—Ç—É—Å:** üü° –°–†–ï–î–ù–ò–ô. –•–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è API, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω.

---

### 3Ô∏è‚É£ –°–†–ï–î–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 6: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è WEB –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
WEB –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ localStorage.
–ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä cache –æ—á–∏—â–µ–Ω–∞ ‚Üí –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞.
–ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ —É–∑–Ω–∞—Ç—å —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç—Ä–∞—Ç–∏–ª –Ω–∞ WEB.
–ê—Å–∏–º–º–µ—Ç—Ä–∏—è: API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ api_generations, WEB - –Ω–µ—Ç.
```

**–†–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç A (–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)**

```
–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É web_generations (–∫–∞–∫ api_generations):

CREATE TABLE web_generations (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    status TEXT,
    format TEXT,
    input_type TEXT,
    input_data TEXT,
    instructions TEXT,
    credits_charged INTEGER,
    result_code TEXT,
    created_at TIMESTAMP,
    completed_at TIMESTAMP,
    error_message TEXT
)

–ö–æ–≥–¥–∞ WEB –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:
- –ü–æ—Å–ª–µ addHistoryItem() ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ web_generations
- –ò–ª–∏: –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π POST /api/web/generations
- –ò –ø–æ–ª—É—á–∞—Ç—å ID –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ

–ü–ª—é—Å—ã: –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è, –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
–ú–∏–Ω—É—Å—ã: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å localStorage, —Å–ª–æ–∂–Ω–µ–µ
```

**–†–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç B (–¢–æ–ª—å–∫–æ –¥–ª—è API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)**

```
–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å:
- WEB –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ localStorage (–∫–ª–∏–µ–Ω—Ç)
- API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ api_generations (—Å–µ—Ä–≤–µ—Ä)

–≠—Ç–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–∏–∑–∞–π–Ω—É:
- WEB: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∏—Å—Ç–æ—Ä–∏—è –ª–æ–∫–∞–ª—å–Ω–∞—è
- API: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ —Å–µ—Ä–≤–∏—Å, –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç B (–ø—Ä–æ—â–µ, –ø–æ –¥–∏–∑–∞–π–Ω—É —Ä–∞–∑—É–º–Ω–æ)

**–°—Ç–∞—Ç—É—Å:** üü° –°–†–ï–î–ù–ò–ô. –ü–æ–ª–µ–∑–Ω–æ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω.

---

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 7: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–ï—Å–ª–∏ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å FORMAT_COSTS –Ω–∞ 1 –≤–µ–∑–¥–µ:
–ö–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –∑–∞–ø—É—Ç–∞–Ω—ã –ø–æ—á–µ–º—É React —Å—Ç–æ–∏—Ç 2 –∫—Ä–µ–¥–∏—Ç–∞.
```

**–†–µ—à–µ–Ω–∏–µ:**

```
–ï—Å–ª–∏ —Ä–µ—à–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å 2 –∫—Ä–µ–¥–∏—Ç–∞ –¥–ª—è React/Vue:
1. –û–±–Ω–æ–≤–∏—Ç—å API_SPEC.md:
   "Format costs:
    - HTML formats: 1 credit
    - React/Vue formats: 2 credits (due to complexity)"

2. –û–±–Ω–æ–≤–∏—Ç—å /docs —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

3. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ WEB UI –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π:
   "React + Tailwind: 2 –∫—Ä–µ–¥–∏—Ç–∞"

4. –í API –æ—Ç–≤–µ—Ç–µ: –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
```

**–°—Ç–∞—Ç—É—Å:** üî¥ –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø (–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –∑–∞–¥–∞—á–µ)

**–í–´–ï –¢–û–ß–ö–ê:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å FORMAT_COSTS –Ω–∞ 1 –≤–µ–∑–¥–µ!

---

### 4Ô∏è‚É£ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 8: –û–±–Ω–æ–≤–∏—Ç—å API_SPEC.md —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ costs

**–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```
API_SPEC.md –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é?
(–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- –ß–µ—Ç–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ FORMAT_COSTS
- –ü–æ—Å–ª–µ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã = 1 –∫—Ä–µ–¥–∏—Ç
- –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏
```

---

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 9: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å tier restrictions

**–ß—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:**

```
"Tier Access:
- free tier: HTML formats only (html_tailwind, html_css)
- pro tier: All formats (HTML, React, Vue)

Example:
- free user tries react_tailwind ‚Üí 403 Forbidden
- pro user tries react_tailwind ‚Üí 201 Created (1 credit charged)
"
```

---

### 5Ô∏è‚É£ –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô –ù–ê–ë–û–† –ü–†–ê–í–û–ö –î–õ–Ø –ï–î–ò–ù–û–ô –õ–û–ì–ò–ö–ò

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ–¥ –ª–∞—É–Ω—á–µ–º:**

```
MUST DO:
1. ‚úÖ FORMAT_COSTS = 1 –¥–ª—è –≤—Å–µ—Ö (–∏—Å–ø—Ä–∞–≤–∏—Ç—å credits.py)
2. ‚úÖ –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ billing.py (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å get_format_cost())
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å refund_credits() –ª–æ–≥–∏–∫—É –ø—Ä–∏ failed/timeout

SHOULD DO:
4. üü° –û–±–Ω–æ–≤–∏—Ç—å API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
5. üü° –î–æ–±–∞–≤–∏—Ç—å /api/formats endpoint
6. üü° –î–æ–±–∞–≤–∏—Ç—å format_cost –≤ GenerateResponse

CAN DO LATER:
7. ‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å WEB –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
8. ‚è≥ –£–ª—É—á—à–∏—Ç—å UX –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
```

---

### 6Ô∏è‚É£ –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´

#### –í–æ–ø—Ä–æ—Å: –ß—Ç–æ —Å—á–∏—Ç–∞—Ç—å "–∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã"?

**–û—Ç–≤–µ—Ç: WEB —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º UI –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

```
–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è:

1. –ó–ê–î–ê–ß–ê (–≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
   "1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 1 –∫—Ä–µ–¥–∏—Ç, —Ñ–æ—Ä–º–∞—Ç –ù–ï –≤–ª–∏—è–µ—Ç"
   ‚Üì

2. API SPEC (–≤—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å)
   –î–æ–ª–∂–Ω–∞ –æ—Ç—Ä–∞–∂–∞—Ç—å —Ç–æ—á–Ω–æ —Ç–æ —á—Ç–æ –≤ –∑–∞–¥–∞—á–µ
   ‚Üì

3. WEB –∫–æ–¥ (—Ç—Ä–µ—Ç–∏–π —É—Ä–æ–≤–µ–Ω—å)
   Playground –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ spec
   ‚Üì

4. API –∫–æ–¥ (—á–µ—Ç–≤–µ—Ä—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å)
   Public API –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å spec –∏ WEB

–°–µ–π—á–∞—Å –ø–æ—Ä—è–¥–æ–∫ –Ω–∞—Ä—É—à–µ–Ω:
- –ö–æ–¥ —Ä–µ–∞–ª–∏–∑—É–µ—Ç FORMAT_COSTS[react]=2 (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –û–±–∞ WEB –∏ API —Ç–∞–∫ —Ä–µ–∞–ª–∏–∑—É—é—Ç (–æ–¥–∏–Ω–∞–∫–æ–≤–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏" –Ω–æ –Ω–∞—Ä—É—à–∞–µ—Ç –∑–∞–¥–∞—á—É
```

**–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**

```
1. –ó–∞–¥–∞—á–∞ –≥–æ–≤–æ—Ä–∏—Ç: 1 credit = 1 generation (all formats)
2. –û–±–Ω–æ–≤–∏—Ç—å TASK –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ –∫–æ–¥–µ (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
3. –û–±–Ω–æ–≤–∏—Ç—å FORMAT_COSTS –≤ credits.py
4. –û–±–Ω–æ–≤–∏—Ç—å billing.py –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å get_format_cost()
5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å WEB –∏ API —Å –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
6. –û–±–Ω–æ–≤–∏—Ç—å API_SPEC.md
7. –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
```

---

### 7Ô∏è‚É£ –¢–ê–ë–õ–ò–¶–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

| # | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∞ | –¢–µ–∫—É—â–µ–µ | –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---|------|--------|---------|------------|-----------|
| 1 | `/backend/api/credits.py` | 8-18 | FORMAT_COSTS[react]=2 | FORMAT_COSTS[react]=1 | üî¥ –ë–õ–û–ö–ò–†–£–ï–¢ |
| 2 | `/backend/api/routes/billing.py` | 433-438 | –õ–æ–∫–∞–ª—å–Ω—ã–π format_costs | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å get_format_cost() | üü¢ –õ–ï–ì–ö–û |
| 3 | `/backend/api/routes/generate.py` | 88-98 | –ù–µ—Ç refund –ª–æ–≥–∏–∫–∏ | –î–æ–±–∞–≤–∏—Ç—å refund –ø—Ä–∏ error/timeout | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô |
| 4 | `/backend/api/routes/stream.py` | 207-214 | Timeout ‚Üí error | Timeout ‚Üí refund + error | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô |
| 5 | `/backend/api/routes/generate.py` | 154-159 | –ù–µ—Ç format_cost –≤ –æ—Ç–≤–µ—Ç–µ | –î–æ–±–∞–≤–∏—Ç—å format_cost | üü° –°–†–ï–î–ù–ò–ô |
| 6 | `/backend/api/routes/formats.py` | - | –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–π | –î–æ–±–∞–≤–∏—Ç—å cost –≤ –æ—Ç–≤–µ—Ç | üü° –°–†–ï–î–ù–ò–ô |
| 7 | `/backend/api/API_SPEC.md` | - | –°—Ç–∞—Ä–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è | –û–±–Ω–æ–≤–∏—Ç—å costs –∏ tier | üü° –°–†–ï–î–ù–ò–ô |
| 8 | `/frontend/src/app/playground/page.tsx` | 143-175 | –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è costs | üü¢ –ü–†–û–í–ï–†–ò–¢–¨ |

---

### 8Ô∏è‚É£ –¢–ï–°–¢-–ü–õ–ê–ù –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π MUST DO –ø—É–Ω–∫—Ç—ã:**

```
–°–¶–ï–ù–ê–†–ò–ô 1: WEB HTML –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (1 –∫—Ä–µ–¥–∏—Ç)
1. –û—Ç–∫—Ä—ã—Ç—å playground
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç
3. –í—ã–±—Ä–∞—Ç—å "HTML + Tailwind"
4. –ö–ª–∏–∫ "–°–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç"
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: POST /api/billing/deduct-credits –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç credits_deducted=1
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –±–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–∏–ª—Å—è –Ω–∞ 1
–û–ñ–ò–î–ê–ù–ò–ï: ‚úÖ 1 –∫—Ä–µ–¥–∏—Ç —Å–ø–∏—Å–∞–Ω

–°–¶–ï–ù–ê–†–ò–ô 2: WEB React –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (–ë–´–õ–û 2, –î–û–õ–ñ–ù–û 1)
1. –û—Ç–∫—Ä—ã—Ç—å playground
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç
3. –í—ã–±—Ä–∞—Ç—å "React + Tailwind"
4. –ö–ª–∏–∫ "–°–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç"
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: POST /api/billing/deduct-credits –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç credits_deducted=1 (–Ω–µ 2!)
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –±–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–∏–ª—Å—è –Ω–∞ 1 (–Ω–µ 2!)
–û–ñ–ò–î–ê–ù–ò–ï: ‚úÖ 1 –∫—Ä–µ–¥–∏—Ç —Å–ø–∏—Å–∞–Ω (–≤–∞–∂–Ω–æ —á—Ç–æ –Ω–µ 2)

–°–¶–ï–ù–ê–†–ò–ô 3: API HTML –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (1 –∫—Ä–µ–¥–∏—Ç)
1. curl -X POST https://api/api/generate -H "X-API-Key: sk_live_xxx" -d '{"input":{"type":"url","data":"https://..."}, "format":"html_tailwind"}'
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "credits_charged": 1
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: api_keys.credits_used —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 1
–û–ñ–ò–î–ê–ù–ò–ï: ‚úÖ 1 –∫—Ä–µ–¥–∏—Ç —Å–ø–∏—Å–∞–Ω

–°–¶–ï–ù–ê–†–ò–ô 4: API React –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (–ë–´–õ–û 2, –î–û–õ–ñ–ù–û 1)
1. –¢–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å —Å format=react_tailwind
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: credits_charged = 1 (–Ω–µ 2!)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: api_keys.credits_used —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 1 (–Ω–µ 2!)
–û–ñ–ò–î–ê–ù–ò–ï: ‚úÖ 1 –∫—Ä–µ–¥–∏—Ç —Å–ø–∏—Å–∞–Ω

–°–¶–ï–ù–ê–†–ò–ô 5: WEB –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ø–∞–ª–æ ‚Üí –∫—Ä–∞—Ö –º–æ–¥–µ–ª–∏
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
2. –î–æ–∂–¥–∞—Ç—å—Å—è –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, model timeout)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: onVariantError() –≤—ã–∑–≤–∞–Ω
4. –ü–†–û–í–ï–†–ò–¢–¨ –ù–û–í–û–ï: –±–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨–°–Ø (+1 –∫—Ä–µ–¥–∏—Ç)
–û–ñ–ò–î–ê–ù–ò–ï: ‚úÖ –ö—Ä–µ–¥–∏—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)

–°–¶–ï–ù–ê–†–ò–ô 6: API –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ø–∞–ª–æ ‚Üí trigger_generation() –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
1. POST /api/generate —É—Å–ø–µ—à–Ω–æ (credits_charged = 1)
2. –§–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø–∞–¥–µ—Ç (simulate error)
3. WS –æ—Ç–ø—Ä–∞–≤–∏—Ç error —Å–æ–æ–±—â–µ–Ω–∏–µ
4. –ü–†–û–í–ï–†–ò–¢–¨ –ù–û–í–û–ï: api_keys.credits_used –¥–æ–ª–∂–µ–Ω –£–ú–ï–ù–¨–®–ò–¢–¨–°–Ø –æ–±—Ä–∞—Ç–Ω–æ
–û–ñ–ò–î–ê–ù–ò–ï: ‚úÖ –ö—Ä–µ–¥–∏—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)

–°–¶–ï–ù–ê–†–ò–ô 7: API timeout (10 –º–∏–Ω—É—Ç)
1. POST /api/generate —É—Å–ø–µ—à–Ω–æ
2. –î–æ–∂–¥–∞—Ç—å—Å—è 10 –º–∏–Ω—É—Ç –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
3. WS –æ—Ç–ø—Ä–∞–≤–∏—Ç timeout –æ—à–∏–±–∫—É
4. –ü–†–û–í–ï–†–ò–¢–¨ –ù–û–í–û–ï: –ö—Ä–µ–¥–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–æ–∑–≤—Ä–∞—â–µ–Ω
–û–ñ–ò–î–ê–ù–ò–ï: ‚úÖ –ö—Ä–µ–¥–∏—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)
```

---

### 9Ô∏è‚É£ –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

#### **–ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´: –ó–ê–î–ê–ß–ê**

```
–ß–µ—Ç–∫–æ —Å–∫–∞–∑–∞–Ω–æ:
"1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 1 –∫—Ä–µ–¥–∏—Ç
—Ñ–æ—Ä–º–∞—Ç –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å
–ª—é–±–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–æ–≤–Ω–æ 1 credit"

–î–ï–ô–°–¢–í–ò–ï: –°–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É —è–≤–Ω–æ.
```

#### **–ü–æ—Ä—è–¥–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É):**

```
–§–ê–ó–ê 1 (–ë–õ–û–ö–ò–†–£–ï–¢ –õ–ê–£–ù–ß - –°–î–ï–õ–ê–¢–¨ –î–û –ü–£–ë–õ–ò–ö–ê–¶–ò–ò API):
‚òê –ò—Å–ø—Ä–∞–≤–∏—Ç—å FORMAT_COSTS –Ω–∞ 1 –≤–µ–∑–¥–µ
‚òê –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é)
‚òê –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å refund_credits() –ª–æ–≥–∏–∫—É
‚òê –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å all scenarios

–§–ê–ó–ê 2 (–°–†–ê–ó–£ –ü–û–°–õ–ï –§–ê–ó–´ 1 - –£–õ–£–ß–®–ï–ù–ò–Ø):
‚òê –û–±–Ω–æ–≤–∏—Ç—å API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
‚òê –î–æ–±–∞–≤–∏—Ç—å /api/formats endpoint
‚òê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã API

–§–ê–ó–ê 3 (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û - NICE TO HAVE):
‚òê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å WEB –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
‚òê –£–ª—É—á—à–∏—Ç—å UX –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
```

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ù–ê–ô–î–ï–ù–´

1. **–°—Ç–æ–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–æ–≤:** React/Vue = 2 –∫—Ä–µ–¥–∏—Ç–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1)
   - –†–∞—Å—Ö–æ–¥–∏—Ç—Å—è —Å –∑–∞–¥–∞—á–µ–π
   - –í–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ–¥–∏–Ω–∞–∫–æ–≤–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
   - **–ò—Å–ø—Ä–∞–≤–∏—Ç—å:** FORMAT_COSTS –Ω–∞ –≤—Å–µ 1

2. **–ù–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤:** –ü—Ä–∏ –æ—à–∏–±–∫–µ/timeout –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç –¥–µ–Ω—å–≥–∏
   - –≠—Ç–æ –ø–æ—Ç–µ—Ä—è –¥–µ–Ω–µ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞
   - **–ò—Å–ø—Ä–∞–≤–∏—Ç—å:** –î–æ–±–∞–≤–∏—Ç—å refund_credits() –ª–æ–≥–∏–∫—É

3. **–ê—Å–∏–º–º–µ—Ç—Ä–∏—è –±–∏–ª–ª–∏–Ω–≥–∞:** –†–∞–∑–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è WEB –∏ API
   - –≠—Ç–æ –ø–æ –¥–∏–∑–∞–π–Ω—É, OK, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
   - **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:** –ß—Ç–æ users –¥–ª—è WEB, api_keys –¥–ª—è API

### üü¢ –í–°–ï –ì–û–¢–û–í–û

- WEB –∏ API –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É —Å–ø–∏—Å–∞–Ω–∏—è (–∞—Ç–æ–º–∞—Ä–Ω–æ)
- WEB –∏ API –æ–±–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç –Ω–∞ 402 (insufficient credits)
- WEB –∏ API –æ–±–∞ –ø–æ—Ç–µ—Ä—è—é—Ç –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞ –æ—à–∏–±–∫–µ (–Ω–æ —ç—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)

### ‚úÖ –¢–†–ï–ë–£–ï–ú–´–ï –î–ï–ô–°–¢–í–ò–Ø

**–î–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ API –¥–ª—è –ø—É–±–ª–∏–∫–∏:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å FORMAT_COSTS = 1 –≤–µ–∑–¥–µ
2. –î–æ–±–∞–≤–∏—Ç—å refund_credits() –ø—Ä–∏ –æ—à–∏–±–∫–µ
3. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º –≤—ã—à–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** WEB –∏ API –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ.

---

