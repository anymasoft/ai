# –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ê–£–î–ò–¢: –¶–ï–ù–û–û–ë–†–ê–ó–û–í–ê–ù–ò–ï –ò –ü–ê–ö–ï–¢–´
## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ screen-to-code –∏ CardMaker

**–î–∞—Ç–∞**: 2026-01-02
**–°—Ç–∞—Ç—É—Å**: –¢–û–õ–¨–ö–û –ê–£–î–ò–¢, –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –ö–û–î–ê
**–§–æ—Ä–º–∞—Ç**: –û–ø–∏—Å–∞–Ω–∏–µ, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑

---

## –ß–ê–°–¢–¨ 1: –ö–ê–†–¢–ê –¶–ï–ù–û–û–ë–†–ê–ó–û–í–ê–ù–ò–Ø (screen-to-code)

### 1.1 –•—Ä–∞–Ω–∏–ª–∏—â–µ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¶–µ–Ω–∞—Ö

#### –¢–∞–±–ª–∏—Ü–∞ `tariffs` (–û–°–ù–û–í–ù–û–ô –ò–°–¢–û–ß–ù–ò–ö –î–ê–ù–ù–´–•)
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/db/sqlite.py` –ª–∏–Ω–∏–∏ 374-385

```sql
CREATE TABLE IF NOT EXISTS tariffs (
    key TEXT PRIMARY KEY,           -- "free", "basic", "professional"
    name TEXT NOT NULL,             -- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
    price_rub REAL NOT NULL,        -- –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö (–†–ï–î–ê–ö–¢–ò–†–£–ï–¢–°–Ø)
    credits INTEGER NOT NULL,       -- –ö–æ–ª-–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π/–≥–µ–Ω–µ—Ä–∞—Ü–∏–π (–†–ï–î–ê–ö–¢–ò–†–£–ï–¢–°–Ø)
    is_active INTEGER DEFAULT 1,    -- –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
)
```

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ü–æ –£–º–æ–ª—á–∞–Ω–∏—é
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/db/sqlite.py` –ª–∏–Ω–∏–∏ 514-531

–¢—Ä–∏ —Ç–∞—Ä–∏—Ñ–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ë–î:
- `free`: 0 —Ä—É–±, 0 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- `basic`: 3000 —Ä—É–±, 100 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- `professional`: 14000 —Ä—É–±, 500 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

**–ö–†–ò–¢–ò–ß–ù–û**: –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û –Ω–∞—á–∞–ª—å–Ω—ã–µ. –û–Ω–∏ –∂–∏–≤—É—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ –ë–î –∏ –ú–û–ì–£–¢ –ë–´–¢–¨ –ò–ó–ú–ï–ù–ï–ù–´.

### 1.2 –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¶–µ–Ω –≤ Payment Flow

#### –§—É–Ω–∫—Ü–∏—è `create_payment()` - –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ï –ß–¢–ï–ù–ò–ï
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/api/billing/yookassa.py` –ª–∏–Ω–∏–∏ 52-183

```python
def create_payment(user_id: str, package: str, return_url: str):
    # ...
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ú 1: –ß–ò–¢–ê–ï–ú –¶–ï–ù–£ –ò–ó –ë–î
    tariff = get_tariff_by_key(package)  # –õ–∏–Ω–∏—è 90

    if not tariff:
        print(f"[BILLING] ‚úó Tariff '{package}' not found in DB!")
        return None

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –î–ò–ù–ê–ú–ò–ß–ï–°–ö–£–Æ —Ü–µ–Ω—É –∏–∑ –ë–î
    price_rub = tariff["price_rub"]      # –õ–∏–Ω–∏—è 97
    credits = tariff["credits"]          # –õ–∏–Ω–∏—è 98

    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–æ–ø–µ–π–∫–∏ –¥–ª—è YooKassa
    package_info = {
        "price_kopeks": int(price_rub * 100),  # –õ–∏–Ω–∏—è 103
        "credits": credits,
    }
    # ...
```

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç**: –¶–µ–Ω–∞ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `tariffs`, –ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∞.

#### –§—É–Ω–∫—Ü–∏—è `get_tariff_by_key()` - –ß–ò–¢–ê–ï–¢ –ò–ó –ë–î
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/db/sqlite.py` –ª–∏–Ω–∏–∏ 998-1025

```python
def get_tariff_by_key(key: str):
    conn = get_conn()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT key, name, price_rub, credits, is_active, created_at, updated_at
            FROM tariffs
            WHERE key = ?
        """, (key,))

        row = cursor.fetchone()
        if row:
            return {
                "key": row[0],
                "name": row[1],
                "price_rub": row[2],        # ‚Üê –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –¶–ï–ù–ê
                "credits": row[3],          # ‚Üê –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û
                "is_active": bool(row[4]),
                ...
            }
        return None
```

### 1.3 –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –î–æ—Å—Ç—É–ø–Ω—ã—Ö –û–ø–µ—Ä–∞—Ü–∏–π

#### –ò—Å—Ç–æ—á–Ω–∏–∫ 1: –¢–∞–±–ª–∏—Ü–∞ `tariffs`
–ü–æ–ª–µ `credits` —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/–æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–∞.

#### –ò—Å—Ç–æ—á–Ω–∏–∫ 2: –¢–∞–±–ª–∏—Ü–∞ `users`
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/db/sqlite.py` –ª–∏–Ω–∏–∏ 67-81

```sql
CREATE TABLE IF NOT EXISTS users (
    ...
    credits INTEGER DEFAULT 0,          -- –ë–ê–õ–ê–ù–° –û–ü–ï–†–ê–¶–ò–ô
    ...
)
```

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
- –ü–ª–∞—Ç–µ–∂ –±–µ—Ä–µ—Ç `credits_amount` –∏–∑ –ø–∞–∫–µ—Ç–∞ (–∏–∑ `tariffs.credits`)
- –§—É–Ω–∫—Ü–∏—è `add_credits_to_user()` –¥–æ–±–∞–≤–ª—è–µ—Ç —ç—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∫ `users.credits`

#### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- `users.used_generations`: –°—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è = 1 –æ–ø–µ—Ä–∞—Ü–∏—è (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
- **–ò—Å—Ç–æ—á–Ω–∏–∫**: `backend/api/credits.py` –ª–∏–Ω–∏–∏ 7-18

### 1.4 –ï—Å—Ç—å –ª–∏ –û—Ç–¥–µ–ª—å–Ω–∞—è –¢–∞–±–ª–∏—Ü–∞ –ü–∞–∫–µ—Ç–æ–≤?

**–ù–ï–¢** - –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø!

–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç–æ–≤ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `tariffs`:
- –û–¥–∏–Ω —Ç–∞—Ä–∏—Ñ = –æ–¥–∏–Ω –ø–∞–∫–µ—Ç
- –ù–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã `packages`
- –ü—Ä–æ—Å—Ç–∞—è, –ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

---

## –ß–ê–°–¢–¨ 2: –ê–î–ú–ò–ù-–ò–ù–¢–ï–†–§–ï–ô–° –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –¶–ï–ù–û–û–ë–†–ê–ó–û–í–ê–ù–ò–ï–ú

### 2.1 –°—Ç—Ä–∞–Ω–∏—Ü–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¢–∞—Ä–∏—Ñ–∞–º–∏ (Tariffs Management)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `frontend/src/app/admin/tariffs/index.tsx`

#### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
1. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ**: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ —Å –ø–æ–ª—è–º–∏:
   - –ù–∞–∑–≤–∞–Ω–∏–µ
   - –¶–µ–Ω–∞ (–≤ —Ä—É–±–ª—è—Ö)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
   - –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

2. **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ò–Ω–ª–∞–π–Ω–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Input —ç–ª–µ–º–µ–Ω—Ç—ã
   - –ü–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ:
     - `price_rub`: –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
     - `credits`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** (—Å—Ç—Ä–æ–∫–∞ 62-101):
   ```typescript
   async function saveTariff() {
       const price_rub = parseFloat(editing.price_rub)
       const credits = parseInt(editing.credits)

       if (price_rub < 0 || credits < 0) {
           toast.error("–ù–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏")
           return
       }

       const response = await fetchJSON(`/api/admin/tariffs/${editing.key}`, {
           method: "PUT",
           body: JSON.stringify({
               price_rub,
               credits,
           }),
       })
   }
   ```

4. **–í–∞–ª–∏–¥–∞—Ü–∏—è**:
   - –ß–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   - –ù–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ–ª–∏—á–∏–Ω—ã
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**:
   - "–ò–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —Å—Ä–∞–∑—É –Ω–∞ –≤—Å–µ –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏"
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É (–ë–ï–ó —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)

### 2.2 API Endpoint –¥–ª—è –ò–∑–º–µ–Ω–µ–Ω–∏—è –¢–∞—Ä–∏—Ñ–æ–≤

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/api/routes/billing.py` (–Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—á–∏—Ç–∞–Ω–æ, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

**–§—É–Ω–∫—Ü–∏—è**: `update_tariff(key: str, price_rub: float, credits: int)`
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/db/sqlite.py` –ª–∏–Ω–∏–∏ 1027-1049

```python
def update_tariff(key: str, price_rub: float, credits: int) -> bool:
    """Update tariff price and credits."""
    conn = get_conn()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            UPDATE tariffs
            SET price_rub = ?, credits = ?, updated_at = CURRENT_TIMESTAMP
            WHERE key = ?
        """, (price_rub, credits, key))

        conn.commit()
        print(f"[DB] Updated tariff '{key}': price={price_rub} rub, credits={credits}")
        return rows > 0
```

**REST API**: `PUT /api/admin/tariffs/{key}`

---

## –ß–ê–°–¢–¨ 3: –ü–û–õ–ù–ê–Ø –¢–†–ê–°–°–ò–†–û–í–ö–ê DATA FLOW –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –¶–ï–ù

### 3.1 –°—Ü–µ–Ω–∞—Ä–∏–π: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¶–µ–Ω—ã –ü–∞–∫–µ—Ç–∞ "Basic"

#### –®–ê–ì 1: –ê–¥–º–∏–Ω –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –¶–µ–Ω—É –≤ UI
```
–ê–¥–º–∏–Ω –≤–≤–æ–¥–∏—Ç –Ω–æ–≤—É—é —Ü–µ–Ω—É –≤ Input ‚Üí React state –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
```

#### –®–ê–ì 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (PUT Request)
```
PUT /api/admin/tariffs/basic
{
    "price_rub": 3500,      // –ë—ã–ª–∞ 3000
    "credits": 100
}
```

#### –®–ê–ì 3: Backend –û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î
```python
# backend/db/sqlite.py - update_tariff()
UPDATE tariffs
SET price_rub = 3500, credits = 100, updated_at = CURRENT_TIMESTAMP
WHERE key = 'basic'
```

#### –®–ê–ì 4: –ù–æ–≤–∞—è –¶–µ–Ω–∞ –°—Ä–∞–∑—É –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
–ö–æ–≥–¥–∞ —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂:

```python
# backend/api/billing/yookassa.py - create_payment()
tariff = get_tariff_by_key("basic")  # ‚Üê –ß–ò–¢–ê–ï–¢ –ò–ó –ë–î, –ë–ï–†–ï–¢ 3500
price_rub = tariff["price_rub"]      # = 3500 (–Ω–æ–≤–∞—è —Ü–µ–Ω–∞)
```

#### –®–ê–ì 5: YooKassa –ü–ª–∞—Ç–µ–∂ –°–æ–∑–¥–∞–Ω–∞ —Å –ù–æ–≤–æ–π –¶–µ–Ω–æ–π
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç 3500 —Ä—É–± (–Ω–µ 3000)
```

### 3.2 Key Points –≤ Data Flow

| –®–∞–≥ | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –î–µ–π—Å—Ç–≤–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ –ò—Å—Ç–∏–Ω—ã |
|-----|-----------|---------|-----------------|
| 1 | Frontend Admin | –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç input | React state (–≤—Ä–µ–º–µ–Ω–Ω–æ) |
| 2 | PUT API | –ü–æ–ª—É—á–∞–µ—Ç JSON | Request body |
| 3 | Backend | –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç | None (–¥–æ–≤–µ—Ä—è–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É) |
| 4 | SQLite | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç | UPDATE query |
| 5 | create_payment() | –ß–∏—Ç–∞–µ—Ç —Ü–µ–Ω—É | **tariffs table (–ë–î)** |
| 6 | YooKassa API | –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ | payment_request JSON |
| 7 | add_credits_to_user() | –î–æ–±–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ | tariff["credits"] |

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –¢–û–ß–ö–ê**: –¢–æ—á–∫–∞ 5 - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –∫–æ–¥–∞, –≤—Å–µ–≥–¥–∞ –∏–∑ –ë–î.

---

## –ß–ê–°–¢–¨ 4: PAYMENT CREATION –ò ALLOCATION –õ–û–ì–ò–ö–ê

### 4.1 –ü–æ–ª–Ω—ã–π Flow –£—Å–ø–µ—à–Ω–æ–≥–æ –ü–ª–∞—Ç–µ–∂–∞

```
1. –ò–ù–ò–¶–ò–ê–¶–ò–Ø –ü–õ–ê–¢–ï–ñ–ê (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö—É–ø–∏—Ç—å")
   ‚îî‚îÄ POST /api/billing/checkout
      ‚îú‚îÄ get_tariff_by_key(package)  ‚Üê –ß–ò–¢–ê–ï–¢ –¶–ï–ù–£ –∏–∑ –ë–î
      ‚îú‚îÄ create_payment() –≤ YooKassa
      ‚îú‚îÄ _save_payment_to_db(status='pending')
      ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç confirmation_url

2. –†–ï–î–ò–†–ï–ö–¢ –ù–ê YooKassa
   ‚îî‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç

3. –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ü–õ–ê–¢–ï–ñ–ê (–í–ê–†–ò–ê–ù–¢ –ê - Webhook)
   ‚îî‚îÄ YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ /webhook
      ‚îú‚îÄ check_payment_status() –≤ YooKassa
      ‚îú‚îÄ –ï—Å–ª–∏ succeeded:
      ‚îÇ  ‚îú‚îÄ update_payment_status(status='succeeded')
      ‚îÇ  ‚îú‚îÄ add_credits_to_user(credits=tariff['credits'])
      ‚îÇ  ‚îî‚îÄ update_user_plan(plan=package)
      ‚îî‚îÄ –ï—Å–ª–∏ failed/canceled: –Ω–∏—á–µ–≥–æ

4. –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ü–õ–ê–¢–ï–ñ–ê (–í–ê–†–ò–ê–ù–¢ –ë - Polling)
   ‚îî‚îÄ Frontend –∫–∞–∂–¥—ã–µ 2.5s –ø—Ä–æ–≤–µ—Ä—è–µ—Ç GET /api/billing/status
      ‚îú‚îÄ check_payment_status() –≤ YooKassa
      ‚îú‚îÄ get_payment_by_db_id()
      ‚îú‚îÄ –ï—Å–ª–∏ succeeded:
      ‚îÇ  ‚îú‚îÄ add_credits_to_user()
      ‚îÇ  ‚îú‚îÄ update_payment_status()
      ‚îÇ  ‚îî‚îÄ update_user_plan()
      ‚îî‚îÄ –ï—Å–ª–∏ –≤—Å–µ –∂–µ pending: –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å
```

### 4.2 –ö–ª—é—á–µ–≤—ã–µ –§—É–Ω–∫—Ü–∏–∏: –ì–¥–µ –ë–µ—Ä–µ—Ç—Å—è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –û–ø–µ—Ä–∞—Ü–∏–π

#### add_credits_to_user()
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/api/billing/yookassa.py` –ª–∏–Ω–∏–∏ 359-410

```python
def add_credits_to_user(user_id: str, credits: int, reason: str = "payment") -> bool:
    """Add credits to user account (idempotent)."""

    conn = get_conn()
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    cursor.execute("SELECT credits FROM users WHERE id = ?", (user_id,))
    row = cursor.fetchone()
    current_credits = row[0] or 0

    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    new_credits = current_credits + credits  # ‚Üê credits = –∏–∑ –ø–ª–∞—Ç–µ–∂–∞

    # –û–±–Ω–æ–≤–∏—Ç—å –ë–î
    cursor.execute("""
        UPDATE users SET credits = ?, updated_at = datetime('now')
        WHERE id = ?
    """, (new_credits, user_id))

    conn.commit()
    print(f"Added {credits} credits: {current_credits} ‚Üí {new_credits}")
```

**–ò–°–¢–û–ß–ù–ò–ö –ö–û–õ–ò–ß–ï–°–¢–í–ê**: –ü–∞—Ä–∞–º–µ—Ç—Ä `credits` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ –ø–ª–∞—Ç–µ–∂–∞:
```python
# –∏–∑ create_payment() -> _save_payment_to_db()
credits_amount=package_info["credits"]  # –ò–∑ tariff["credits"]
```

#### update_user_plan()
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/api/billing/yookassa.py` –ª–∏–Ω–∏–∏ 466-502

```python
def update_user_plan(user_id: str, plan: str) -> bool:
    """Update user's plan in users table (SINGLE SOURCE OF TRUTH)."""

    cursor.execute("""
        UPDATE users SET plan = ?, updated_at = datetime('now')
        WHERE id = ?
    """, (plan, user_id))

    conn.commit()
```

**–ò–°–¢–û–ß–ù–ò–ö –ü–õ–ê–ù–ê**: –ò–∑ request.package ‚Üí "basic" | "professional"

### 4.3 –ó–∞—â–∏—Ç–∞ –æ—Ç –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

#### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 1: –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ ID –ü–ª–∞—Ç–µ–∂–∞ –≤ YooKassa
```
Idempotence-Key = db_payment_id (UUID)
```

#### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 2: INSERT OR IGNORE
```python
cursor.execute("""
    INSERT OR IGNORE INTO payments (...)  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –¥—É–±–ª–∏
    VALUES (...)
""")
```

#### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 3: Status Check
```python
if current_status === "succeeded":
    # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    return True
```

---

## –ß–ê–°–¢–¨ 5: –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´

### 5.1 –î–ª—è Pricing (–¶–ï–ù–´ –ò –ö–û–õ–ò–ß–ï–°–¢–í–û –û–ü–ï–†–ê–¶–ò–ô):

**–¢–ê–ë–õ–ò–¶–ê: `tariffs`**

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | –¢–∏–ø | –ò–∑–º–µ–Ω—è–µ—Ç—Å—è |
|------|---------|------|-----------|
| `key` | "basic" | TEXT | –ù–ò–ö–û–ì–î–ê |
| `name` | "Basic" | TEXT | –†–ï–î–ö–û |
| `price_rub` | 3000 | REAL | **–ß–ê–°–¢–û** (–∞–¥–º–∏–Ω) |
| `credits` | 100 | INTEGER | **–ß–ê–°–¢–û** (–∞–¥–º–∏–Ω) |
| `is_active` | 1 | INTEGER | –†–µ–¥–∫–æ |

**–ö–ê–ö –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø**:
- `create_payment()` ‚Üí `get_tariff_by_key()` ‚Üí SELECT –∏–∑ –ë–î
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –∫–æ–¥–∞/–∫–æ–Ω—Ñ–∏–≥–∞
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è
- –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

### 5.2 –î–ª—è User Credits (–ë–ê–õ–ê–ù–° –û–ü–ï–†–ê–¶–ò–ô):

**–¢–ê–ë–õ–ò–¶–ê: `users.credits`**

| –û–ø–µ—Ä–∞—Ü–∏—è | –§—É–Ω–∫—Ü–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|----------|---------|-----------|
| –î–æ–±–∞–≤–∏—Ç—å | `add_credits_to_user()` | `credits + amount` |
| –í—ã—á–µ—Å—Ç—å | `deduct_credits()` | `credits - amount` |
| –ü—Ä–æ—á–∏—Ç–∞—Ç—å | `get_user_credits()` | SELECT –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |

**–ê–¢–û–ú–ê–†–ù–û–°–¢–¨**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ SQLite –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è.

---

## –ß–ê–°–¢–¨ 6: –°–†–ê–í–ù–ï–ù–ò–ï –° CardMaker

### 6.1 –¢–∞–±–ª–∏—Ü–∞ –°—Ä–∞–≤–Ω–µ–Ω–∏—è

| –ê—Å–ø–µ–∫—Ç | **screen-to-code** | **CardMaker** |
|--------|------------------|--------------|
| **–•—Ä–∞–Ω–µ–Ω–∏–µ –¶–µ–Ω** | –¢–∞–±–ª–∏—Ü–∞ `tariffs` –≤ –ë–î | –§—É–Ω–∫—Ü–∏–∏ –≤ –∫–æ–¥–µ (`payments.ts`) |
| **–¶–µ–Ω–∞ Basic** | `tariffs.price_rub` (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è) | `getPlanPrice()` = 99000 –∫–æ–ø–µ–µ–∫ (–∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ) |
| **–¶–µ–Ω–∞ Professional** | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤ –ë–î | `getPlanPrice()` = 249000 –∫–æ–ø–µ–µ–∫ (–∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ) |
| **–¶–µ–Ω–∞ Enterprise** | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤ –ë–î | `getPlanPrice()` = 599000 –∫–æ–ø–µ–µ–∫ (–∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ) |
| **–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ Basic** | `tariffs.credits` = 100 | `getGenerationsForPlan()` = 50 (–∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ) |
| **–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ Professional** | `tariffs.credits` = 500 | `getGenerationsForPlan()` = 250 (–∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ) |
| **–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ Enterprise** | `tariffs.credits` = 500 | `getGenerationsForPlan()` = 1000 (–∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ) |
| **–ê–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** | ‚úÖ –ü–æ–ª–Ω—ã–π (Tariffs Page) | ‚ùå –ù–ï–¢ |
| **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã** | üîß –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –±–µ–∑ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è | üíª –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ |
| **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫** | `tariffs` —Ç–∞–±–ª–∏—Ü–∞ | `payments.ts` –∫–æ–¥ |
| **–î–∏–Ω–∞–º–∏—á–Ω–æ—Å—Ç—å** | ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ | ‚ùå –°—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ, —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è |
| **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü–ª–∞—Ç–µ–∂–∞** | `payments(package, credits_amount)` | `payments(planId, generation_balance)` |
| **–ü–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞** | `add_credits_to_user()` | `UPDATE users.generation_balance` |

### 6.2 CardMaker –¢–µ–∫—É—â–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª**: `src/lib/payments.ts` –ª–∏–Ω–∏–∏ 115-138

```typescript
export function getGenerationsForPlan(
  plan: "basic" | "professional" | "enterprise"
): number {
  const generations: Record<string, number> = {
    basic: 50,
    professional: 250,
    enterprise: 1000,
  };
  return generations[plan] || 0;
}

export function getPlanPrice(
  plan: "basic" | "professional" | "enterprise"
): number {
  const prices: Record<string, number> = {
    basic: 99000,         // 990 ‚ÇΩ
    professional: 249000, // 2490 ‚ÇΩ
    enterprise: 599000,   // 5990 ‚ÇΩ
  };
  return prices[plan] || 0;
}
```

**–ü–†–û–ë–õ–ï–ú–ê**:
- –ó–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ –≤ TypeScript
- –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –Ω—É–∂–Ω–æ:
  1. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥
  2. –ü–µ—Ä–µ–ø–æ—Å—Ç—Ä–æ–∏—Ç—å (build)
  3. –ü–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

**–†–ò–°–ö**:
- –¶–µ–Ω—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –ê–¥–º–∏–Ω –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ü–µ–Ω–∞–º–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ downtime

### 6.3 –ö–∞–∫ CardMaker –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≠—Ç–∏ –¶–µ–Ω—ã

**–§–∞–π–ª**: `src/app/api/payments/yookassa/create/route.ts` –ª–∏–Ω–∏–∏ 75-77

```typescript
const amountCopecks = getPlanPrice(
  planId as "basic" | "professional" | "enterprise"
);
```

**–ü–û–¢–û–ö**:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞–∫–µ—Ç
2. API –≤—ã–∑—ã–≤–∞–µ—Ç `getPlanPrice()` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ —Ä—É–±–ª–∏: `(amountCopecks / 100).toFixed(2)`
4. –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –≤ YooKassa

### 6.4 –ü–æ—Å–ª–µ –£—Å–ø–µ—à–Ω–æ–≥–æ –ü–ª–∞—Ç–µ–∂–∞

**–§–∞–π–ª**: `src/lib/payments.ts` –ª–∏–Ω–∏–∏ 164-253 (applySuccessfulPayment)

```typescript
export async function applySuccessfulPayment(paymentId: string) {
    // ...
    const generationsAmount = getGenerationsForPlan(
      planId as "basic" | "professional" | "enterprise"
    );

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º generation_balance –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await db.execute(
      `UPDATE users
       SET generation_balance = generation_balance + ?, updatedAt = ?
       WHERE id = ?`,
      [generationsAmount, now, userId]
    );
}
```

**–ò–°–¢–û–ß–ù–ò–ö –û–ü–ï–†–ê–¶–ò–ô**: –¢–∞–∫–∂–µ –∏–∑ –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

---

## –ß–ê–°–¢–¨ 7: –í–´–í–û–î–´ –ê–£–î–ò–¢–ê

### 7.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –†–∞–∑–ª–∏—á–∏—è

| –ö—Ä–∏—Ç–µ—Ä–∏–π | screen-to-code | CardMaker |
|----------|---|---|
| **–ü–∞—Ç—Ç–µ—Ä–Ω –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è** | Database-Driven | Code-Driven |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã) | –ù–∏–∑–∫–∞—è (–Ω—É–∂–µ–Ω –ø–µ—Ä–µ—Å–º–æ—Ç—Ä –∫–æ–¥–∞) |
| **–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å** | –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ü–µ–Ω—ã | –¢—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ |
| **–°–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (–≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–ª–∞—Ç–µ–∂–µ) | ~30-60 –º–∏–Ω (—Å –ø–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º) |
| **–≠–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å** | –ü–æ–ª–Ω–∞—è (–ª—é–±–∞—è —Ü–µ–Ω–∞) | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è (—Ç–æ–ª—å–∫–æ 3 –ø–∞–∫–µ—Ç–∞) |

### 7.2 –ß–µ–º screen-to-code –õ—É—á—à–µ –¥–ª—è CardMaker

1. **–û—Ç–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ª–æ–≥–∏–∫–∏**
   - –¶–µ–Ω—ã = –î–ê–ù–ù–´–ï (–∂–∏–≤—É—Ç –≤ –ë–î)
   - –õ–æ–≥–∏–∫–∞ = –ö–û–î (fetch, validate, process)

2. **Admin Control**
   - –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ü–µ–Ω—ã –ë–ï–ó –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–¥—É
   - –ë–ï–ó git commits, builds, deploys

3. **A/B Testing**
   - –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ü–µ–Ω—ã
   - –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–Ω–∏–µ

4. **Audit Trail**
   - `created_at`, `updated_at` –≤ tariffs —Ç–∞–±–ª–∏—Ü–µ
   - –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω

5. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**
   - –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã (–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ –ë–î)
   - –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è (–Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü –≤ –ë–î)

### 7.3 –ö–∞–∫ screen-to-code –≠—Ç–æ –†–µ–∞–ª–∏–∑–æ–≤–∞–ª

**–ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø –°–õ–û–ñ–ù–û–°–¢–¨**:
- –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `tariffs` (4 –ø–æ–ª—è)
- –û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_tariff_by_key()` –¥–ª—è —á—Ç–µ–Ω–∏—è
- –û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `update_tariff()` –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –û–¥–Ω–∞ –∞–¥–º–∏–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è UI

**–¢–û–ß–ö–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò**:
```python
# backend/api/billing/yookassa.py –ª–∏–Ω–∏—è 90
tariff = get_tariff_by_key(package)  # ‚Üê –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç –∏–∑ –ë–î
```

–≠—Ç–∞ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –í–°–ï–ì–î–ê –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞.

### 7.4 –ö–ª—é—á–µ–≤—ã–µ –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | screen-to-code | CardMaker |
|---------|---|---|
| –¢–∞–±–ª–∏—Ü –¥–ª—è —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è | 1 (`tariffs`) | 0 |
| –§—É–Ω–∫—Ü–∏–π –¥–ª—è —á—Ç–µ–Ω–∏—è —Ü–µ–Ω | 1 (`get_tariff_by_key`) | 2 (`getPlanPrice`, `getGenerationsForPlan`) |
| –ó–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π | 3 (–Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ init_db) | 6 (3 —Ü–µ–Ω—ã + 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏) |
| –ê–¥–º–∏–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü | 1 (Tariffs Management) | 0 |
| REST API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–ª—è —Ü–µ–Ω | 1 (`PUT /api/admin/tariffs/{key}`) | 0 |
| –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–ª—è —Å–º–µ–Ω—ã —Ü–µ–Ω—ã | ‚ùå –ù–ï–¢ | ‚úÖ –î–ê |

---

## –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê

### –î–õ–Ø screen-to-code:

**–ò–°–¢–û–ß–ù–ò–ö –¶–ï–ù**: `tariffs` —Ç–∞–±–ª–∏—Ü–∞
**–ö–ê–ö –ß–ò–¢–ê–ï–¢–°–Ø**: `get_tariff_by_key(package)` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
**–ö–ê–ö –†–ï–î–ê–ö–¢–ò–†–£–ï–¢–°–Ø**: `PUT /api/admin/tariffs/{key}` –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
**–î–ò–ù–ê–ú–ò–ß–ù–û?**: ‚úÖ –î–ê - —Ü–µ–Ω—ã –º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### –î–õ–Ø CardMaker:

**–ò–°–¢–û–ß–ù–ò–ö –¶–ï–ù**: `getPlanPrice()` –∏ `getGenerationsForPlan()` –≤ `payments.ts`
**–ö–ê–ö –ß–ò–¢–ê–ï–¢–°–Ø**: –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏
**–ö–ê–ö –†–ï–î–ê–ö–¢–ò–†–£–ï–¢–°–Ø**: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ ‚Üí rebuild ‚Üí redeploy
**–î–ò–ù–ê–ú–ò–ß–ù–û?**: ‚ùå –ù–ï–¢ - —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

---

**–ö–û–ù–ï–¶ –ê–£–î–ò–¢–ê**

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–µ –≤ screen-to-code
- ‚úÖ –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ï—Å—Ç—å –ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–∞–∫–µ—Ç–æ–≤ (–ù–ï–¢, –Ω–æ tariffs —ç—Ç—É —Ä–æ–ª—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç)
- ‚úÖ –ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ API flow –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω
- ‚úÖ –ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ payment creation –∏ allocation
- ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å CardMaker (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
